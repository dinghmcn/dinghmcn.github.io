<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Android9.0 PackageManagerService 构造篇 （二） - dinghmcn&#39;s blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="dinghmcn" />
  <meta name="description" content="分析 PackageManagerService 的构造方法，主要是扫描已存在的应用并建立应用信息库用于查询
" />

  <meta name="keywords" content="Java, Android, C&#43;&#43;" />






<meta name="generator" content="Hugo 0.55.1" />


<link rel="canonical" href="https://dinghmcn.github.io/post/packagemanagerservice2/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.ec807d8b802a40889537c26e014f733206312ea440d42e1f0dabed80918de1ac.css" integrity="sha256-7IB9i4AqQIiVN8JuAU9zMgYxLqRA1C4fDavtgJGN4aw=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="Android9.0 PackageManagerService 构造篇 （二）" />
<meta property="og:description" content="分析 PackageManagerService 的构造方法，主要是扫描已存在的应用并建立应用信息库用于查询" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dinghmcn.github.io/post/packagemanagerservice2/" />
<meta property="article:published_time" content="2019-01-14T00:00:00&#43;08:00"/>
<meta property="article:modified_time" content="2019-04-22T17:02:23&#43;08:00"/>

<meta itemprop="name" content="Android9.0 PackageManagerService 构造篇 （二）">
<meta itemprop="description" content="分析 PackageManagerService 的构造方法，主要是扫描已存在的应用并建立应用信息库用于查询">


<meta itemprop="datePublished" content="2019-01-14T00:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2019-04-22T17:02:23&#43;08:00" />
<meta itemprop="wordCount" content="0">



<meta itemprop="keywords" content="Android,SystemServer," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Android9.0 PackageManagerService 构造篇 （二）"/>
<meta name="twitter:description" content="分析 PackageManagerService 的构造方法，主要是扫描已存在的应用并建立应用信息库用于查询"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">dinghmcn&#39;s blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/about/">关于</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/index.xml">订阅</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      dinghmcn&#39;s blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/about/">关于</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/index.xml">订阅</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Android9.0 PackageManagerService 构造篇 （二）</h1>
      
      <div class="post-meta">
        <time datetime="2019-01-14" class="post-time">
          2019-01-14
        </time>
        <div class="post-category">
            <a href="https://dinghmcn.github.io/categories/android/"> Android </a>
            
          </div>
        <span class="more-meta"> 约 0 字 </span>
          <span class="more-meta"> 预计阅读 0 分钟 </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#packagemanagerservice-构造过程"><code>PackageManagerService</code> 构造过程</a>
<ul>
<li><a href="#packagemanagerservice"><code>PackageManagerService()</code></a></li>
<li><a href="#settings-dot-class"><code>Settings.class</code></a>
<ul>
<li><a href="#settings"><code>Settings()</code></a></li>
<li><a href="#addshareduserlpw"><code>addSharedUserLPw()</code></a></li>
</ul></li>
<li><a href="#systemconfig-dot-class"><code>SystemConfig.class</code></a>
<ul>
<li><a href="#systemconfig"><code>SystemConfig()</code></a></li>
<li><a href="#readpermissions"><code>readPermissions()</code></a></li>
</ul></li>
<li><a href="#扫描已安装应用信息并保存">扫描已安装应用信息并保存</a>
<ul>
<li><a href="#scandirtracedli"><code>scanDirTracedLI()</code></a></li>
<li><a href="#parallelpackageparser-dot-class"><code>ParallelPackageParser.class</code></a></li>
<li><a href="#packageparser-dot-class"><code>PackageParser.class</code></a></li>
<li><a href="#scanpackagechildli"><code>scanPackageChildLI()</code></a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>分析 <code>PackageManagerService</code> 的构造方法，主要是扫描已存在的应用并建立应用信息库用于查询</p>

<h2 id="packagemanagerservice-构造过程"><code>PackageManagerService</code> 构造过程</h2>

<ul>
<li>涉及文件

<ul>
<li><code>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</code></li>
<li><code>frameworks/base/services/core/java/com/android/server/pm/Settings.java</code></li>
<li><code>frameworks/base/core/java/com/android/server/SystemConfig.java</code></li>
<li><code>frameworks/base/services/core/java/com/android/server/pm/ParallelPackageParser.java</code></li>
<li><code>frameworks/base/core/java/android/content/pm/PackageParser.java</code></li>
<li><code>frameworks/base/services/core/java/com/android/server/pm/PackageSetting.java</code></li>
</ul></li>
</ul>

<h3 id="packagemanagerservice"><code>PackageManagerService()</code></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span><span class="lnt">656
</span><span class="lnt">657
</span><span class="lnt">658
</span><span class="lnt">659
</span><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span><span class="lnt">663
</span><span class="lnt">664
</span><span class="lnt">665
</span><span class="lnt">666
</span><span class="lnt">667
</span><span class="lnt">668
</span><span class="lnt">669
</span><span class="lnt">670
</span><span class="lnt">671
</span><span class="lnt">672
</span><span class="lnt">673
</span><span class="lnt">674
</span><span class="lnt">675
</span><span class="lnt">676
</span><span class="lnt">677
</span><span class="lnt">678
</span><span class="lnt">679
</span><span class="lnt">680
</span><span class="lnt">681
</span><span class="lnt">682
</span><span class="lnt">683
</span><span class="lnt">684
</span><span class="lnt">685
</span><span class="lnt">686
</span><span class="lnt">687
</span><span class="lnt">688
</span><span class="lnt">689
</span><span class="lnt">690
</span><span class="lnt">691
</span><span class="lnt">692
</span><span class="lnt">693
</span><span class="lnt">694
</span><span class="lnt">695
</span><span class="lnt">696
</span><span class="lnt">697
</span><span class="lnt">698
</span><span class="lnt">699
</span><span class="lnt">700
</span><span class="lnt">701
</span><span class="lnt">702
</span><span class="lnt">703
</span><span class="lnt">704
</span><span class="lnt">705
</span><span class="lnt">706
</span><span class="lnt">707
</span><span class="lnt">708
</span><span class="lnt">709
</span><span class="lnt">710
</span><span class="lnt">711
</span><span class="lnt">712
</span><span class="lnt">713
</span><span class="lnt">714
</span><span class="lnt">715
</span><span class="lnt">716
</span><span class="lnt">717
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">PackageManagerService</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Installer</span> <span class="n">installer</span><span class="o">,</span>
                             <span class="kt">boolean</span> <span class="n">factoryTest</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">onlyCore</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//LockGuard 验证所有锁定是否以一致的顺序完成，并且如果检测到任何反转则将记录。
</span><span class="c1"></span>    <span class="c1">//例如，如果调用线程在保持  PackageManager 锁时试图获取  ActivityManager 锁，它将会提示。
</span><span class="c1"></span>    <span class="n">LockGuard</span><span class="o">.</span><span class="na">installLock</span><span class="o">(</span><span class="n">mPackages</span><span class="o">,</span> <span class="n">LockGuard</span><span class="o">.</span><span class="na">INDEX_PACKAGES</span><span class="o">);</span>
    <span class="n">EventLog</span><span class="o">.</span><span class="na">writeEvent</span><span class="o">(</span><span class="n">EventLogTags</span><span class="o">.</span><span class="na">BOOT_PROGRESS_PMS_START</span><span class="o">,</span>
                        <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">());</span>
    <span class="c1">//ro.build.version.sdk 没有设置，这个一般是不可能的
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">mSdkVersion</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;**** ro.build.version.sdk not set!&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
    <span class="c1">// 正常情况下，mFactoryTest=false mOnlyCore=false
</span><span class="c1"></span>    <span class="n">mFactoryTest</span> <span class="o">=</span> <span class="n">factoryTest</span><span class="o">;</span>
    <span class="n">mOnlyCore</span> <span class="o">=</span> <span class="n">onlyCore</span><span class="o">;</span>
    <span class="c1">//分辨率相关
</span><span class="c1"></span>    <span class="n">mMetrics</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DisplayMetrics</span><span class="o">();</span>
    <span class="c1">//用于远程调用  installd
</span><span class="c1"></span>    <span class="n">mInstaller</span> <span class="o">=</span> <span class="n">installer</span><span class="o">;</span>

    <span class="c1">// Create sub-components that provide services / data. Order here is important.
</span><span class="c1"></span>    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mInstallLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mPackages</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Expose private service for system components to use.
</span><span class="c1"></span>            <span class="c1">// PackageManager 加入到  LocalServices 供  SystemServer 内部调用  PackageManagerService
</span><span class="c1"></span>            <span class="n">LocalServices</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span>
                                     <span class="n">PackageManagerInternal</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">PackageManagerInternalImpl</span><span class="o">());</span>
            <span class="c1">// 用户管理
</span><span class="c1"></span>            <span class="n">sUserManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span>
                                                  <span class="k">new</span> <span class="n">UserDataPreparer</span><span class="o">(</span><span class="n">mInstaller</span><span class="o">,</span> <span class="n">mInstallLock</span><span class="o">,</span> <span class="n">mContext</span><span class="o">,</span> <span class="n">mOnlyCore</span><span class="o">),</span> <span class="n">mPackages</span><span class="o">);</span>
            <span class="c1">// 权限管理
</span><span class="c1"></span>            <span class="n">mPermissionManager</span> <span class="o">=</span> <span class="n">PermissionManagerService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">context</span><span class="o">,</span>
                                                                 <span class="k">new</span> <span class="n">DefaultPermissionGrantedCallback</span><span class="o">()</span> <span class="o">{</span>
                                                                     <span class="nd">@Override</span>
                                                                     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDefaultRuntimePermissionsGranted</span><span class="o">(</span><span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
                                                                         <span class="kd">synchronized</span><span class="o">(</span><span class="n">mPackages</span><span class="o">)</span> <span class="o">{</span>
                                                                             <span class="n">mSettings</span><span class="o">.</span><span class="na">onDefaultRuntimePermissionsGrantedLPr</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
                                                                         <span class="o">}</span>
                                                                     <span class="o">}</span>
                                                                 <span class="o">},</span> <span class="n">mPackages</span> <span class="cm">/*externalLock*/</span><span class="o">);</span>
            <span class="c1">// 默认权限策略，比如默认情况下  Phone 应该具有电话相关的权限
</span><span class="c1"></span>            <span class="n">mDefaultPermissionPolicy</span> <span class="o">=</span> <span class="n">mPermissionManager</span><span class="o">.</span><span class="na">getDefaultPermissionGrantPolicy</span><span class="o">();</span>
            <span class="c1">// 保存有关动态设置的信息 &lt;1.&gt;
</span><span class="c1"></span>            <span class="n">mSettings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Settings</span><span class="o">(</span><span class="n">mPermissionManager</span><span class="o">.</span><span class="na">getPermissionSettings</span><span class="o">(),</span> <span class="n">mPackages</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// Android UID 与  Linux UID 的一一对应关系
</span><span class="c1"></span>    <span class="n">mSettings</span><span class="o">.</span><span class="na">addSharedUserLPw</span><span class="o">(</span><span class="s">&#34;android.uid.system&#34;</span><span class="o">,</span> <span class="n">Process</span><span class="o">.</span><span class="na">SYSTEM_UID</span><span class="o">,</span>
                               <span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">FLAG_SYSTEM</span><span class="o">,</span> <span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">PRIVATE_FLAG_PRIVILEGED</span><span class="o">);</span>
    <span class="n">mSettings</span><span class="o">.</span><span class="na">addSharedUserLPw</span><span class="o">(</span><span class="s">&#34;android.uid.phone&#34;</span><span class="o">,</span> <span class="n">RADIO_UID</span><span class="o">,</span>
                               <span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">FLAG_SYSTEM</span><span class="o">,</span> <span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">PRIVATE_FLAG_PRIVILEGED</span><span class="o">);</span>
    <span class="n">mSettings</span><span class="o">.</span><span class="na">addSharedUserLPw</span><span class="o">(</span><span class="s">&#34;android.uid.log&#34;</span><span class="o">,</span> <span class="n">LOG_UID</span><span class="o">,</span>
                               <span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">FLAG_SYSTEM</span><span class="o">,</span> <span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">PRIVATE_FLAG_PRIVILEGED</span><span class="o">);</span>
    <span class="n">mSettings</span><span class="o">.</span><span class="na">addSharedUserLPw</span><span class="o">(</span><span class="s">&#34;android.uid.nfc&#34;</span><span class="o">,</span> <span class="n">NFC_UID</span><span class="o">,</span>
                               <span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">FLAG_SYSTEM</span><span class="o">,</span> <span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">PRIVATE_FLAG_PRIVILEGED</span><span class="o">);</span>
    <span class="n">mSettings</span><span class="o">.</span><span class="na">addSharedUserLPw</span><span class="o">(</span><span class="s">&#34;android.uid.bluetooth&#34;</span><span class="o">,</span> <span class="n">BLUETOOTH_UID</span><span class="o">,</span>
                               <span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">FLAG_SYSTEM</span><span class="o">,</span> <span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">PRIVATE_FLAG_PRIVILEGED</span><span class="o">);</span>
    <span class="n">mSettings</span><span class="o">.</span><span class="na">addSharedUserLPw</span><span class="o">(</span><span class="s">&#34;android.uid.shell&#34;</span><span class="o">,</span> <span class="n">SHELL_UID</span><span class="o">,</span>
                               <span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">FLAG_SYSTEM</span><span class="o">,</span> <span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">PRIVATE_FLAG_PRIVILEGED</span><span class="o">);</span>
    <span class="n">mSettings</span><span class="o">.</span><span class="na">addSharedUserLPw</span><span class="o">(</span><span class="s">&#34;android.uid.se&#34;</span><span class="o">,</span> <span class="n">SE_UID</span><span class="o">,</span>
                               <span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">FLAG_SYSTEM</span><span class="o">,</span> <span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">PRIVATE_FLAG_PRIVILEGED</span><span class="o">);</span>
    <span class="c1">// 调试相关，默认未设置是空
</span><span class="c1"></span>    <span class="n">String</span> <span class="n">separateProcesses</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;debug.separate_processes&#34;</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">separateProcesses</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">separateProcesses</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="s">&#34;*&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">separateProcesses</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">mDefParseFlags</span> <span class="o">=</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">PARSE_IGNORE_PROCESSES</span><span class="o">;</span>
            <span class="n">mSeparateProcesses</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Running with debug.separate_processes: * (ALL)&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">mDefParseFlags</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
            <span class="n">mSeparateProcesses</span> <span class="o">=</span> <span class="n">separateProcesses</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;,&#34;</span><span class="o">);</span>
            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Running with debug.separate_processes: &#34;</span>
                   <span class="o">+</span> <span class="n">separateProcesses</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">mDefParseFlags</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="n">mSeparateProcesses</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// 用于在包上运行  dexopt 命令的  Helper 类
</span><span class="c1"></span>    <span class="n">mPackageDexOptimizer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PackageDexOptimizer</span><span class="o">(</span><span class="n">installer</span><span class="o">,</span> <span class="n">mInstallLock</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span>
                                                   <span class="s">&#34;*dexopt*&#34;</span><span class="o">);</span>
    <span class="n">DexManager</span><span class="o">.</span><span class="na">Listener</span> <span class="n">dexManagerListener</span> <span class="o">=</span> <span class="n">DexLogger</span><span class="o">.</span><span class="na">getListener</span><span class="o">(</span><span class="k">this</span><span class="o">,</span>
                                                                   <span class="n">installer</span><span class="o">,</span> <span class="n">mInstallLock</span><span class="o">);</span>
    <span class="c1">// 用于处理  dex 文件
</span><span class="c1"></span>    <span class="n">mDexManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DexManager</span><span class="o">(</span><span class="n">mContext</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">mPackageDexOptimizer</span><span class="o">,</span> <span class="n">installer</span><span class="o">,</span> <span class="n">mInstallLock</span><span class="o">,</span>
                                 <span class="n">dexManagerListener</span><span class="o">);</span>
    <span class="c1">// ArtManagerService Art 虚拟机管理服务
</span><span class="c1"></span>    <span class="n">mArtManagerService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArtManagerService</span><span class="o">(</span><span class="n">mContext</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">installer</span><span class="o">,</span> <span class="n">mInstallLock</span><span class="o">);</span>
    <span class="c1">// 两个回调
</span><span class="c1"></span>    <span class="n">mMoveCallbacks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MoveCallbacks</span><span class="o">(</span><span class="n">FgThread</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getLooper</span><span class="o">());</span>

    <span class="n">mOnPermissionChangeListeners</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OnPermissionChangeListeners</span><span class="o">(</span>
                                                                   <span class="n">FgThread</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getLooper</span><span class="o">());</span>
    <span class="c1">// 存储分辨率、显示等相关信息
</span><span class="c1"></span>    <span class="n">getDefaultDisplayMetrics</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">mMetrics</span><span class="o">);</span>
    <span class="c1">// 系统设置 &lt;2.&gt;
</span><span class="c1"></span>    <span class="n">SystemConfig</span> <span class="n">systemConfig</span> <span class="o">=</span> <span class="n">SystemConfig</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
    <span class="c1">// 支持的功能
</span><span class="c1"></span>    <span class="n">mAvailableFeatures</span> <span class="o">=</span> <span class="n">systemConfig</span><span class="o">.</span><span class="na">getAvailableFeatures</span><span class="o">();</span>
    <span class="c1">// 需要特殊保护的包
</span><span class="c1"></span>    <span class="n">mProtectedPackages</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProtectedPackages</span><span class="o">(</span><span class="n">mContext</span><span class="o">);</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mInstallLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// writer
</span><span class="c1"></span>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mPackages</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 该  Handler 将处理  PackageManagerService 的相关消息，APK 的安装就由其负责
</span><span class="c1"></span>            <span class="n">mHandlerThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServiceThread</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span>
                                               <span class="n">Process</span><span class="o">.</span><span class="na">THREAD_PRIORITY_BACKGROUND</span><span class="o">,</span> <span class="kc">true</span> <span class="cm">/*allowIo*/</span><span class="o">);</span>
            <span class="n">mHandlerThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
            <span class="n">mHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PackageHandler</span><span class="o">(</span><span class="n">mHandlerThread</span><span class="o">.</span><span class="na">getLooper</span><span class="o">());</span>
            <span class="c1">// 日志相关
</span><span class="c1"></span>            <span class="n">mProcessLoggingHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProcessLoggingHandler</span><span class="o">();</span>
            <span class="c1">// 监控堵塞
</span><span class="c1"></span>            <span class="n">Watchdog</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">addThread</span><span class="o">(</span><span class="n">mHandler</span><span class="o">,</span> <span class="n">WATCHDOG_TIMEOUT</span><span class="o">);</span>
            <span class="c1">// 用于管理即时应用
</span><span class="c1"></span>            <span class="n">mInstantAppRegistry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InstantAppRegistry</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="c1">// 保存共享库到当前服务
</span><span class="c1"></span>            <span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">libConfig</span> <span class="o">=</span> <span class="n">systemConfig</span><span class="o">.</span><span class="na">getSharedLibraries</span><span class="o">();</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">builtInLibCount</span> <span class="o">=</span> <span class="n">libConfig</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">builtInLibCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">libConfig</span><span class="o">.</span><span class="na">keyAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">libConfig</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="n">addSharedLibraryLPw</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">SharedLibraryInfo</span><span class="o">.</span><span class="na">VERSION_UNDEFINED</span><span class="o">,</span>
                                    <span class="n">SharedLibraryInfo</span><span class="o">.</span><span class="na">TYPE_BUILTIN</span><span class="o">,</span> <span class="n">PLATFORM_PACKAGE_NAME</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// 从  mac_permissions.xml 等相关文件加载  SELinux MAC 策略
</span><span class="c1"></span>            <span class="n">SELinuxMMAC</span><span class="o">.</span><span class="na">readInstallPolicy</span><span class="o">();</span>

            <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="o">,</span> <span class="s">&#34;loadFallbacks&#34;</span><span class="o">);</span>
            <span class="c1">// ApplicationInfo#category 的回调
</span><span class="c1"></span>            <span class="n">FallbackCategoryProvider</span><span class="o">.</span><span class="na">loadFallbacks</span><span class="o">();</span>
            <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="o">);</span>

            <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="o">,</span> <span class="s">&#34;read user settings&#34;</span><span class="o">);</span>
            <span class="c1">// 是否首次启动设备
</span><span class="c1"></span>            <span class="n">mFirstBoot</span> <span class="o">=</span> <span class="o">!</span><span class="n">mSettings</span><span class="o">.</span><span class="na">readLPw</span><span class="o">(</span><span class="n">sUserManager</span><span class="o">.</span><span class="na">getUsers</span><span class="o">(</span><span class="kc">false</span><span class="o">));</span>
            <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="o">);</span>

            <span class="c1">// Clean up orphaned packages for which the code path doesn&#39;t exist
</span><span class="c1"></span>            <span class="c1">// and they are an update to a system app - caused by bug/32321269
</span><span class="c1"></span>            <span class="c1">// 清除孤立包
</span><span class="c1"></span>            <span class="kd">final</span> <span class="kt">int</span> <span class="n">packageSettingCount</span> <span class="o">=</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">mPackages</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">packageSettingCount</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span> <span class="o">{</span>
                <span class="n">PackageSetting</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">mPackages</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">isExternal</span><span class="o">(</span><span class="n">ps</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">ps</span><span class="o">.</span><span class="na">codePath</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">ps</span><span class="o">.</span><span class="na">codePath</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span>
                    <span class="o">&amp;&amp;</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">getDisabledSystemPkgLPr</span><span class="o">(</span><span class="n">ps</span><span class="o">.</span><span class="na">name</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">mSettings</span><span class="o">.</span><span class="na">mPackages</span><span class="o">.</span><span class="na">removeAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                    <span class="n">mSettings</span><span class="o">.</span><span class="na">enableSystemPackageLPw</span><span class="o">(</span><span class="n">ps</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">mFirstBoot</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 请求把备份系统的数据复制到  data 分区，如果有的话
</span><span class="c1"></span>                <span class="n">requestCopyPreoptedFiles</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="c1">// 获取自定义  ResolverActivity，一般为空，
</span><span class="c1"></span>            <span class="c1">//ResolverActivity 用于显示系统启动一个  Intent 的多个匹配项
</span><span class="c1"></span>            <span class="n">String</span> <span class="n">customResolverActivity</span> <span class="o">=</span> <span class="n">Resources</span><span class="o">.</span><span class="na">getSystem</span><span class="o">().</span><span class="na">getString</span><span class="o">(</span>
                                                                            <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">config_customResolverActivity</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">TextUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">customResolverActivity</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">customResolverActivity</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">mCustomResolverComponentName</span> <span class="o">=</span> <span class="n">ComponentName</span><span class="o">.</span><span class="na">unflattenFromString</span><span class="o">(</span>
                                                                                 <span class="n">customResolverActivity</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>

            <span class="n">EventLog</span><span class="o">.</span><span class="na">writeEvent</span><span class="o">(</span><span class="n">EventLogTags</span><span class="o">.</span><span class="na">BOOT_PROGRESS_PMS_SYSTEM_SCAN_START</span><span class="o">,</span>
                                <span class="n">startTime</span><span class="o">);</span>
            <span class="c1">// 系统启动相关类的环境变量，默认包括 /sysem/frameworks/*.jar
</span><span class="c1"></span>            <span class="kd">final</span> <span class="n">String</span> <span class="n">bootClassPath</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="s">&#34;BOOTCLASSPATH&#34;</span><span class="o">);</span>
            <span class="c1">// SystemServer 相关类的环境变量， 包括 /system/framework/services.jar /system/framework/*-service.jar
</span><span class="c1"></span>            <span class="kd">final</span> <span class="n">String</span> <span class="n">systemServerClassPath</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="s">&#34;SYSTEMSERVERCLASSPATH&#34;</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">bootClassPath</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;No BOOTCLASSPATH found!&#34;</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">systemServerClassPath</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;No SYSTEMSERVERCLASSPATH found!&#34;</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">//  /system/framework 目录
</span><span class="c1"></span>            <span class="n">File</span> <span class="n">frameworkDir</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">Environment</span><span class="o">.</span><span class="na">getRootDirectory</span><span class="o">(),</span> <span class="s">&#34;framework&#34;</span><span class="o">);</span>
            <span class="c1">// 系统  ota 升级相关
</span><span class="c1"></span>            <span class="kd">final</span> <span class="n">VersionInfo</span> <span class="n">ver</span> <span class="o">=</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">getInternalVersion</span><span class="o">();</span>
            <span class="n">mIsUpgrade</span> <span class="o">=</span> <span class="o">!</span><span class="n">Build</span><span class="o">.</span><span class="na">FINGERPRINT</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ver</span><span class="o">.</span><span class="na">fingerprint</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mIsUpgrade</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">logCriticalInfo</span><span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">INFO</span><span class="o">,</span>
                                <span class="s">&#34;Upgrading from &#34;</span> <span class="o">+</span> <span class="n">ver</span><span class="o">.</span><span class="na">fingerprint</span> <span class="o">+</span> <span class="s">&#34; to &#34;</span> <span class="o">+</span> <span class="n">Build</span><span class="o">.</span><span class="na">FINGERPRINT</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// when upgrading from pre-M, promote system app permissions from install to runtime
</span><span class="c1"></span>            <span class="n">mPromoteSystemApps</span> <span class="o">=</span>
                <span class="n">mIsUpgrade</span> <span class="o">&amp;&amp;</span> <span class="n">ver</span><span class="o">.</span><span class="na">sdkVersion</span> <span class="o">&lt;=</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">LOLLIPOP_MR1</span><span class="o">;</span>

            <span class="c1">// When upgrading from pre-N, we need to handle package extraction like first boot,
</span><span class="c1"></span>            <span class="c1">// as there is no profiling data available.
</span><span class="c1"></span>            <span class="n">mIsPreNUpgrade</span> <span class="o">=</span> <span class="n">mIsUpgrade</span> <span class="o">&amp;&amp;</span> <span class="n">ver</span><span class="o">.</span><span class="na">sdkVersion</span> <span class="o">&lt;</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">N</span><span class="o">;</span>

            <span class="n">mIsPreNMR1Upgrade</span> <span class="o">=</span> <span class="n">mIsUpgrade</span> <span class="o">&amp;&amp;</span> <span class="n">ver</span><span class="o">.</span><span class="na">sdkVersion</span> <span class="o">&lt;</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">N_MR1</span><span class="o">;</span>

            <span class="c1">// save off the names of pre-existing system packages prior to scanning; we don&#39;t
</span><span class="c1"></span>            <span class="c1">// want to automatically grant runtime permissions for new system apps
</span><span class="c1"></span>            <span class="c1">// 在扫描之前保存预先存在的系统包的名称; 我们不希望自动为新系统应用授予运行时权限
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">mPromoteSystemApps</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">PackageSetting</span><span class="o">&gt;</span> <span class="n">pkgSettingIter</span> <span class="o">=</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">mPackages</span><span class="o">.</span><span class="na">values</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">pkgSettingIter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">PackageSetting</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">pkgSettingIter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">isSystemApp</span><span class="o">(</span><span class="n">ps</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">mExistingSystemPackages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ps</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">// 获取缓存目录，如果是升级的话则删除缓存目录并重新生成缓存
</span><span class="c1"></span>            <span class="n">mCacheDir</span> <span class="o">=</span> <span class="n">preparePackageParserCache</span><span class="o">(</span><span class="n">mIsUpgrade</span><span class="o">);</span>

            <span class="c1">// Set flag to monitor and not change apk file paths when
</span><span class="c1"></span>            <span class="c1">// scanning install directories.
</span><span class="c1"></span>            <span class="c1">// 扫描安装包的默认参数
</span><span class="c1"></span>            <span class="kt">int</span> <span class="n">scanFlags</span> <span class="o">=</span> <span class="n">SCAN_BOOTING</span> <span class="o">|</span> <span class="n">SCAN_INITIAL</span><span class="o">;</span>
            <span class="c1">// 第一次或  ota 升级后开机
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">mIsUpgrade</span> <span class="o">||</span> <span class="n">mFirstBoot</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">scanFlags</span> <span class="o">=</span> <span class="n">scanFlags</span> <span class="o">|</span> <span class="n">SCAN_FIRST_BOOT_OR_UPGRADE</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// 从指定目录扫描安装包，不同点目录扫描参数不一样 &lt;3.&gt;
</span><span class="c1"></span>            <span class="c1">// /system/priv-app,/system/app,/system/frameworks,/vender,/odm 等目录
</span><span class="c1"></span>            <span class="c1">// Collect vendor/product overlay packages. (Do this before scanning any apps.)
</span><span class="c1"></span>            <span class="c1">// For security and version matching reason, only consider
</span><span class="c1"></span>            <span class="c1">// overlay packages if they reside in the right directory.
</span><span class="c1"></span>            <span class="n">scanDirTracedLI</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">VENDOR_OVERLAY_DIR</span><span class="o">),</span>
                            <span class="n">mDefParseFlags</span>
                            <span class="o">|</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">PARSE_IS_SYSTEM_DIR</span><span class="o">,</span>
                            <span class="n">scanFlags</span>
                            <span class="o">|</span> <span class="n">SCAN_AS_SYSTEM</span>
                            <span class="o">|</span> <span class="n">SCAN_AS_VENDOR</span><span class="o">,</span>
                            <span class="n">0</span><span class="o">);</span>

            <span class="c1">// ......
</span><span class="c1"></span>
            <span class="c1">// Collect ordinary product packages.
</span><span class="c1"></span>            <span class="n">File</span> <span class="n">productAppDir</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">Environment</span><span class="o">.</span><span class="na">getProductDirectory</span><span class="o">(),</span> <span class="s">&#34;app&#34;</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">productAppDir</span> <span class="o">=</span> <span class="n">productAppDir</span><span class="o">.</span><span class="na">getCanonicalFile</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// failed to look up canonical path, continue with original one
</span><span class="c1"></span>            <span class="o">}</span>
            <span class="n">scanDirTracedLI</span><span class="o">(</span><span class="n">productAppDir</span><span class="o">,</span>
                            <span class="n">mDefParseFlags</span>
                            <span class="o">|</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">PARSE_IS_SYSTEM_DIR</span><span class="o">,</span>
                            <span class="n">scanFlags</span>
                            <span class="o">|</span> <span class="n">SCAN_AS_SYSTEM</span>
                            <span class="o">|</span> <span class="n">SCAN_AS_PRODUCT</span><span class="o">,</span>
                            <span class="n">0</span><span class="o">);</span>
            <span class="c1">// 处理不存在的系统安装包
</span><span class="c1"></span>            <span class="c1">// Prune any system packages that no longer exist.
</span><span class="c1"></span>            <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">possiblyDeletedUpdatedSystemApps</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
            <span class="c1">// 子包必须替换为  data 分区上的完整包或被禁用
</span><span class="c1"></span>            <span class="c1">// Stub packages must either be replaced with full versions in the /data
</span><span class="c1"></span>            <span class="c1">// partition or be disabled.
</span><span class="c1"></span>            <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">stubSystemApps</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">mOnlyCore</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// do this first before mucking with mPackages for the &#34;expecting better&#34; case
</span><span class="c1"></span>                <span class="kd">final</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span><span class="o">&gt;</span> <span class="n">pkgIterator</span> <span class="o">=</span> <span class="n">mPackages</span><span class="o">.</span><span class="na">values</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">pkgIterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                    <span class="kd">final</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="n">pkg</span> <span class="o">=</span> <span class="n">pkgIterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">isStub</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">stubSystemApps</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>

                <span class="kd">final</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">PackageSetting</span><span class="o">&gt;</span> <span class="n">psit</span> <span class="o">=</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">mPackages</span><span class="o">.</span><span class="na">values</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">psit</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">PackageSetting</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">psit</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>

                    <span class="cm">/*
</span><span class="cm">                     * If this is not a system app, it can&#39;t be a
</span><span class="cm">                     * disable system app.
</span><span class="cm">                     */</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">ps</span><span class="o">.</span><span class="na">pkgFlags</span> <span class="o">&amp;</span> <span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">FLAG_SYSTEM</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span>

                    <span class="cm">/*
</span><span class="cm">                     * If the package is scanned, it&#39;s not erased.
</span><span class="cm">                     */</span>
                    <span class="kd">final</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="n">scannedPkg</span> <span class="o">=</span> <span class="n">mPackages</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ps</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">scannedPkg</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="cm">/*
</span><span class="cm">                         * If the system app is both scanned and in the
</span><span class="cm">                         * disabled packages list, then it must have been
</span><span class="cm">                         * added via OTA. Remove it from the currently
</span><span class="cm">                         * scanned package so the previously user-installed
</span><span class="cm">                         * application can be scanned.
</span><span class="cm">                         */</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">mSettings</span><span class="o">.</span><span class="na">isDisabledSystemPackageLPr</span><span class="o">(</span><span class="n">ps</span><span class="o">.</span><span class="na">name</span><span class="o">))</span> <span class="o">{</span>
                            <span class="n">logCriticalInfo</span><span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">WARN</span><span class="o">,</span>
                                            <span class="s">&#34;Expecting better updated system app for &#34;</span> <span class="o">+</span> <span class="n">ps</span><span class="o">.</span><span class="na">name</span>
                                            <span class="o">+</span> <span class="s">&#34;; removing system app.  Last known&#34;</span>
                                            <span class="o">+</span> <span class="s">&#34; codePath=&#34;</span> <span class="o">+</span> <span class="n">ps</span><span class="o">.</span><span class="na">codePathString</span>
                                            <span class="o">+</span> <span class="s">&#34;, versionCode=&#34;</span> <span class="o">+</span> <span class="n">ps</span><span class="o">.</span><span class="na">versionCode</span>
                                            <span class="o">+</span> <span class="s">&#34;; scanned versionCode=&#34;</span> <span class="o">+</span> <span class="n">scannedPkg</span><span class="o">.</span><span class="na">getLongVersionCode</span><span class="o">());</span>
                            <span class="n">removePackageLI</span><span class="o">(</span><span class="n">scannedPkg</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
                            <span class="n">mExpectingBetter</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ps</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">ps</span><span class="o">.</span><span class="na">codePath</span><span class="o">);</span>
                        <span class="o">}</span>

                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span>

                    <span class="k">if</span> <span class="o">(!</span><span class="n">mSettings</span><span class="o">.</span><span class="na">isDisabledSystemPackageLPr</span><span class="o">(</span><span class="n">ps</span><span class="o">.</span><span class="na">name</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">psit</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
                        <span class="n">logCriticalInfo</span><span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">WARN</span><span class="o">,</span> <span class="s">&#34;System package &#34;</span> <span class="o">+</span> <span class="n">ps</span><span class="o">.</span><span class="na">name</span>
                                        <span class="o">+</span> <span class="s">&#34; no longer exists; it&#39;s data will be wiped&#34;</span><span class="o">);</span>
                        <span class="c1">// Actual deletion of code and data will be handled by later
</span><span class="c1"></span>                        <span class="c1">// reconciliation step
</span><span class="c1"></span>                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="c1">// we still have a disabled system package, but, it still might have
</span><span class="c1"></span>                        <span class="c1">// been removed. check the code path still exists and check there&#39;s
</span><span class="c1"></span>                        <span class="c1">// still a package. the latter can happen if an OTA keeps the same
</span><span class="c1"></span>                        <span class="c1">// code path, but, changes the package name.
</span><span class="c1"></span>                        <span class="kd">final</span> <span class="n">PackageSetting</span> <span class="n">disabledPs</span> <span class="o">=</span>
                            <span class="n">mSettings</span><span class="o">.</span><span class="na">getDisabledSystemPkgLPr</span><span class="o">(</span><span class="n">ps</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">disabledPs</span><span class="o">.</span><span class="na">codePath</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">disabledPs</span><span class="o">.</span><span class="na">codePath</span><span class="o">.</span><span class="na">exists</span><span class="o">()</span>
                            <span class="o">||</span> <span class="n">disabledPs</span><span class="o">.</span><span class="na">pkg</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">possiblyDeletedUpdatedSystemApps</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ps</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="c1">//delete tmp files
</span><span class="c1"></span>            <span class="n">deleteTempPackageFiles</span><span class="o">();</span>

            <span class="kd">final</span> <span class="kt">int</span> <span class="n">cachedSystemApps</span> <span class="o">=</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">sCachedPackageReadCount</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>

            <span class="c1">// Remove any shared userIDs that have no associated packages
</span><span class="c1"></span>            <span class="c1">// 删除没有关联包的任何共享用户标识
</span><span class="c1"></span>            <span class="n">mSettings</span><span class="o">.</span><span class="na">pruneSharedUsersLPw</span><span class="o">();</span>
            <span class="kd">final</span> <span class="kt">long</span> <span class="n">systemScanTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">;</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">systemPackagesCount</span> <span class="o">=</span> <span class="n">mPackages</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
            <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Finished scanning system apps. Time: &#34;</span> <span class="o">+</span> <span class="n">systemScanTime</span>
                   <span class="o">+</span> <span class="s">&#34; ms, packageCount: &#34;</span> <span class="o">+</span> <span class="n">systemPackagesCount</span>
                   <span class="o">+</span> <span class="s">&#34; , timePerPackage: &#34;</span>
                   <span class="o">+</span> <span class="o">(</span><span class="n">systemPackagesCount</span> <span class="o">==</span> <span class="n">0</span> <span class="o">?</span> <span class="n">0</span> <span class="o">:</span> <span class="n">systemScanTime</span> <span class="o">/</span> <span class="n">systemPackagesCount</span><span class="o">)</span>
                   <span class="o">+</span> <span class="s">&#34; , cached: &#34;</span> <span class="o">+</span> <span class="n">cachedSystemApps</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mIsUpgrade</span> <span class="o">&amp;&amp;</span> <span class="n">systemPackagesCount</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">MetricsLogger</span><span class="o">.</span><span class="na">histogram</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="s">&#34;ota_package_manager_system_app_avg_scan_time&#34;</span><span class="o">,</span>
                                        <span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">systemScanTime</span><span class="o">)</span> <span class="o">/</span> <span class="n">systemPackagesCount</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">mOnlyCore</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 处理第三方安装包
</span><span class="c1"></span>                <span class="n">EventLog</span><span class="o">.</span><span class="na">writeEvent</span><span class="o">(</span><span class="n">EventLogTags</span><span class="o">.</span><span class="na">BOOT_PROGRESS_PMS_DATA_SCAN_START</span><span class="o">,</span>
                                    <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">());</span>
                <span class="n">scanDirTracedLI</span><span class="o">(</span><span class="n">sAppInstallDir</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">scanFlags</span> <span class="o">|</span> <span class="n">SCAN_REQUIRE_KNOWN</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>

                <span class="n">scanDirTracedLI</span><span class="o">(</span><span class="n">sDrmAppPrivateInstallDir</span><span class="o">,</span> <span class="n">mDefParseFlags</span>
                                <span class="o">|</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">PARSE_FORWARD_LOCK</span><span class="o">,</span>
                                <span class="n">scanFlags</span> <span class="o">|</span> <span class="n">SCAN_REQUIRE_KNOWN</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>

                <span class="c1">// Remove disable package settings for updated system apps that were
</span><span class="c1"></span>                <span class="c1">// removed via an OTA. If the update is no longer present, remove the
</span><span class="c1"></span>                <span class="c1">// app completely. Otherwise, revoke their system privileges.
</span><span class="c1"></span>                <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">deletedAppName</span> <span class="o">:</span> <span class="n">possiblyDeletedUpdatedSystemApps</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="n">deletedPkg</span> <span class="o">=</span> <span class="n">mPackages</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">deletedAppName</span><span class="o">);</span>
                    <span class="n">mSettings</span><span class="o">.</span><span class="na">removeDisabledSystemPackageLPw</span><span class="o">(</span><span class="n">deletedAppName</span><span class="o">);</span>
                    <span class="kd">final</span> <span class="n">String</span> <span class="n">msg</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">deletedPkg</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// should have found an update, but, we didn&#39;t; remove everything
</span><span class="c1"></span>                        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#34;Updated system package &#34;</span> <span class="o">+</span> <span class="n">deletedAppName</span>
                            <span class="o">+</span> <span class="s">&#34; no longer exists; removing its data&#34;</span><span class="o">;</span>
                        <span class="c1">// Actual deletion of code and data will be handled by later
</span><span class="c1"></span>                        <span class="c1">// reconciliation step
</span><span class="c1"></span>                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="c1">// found an update; revoke system privileges
</span><span class="c1"></span>                        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#34;Updated system package + &#34;</span> <span class="o">+</span> <span class="n">deletedAppName</span>
                            <span class="o">+</span> <span class="s">&#34; no longer exists; revoking system privileges&#34;</span><span class="o">;</span>

                        <span class="c1">// Don&#39;t do anything if a stub is removed from the system image. If
</span><span class="c1"></span>                        <span class="c1">// we were to remove the uncompressed version from the /data partition,
</span><span class="c1"></span>                        <span class="c1">// this is where it&#39;d be done.
</span><span class="c1"></span>
                        <span class="kd">final</span> <span class="n">PackageSetting</span> <span class="n">deletedPs</span> <span class="o">=</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">mPackages</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">deletedAppName</span><span class="o">);</span>
                        <span class="n">deletedPkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">FLAG_SYSTEM</span><span class="o">;</span>
                        <span class="n">deletedPs</span><span class="o">.</span><span class="na">pkgFlags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">FLAG_SYSTEM</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">logCriticalInfo</span><span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">WARN</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="cm">/*
</span><span class="cm">                 * Make sure all system apps that we expected to appear on
</span><span class="cm">                 * the userdata partition actually showed up. If they never
</span><span class="cm">                 * appeared, crawl back and revive the system version.
</span><span class="cm">                 */</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mExpectingBetter</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="kd">final</span> <span class="n">String</span> <span class="n">packageName</span> <span class="o">=</span> <span class="n">mExpectingBetter</span><span class="o">.</span><span class="na">keyAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">mPackages</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">packageName</span><span class="o">))</span> <span class="o">{</span>
                        <span class="kd">final</span> <span class="n">File</span> <span class="n">scanFile</span> <span class="o">=</span> <span class="n">mExpectingBetter</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>

                        <span class="n">logCriticalInfo</span><span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">WARN</span><span class="o">,</span> <span class="s">&#34;Expected better &#34;</span> <span class="o">+</span> <span class="n">packageName</span>
                                        <span class="o">+</span> <span class="s">&#34; but never showed up; reverting to system&#34;</span><span class="o">);</span>

                        <span class="kd">final</span> <span class="nd">@ParseFlags</span> <span class="kt">int</span> <span class="n">reparseFlags</span><span class="o">;</span>
                        <span class="kd">final</span> <span class="nd">@ScanFlags</span> <span class="kt">int</span> <span class="n">rescanFlags</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">FileUtils</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">privilegedAppDir</span><span class="o">,</span> <span class="n">scanFile</span><span class="o">))</span> <span class="o">{</span>
                            <span class="n">reparseFlags</span> <span class="o">=</span>
                                <span class="n">mDefParseFlags</span> <span class="o">|</span>
                                <span class="n">PackageParser</span><span class="o">.</span><span class="na">PARSE_IS_SYSTEM_DIR</span><span class="o">;</span>
                            <span class="n">rescanFlags</span> <span class="o">=</span>
                                <span class="n">scanFlags</span>
                                <span class="o">|</span> <span class="n">SCAN_AS_SYSTEM</span>
                                <span class="o">|</span> <span class="n">SCAN_AS_PRIVILEGED</span><span class="o">;</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">FileUtils</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">systemAppDir</span><span class="o">,</span> <span class="n">scanFile</span><span class="o">))</span> <span class="o">{</span>

                            <span class="c1">// ......
</span><span class="c1"></span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Ignoring unexpected fallback path &#34;</span> <span class="o">+</span> <span class="n">scanFile</span><span class="o">);</span>
                            <span class="k">continue</span><span class="o">;</span>
                        <span class="o">}</span>

                        <span class="n">mSettings</span><span class="o">.</span><span class="na">enableSystemPackageLPw</span><span class="o">(</span><span class="n">packageName</span><span class="o">);</span>

                        <span class="k">try</span> <span class="o">{</span>
                            <span class="n">scanPackageTracedLI</span><span class="o">(</span><span class="n">scanFile</span><span class="o">,</span> <span class="n">reparseFlags</span><span class="o">,</span> <span class="n">rescanFlags</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PackageManagerException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Failed to parse original system package: &#34;</span>
                                   <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>

                <span class="c1">// Uncompress and install any stubbed system applications.
</span><span class="c1"></span>                <span class="c1">// This must be done last to ensure all stubs are replaced or disabled.
</span><span class="c1"></span>                <span class="c1">// 最后处理子安装包，确保子安装包被整包替换或被禁用
</span><span class="c1"></span>                <span class="n">decompressSystemApplications</span><span class="o">(</span><span class="n">stubSystemApps</span><span class="o">,</span> <span class="n">scanFlags</span><span class="o">);</span>

                <span class="kd">final</span> <span class="kt">int</span> <span class="n">cachedNonSystemApps</span> <span class="o">=</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">sCachedPackageReadCount</span><span class="o">.</span><span class="na">get</span><span class="o">()</span>
                    <span class="o">-</span> <span class="n">cachedSystemApps</span><span class="o">;</span>

                <span class="kd">final</span> <span class="kt">long</span> <span class="n">dataScanTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">systemScanTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">;</span>
                <span class="kd">final</span> <span class="kt">int</span> <span class="n">dataPackagesCount</span> <span class="o">=</span> <span class="n">mPackages</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="n">systemPackagesCount</span><span class="o">;</span>
                <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Finished scanning non-system apps. Time: &#34;</span> <span class="o">+</span> <span class="n">dataScanTime</span>
                       <span class="o">+</span> <span class="s">&#34; ms, packageCount: &#34;</span> <span class="o">+</span> <span class="n">dataPackagesCount</span>
                       <span class="o">+</span> <span class="s">&#34; , timePerPackage: &#34;</span>
                       <span class="o">+</span> <span class="o">(</span><span class="n">dataPackagesCount</span> <span class="o">==</span> <span class="n">0</span> <span class="o">?</span> <span class="n">0</span> <span class="o">:</span> <span class="n">dataScanTime</span> <span class="o">/</span> <span class="n">dataPackagesCount</span><span class="o">)</span>
                       <span class="o">+</span> <span class="s">&#34; , cached: &#34;</span> <span class="o">+</span> <span class="n">cachedNonSystemApps</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mIsUpgrade</span> <span class="o">&amp;&amp;</span> <span class="n">dataPackagesCount</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">MetricsLogger</span><span class="o">.</span><span class="na">histogram</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="s">&#34;ota_package_manager_data_app_avg_scan_time&#34;</span><span class="o">,</span>
                                            <span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">dataScanTime</span><span class="o">)</span> <span class="o">/</span> <span class="n">dataPackagesCount</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">mExpectingBetter</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>

            <span class="c1">// Resolve the storage manager.
</span><span class="c1"></span>            <span class="c1">// 获取存储管理器
</span><span class="c1"></span>            <span class="n">mStorageManagerPackage</span> <span class="o">=</span> <span class="n">getStorageManagerPackageName</span><span class="o">();</span>

            <span class="c1">// Resolve protected action filters. Only the setup wizard is allowed to
</span><span class="c1"></span>            <span class="c1">// have a high priority filter for these actions.
</span><span class="c1"></span>            <span class="c1">// 只允许开机向导设为高优先级
</span><span class="c1"></span>            <span class="n">mSetupWizardPackage</span> <span class="o">=</span> <span class="n">getSetupWizardPackageName</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mProtectedFilters</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_FILTERS</span> <span class="o">&amp;&amp;</span> <span class="n">mSetupWizardPackage</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;No setup wizard;&#34;</span>
                           <span class="o">+</span> <span class="s">&#34; All protected intents capped to priority 0&#34;</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">ActivityIntentInfo</span> <span class="n">filter</span> <span class="o">:</span> <span class="n">mProtectedFilters</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">filter</span><span class="o">.</span><span class="na">activity</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">packageName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">mSetupWizardPackage</span><span class="o">))</span> <span class="o">{</span>
                        <span class="c1">// skip setup wizard; allow it to keep the high priority filter
</span><span class="c1"></span>                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">filter</span><span class="o">.</span><span class="na">setPriority</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="n">mSystemTextClassifierPackage</span> <span class="o">=</span> <span class="n">getSystemTextClassifierPackageName</span><span class="o">();</span>

            <span class="n">mDeferProtectedFilters</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">mProtectedFilters</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>

            <span class="c1">// Now that we know all of the shared libraries, update all clients to have
</span><span class="c1"></span>            <span class="c1">// the correct library paths.
</span><span class="c1"></span>            <span class="c1">// 现在我们知道所有共享库，更新所有客户端以获得正确的库路径。
</span><span class="c1"></span>            <span class="n">updateAllSharedLibrariesLPw</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

            <span class="k">for</span> <span class="o">(</span><span class="n">SharedUserSetting</span> <span class="n">setting</span> <span class="o">:</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">getAllSharedUsersLPw</span><span class="o">())</span> <span class="o">{</span>
                <span class="c1">// NOTE: We ignore potential failures here during a system scan (like
</span><span class="c1"></span>                <span class="c1">// the rest of the commands above) because there&#39;s precious little we
</span><span class="c1"></span>                <span class="c1">// can do about it. A settings error is reported, though.
</span><span class="c1"></span>                <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">changedAbiCodePath</span> <span class="o">=</span>
                    <span class="n">adjustCpuAbisForSharedUserLPw</span><span class="o">(</span><span class="n">setting</span><span class="o">.</span><span class="na">packages</span><span class="o">,</span> <span class="kc">null</span> <span class="cm">/*scannedPackage*/</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">changedAbiCodePath</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">changedAbiCodePath</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">changedAbiCodePath</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">;</span> <span class="o">--</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
                        <span class="kd">final</span> <span class="n">String</span> <span class="n">codePathString</span> <span class="o">=</span> <span class="n">changedAbiCodePath</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="n">mInstaller</span><span class="o">.</span><span class="na">rmdex</span><span class="o">(</span><span class="n">codePathString</span><span class="o">,</span>
                                             <span class="n">getDexCodeInstructionSet</span><span class="o">(</span><span class="n">getPreferredInstructionSet</span><span class="o">()));</span>
                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InstallerException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="c1">// Adjust seInfo to ensure apps which share a sharedUserId are placed in the same
</span><span class="c1"></span>                <span class="c1">// SELinux domain.
</span><span class="c1"></span>                <span class="n">setting</span><span class="o">.</span><span class="na">fixSeInfoLocked</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="c1">// Now that we know all the packages we are keeping,
</span><span class="c1"></span>            <span class="c1">// read and update their last usage times.
</span><span class="c1"></span>            <span class="n">mPackageUsage</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">mPackages</span><span class="o">);</span>
            <span class="n">mCompilerStats</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>

            <span class="n">EventLog</span><span class="o">.</span><span class="na">writeEvent</span><span class="o">(</span><span class="n">EventLogTags</span><span class="o">.</span><span class="na">BOOT_PROGRESS_PMS_SCAN_END</span><span class="o">,</span>
                                <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">());</span>
            <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Time to scan packages: &#34;</span>
                   <span class="o">+</span> <span class="o">((</span><span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">()-</span><span class="n">startTime</span><span class="o">)/</span><span class="n">1000f</span><span class="o">)</span>
                   <span class="o">+</span> <span class="s">&#34; seconds&#34;</span><span class="o">);</span>

            <span class="c1">// If the platform SDK has changed since the last time we booted,
</span><span class="c1"></span>            <span class="c1">// we need to re-grant app permission to catch any new ones that
</span><span class="c1"></span>            <span class="c1">// appear.  This is really a hack, and means that apps can in some
</span><span class="c1"></span>            <span class="c1">// cases get permissions that the user didn&#39;t initially explicitly
</span><span class="c1"></span>            <span class="c1">// allow...  it would be nice to have some better way to handle
</span><span class="c1"></span>            <span class="c1">// this situation.
</span><span class="c1"></span>            <span class="c1">// SDK 有改变时，需处理新出现的权限
</span><span class="c1"></span>            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">sdkUpdated</span> <span class="o">=</span> <span class="o">(</span><span class="n">ver</span><span class="o">.</span><span class="na">sdkVersion</span> <span class="o">!=</span> <span class="n">mSdkVersion</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">sdkUpdated</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Platform changed from &#34;</span> <span class="o">+</span> <span class="n">ver</span><span class="o">.</span><span class="na">sdkVersion</span> <span class="o">+</span> <span class="s">&#34; to &#34;</span>
                       <span class="o">+</span> <span class="n">mSdkVersion</span> <span class="o">+</span> <span class="s">&#34;; regranting permissions for internal storage&#34;</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">mPermissionManager</span><span class="o">.</span><span class="na">updateAllPermissions</span><span class="o">(</span>
                                                    <span class="n">StorageManager</span><span class="o">.</span><span class="na">UUID_PRIVATE_INTERNAL</span><span class="o">,</span> <span class="n">sdkUpdated</span><span class="o">,</span> <span class="n">mPackages</span><span class="o">.</span><span class="na">values</span><span class="o">(),</span>
                                                    <span class="n">mPermissionCallback</span><span class="o">);</span>
            <span class="n">ver</span><span class="o">.</span><span class="na">sdkVersion</span> <span class="o">=</span> <span class="n">mSdkVersion</span><span class="o">;</span>

            <span class="c1">// If this is the first boot or an update from pre-M, and it is a normal
</span><span class="c1"></span>            <span class="c1">// boot, then we need to initialize the default preferred apps across
</span><span class="c1"></span>            <span class="c1">// all defined users.
</span><span class="c1"></span>            <span class="c1">// 如果这是第一次启动或来自  pre-M 的更新，并且它是正常启动，
</span><span class="c1"></span>            <span class="c1">//那么我们需要在所有已定义的用户中初始化默认的首选应用程序。
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(!</span><span class="n">onlyCore</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">mPromoteSystemApps</span> <span class="o">||</span> <span class="n">mFirstBoot</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">UserInfo</span> <span class="n">user</span> <span class="o">:</span> <span class="n">sUserManager</span><span class="o">.</span><span class="na">getUsers</span><span class="o">(</span><span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">mSettings</span><span class="o">.</span><span class="na">applyDefaultPreferredAppsLPw</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">id</span><span class="o">);</span>
                    <span class="n">applyFactoryDefaultBrowserLPw</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">id</span><span class="o">);</span>
                    <span class="n">primeDomainVerificationsLPw</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">id</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="c1">// Prepare storage for system user really early during boot,
</span><span class="c1"></span>            <span class="c1">// since core system apps like SettingsProvider and SystemUI
</span><span class="c1"></span>            <span class="c1">// can&#39;t wait for user to start
</span><span class="c1"></span>            <span class="c1">// 为先于用户启动的系统应用准备存储
</span><span class="c1"></span>            <span class="kd">final</span> <span class="kt">int</span> <span class="n">storageFlags</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">StorageManager</span><span class="o">.</span><span class="na">isFileEncryptedNativeOrEmulated</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">storageFlags</span> <span class="o">=</span> <span class="n">StorageManager</span><span class="o">.</span><span class="na">FLAG_STORAGE_DE</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">storageFlags</span> <span class="o">=</span> <span class="n">StorageManager</span><span class="o">.</span><span class="na">FLAG_STORAGE_DE</span> <span class="o">|</span> <span class="n">StorageManager</span><span class="o">.</span><span class="na">FLAG_STORAGE_CE</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">deferPackages</span> <span class="o">=</span> <span class="n">reconcileAppsDataLI</span><span class="o">(</span><span class="n">StorageManager</span><span class="o">.</span><span class="na">UUID_PRIVATE_INTERNAL</span><span class="o">,</span>
                                                             <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_SYSTEM</span><span class="o">,</span> <span class="n">storageFlags</span><span class="o">,</span> <span class="kc">true</span> <span class="cm">/* migrateAppData */</span><span class="o">,</span>
                                                             <span class="kc">true</span> <span class="cm">/* onlyCoreApps */</span><span class="o">);</span>
            <span class="n">mPrepareAppDataFuture</span> <span class="o">=</span> <span class="n">SystemServerInitThreadPool</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="n">TimingsTraceLog</span> <span class="n">traceLog</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TimingsTraceLog</span><span class="o">(</span><span class="s">&#34;SystemServerTimingAsync&#34;</span><span class="o">,</span>
                                                                   <span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_PACKAGE_MANAGER</span><span class="o">);</span>
                    <span class="n">traceLog</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="s">&#34;AppDataFixup&#34;</span><span class="o">);</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">mInstaller</span><span class="o">.</span><span class="na">fixupAppData</span><span class="o">(</span><span class="n">StorageManager</span><span class="o">.</span><span class="na">UUID_PRIVATE_INTERNAL</span><span class="o">,</span>
                                                <span class="n">StorageManager</span><span class="o">.</span><span class="na">FLAG_STORAGE_DE</span> <span class="o">|</span> <span class="n">StorageManager</span><span class="o">.</span><span class="na">FLAG_STORAGE_CE</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InstallerException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Trouble fixing GIDs&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">traceLog</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">();</span>

                    <span class="n">traceLog</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="s">&#34;AppDataPrepare&#34;</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">deferPackages</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">deferPackages</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                        <span class="k">return</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">pkgName</span> <span class="o">:</span> <span class="n">deferPackages</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="n">pkg</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mPackages</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">PackageSetting</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">getPackageLPr</span><span class="o">(</span><span class="n">pkgName</span><span class="o">);</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">ps</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">ps</span><span class="o">.</span><span class="na">getInstalled</span><span class="o">(</span><span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_SYSTEM</span><span class="o">))</span> <span class="o">{</span>
                                <span class="n">pkg</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="na">pkg</span><span class="o">;</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">pkg</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mInstallLock</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">prepareAppDataAndMigrateLIF</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_SYSTEM</span><span class="o">,</span> <span class="n">storageFlags</span><span class="o">,</span>
                                                            <span class="kc">true</span> <span class="cm">/* maybeMigrateAppData */</span><span class="o">);</span>
                            <span class="o">}</span>
                            <span class="n">count</span><span class="o">++;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="n">traceLog</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">();</span>
                    <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Deferred reconcileAppsData finished &#34;</span> <span class="o">+</span> <span class="n">count</span> <span class="o">+</span> <span class="s">&#34; packages&#34;</span><span class="o">);</span>
                <span class="o">},</span> <span class="s">&#34;prepareAppData&#34;</span><span class="o">);</span>

            <span class="c1">// If this is first boot after an OTA, and a normal boot, then
</span><span class="c1"></span>            <span class="c1">// we need to clear code cache directories.
</span><span class="c1"></span>            <span class="c1">// Note that we do *not* clear the application profiles. These remain valid
</span><span class="c1"></span>            <span class="c1">// across OTAs and are used to drive profile verification (post OTA) and
</span><span class="c1"></span>            <span class="c1">// profile compilation (without waiting to collect a fresh set of profiles).
</span><span class="c1"></span>            <span class="c1">// OTA 清除缓存不是应用数据，所以  OTA 后开机会很慢，因为要重新生成缓存
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">mIsUpgrade</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">onlyCore</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Build fingerprint changed; clearing code caches&#34;</span><span class="o">);</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">mPackages</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="kd">final</span> <span class="n">PackageSetting</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">mPackages</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">StorageManager</span><span class="o">.</span><span class="na">UUID_PRIVATE_INTERNAL</span><span class="o">,</span> <span class="n">ps</span><span class="o">.</span><span class="na">volumeUuid</span><span class="o">))</span> <span class="o">{</span>
                        <span class="c1">// No apps are running this early, so no need to freeze
</span><span class="c1"></span>                        <span class="n">clearAppDataLIF</span><span class="o">(</span><span class="n">ps</span><span class="o">.</span><span class="na">pkg</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_ALL</span><span class="o">,</span>
                                        <span class="n">StorageManager</span><span class="o">.</span><span class="na">FLAG_STORAGE_DE</span> <span class="o">|</span> <span class="n">StorageManager</span><span class="o">.</span><span class="na">FLAG_STORAGE_CE</span>
                                        <span class="o">|</span> <span class="n">Installer</span><span class="o">.</span><span class="na">FLAG_CLEAR_CODE_CACHE_ONLY</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">ver</span><span class="o">.</span><span class="na">fingerprint</span> <span class="o">=</span> <span class="n">Build</span><span class="o">.</span><span class="na">FINGERPRINT</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// 检查默认浏览器，没有则设置
</span><span class="c1"></span>            <span class="n">checkDefaultBrowser</span><span class="o">();</span>

            <span class="c1">// clear only after permissions and other defaults have been updated
</span><span class="c1"></span>            <span class="n">mExistingSystemPackages</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="n">mPromoteSystemApps</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

            <span class="c1">// All the changes are done during package scanning.
</span><span class="c1"></span>            <span class="n">ver</span><span class="o">.</span><span class="na">databaseVersion</span> <span class="o">=</span> <span class="n">Settings</span><span class="o">.</span><span class="na">CURRENT_DATABASE_VERSION</span><span class="o">;</span>

            <span class="c1">// can downgrade to reader
</span><span class="c1"></span>            <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="o">,</span> <span class="s">&#34;write settings&#34;</span><span class="o">);</span>
            <span class="c1">// 保存配置，将信息写到  package.xml、package.lsit 及  pacakge-stopped.xml 文件中
</span><span class="c1"></span>            <span class="n">mSettings</span><span class="o">.</span><span class="na">writeLPr</span><span class="o">();</span>
            <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="o">);</span>
            <span class="n">EventLog</span><span class="o">.</span><span class="na">writeEvent</span><span class="o">(</span><span class="n">EventLogTags</span><span class="o">.</span><span class="na">BOOT_PROGRESS_PMS_READY</span><span class="o">,</span>
                                <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">());</span>
            <span class="c1">// 获取一下变量
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(!</span><span class="n">mOnlyCore</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mRequiredVerifierPackage</span> <span class="o">=</span> <span class="n">getRequiredButNotReallyRequiredVerifierLPr</span><span class="o">();</span>
                <span class="n">mRequiredInstallerPackage</span> <span class="o">=</span> <span class="n">getRequiredInstallerLPr</span><span class="o">();</span>
                <span class="n">mRequiredUninstallerPackage</span> <span class="o">=</span> <span class="n">getRequiredUninstallerLPr</span><span class="o">();</span>
                <span class="n">mIntentFilterVerifierComponent</span> <span class="o">=</span> <span class="n">getIntentFilterVerifierComponentNameLPr</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mIntentFilterVerifierComponent</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">mIntentFilterVerifier</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IntentVerifierProxy</span><span class="o">(</span><span class="n">mContext</span><span class="o">,</span>
                                                                    <span class="n">mIntentFilterVerifierComponent</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">mIntentFilterVerifier</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">mServicesSystemSharedLibraryPackageName</span> <span class="o">=</span> <span class="n">getRequiredSharedLibraryLPr</span><span class="o">(</span>
                                                                                      <span class="n">PackageManager</span><span class="o">.</span><span class="na">SYSTEM_SHARED_LIBRARY_SERVICES</span><span class="o">,</span>
                                                                                      <span class="n">SharedLibraryInfo</span><span class="o">.</span><span class="na">VERSION_UNDEFINED</span><span class="o">);</span>
                <span class="n">mSharedSystemSharedLibraryPackageName</span> <span class="o">=</span> <span class="n">getRequiredSharedLibraryLPr</span><span class="o">(</span>
                                                                                    <span class="n">PackageManager</span><span class="o">.</span><span class="na">SYSTEM_SHARED_LIBRARY_SHARED</span><span class="o">,</span>
                                                                                    <span class="n">SharedLibraryInfo</span><span class="o">.</span><span class="na">VERSION_UNDEFINED</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">mRequiredVerifierPackage</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">mRequiredInstallerPackage</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">mRequiredUninstallerPackage</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">mIntentFilterVerifierComponent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">mIntentFilterVerifier</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">mServicesSystemSharedLibraryPackageName</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">mSharedSystemSharedLibraryPackageName</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="n">mInstallerService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PackageInstallerService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
            <span class="kd">final</span> <span class="n">Pair</span><span class="o">&lt;</span><span class="n">ComponentName</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">instantAppResolverComponent</span> <span class="o">=</span>
                <span class="n">getInstantAppResolverLPr</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">instantAppResolverComponent</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_INSTANT</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Set ephemeral resolver: &#34;</span> <span class="o">+</span> <span class="n">instantAppResolverComponent</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">mInstantAppResolverConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InstantAppResolverConnection</span><span class="o">(</span>
                                                                                 <span class="n">mContext</span><span class="o">,</span> <span class="n">instantAppResolverComponent</span><span class="o">.</span><span class="na">first</span><span class="o">,</span>
                                                                                 <span class="n">instantAppResolverComponent</span><span class="o">.</span><span class="na">second</span><span class="o">);</span>
                <span class="n">mInstantAppResolverSettingsComponent</span> <span class="o">=</span>
                    <span class="n">getInstantAppResolverSettingsLPr</span><span class="o">(</span><span class="n">instantAppResolverComponent</span><span class="o">.</span><span class="na">first</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">mInstantAppResolverConnection</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">mInstantAppResolverSettingsComponent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">updateInstantAppInstallerLocked</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

            <span class="c1">// Read and update the usage of dex files.
</span><span class="c1"></span>            <span class="c1">// Do this at the end of PM init so that all the packages have their
</span><span class="c1"></span>            <span class="c1">// data directory reconciled.
</span><span class="c1"></span>            <span class="c1">// At this point we know the code paths of the packages, so we can validate
</span><span class="c1"></span>            <span class="c1">// the disk file and build the internal cache.
</span><span class="c1"></span>            <span class="c1">// The usage file is expected to be small so loading and verifying it
</span><span class="c1"></span>            <span class="c1">// should take a fairly small time compare to the other activities (e.g. package
</span><span class="c1"></span>            <span class="c1">// scanning).
</span><span class="c1"></span>            <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">PackageInfo</span><span class="o">&gt;&gt;</span> <span class="n">userPackages</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
            <span class="kd">final</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">currentUserIds</span> <span class="o">=</span> <span class="n">UserManagerService</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getUserIds</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">userId</span> <span class="o">:</span> <span class="n">currentUserIds</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">userPackages</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">getInstalledPackages</span><span class="o">(</span><span class="cm">/*flags*/</span> <span class="n">0</span><span class="o">,</span> <span class="n">userId</span><span class="o">).</span><span class="na">getList</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="c1">// 执行  dexopt 操作生成 .odex 后缀文件
</span><span class="c1"></span>            <span class="n">mDexManager</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">userPackages</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mIsUpgrade</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">MetricsLogger</span><span class="o">.</span><span class="na">histogram</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="s">&#34;ota_package_manager_init_time&#34;</span><span class="o">,</span>
                                        <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="c1">// synchronized (mPackages)
</span><span class="c1"></span>    <span class="o">}</span> <span class="c1">// synchronized (mInstallLock)
</span><span class="c1"></span>
    <span class="c1">// Now after opening every single application zip, make sure they
</span><span class="c1"></span>    <span class="c1">// are all flushed.  Not really needed, but keeps things nice and
</span><span class="c1"></span>    <span class="c1">// tidy.
</span><span class="c1"></span>    <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="o">,</span> <span class="s">&#34;GC&#34;</span><span class="o">);</span>
    <span class="c1">// 清理及资源回收
</span><span class="c1"></span>    <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">gc</span><span class="o">();</span>
    <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="o">);</span>

    <span class="c1">// The initial scanning above does many calls into installd while
</span><span class="c1"></span>    <span class="c1">// holding the mPackages lock, but we&#39;re mostly interested in yelling
</span><span class="c1"></span>    <span class="c1">// once we have a booted system.
</span><span class="c1"></span>    <span class="n">mInstaller</span><span class="o">.</span><span class="na">setWarnIfHeld</span><span class="o">(</span><span class="n">mPackages</span><span class="o">);</span>

    <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="settings-dot-class"><code>Settings.class</code></h3>

<p>建立  Android 体系与  Linux 内核的用户权限对应关系</p>

<h4 id="settings"><code>Settings()</code></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Settings</span><span class="o">(</span><span class="n">PermissionSettings</span> <span class="n">permissions</span><span class="o">,</span> <span class="n">Object</span> <span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="n">Environment</span><span class="o">.</span><span class="na">getDataDirectory</span><span class="o">(),</span> <span class="n">permissions</span><span class="o">,</span> <span class="n">lock</span><span class="o">);</span>
<span class="o">}</span>

<span class="n">Settings</span><span class="o">(</span><span class="n">File</span> <span class="n">dataDir</span><span class="o">,</span> <span class="n">PermissionSettings</span> <span class="n">permission</span><span class="o">,</span> <span class="n">Object</span> <span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mLock</span> <span class="o">=</span> <span class="n">lock</span><span class="o">;</span>
    <span class="n">mPermissions</span> <span class="o">=</span> <span class="n">permission</span><span class="o">;</span>
    <span class="n">mRuntimePermissionsPersistence</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RuntimePermissionPersistence</span><span class="o">(</span><span class="n">mLock</span><span class="o">);</span>
    <span class="c1">// /data/system 目录
</span><span class="c1"></span>    <span class="n">mSystemDir</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">dataDir</span><span class="o">,</span> <span class="s">&#34;system&#34;</span><span class="o">);</span>
    <span class="n">mSystemDir</span><span class="o">.</span><span class="na">mkdirs</span><span class="o">();</span>
    <span class="n">FileUtils</span><span class="o">.</span><span class="na">setPermissions</span><span class="o">(</span><span class="n">mSystemDir</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span>
                             <span class="n">FileUtils</span><span class="o">.</span><span class="na">S_IRWXU</span><span class="o">|</span><span class="n">FileUtils</span><span class="o">.</span><span class="na">S_IRWXG</span>
                             <span class="o">|</span><span class="n">FileUtils</span><span class="o">.</span><span class="na">S_IROTH</span><span class="o">|</span><span class="n">FileUtils</span><span class="o">.</span><span class="na">S_IXOTH</span><span class="o">,</span>
                             <span class="o">-</span><span class="n">1</span><span class="o">,</span> <span class="o">-</span><span class="n">1</span><span class="o">);</span>
    <span class="c1">// 记录应用相关信息：permission、package、shared-user、keyset-settings
</span><span class="c1"></span>    <span class="n">mSettingsFilename</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">mSystemDir</span><span class="o">,</span> <span class="s">&#34;packages.xml&#34;</span><span class="o">);</span>
    <span class="c1">// package-backup.xml 是  package.xml 的备份文件，
</span><span class="c1"></span>    <span class="c1">// package.xml 写入成功后再写入到备份文件，写入失败时可恢复到上次状态
</span><span class="c1"></span>    <span class="n">mBackupSettingsFilename</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">mSystemDir</span><span class="o">,</span> <span class="s">&#34;packages-backup.xml&#34;</span><span class="o">);</span>
    <span class="c1">// 记录安装包相关信息：包名、userid、debugable、应用数据存放路径、seinfo、gid
</span><span class="c1"></span>    <span class="n">mPackageListFilename</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">mSystemDir</span><span class="o">,</span> <span class="s">&#34;packages.list&#34;</span><span class="o">);</span>
    <span class="n">FileUtils</span><span class="o">.</span><span class="na">setPermissions</span><span class="o">(</span><span class="n">mPackageListFilename</span><span class="o">,</span> <span class="n">0640</span><span class="o">,</span> <span class="n">SYSTEM_UID</span><span class="o">,</span> <span class="n">PACKAGE_INFO_GID</span><span class="o">);</span>
    <span class="c1">// sdcardfs 的作用与  fuse 相同，也是用于控制文件访问的权限。
</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">File</span> <span class="n">kernelDir</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&#34;/config/sdcardfs&#34;</span><span class="o">);</span>
    <span class="n">mKernelMappingFilename</span> <span class="o">=</span> <span class="n">kernelDir</span><span class="o">.</span><span class="na">exists</span><span class="o">()</span> <span class="o">?</span> <span class="n">kernelDir</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>

    <span class="c1">// Deprecated: Needed for migration
</span><span class="c1"></span>    <span class="c1">// 强制停止运行的应用信息
</span><span class="c1"></span>    <span class="n">mStoppedPackagesFilename</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">mSystemDir</span><span class="o">,</span> <span class="s">&#34;packages-stopped.xml&#34;</span><span class="o">);</span>
    <span class="n">mBackupStoppedPackagesFilename</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">mSystemDir</span><span class="o">,</span> <span class="s">&#34;packages-stopped-backup.xml&#34;</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="addshareduserlpw"><code>addSharedUserLPw()</code></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">SharedUserSetting</span> <span class="nf">addSharedUserLPw</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">pkgFlags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">pkgPrivateFlags</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">SharedUserSetting</span> <span class="n">s</span> <span class="o">=</span> <span class="n">mSharedUsers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">userId</span> <span class="o">==</span> <span class="n">uid</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 相应的  SharedUserSetting 存在并且  userId 相同直接返回该对象
</span><span class="c1"></span>            <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// userId 不同则抱一个错误
</span><span class="c1"></span>        <span class="n">PackageManagerService</span><span class="o">.</span><span class="na">reportSettingsProblem</span><span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">ERROR</span><span class="o">,</span>
                                                    <span class="s">&#34;Adding duplicate shared user, keeping first: &#34;</span> <span class="o">+</span> <span class="n">name</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// 不存在新建存入到  mShsredUsers 并返回新建的对象
</span><span class="c1"></span>    <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SharedUserSetting</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">pkgFlags</span><span class="o">,</span> <span class="n">pkgPrivateFlags</span><span class="o">);</span>
    <span class="n">s</span><span class="o">.</span><span class="na">userId</span> <span class="o">=</span> <span class="n">uid</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">addUserIdLPw</span><span class="o">(</span><span class="n">uid</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="n">name</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">mSharedUsers</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">s</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">addUserIdLPw</span><span class="o">(</span><span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="n">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="n">Object</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">uid</span> <span class="o">&gt;</span> <span class="n">Process</span><span class="o">.</span><span class="na">LAST_APPLICATION_UID</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// userId 没有对应的应用，不合法
</span><span class="c1"></span>        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">uid</span> <span class="o">&gt;=</span> <span class="n">Process</span><span class="o">.</span><span class="na">FIRST_APPLICATION_UID</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 非系统应用
</span><span class="c1"></span>        <span class="c1">// 存入到  mUserIds 中  userId 对应的下标位置；中间空白部分用  null 填充
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">N</span> <span class="o">=</span> <span class="n">mUserIds</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">uid</span> <span class="o">-</span> <span class="n">Process</span><span class="o">.</span><span class="na">FIRST_APPLICATION_UID</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">N</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mUserIds</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
            <span class="n">N</span><span class="o">++;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mUserIds</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">PackageManagerService</span><span class="o">.</span><span class="na">reportSettingsProblem</span><span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">ERROR</span><span class="o">,</span>
                                                        <span class="s">&#34;Adding duplicate user id: &#34;</span> <span class="o">+</span> <span class="n">uid</span>
                                                        <span class="o">+</span> <span class="s">&#34; name=&#34;</span> <span class="o">+</span> <span class="n">name</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">mUserIds</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// 系统内置的  userId
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">mOtherUserIds</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">uid</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">PackageManagerService</span><span class="o">.</span><span class="na">reportSettingsProblem</span><span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">ERROR</span><span class="o">,</span>
                                                        <span class="s">&#34;Adding duplicate shared id: &#34;</span> <span class="o">+</span> <span class="n">uid</span>
                                                        <span class="o">+</span> <span class="s">&#34; name=&#34;</span> <span class="o">+</span> <span class="n">name</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 存入到  mOtherUserIds 中
</span><span class="c1"></span>        <span class="n">mOtherUserIds</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">uid</span><span class="o">,</span> <span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>在 <code>Settings</code> 中 <code>mSharedUsers</code> 是一个 <code>map</code> 对象，利用名称作为索引管理 <code>SharedUserSettings</code> 对象。 <code>Settings</code> 中的 <code>mOtherUserIds</code> 和 <code>mUserIds</code> ，均是利用 <code>userId</code> 作为索引管理 <code>SharedUserSettings</code> 对象。不同的是 <code>mOtherUserIds</code> 是 <code>SparseArray</code> ，以系统 <code>uid</code> 作为键值；=mUserIds= 是 <code>ArrayList</code> ，普通  APK 的 <code>uid</code> 为 <code>ArrayList</code> 的下标。 <code>SharedUserSettings</code> 将持有一组 <code>PackageSetting</code> 。
<code>AndroidManifest.xml</code> 中 <code>android:sharedUserId</code> 的属性就是应用的 <code>UserId</code> 其与  Linux 的  UID 相关联，而  Linux 的权限是建立再用户的基础上的，从而建立应用的权限体系。</p>

<h3 id="systemconfig-dot-class"><code>SystemConfig.class</code></h3>

<p>从文件读取系统配置</p>

<h4 id="systemconfig"><code>SystemConfig()</code></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// 单例模式
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">SystemConfig</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">SystemConfig</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sInstance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SystemConfig</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">sInstance</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">SystemConfig</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// Read configuration from system
</span><span class="c1"></span>    <span class="c1">// 从 /system 目录读取权限配置信息
</span><span class="c1"></span>    <span class="n">readPermissions</span><span class="o">(</span><span class="n">Environment</span><span class="o">.</span><span class="na">buildPath</span><span class="o">(</span>
                                          <span class="n">Environment</span><span class="o">.</span><span class="na">getRootDirectory</span><span class="o">(),</span> <span class="s">&#34;etc&#34;</span><span class="o">,</span> <span class="s">&#34;sysconfig&#34;</span><span class="o">),</span> <span class="n">ALLOW_ALL</span><span class="o">);</span>

    <span class="c1">// Read configuration from the old permissions dir
</span><span class="c1"></span>    <span class="c1">// 旧配置文件
</span><span class="c1"></span>    <span class="n">readPermissions</span><span class="o">(</span><span class="n">Environment</span><span class="o">.</span><span class="na">buildPath</span><span class="o">(</span>
                                          <span class="n">Environment</span><span class="o">.</span><span class="na">getRootDirectory</span><span class="o">(),</span> <span class="s">&#34;etc&#34;</span><span class="o">,</span> <span class="s">&#34;permissions&#34;</span><span class="o">),</span> <span class="n">ALLOW_ALL</span><span class="o">);</span>

    <span class="c1">// Vendors are only allowed to customze libs, features and privapp permissions
</span><span class="c1"></span>    <span class="c1">// 从 /vendor 目录读取权限配置信息，该目录下只能自定义：libs、features、privapp 权限
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">vendorPermissionFlag</span> <span class="o">=</span> <span class="n">ALLOW_LIBS</span> <span class="o">|</span> <span class="n">ALLOW_FEATURES</span> <span class="o">|</span> <span class="n">ALLOW_PRIVAPP_PERMISSIONS</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">FIRST_SDK_INT</span> <span class="o">&lt;=</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">O_MR1</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// For backward compatibility
</span><span class="c1"></span>        <span class="n">vendorPermissionFlag</span> <span class="o">|=</span> <span class="o">(</span><span class="n">ALLOW_PERMISSIONS</span> <span class="o">|</span> <span class="n">ALLOW_APP_CONFIGS</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">readPermissions</span><span class="o">(</span><span class="n">Environment</span><span class="o">.</span><span class="na">buildPath</span><span class="o">(</span>
                                          <span class="n">Environment</span><span class="o">.</span><span class="na">getVendorDirectory</span><span class="o">(),</span> <span class="s">&#34;etc&#34;</span><span class="o">,</span> <span class="s">&#34;sysconfig&#34;</span><span class="o">),</span> <span class="n">vendorPermissionFlag</span><span class="o">);</span>
    <span class="n">readPermissions</span><span class="o">(</span><span class="n">Environment</span><span class="o">.</span><span class="na">buildPath</span><span class="o">(</span>
                                          <span class="n">Environment</span><span class="o">.</span><span class="na">getVendorDirectory</span><span class="o">(),</span> <span class="s">&#34;etc&#34;</span><span class="o">,</span> <span class="s">&#34;permissions&#34;</span><span class="o">),</span> <span class="n">vendorPermissionFlag</span><span class="o">);</span>

    <span class="c1">// Allow ODM to customize system configs as much as Vendor, because /odm is another
</span><span class="c1"></span>    <span class="c1">// vendor partition other than /vendor.
</span><span class="c1"></span>    <span class="c1">// 从 /odm 目录读取权限配置信息，限制和 /vendor 一样
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">odmPermissionFlag</span> <span class="o">=</span> <span class="n">vendorPermissionFlag</span><span class="o">;</span>
    <span class="n">readPermissions</span><span class="o">(</span><span class="n">Environment</span><span class="o">.</span><span class="na">buildPath</span><span class="o">(</span>
                                          <span class="n">Environment</span><span class="o">.</span><span class="na">getOdmDirectory</span><span class="o">(),</span> <span class="s">&#34;etc&#34;</span><span class="o">,</span> <span class="s">&#34;sysconfig&#34;</span><span class="o">),</span> <span class="n">odmPermissionFlag</span><span class="o">);</span>
    <span class="n">readPermissions</span><span class="o">(</span><span class="n">Environment</span><span class="o">.</span><span class="na">buildPath</span><span class="o">(</span>
                                          <span class="n">Environment</span><span class="o">.</span><span class="na">getOdmDirectory</span><span class="o">(),</span> <span class="s">&#34;etc&#34;</span><span class="o">,</span> <span class="s">&#34;permissions&#34;</span><span class="o">),</span> <span class="n">odmPermissionFlag</span><span class="o">);</span>

    <span class="c1">// Allow OEM to customize features and OEM permissions
</span><span class="c1"></span>    <span class="c1">// 从  /oem 目录读取权限配置信息，只能自定义：features 和  OEM 权限
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">oemPermissionFlag</span> <span class="o">=</span> <span class="n">ALLOW_FEATURES</span> <span class="o">|</span> <span class="n">ALLOW_OEM_PERMISSIONS</span><span class="o">;</span>
    <span class="n">readPermissions</span><span class="o">(</span><span class="n">Environment</span><span class="o">.</span><span class="na">buildPath</span><span class="o">(</span>
                                          <span class="n">Environment</span><span class="o">.</span><span class="na">getOemDirectory</span><span class="o">(),</span> <span class="s">&#34;etc&#34;</span><span class="o">,</span> <span class="s">&#34;sysconfig&#34;</span><span class="o">),</span> <span class="n">oemPermissionFlag</span><span class="o">);</span>
    <span class="n">readPermissions</span><span class="o">(</span><span class="n">Environment</span><span class="o">.</span><span class="na">buildPath</span><span class="o">(</span>
                                          <span class="n">Environment</span><span class="o">.</span><span class="na">getOemDirectory</span><span class="o">(),</span> <span class="s">&#34;etc&#34;</span><span class="o">,</span> <span class="s">&#34;permissions&#34;</span><span class="o">),</span> <span class="n">oemPermissionFlag</span><span class="o">);</span>

    <span class="c1">// Allow Product to customize system configs around libs, features, permissions and apps
</span><span class="c1"></span>    <span class="c1">// 从产品目录读取配置信息，可以自定义：system configs、libs、features、permissions、apps
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">productPermissionFlag</span> <span class="o">=</span> <span class="n">ALLOW_LIBS</span> <span class="o">|</span> <span class="n">ALLOW_FEATURES</span> <span class="o">|</span> <span class="n">ALLOW_PERMISSIONS</span> <span class="o">|</span>
        <span class="n">ALLOW_APP_CONFIGS</span> <span class="o">|</span> <span class="n">ALLOW_PRIVAPP_PERMISSIONS</span><span class="o">;</span>
    <span class="n">readPermissions</span><span class="o">(</span><span class="n">Environment</span><span class="o">.</span><span class="na">buildPath</span><span class="o">(</span>
                                          <span class="n">Environment</span><span class="o">.</span><span class="na">getProductDirectory</span><span class="o">(),</span> <span class="s">&#34;etc&#34;</span><span class="o">,</span> <span class="s">&#34;sysconfig&#34;</span><span class="o">),</span> <span class="n">productPermissionFlag</span><span class="o">);</span>
    <span class="n">readPermissions</span><span class="o">(</span><span class="n">Environment</span><span class="o">.</span><span class="na">buildPath</span><span class="o">(</span>
                                          <span class="n">Environment</span><span class="o">.</span><span class="na">getProductDirectory</span><span class="o">(),</span> <span class="s">&#34;etc&#34;</span><span class="o">,</span> <span class="s">&#34;permissions&#34;</span><span class="o">),</span> <span class="n">productPermissionFlag</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="readpermissions"><code>readPermissions()</code></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">void</span> <span class="nf">readPermissions</span><span class="o">(</span><span class="n">File</span> <span class="n">libraryDir</span><span class="o">,</span> <span class="kt">int</span> <span class="n">permissionFlag</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Read permissions from given directory.
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(!</span><span class="n">libraryDir</span><span class="o">.</span><span class="na">exists</span><span class="o">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">libraryDir</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">permissionFlag</span> <span class="o">==</span> <span class="n">ALLOW_ALL</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;No directory &#34;</span> <span class="o">+</span> <span class="n">libraryDir</span> <span class="o">+</span> <span class="s">&#34;, skipping&#34;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">libraryDir</span><span class="o">.</span><span class="na">canRead</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Directory &#34;</span> <span class="o">+</span> <span class="n">libraryDir</span> <span class="o">+</span> <span class="s">&#34; cannot be read&#34;</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Iterate over the files in the directory and scan .xml files
</span><span class="c1"></span>    <span class="n">File</span> <span class="n">platformFile</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">File</span> <span class="n">f</span> <span class="o">:</span> <span class="n">libraryDir</span><span class="o">.</span><span class="na">listFiles</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// We&#39;ll read platform.xml last
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">getPath</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&#34;etc/permissions/platform.xml&#34;</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">platformFile</span> <span class="o">=</span> <span class="n">f</span><span class="o">;</span>
            <span class="k">continue</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">f</span><span class="o">.</span><span class="na">getPath</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&#34;.xml&#34;</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Non-xml file &#34;</span> <span class="o">+</span> <span class="n">f</span> <span class="o">+</span> <span class="s">&#34; in &#34;</span> <span class="o">+</span> <span class="n">libraryDir</span> <span class="o">+</span> <span class="s">&#34; directory, ignoring&#34;</span><span class="o">);</span>
            <span class="k">continue</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">f</span><span class="o">.</span><span class="na">canRead</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Permissions library file &#34;</span> <span class="o">+</span> <span class="n">f</span> <span class="o">+</span> <span class="s">&#34; cannot be read&#34;</span><span class="o">);</span>
            <span class="k">continue</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">readPermissionsFromXml</span><span class="o">(</span><span class="n">f</span><span class="o">,</span> <span class="n">permissionFlag</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Read platform permissions last so it will take precedence
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">platformFile</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 解析  XML 文件并保存解析后的结果
</span><span class="c1"></span>        <span class="n">readPermissionsFromXml</span><span class="o">(</span><span class="n">platformFile</span><span class="o">,</span> <span class="n">permissionFlag</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="扫描已安装应用信息并保存">扫描已安装应用信息并保存</h3>

<h4 id="scandirtracedli"><code>scanDirTracedLI()</code></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">scanDirTracedLI</span><span class="o">(</span><span class="n">File</span> <span class="n">scanDir</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">parseFlags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">scanFlags</span><span class="o">,</span> <span class="kt">long</span> <span class="n">currentTime</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="o">,</span> <span class="s">&#34;scanDir [&#34;</span> <span class="o">+</span> <span class="n">scanDir</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;]&#34;</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">scanDirLI</span><span class="o">(</span><span class="n">scanDir</span><span class="o">,</span> <span class="n">parseFlags</span><span class="o">,</span> <span class="n">scanFlags</span><span class="o">,</span> <span class="n">currentTime</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">scanDirLI</span><span class="o">(</span><span class="n">File</span> <span class="n">scanDir</span><span class="o">,</span> <span class="kt">int</span> <span class="n">parseFlags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">scanFlags</span><span class="o">,</span> <span class="kt">long</span> <span class="n">currentTime</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">File</span><span class="o">[]</span> <span class="n">files</span> <span class="o">=</span> <span class="n">scanDir</span><span class="o">.</span><span class="na">listFiles</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">ArrayUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">files</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;No files in app dir &#34;</span> <span class="o">+</span> <span class="n">scanDir</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">(</span><span class="n">ParallelPackageParser</span> <span class="n">parallelPackageParser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ParallelPackageParser</span><span class="o">(</span>
                                                                                 <span class="n">mSeparateProcesses</span><span class="o">,</span> <span class="n">mOnlyCore</span><span class="o">,</span> <span class="n">mMetrics</span><span class="o">,</span> <span class="n">mCacheDir</span><span class="o">,</span>
                                                                                 <span class="n">mParallelPackageParserCallback</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// Submit files for parsing in parallel
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">fileCount</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">File</span> <span class="n">file</span> <span class="o">:</span> <span class="n">files</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 过滤  apk、文件夹并排除临时文件
</span><span class="c1"></span>            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isPackage</span> <span class="o">=</span> <span class="o">(</span><span class="n">isApkFile</span><span class="o">(</span><span class="n">file</span><span class="o">)</span> <span class="o">||</span> <span class="n">file</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">())</span>
                <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">PackageInstallerService</span><span class="o">.</span><span class="na">isStageName</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">isPackage</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Ignore entries which are not packages
</span><span class="c1"></span>                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// 提交符合条件的文件，用于并行解析
</span><span class="c1"></span>            <span class="n">parallelPackageParser</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">parseFlags</span><span class="o">);</span>
            <span class="c1">// 计数用于后面处理解析结果
</span><span class="c1"></span>            <span class="n">fileCount</span><span class="o">++;</span>
        <span class="o">}</span>

        <span class="c1">// Process results one by one
</span><span class="c1"></span>        <span class="c1">// 逐个处理解析结果
</span><span class="c1"></span>        <span class="k">for</span> <span class="o">(;</span> <span class="n">fileCount</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">;</span> <span class="n">fileCount</span><span class="o">--)</span> <span class="o">{</span>
            <span class="n">ParallelPackageParser</span><span class="o">.</span><span class="na">ParseResult</span> <span class="n">parseResult</span> <span class="o">=</span> <span class="n">parallelPackageParser</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
            <span class="n">Throwable</span> <span class="n">throwable</span> <span class="o">=</span> <span class="n">parseResult</span><span class="o">.</span><span class="na">throwable</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">errorCode</span> <span class="o">=</span> <span class="n">PackageManager</span><span class="o">.</span><span class="na">INSTALL_SUCCEEDED</span><span class="o">;</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">throwable</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// TODO(toddke): move lower in the scan chain
</span><span class="c1"></span>                <span class="c1">// Static shared libraries have synthetic package names
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">parseResult</span><span class="o">.</span><span class="na">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">isStaticSharedLibrary</span><span class="o">())</span> <span class="o">{</span>
                    <span class="c1">// 重命名静态共享库包：pkg.packageName + &#34;_&#34;  + pkg.staticSharedLibVersion
</span><span class="c1"></span>                    <span class="n">renameStaticSharedLibraryPackage</span><span class="o">(</span><span class="n">parseResult</span><span class="o">.</span><span class="na">pkg</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">errorCode</span> <span class="o">==</span> <span class="n">PackageManager</span><span class="o">.</span><span class="na">INSTALL_SUCCEEDED</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// 继续解析其它信息
</span><span class="c1"></span>                        <span class="n">scanPackageChildLI</span><span class="o">(</span><span class="n">parseResult</span><span class="o">.</span><span class="na">pkg</span><span class="o">,</span> <span class="n">parseFlags</span><span class="o">,</span> <span class="n">scanFlags</span><span class="o">,</span>
                                           <span class="n">currentTime</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PackageManagerException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">errorCode</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">error</span><span class="o">;</span>
                    <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Failed to scan &#34;</span> <span class="o">+</span> <span class="n">parseResult</span><span class="o">.</span><span class="na">scanFile</span> <span class="o">+</span> <span class="s">&#34;: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">throwable</span> <span class="k">instanceof</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">PackageParserException</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">PackageParser</span><span class="o">.</span><span class="na">PackageParserException</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="n">PackageParser</span><span class="o">.</span><span class="na">PackageParserException</span><span class="o">)</span>
                    <span class="n">throwable</span><span class="o">;</span>
                <span class="n">errorCode</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">error</span><span class="o">;</span>
                <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Failed to parse &#34;</span> <span class="o">+</span> <span class="n">parseResult</span><span class="o">.</span><span class="na">scanFile</span> <span class="o">+</span> <span class="s">&#34;: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;Unexpected exception occurred while parsing &#34;</span>
                                                <span class="o">+</span> <span class="n">parseResult</span><span class="o">.</span><span class="na">scanFile</span><span class="o">,</span> <span class="n">throwable</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// Delete invalid userdata apps
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">((</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_AS_SYSTEM</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
                <span class="n">errorCode</span> <span class="o">!=</span> <span class="n">PackageManager</span><span class="o">.</span><span class="na">INSTALL_SUCCEEDED</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">logCriticalInfo</span><span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">WARN</span><span class="o">,</span>
                                <span class="s">&#34;Deleting invalid package at &#34;</span> <span class="o">+</span> <span class="n">parseResult</span><span class="o">.</span><span class="na">scanFile</span><span class="o">);</span>
                <span class="c1">// 移除无用的用户安装包
</span><span class="c1"></span>                <span class="n">removeCodePathLI</span><span class="o">(</span><span class="n">parseResult</span><span class="o">.</span><span class="na">scanFile</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="parallelpackageparser-dot-class"><code>ParallelPackageParser.class</code></h4>

<p>这是一个辅助类用于并行解析安装包</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="kd">class</span> <span class="nc">ParseResult</span> <span class="o">{</span>

    <span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="n">pkg</span><span class="o">;</span> <span class="c1">// Parsed package
</span><span class="c1"></span>    <span class="n">File</span> <span class="n">scanFile</span><span class="o">;</span> <span class="c1">// File that was parsed
</span><span class="c1"></span>    <span class="n">Throwable</span> <span class="n">throwable</span><span class="o">;</span> <span class="c1">// Set if an error occurs during parsing
</span><span class="c1"></span><span class="o">}</span>

<span class="cm">/**
</span><span class="cm"> * Take the parsed package from the parsing queue, waiting if necessary until the element
</span><span class="cm"> * appears in the queue.
</span><span class="cm"> * @return parsed package
</span><span class="cm"> */</span>
<span class="c1">// 取出解析结果
</span><span class="c1"></span><span class="kd">public</span> <span class="n">ParseResult</span> <span class="nf">take</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mInterruptedInThread</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">InterruptedException</span><span class="o">(</span><span class="s">&#34;Interrupted in &#34;</span> <span class="o">+</span> <span class="n">mInterruptedInThread</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">mQueue</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// We cannot recover from interrupt here
</span><span class="c1"></span>        <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/**
</span><span class="cm"> * Submits the file for parsing
</span><span class="cm"> * @param scanFile file to scan
</span><span class="cm"> * @param parseFlags parse falgs
</span><span class="cm"> */</span>
<span class="n">提交到线程池</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">submit</span><span class="o">(</span><span class="n">File</span> <span class="n">scanFile</span><span class="o">,</span> <span class="kt">int</span> <span class="n">parseFlags</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mService</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">ParseResult</span> <span class="n">pr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ParseResult</span><span class="o">();</span>
            <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="o">,</span> <span class="s">&#34;parallel parsePackage [&#34;</span> <span class="o">+</span> <span class="n">scanFile</span> <span class="o">+</span> <span class="s">&#34;]&#34;</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">PackageParser</span> <span class="n">pp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PackageParser</span><span class="o">();</span>
                <span class="c1">// debug.separate_processes 值
</span><span class="c1"></span>                <span class="n">pp</span><span class="o">.</span><span class="na">setSeparateProcesses</span><span class="o">(</span><span class="n">mSeparateProcesses</span><span class="o">);</span>
                <span class="n">pp</span><span class="o">.</span><span class="na">setOnlyCoreApps</span><span class="o">(</span><span class="n">mOnlyCore</span><span class="o">);</span>
                <span class="n">pp</span><span class="o">.</span><span class="na">setDisplayMetrics</span><span class="o">(</span><span class="n">mMetrics</span><span class="o">);</span>
                <span class="n">pp</span><span class="o">.</span><span class="na">setCacheDir</span><span class="o">(</span><span class="n">mCacheDir</span><span class="o">);</span>
                <span class="n">pp</span><span class="o">.</span><span class="na">setCallback</span><span class="o">(</span><span class="n">mPackageParserCallback</span><span class="o">);</span>
                <span class="n">pr</span><span class="o">.</span><span class="na">scanFile</span> <span class="o">=</span> <span class="n">scanFile</span><span class="o">;</span>
                <span class="c1">// 保存解析信息
</span><span class="c1"></span>                <span class="n">pr</span><span class="o">.</span><span class="na">pkg</span> <span class="o">=</span> <span class="n">parsePackage</span><span class="o">(</span><span class="n">pp</span><span class="o">,</span> <span class="n">scanFile</span><span class="o">,</span> <span class="n">parseFlags</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">pr</span><span class="o">.</span><span class="na">throwable</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// 保存解析结果
</span><span class="c1"></span>                <span class="n">mQueue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">pr</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
                <span class="c1">// Propagate result to callers of take().
</span><span class="c1"></span>                <span class="c1">// This is helpful to prevent main thread from getting stuck waiting on
</span><span class="c1"></span>                <span class="c1">// ParallelPackageParser to finish in case of interruption
</span><span class="c1"></span>                <span class="n">mInterruptedInThread</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
<span class="o">}</span>

<span class="nd">@VisibleForTesting</span>
<span class="kd">protected</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="nf">parsePackage</span><span class="o">(</span><span class="n">PackageParser</span> <span class="n">packageParser</span><span class="o">,</span> <span class="n">File</span> <span class="n">scanFile</span><span class="o">,</span>
                                             <span class="kt">int</span> <span class="n">parseFlags</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">PackageParserException</span> <span class="o">{</span>
    <span class="c1">// 交由  PackageParser 类进行解析
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">packageParser</span><span class="o">.</span><span class="na">parsePackage</span><span class="o">(</span><span class="n">scanFile</span><span class="o">,</span> <span class="n">parseFlags</span><span class="o">,</span> <span class="kc">true</span> <span class="cm">/* useCaches */</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="packageparser-dot-class"><code>PackageParser.class</code></h4>

<p>安装包解析类</p>

<ul>
<li><p><code>parsePackage()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Package</span> <span class="nf">parsePackage</span><span class="o">(</span><span class="n">File</span> <span class="n">packageFile</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">PackageParserException</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">parsePackage</span><span class="o">(</span><span class="n">packageFile</span><span class="o">,</span> <span class="n">flags</span><span class="o">,</span> <span class="kc">false</span> <span class="cm">/* useCaches */</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="n">Package</span> <span class="nf">parsePackage</span><span class="o">(</span><span class="n">File</span> <span class="n">packageFile</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">useCaches</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="n">PackageParserException</span> <span class="o">{</span>
    <span class="c1">// 这次是  true，如果从缓存中找到直接返回该对象
</span><span class="c1"></span>    <span class="n">Package</span> <span class="n">parsed</span> <span class="o">=</span> <span class="n">useCaches</span> <span class="o">?</span> <span class="n">getCachedResult</span><span class="o">(</span><span class="n">packageFile</span><span class="o">,</span> <span class="n">flags</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">parsed</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">parsed</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kt">long</span> <span class="n">parseTime</span> <span class="o">=</span> <span class="n">LOG_PARSE_TIMINGS</span> <span class="o">?</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">()</span> <span class="o">:</span> <span class="n">0</span><span class="o">;</span>
    <span class="c1">// 目录和单个文件调用的方法不同，但大同小异；
</span><span class="c1"></span>    <span class="c1">// Android 目前默认都是文件夹；那我这里也就只分析解析文件夹的方法
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">packageFile</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parseClusterPackage</span><span class="o">(</span><span class="n">packageFile</span><span class="o">,</span> <span class="n">flags</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parseMonolithicPackage</span><span class="o">(</span><span class="n">packageFile</span><span class="o">,</span> <span class="n">flags</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kt">long</span> <span class="n">cacheTime</span> <span class="o">=</span> <span class="n">LOG_PARSE_TIMINGS</span> <span class="o">?</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">()</span> <span class="o">:</span> <span class="n">0</span><span class="o">;</span>
    <span class="c1">// 缓存解析结果
</span><span class="c1"></span>    <span class="n">cacheResult</span><span class="o">(</span><span class="n">packageFile</span><span class="o">,</span> <span class="n">flags</span><span class="o">,</span> <span class="n">parsed</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">LOG_PARSE_TIMINGS</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">parseTime</span> <span class="o">=</span> <span class="n">cacheTime</span> <span class="o">-</span> <span class="n">parseTime</span><span class="o">;</span>
        <span class="n">cacheTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">cacheTime</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parseTime</span> <span class="o">+</span> <span class="n">cacheTime</span> <span class="o">&gt;</span> <span class="n">LOG_PARSE_TIMINGS_THRESHOLD_MS</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Parse times for &#39;&#34;</span> <span class="o">+</span> <span class="n">packageFile</span> <span class="o">+</span> <span class="s">&#34;&#39;: parse=&#34;</span> <span class="o">+</span> <span class="n">parseTime</span>
                   <span class="o">+</span> <span class="s">&#34;ms, update_cache=&#34;</span> <span class="o">+</span> <span class="n">cacheTime</span> <span class="o">+</span> <span class="s">&#34; ms&#34;</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">parsed</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>parseClusterPackage()</code> 解析文件夹</p>

<p>```java
/**</p>

<ul>
<li>Parse all APKs contained in the given directory, treating them as a</li>
<li>single package. This also performs sanity checking, such as requiring</li>
<li>identical package name and version codes, a single base APK, and unique</li>
<li>split names.</li>
<li><p></li>
<li>Note that this <em>does not</em> perform signature verification; that</li>

<li><p>must be done separately in {@link #collectCertificates(Package, int)}.
*/
private Package parseClusterPackage(File packageDir, int flags) throws PackageParserException {
// 解析出所有  apk 信息  <3>
final PackageLite lite = parseClusterPackageLite(packageDir, 0);
if (mOnlyCoreApps &amp;&amp; !lite.coreApp) {
    throw new PackageParserException(INSTALL_PARSE_FAILED_MANIFEST_MALFORMED,
                                     &ldquo;Not a coreApp: &ldquo; + packageDir);
}</p>

<p>// Build the split dependency tree.
// 构建子包依赖树
SparseArray<int[]> splitDependencies = null;
final SplitAssetLoader assetLoader;
if (lite.isolatedSplits &amp;&amp; !ArrayUtils.isEmpty(lite.splitNames)) {
    try {
        splitDependencies = SplitAssetDependencyLoader.createDependenciesFromPackage(lite);
        assetLoader = new SplitAssetDependencyLoader(lite, splitDependencies, flags);
    } catch (SplitAssetDependencyLoader.IllegalDependencyException e) {
        throw new PackageParserException(INSTALL_PARSE_FAILED_BAD_MANIFEST, e.getMessage());
    }
} else {
    assetLoader = new DefaultSplitAssetLoader(lite, flags);
}</p>

<p>try {
    // 解析母  apk <5>
    final AssetManager assets = assetLoader.getBaseAssetManager();
    final File baseApk = new File(lite.baseCodePath);
    final Package pkg = parseBaseApk(baseApk, assets, flags);
    if (pkg == null) {
        throw new PackageParserException(INSTALL_PARSE_FAILED_NOT_APK,
                                         &ldquo;Failed to parse base APK: &ldquo; + baseApk);
    }</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></pre></td>
<td class="lntd">
<pre class="chroma">if (!ArrayUtils.isEmpty(lite.splitNames)) {
    final int num = lite.splitNames.length;
    pkg.splitNames = lite.splitNames;
    pkg.splitCodePaths = lite.splitCodePaths;
    pkg.splitRevisionCodes = lite.splitRevisionCodes;
    pkg.splitFlags = new int[num];
    pkg.splitPrivateFlags = new int[num];
    pkg.applicationInfo.splitNames = pkg.splitNames;
    pkg.applicationInfo.splitDependencies = splitDependencies;
    pkg.applicationInfo.splitClassLoaderNames = new String[num];

    for (int i = 0; i &lt; num; i++) {
        // 解析子  apk，过程类似母  apk
        final AssetManager splitAssets = assetLoader.getSplitAssetManager(i);
        parseSplitApk(pkg, i, splitAssets, flags);
    }
}

pkg.setCodePath(packageDir.getCanonicalPath());
pkg.setUse32bitAbi(lite.use32bitAbi);
return pkg;</pre></td></tr></table>
</div>
</div>
<p>} catch (IOException e) {
    throw new PackageParserException(INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION,
                                     &ldquo;Failed to get path: &ldquo; + lite.baseCodePath, e);
} finally {
    IoUtils.closeQuietly(assetLoader);
}
}
```</p></li>
</ul></li>

<li><p><code>parseClusterPackageLite()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// PackageLite 的构造方法，主要是保存应用的信息
</span><span class="c1"></span><span class="kd">public</span> <span class="nf">PackageLite</span><span class="o">(</span><span class="n">String</span> <span class="n">codePath</span><span class="o">,</span> <span class="n">ApkLite</span> <span class="n">baseApk</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">splitNames</span><span class="o">,</span>
                   <span class="kt">boolean</span><span class="o">[]</span> <span class="n">isFeatureSplits</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">usesSplitNames</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">configForSplit</span><span class="o">,</span>
                   <span class="n">String</span><span class="o">[]</span> <span class="n">splitCodePaths</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">splitRevisionCodes</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">packageName</span> <span class="o">=</span> <span class="n">baseApk</span><span class="o">.</span><span class="na">packageName</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">versionCode</span> <span class="o">=</span> <span class="n">baseApk</span><span class="o">.</span><span class="na">versionCode</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">versionCodeMajor</span> <span class="o">=</span> <span class="n">baseApk</span><span class="o">.</span><span class="na">versionCodeMajor</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">installLocation</span> <span class="o">=</span> <span class="n">baseApk</span><span class="o">.</span><span class="na">installLocation</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">verifiers</span> <span class="o">=</span> <span class="n">baseApk</span><span class="o">.</span><span class="na">verifiers</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">splitNames</span> <span class="o">=</span> <span class="n">splitNames</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">isFeatureSplits</span> <span class="o">=</span> <span class="n">isFeatureSplits</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">usesSplitNames</span> <span class="o">=</span> <span class="n">usesSplitNames</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">configForSplit</span> <span class="o">=</span> <span class="n">configForSplit</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">codePath</span> <span class="o">=</span> <span class="n">codePath</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">baseCodePath</span> <span class="o">=</span> <span class="n">baseApk</span><span class="o">.</span><span class="na">codePath</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">splitCodePaths</span> <span class="o">=</span> <span class="n">splitCodePaths</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">baseRevisionCode</span> <span class="o">=</span> <span class="n">baseApk</span><span class="o">.</span><span class="na">revisionCode</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">splitRevisionCodes</span> <span class="o">=</span> <span class="n">splitRevisionCodes</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">coreApp</span> <span class="o">=</span> <span class="n">baseApk</span><span class="o">.</span><span class="na">coreApp</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">debuggable</span> <span class="o">=</span> <span class="n">baseApk</span><span class="o">.</span><span class="na">debuggable</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">multiArch</span> <span class="o">=</span> <span class="n">baseApk</span><span class="o">.</span><span class="na">multiArch</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">use32bitAbi</span> <span class="o">=</span> <span class="n">baseApk</span><span class="o">.</span><span class="na">use32bitAbi</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">extractNativeLibs</span> <span class="o">=</span> <span class="n">baseApk</span><span class="o">.</span><span class="na">extractNativeLibs</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">isolatedSplits</span> <span class="o">=</span> <span class="n">baseApk</span><span class="o">.</span><span class="na">isolatedSplits</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="n">PackageLite</span> <span class="nf">parseClusterPackageLite</span><span class="o">(</span><span class="n">File</span> <span class="n">packageDir</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="n">PackageParserException</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">File</span><span class="o">[]</span> <span class="n">files</span> <span class="o">=</span> <span class="n">packageDir</span><span class="o">.</span><span class="na">listFiles</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">ArrayUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">files</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">PackageParserException</span><span class="o">(</span><span class="n">INSTALL_PARSE_FAILED_NOT_APK</span><span class="o">,</span>
                                         <span class="s">&#34;No packages found in split&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">String</span> <span class="n">packageName</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">versionCode</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

    <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="o">,</span> <span class="s">&#34;parseApkLite&#34;</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">ApkLite</span><span class="o">&gt;</span> <span class="n">apks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayMap</span><span class="o">&lt;&gt;();</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">File</span> <span class="n">file</span> <span class="o">:</span> <span class="n">files</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isApkFile</span><span class="o">(</span><span class="n">file</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// 解析单个  APK 文件
</span><span class="c1"></span>            <span class="kd">final</span> <span class="n">ApkLite</span> <span class="n">lite</span> <span class="o">=</span> <span class="n">parseApkLite</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">flags</span><span class="o">);</span>

            <span class="c1">// Assert that all package names and version codes are
</span><span class="c1"></span>            <span class="c1">// consistent with the first one we encounter.
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">packageName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">packageName</span> <span class="o">=</span> <span class="n">lite</span><span class="o">.</span><span class="na">packageName</span><span class="o">;</span>
                <span class="n">versionCode</span> <span class="o">=</span> <span class="n">lite</span><span class="o">.</span><span class="na">versionCode</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// 检查包名是否一致
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(!</span><span class="n">packageName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">lite</span><span class="o">.</span><span class="na">packageName</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">PackageParserException</span><span class="o">(</span><span class="n">INSTALL_PARSE_FAILED_BAD_MANIFEST</span><span class="o">,</span>
                                                     <span class="s">&#34;Inconsistent package &#34;</span> <span class="o">+</span> <span class="n">lite</span><span class="o">.</span><span class="na">packageName</span> <span class="o">+</span> <span class="s">&#34; in &#34;</span> <span class="o">+</span> <span class="n">file</span>
                                                     <span class="o">+</span> <span class="s">&#34;; expected &#34;</span> <span class="o">+</span> <span class="n">packageName</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="c1">// 检查版本号是否一致
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">versionCode</span> <span class="o">!=</span> <span class="n">lite</span><span class="o">.</span><span class="na">versionCode</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">PackageParserException</span><span class="o">(</span><span class="n">INSTALL_PARSE_FAILED_BAD_MANIFEST</span><span class="o">,</span>
                                                     <span class="s">&#34;Inconsistent version &#34;</span> <span class="o">+</span> <span class="n">lite</span><span class="o">.</span><span class="na">versionCode</span> <span class="o">+</span> <span class="s">&#34; in &#34;</span> <span class="o">+</span> <span class="n">file</span>
                                                     <span class="o">+</span> <span class="s">&#34;; expected &#34;</span> <span class="o">+</span> <span class="n">versionCode</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">// 检查子包的唯一性
</span><span class="c1"></span>            <span class="c1">// Assert that each split is defined only once
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">apks</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">lite</span><span class="o">.</span><span class="na">splitName</span><span class="o">,</span> <span class="n">lite</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">PackageParserException</span><span class="o">(</span><span class="n">INSTALL_PARSE_FAILED_BAD_MANIFEST</span><span class="o">,</span>
                                                 <span class="s">&#34;Split name &#34;</span> <span class="o">+</span> <span class="n">lite</span><span class="o">.</span><span class="na">splitName</span>
                                                 <span class="o">+</span> <span class="s">&#34; defined more than once; most recent was &#34;</span> <span class="o">+</span> <span class="n">file</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="o">);</span>
    <span class="c1">// 因为  baseApk.splitName=null，所以移除  null 返回  baseApk
</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">ApkLite</span> <span class="n">baseApk</span> <span class="o">=</span> <span class="n">apks</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">baseApk</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">PackageParserException</span><span class="o">(</span><span class="n">INSTALL_PARSE_FAILED_BAD_MANIFEST</span><span class="o">,</span>
                                         <span class="s">&#34;Missing base APK in &#34;</span> <span class="o">+</span> <span class="n">packageDir</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Always apply deterministic ordering based on splitName
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">apks</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>

    <span class="n">String</span><span class="o">[]</span> <span class="n">splitNames</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kt">boolean</span><span class="o">[]</span> <span class="n">isFeatureSplits</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">String</span><span class="o">[]</span> <span class="n">usesSplitNames</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">String</span><span class="o">[]</span> <span class="n">configForSplits</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">String</span><span class="o">[]</span> <span class="n">splitCodePaths</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kt">int</span><span class="o">[]</span> <span class="n">splitRevisionCodes</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">String</span><span class="o">[]</span> <span class="n">splitClassLoaderNames</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">splitNames</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
        <span class="n">isFeatureSplits</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">boolean</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
        <span class="n">usesSplitNames</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
        <span class="n">configForSplits</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
        <span class="n">splitCodePaths</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
        <span class="n">splitRevisionCodes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
        <span class="c1">// 子包排序储存
</span><span class="c1"></span>        <span class="n">splitNames</span> <span class="o">=</span> <span class="n">apks</span><span class="o">.</span><span class="na">keySet</span><span class="o">().</span><span class="na">toArray</span><span class="o">(</span><span class="n">splitNames</span><span class="o">);</span>
        <span class="n">Arrays</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">splitNames</span><span class="o">,</span> <span class="n">sSplitNameComparator</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">ApkLite</span> <span class="n">apk</span> <span class="o">=</span> <span class="n">apks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">splitNames</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="n">usesSplitNames</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">apk</span><span class="o">.</span><span class="na">usesSplitName</span><span class="o">;</span>
            <span class="n">isFeatureSplits</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">apk</span><span class="o">.</span><span class="na">isFeatureSplit</span><span class="o">;</span>
            <span class="n">configForSplits</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">apk</span><span class="o">.</span><span class="na">configForSplit</span><span class="o">;</span>
            <span class="n">splitCodePaths</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">apk</span><span class="o">.</span><span class="na">codePath</span><span class="o">;</span>
            <span class="n">splitRevisionCodes</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">apk</span><span class="o">.</span><span class="na">revisionCode</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="n">String</span> <span class="n">codePath</span> <span class="o">=</span> <span class="n">packageDir</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">();</span>
    <span class="c1">// 构建  PackageLite 对象并返回
</span><span class="c1"></span>    <span class="k">return</span> <span class="k">new</span> <span class="n">PackageLite</span><span class="o">(</span><span class="n">codePath</span><span class="o">,</span> <span class="n">baseApk</span><span class="o">,</span> <span class="n">splitNames</span><span class="o">,</span> <span class="n">isFeatureSplits</span><span class="o">,</span> <span class="n">usesSplitNames</span><span class="o">,</span>
                           <span class="n">configForSplits</span><span class="o">,</span> <span class="n">splitCodePaths</span><span class="o">,</span> <span class="n">splitRevisionCodes</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>parseApkLite()</code></p>

<p>```java
/**</p>

<ul>
<li>Utility method that retrieves lightweight details about a single APK</li>
<li>file, including package name, split name, and install location.
*</li>
<li>@param apkFile path to a single APK</li>
<li>@param flags optional parse flags, such as</li>
<li>{@link #PARSE_COLLECT_CERTIFICATES}
*/
public static ApkLite parseApkLite(File apkFile, int flags)
throws PackageParserException {
return parseApkLiteInner(apkFile, null, null, flags);
}</li>
</ul>

<p>private static ApkLite parseApkLiteInner(File apkFile, FileDescriptor fd, String debugPathName,
                                         int flags) throws PackageParserException {
    // 这里  fd、debugPathName 都是  null
    // 这个获得  apk 绝对路径
    final String apkPath = fd != null ? debugPathName : apkFile.getAbsolutePath();</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></pre></td>
<td class="lntd">
<pre class="chroma">XmlResourceParser parser = null;
try {
    final ApkAssets apkAssets;
    try {
        // 从  apk 中加载  AndroidManifest.xml 文件
        apkAssets = fd != null
            ? ApkAssets.loadFromFd(fd, debugPathName, false, false)
            : ApkAssets.loadFromPath(apkPath);
    } catch (IOException e) {
        throw new PackageParserException(INSTALL_PARSE_FAILED_NOT_APK,
                                         &#34;Failed to parse &#34; + apkPath);
    }
    // 准备解析  AndroidManifest.xml 文件
    parser = apkAssets.openXml(ANDROID_MANIFEST_FILENAME);

    final SigningDetails signingDetails;
    if ((flags &amp; PARSE_COLLECT_CERTIFICATES) != 0) {
        // TODO: factor signature related items out of Package object
        final Package tempPkg = new Package((String) null);
        // 系统签名  apk 跳过签名相关
        final boolean skipVerify = (flags &amp; PARSE_IS_SYSTEM_DIR) != 0;
        Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, &#34;collectCertificates&#34;);
        try {
            // 获取签名信息
            collectCertificates(tempPkg, apkFile, skipVerify);
        } finally {
            Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);
        }
        signingDetails = tempPkg.mSigningDetails;
    } else {
        signingDetails = SigningDetails.UNKNOWN;
    }

    //XmlResourceParser 是  AttributeSet 的子类
    final AttributeSet attrs = parser;
    return parseApkLite(apkPath, parser, attrs, signingDetails);

} catch (XmlPullParserException | IOException | RuntimeException e) {
    Slog.w(TAG, &#34;Failed to parse &#34; + apkPath, e);
    throw new PackageParserException(INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION,
                                     &#34;Failed to parse &#34; + apkPath, e);
} finally {
    IoUtils.closeQuietly(parser);
    // TODO(b/72056911): Implement and call close() on ApkAssets.
}</pre></td></tr></table>
</div>
</div>
<p>}
// 主要解析  AndroidManifest.xml 文件，并将结果保存到  ApkLite 对象中
private static ApkLite parseApkLite(String codePath, XmlPullParser parser, AttributeSet attrs,
                                    SigningDetails signingDetails)
    throws IOException, XmlPullParserException, PackageParserException {
    final Pair<String, String> packageSplit = parsePackageSplitNames(parser, attrs);</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></pre></td>
<td class="lntd">
<pre class="chroma">int installLocation = PARSE_DEFAULT_INSTALL_LOCATION;
int versionCode = 0;
int versionCodeMajor = 0;
int revisionCode = 0;
boolean coreApp = false;
boolean debuggable = false;
boolean multiArch = false;
boolean use32bitAbi = false;
boolean extractNativeLibs = true;
boolean isolatedSplits = false;
boolean isFeatureSplit = false;
String configForSplit = null;
String usesSplitName = null;

// 从  AndroidManifest.xml 中解析上述变量的值
// ......
// 构建  ApkLite 对象并返回
return new ApkLite(codePath, packageSplit.first, packageSplit.second, isFeatureSplit,
                   configForSplit, usesSplitName, versionCode, versionCodeMajor, revisionCode,
                   installLocation, verifiers, signingDetails, coreApp, debuggable,
                   multiArch, use32bitAbi, extractNativeLibs, isolatedSplits);</pre></td></tr></table>
</div>
</div>
<p>}
```</p></li>

<li><p><code>parseBaseApk()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">Package</span> <span class="nf">parseBaseApk</span><span class="o">(</span><span class="n">File</span> <span class="n">apkFile</span><span class="o">,</span> <span class="n">AssetManager</span> <span class="n">assets</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="n">PackageParserException</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">apkPath</span> <span class="o">=</span> <span class="n">apkFile</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">();</span>

    <span class="n">String</span> <span class="n">volumeUuid</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">apkPath</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">MNT_EXPAND</span><span class="o">))</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">end</span> <span class="o">=</span> <span class="n">apkPath</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="sc">&#39;/&#39;</span><span class="o">,</span> <span class="n">MNT_EXPAND</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
        <span class="n">volumeUuid</span> <span class="o">=</span> <span class="n">apkPath</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">MNT_EXPAND</span><span class="o">.</span><span class="na">length</span><span class="o">(),</span> <span class="n">end</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">mParseError</span> <span class="o">=</span> <span class="n">PackageManager</span><span class="o">.</span><span class="na">INSTALL_SUCCEEDED</span><span class="o">;</span>
    <span class="n">mArchiveSourcePath</span> <span class="o">=</span> <span class="n">apkFile</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">();</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_JAR</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Scanning base APK: &#34;</span> <span class="o">+</span> <span class="n">apkPath</span><span class="o">);</span>

    <span class="n">XmlResourceParser</span> <span class="n">parser</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 根据  apk 路径获取资源管理器中的  AndroidManifest.xml
</span><span class="c1"></span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="na">findCookieForPath</span><span class="o">(</span><span class="n">apkPath</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cookie</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">PackageParserException</span><span class="o">(</span><span class="n">INSTALL_PARSE_FAILED_BAD_MANIFEST</span><span class="o">,</span>
                                             <span class="s">&#34;Failed adding asset path: &#34;</span> <span class="o">+</span> <span class="n">apkPath</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="na">openXmlResourceParser</span><span class="o">(</span><span class="n">cookie</span><span class="o">,</span> <span class="n">ANDROID_MANIFEST_FILENAME</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">Resources</span> <span class="n">res</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Resources</span><span class="o">(</span><span class="n">assets</span><span class="o">,</span> <span class="n">mMetrics</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

        <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">outError</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">1</span><span class="o">];</span>
        <span class="kd">final</span> <span class="n">Package</span> <span class="n">pkg</span> <span class="o">=</span> <span class="n">parseBaseApk</span><span class="o">(</span><span class="n">apkPath</span><span class="o">,</span> <span class="n">res</span><span class="o">,</span> <span class="n">parser</span><span class="o">,</span> <span class="n">flags</span><span class="o">,</span> <span class="n">outError</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pkg</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">PackageParserException</span><span class="o">(</span><span class="n">mParseError</span><span class="o">,</span>
                                             <span class="n">apkPath</span> <span class="o">+</span> <span class="s">&#34; (at &#34;</span> <span class="o">+</span> <span class="n">parser</span><span class="o">.</span><span class="na">getPositionDescription</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;): &#34;</span> <span class="o">+</span> <span class="n">outError</span><span class="o">[</span><span class="n">0</span><span class="o">]);</span>
        <span class="o">}</span>

        <span class="n">pkg</span><span class="o">.</span><span class="na">setVolumeUuid</span><span class="o">(</span><span class="n">volumeUuid</span><span class="o">);</span>
        <span class="n">pkg</span><span class="o">.</span><span class="na">setApplicationVolumeUuid</span><span class="o">(</span><span class="n">volumeUuid</span><span class="o">);</span>
        <span class="n">pkg</span><span class="o">.</span><span class="na">setBaseCodePath</span><span class="o">(</span><span class="n">apkPath</span><span class="o">);</span>
        <span class="n">pkg</span><span class="o">.</span><span class="na">setSigningDetails</span><span class="o">(</span><span class="n">SigningDetails</span><span class="o">.</span><span class="na">UNKNOWN</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">pkg</span><span class="o">;</span>

    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PackageParserException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">PackageParserException</span><span class="o">(</span><span class="n">INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION</span><span class="o">,</span>
                                         <span class="s">&#34;Failed to read manifest from &#34;</span> <span class="o">+</span> <span class="n">apkPath</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">parser</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">parseBaseApkChild</span><span class="o">(</span><span class="n">Package</span> <span class="n">parentPkg</span><span class="o">,</span> <span class="n">Resources</span> <span class="n">res</span><span class="o">,</span> <span class="n">XmlResourceParser</span> <span class="n">parser</span><span class="o">,</span>
                                  <span class="kt">int</span> <span class="n">flags</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">outError</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">// Make sure we have a valid child package name
</span><span class="c1"></span>    <span class="c1">// 包名
</span><span class="c1"></span>    <span class="n">String</span> <span class="n">childPackageName</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="na">getAttributeValue</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="s">&#34;package&#34;</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">validateName</span><span class="o">(</span><span class="n">childPackageName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mParseError</span> <span class="o">=</span> <span class="n">PackageManager</span><span class="o">.</span><span class="na">INSTALL_PARSE_FAILED_BAD_PACKAGE_NAME</span><span class="o">;</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Child packages must be unique
</span><span class="c1"></span>    <span class="c1">// 包名唯一
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">childPackageName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">parentPkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&#34;Child package name cannot be equal to parent package name: &#34;</span>
            <span class="o">+</span> <span class="n">parentPkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">;</span>
        <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
        <span class="n">outError</span><span class="o">[</span><span class="n">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
        <span class="n">mParseError</span> <span class="o">=</span> <span class="n">PackageManager</span><span class="o">.</span><span class="na">INSTALL_PARSE_FAILED_MANIFEST_MALFORMED</span><span class="o">;</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Child packages must be unique
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">parentPkg</span><span class="o">.</span><span class="na">hasChildPackage</span><span class="o">(</span><span class="n">childPackageName</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&#34;Duplicate child package:&#34;</span> <span class="o">+</span> <span class="n">childPackageName</span><span class="o">;</span>
        <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
        <span class="n">outError</span><span class="o">[</span><span class="n">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
        <span class="n">mParseError</span> <span class="o">=</span> <span class="n">PackageManager</span><span class="o">.</span><span class="na">INSTALL_PARSE_FAILED_MANIFEST_MALFORMED</span><span class="o">;</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Go ahead and parse the child
</span><span class="c1"></span>    <span class="n">Package</span> <span class="n">childPkg</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Package</span><span class="o">(</span><span class="n">childPackageName</span><span class="o">);</span>

    <span class="c1">// Child package inherits parent version code/name/target SDK
</span><span class="c1"></span>    <span class="c1">// 解析出：版本号、名称、SDK 版本等信息
</span><span class="c1"></span>    <span class="n">childPkg</span><span class="o">.</span><span class="na">mVersionCode</span> <span class="o">=</span> <span class="n">parentPkg</span><span class="o">.</span><span class="na">mVersionCode</span><span class="o">;</span>
    <span class="n">childPkg</span><span class="o">.</span><span class="na">baseRevisionCode</span> <span class="o">=</span> <span class="n">parentPkg</span><span class="o">.</span><span class="na">baseRevisionCode</span><span class="o">;</span>
    <span class="n">childPkg</span><span class="o">.</span><span class="na">mVersionName</span> <span class="o">=</span> <span class="n">parentPkg</span><span class="o">.</span><span class="na">mVersionName</span><span class="o">;</span>
    <span class="n">childPkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">targetSdkVersion</span> <span class="o">=</span> <span class="n">parentPkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">targetSdkVersion</span><span class="o">;</span>
    <span class="n">childPkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">minSdkVersion</span> <span class="o">=</span> <span class="n">parentPkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">minSdkVersion</span><span class="o">;</span>

    <span class="n">childPkg</span> <span class="o">=</span> <span class="n">parseBaseApkCommon</span><span class="o">(</span><span class="n">childPkg</span><span class="o">,</span> <span class="n">CHILD_PACKAGE_TAGS</span><span class="o">,</span> <span class="n">res</span><span class="o">,</span> <span class="n">parser</span><span class="o">,</span> <span class="n">flags</span><span class="o">,</span> <span class="n">outError</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">childPkg</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// If we got null then error was set during child parsing
</span><span class="c1"></span>        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Set the parent-child relation
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">parentPkg</span><span class="o">.</span><span class="na">childPackages</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">parentPkg</span><span class="o">.</span><span class="na">childPackages</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="o">}</span>
    <span class="n">parentPkg</span><span class="o">.</span><span class="na">childPackages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">childPkg</span><span class="o">);</span>
    <span class="n">childPkg</span><span class="o">.</span><span class="na">parentPackage</span> <span class="o">=</span> <span class="n">parentPkg</span><span class="o">;</span>

    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>

<h4 id="scanpackagechildli"><code>scanPackageChildLI()</code></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="nf">scanPackageChildLI</span><span class="o">(</span><span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="n">pkg</span><span class="o">,</span>
                                                 <span class="kd">final</span> <span class="nd">@ParseFlags</span> <span class="kt">int</span> <span class="n">parseFlags</span><span class="o">,</span> <span class="nd">@ScanFlags</span> <span class="kt">int</span> <span class="n">scanFlags</span><span class="o">,</span> <span class="kt">long</span> <span class="n">currentTime</span><span class="o">,</span>
                                                 <span class="nd">@Nullable</span> <span class="n">UserHandle</span> <span class="n">user</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="n">PackageManagerException</span> <span class="o">{</span>
    <span class="c1">// If the package has children and this is the first dive in the function
</span><span class="c1"></span>    <span class="c1">// we scan the package with the SCAN_CHECK_ONLY flag set to see whether all
</span><span class="c1"></span>    <span class="c1">// packages (parent and children) would be successfully scanned before the
</span><span class="c1"></span>    <span class="c1">// actual scan since scanning mutates internal state and we want to atomically
</span><span class="c1"></span>    <span class="c1">// install the package and its children.
</span><span class="c1"></span>    <span class="c1">// 如果有子包，第一次只确保扫描到所有子包但不解析，因为解析会改变包的状态
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">((</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_CHECK_ONLY</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">childPackages</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">pkg</span><span class="o">.</span><span class="na">childPackages</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">scanFlags</span> <span class="o">|=</span> <span class="n">SCAN_CHECK_ONLY</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">scanFlags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCAN_CHECK_ONLY</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Scan the parent
</span><span class="c1"></span>    <span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="n">scannedPkg</span> <span class="o">=</span> <span class="n">addForInitLI</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">parseFlags</span><span class="o">,</span>
                                                    <span class="n">scanFlags</span><span class="o">,</span> <span class="n">currentTime</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>

    <span class="c1">// Scan the children
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">childCount</span> <span class="o">=</span> <span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">childPackages</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">pkg</span><span class="o">.</span><span class="na">childPackages</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">:</span> <span class="n">0</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">childCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="n">childPackage</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">childPackages</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="n">addForInitLI</span><span class="o">(</span><span class="n">childPackage</span><span class="o">,</span> <span class="n">parseFlags</span><span class="o">,</span> <span class="n">scanFlags</span><span class="o">,</span>
                     <span class="n">currentTime</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="k">if</span> <span class="o">((</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_CHECK_ONLY</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 第二次进入改方法，解析所有包
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">scanPackageChildLI</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">parseFlags</span><span class="o">,</span> <span class="n">scanFlags</span><span class="o">,</span> <span class="n">currentTime</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">scannedPkg</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<ul>
<li><p><code>addForInitLI()</code></p>

<p>这个方法比较长，主要作用是把扫描到的应用包信息存储到 <code>PackageManagerService</code> ，由于以后查询， <code>Intent</code> 行为主要依赖次信息库；在此过程中也会附加检查,如果包与先前已知的包相同，则发生基本验证[例如确保匹配签名，检查版本代码等]。 如果程序包未通过签名检查，则将删除 <code>/data</code> 上安装的版本。 如果新软件包的版本小于或等于 <code>/data</code> 上的版本，则将忽略它。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="nf">addForInitLI</span><span class="o">(</span><span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="n">pkg</span><span class="o">,</span>
                                           <span class="nd">@ParseFlags</span> <span class="kt">int</span> <span class="n">parseFlags</span><span class="o">,</span> <span class="nd">@ScanFlags</span> <span class="kt">int</span> <span class="n">scanFlags</span><span class="o">,</span> <span class="kt">long</span> <span class="n">currentTime</span><span class="o">,</span>
                                           <span class="nd">@Nullable</span> <span class="n">UserHandle</span> <span class="n">user</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="n">PackageManagerException</span> <span class="o">{</span>
    <span class="c1">// 系统内置的即非  data 分区
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">scanSystemPartition</span> <span class="o">=</span> <span class="o">(</span><span class="n">parseFlags</span> <span class="o">&amp;</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">PARSE_IS_SYSTEM_DIR</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">renamedPkgName</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">PackageSetting</span> <span class="n">disabledPkgSetting</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isSystemPkgUpdated</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">pkgAlreadyExists</span><span class="o">;</span>
    <span class="n">PackageSetting</span> <span class="n">pkgSetting</span><span class="o">;</span>

    <span class="c1">// NOTE: installPackageLI() has the same code to setup the package&#39;s
</span><span class="c1"></span>    <span class="c1">// application info. This probably should be done lower in the call
</span><span class="c1"></span>    <span class="c1">// stack [such as scanPackageOnly()]. However, we verify the application
</span><span class="c1"></span>    <span class="c1">// info prior to that [in scanPackageNew()] and thus have to setup
</span><span class="c1"></span>    <span class="c1">// the application info early.
</span><span class="c1"></span>    <span class="n">pkg</span><span class="o">.</span><span class="na">setApplicationVolumeUuid</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">volumeUuid</span><span class="o">);</span>
    <span class="n">pkg</span><span class="o">.</span><span class="na">setApplicationInfoCodePath</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">codePath</span><span class="o">);</span>
    <span class="n">pkg</span><span class="o">.</span><span class="na">setApplicationInfoBaseCodePath</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">baseCodePath</span><span class="o">);</span>
    <span class="n">pkg</span><span class="o">.</span><span class="na">setApplicationInfoSplitCodePaths</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">splitCodePaths</span><span class="o">);</span>
    <span class="n">pkg</span><span class="o">.</span><span class="na">setApplicationInfoResourcePath</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">codePath</span><span class="o">);</span>
    <span class="n">pkg</span><span class="o">.</span><span class="na">setApplicationInfoBaseResourcePath</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">baseCodePath</span><span class="o">);</span>
    <span class="n">pkg</span><span class="o">.</span><span class="na">setApplicationInfoSplitResourcePaths</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">splitCodePaths</span><span class="o">);</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mPackages</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 获取自首次安装以来已重命名的软件包的原始包名。 键是包的新名称，值是原始名称。
</span><span class="c1"></span>        <span class="n">renamedPkgName</span> <span class="o">=</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">getRenamedPackageLPr</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">mRealPackage</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">String</span> <span class="n">realPkgName</span> <span class="o">=</span> <span class="n">getRealPackageName</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">renamedPkgName</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">realPkgName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 更改为原始包名
</span><span class="c1"></span>            <span class="n">ensurePackageRenamed</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">renamedPkgName</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//获取原始包配置，原始包必须以相同的方式签名，且必须具有相同的名称和共享用户[如果有]。
</span><span class="c1"></span>        <span class="kd">final</span> <span class="n">PackageSetting</span> <span class="n">originalPkgSetting</span> <span class="o">=</span> <span class="n">getOriginalPackageLocked</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">renamedPkgName</span><span class="o">);</span>
        <span class="c1">// 获取当前包配置
</span><span class="c1"></span>        <span class="kd">final</span> <span class="n">PackageSetting</span> <span class="n">installedPkgSetting</span> <span class="o">=</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">getPackageLPr</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">);</span>
        <span class="n">pkgSetting</span> <span class="o">=</span> <span class="n">originalPkgSetting</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">installedPkgSetting</span> <span class="o">:</span> <span class="n">originalPkgSetting</span><span class="o">;</span>
        <span class="c1">// 判断当前应用包是否已经存在
</span><span class="c1"></span>        <span class="n">pkgAlreadyExists</span> <span class="o">=</span> <span class="n">pkgSetting</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kd">final</span> <span class="n">String</span> <span class="n">disabledPkgName</span> <span class="o">=</span> <span class="n">pkgAlreadyExists</span> <span class="o">?</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">name</span> <span class="o">:</span> <span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">;</span>
        <span class="c1">// 获取被当前应用包替换的系统应用包配置
</span><span class="c1"></span>        <span class="n">disabledPkgSetting</span> <span class="o">=</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">getDisabledSystemPkgLPr</span><span class="o">(</span><span class="n">disabledPkgName</span><span class="o">);</span>
        <span class="c1">// 是否是系统应用的升级包
</span><span class="c1"></span>        <span class="n">isSystemPkgUpdated</span> <span class="o">=</span> <span class="n">disabledPkgSetting</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="kd">final</span> <span class="n">SharedUserSetting</span> <span class="n">sharedUserSetting</span> <span class="o">=</span> <span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">mSharedUserId</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="o">?</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">getSharedUserLPw</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">mSharedUserId</span><span class="o">,</span>
                                         <span class="n">0</span> <span class="cm">/*pkgFlags*/</span><span class="o">,</span> <span class="n">0</span> <span class="cm">/*pkgPrivateFlags*/</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>
            <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">scanSystemPartition</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Potentially prune child packages. If the application on the /system
</span><span class="c1"></span>            <span class="c1">// partition has been updated via OTA, but, is still disabled by a
</span><span class="c1"></span>            <span class="c1">// version on /data, cycle through all of its children packages and
</span><span class="c1"></span>            <span class="c1">// remove children that are no longer defined.
</span><span class="c1"></span>            <span class="c1">// 如果 /system 分区上的应用程序已通过  OTA 更新，但仍然被 /data 上的版本禁用，则循环遍历其所有子程序包并删除不再定义的子项。
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">isSystemPkgUpdated</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="kt">int</span> <span class="n">scannedChildCount</span> <span class="o">=</span> <span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">childPackages</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="o">?</span> <span class="n">pkg</span><span class="o">.</span><span class="na">childPackages</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">:</span> <span class="n">0</span><span class="o">;</span>
                <span class="kd">final</span> <span class="kt">int</span> <span class="n">disabledChildCount</span> <span class="o">=</span> <span class="n">disabledPkgSetting</span><span class="o">.</span><span class="na">childPackageNames</span> <span class="o">!=</span> <span class="kc">null</span>
                    <span class="o">?</span> <span class="n">disabledPkgSetting</span><span class="o">.</span><span class="na">childPackageNames</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">:</span> <span class="n">0</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">disabledChildCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">String</span> <span class="n">disabledChildPackageName</span> <span class="o">=</span>
                        <span class="n">disabledPkgSetting</span><span class="o">.</span><span class="na">childPackageNames</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                    <span class="kt">boolean</span> <span class="n">disabledPackageAvailable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">scannedChildCount</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                        <span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="n">childPkg</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">childPackages</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">childPkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">disabledChildPackageName</span><span class="o">))</span> <span class="o">{</span>
                            <span class="n">disabledPackageAvailable</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">disabledPackageAvailable</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">mSettings</span><span class="o">.</span><span class="na">removeDisabledSystemPackageLPw</span><span class="o">(</span><span class="n">disabledChildPackageName</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="c1">// we&#39;re updating the disabled package, so, scan it as the package setting
</span><span class="c1"></span>                <span class="kd">final</span> <span class="n">ScanRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ScanRequest</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">sharedUserSetting</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
                                                            <span class="n">disabledPkgSetting</span> <span class="cm">/* pkgSetting */</span><span class="o">,</span> <span class="kc">null</span> <span class="cm">/* disabledPkgSetting */</span><span class="o">,</span>
                                                            <span class="kc">null</span> <span class="cm">/* originalPkgSetting */</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">parseFlags</span><span class="o">,</span> <span class="n">scanFlags</span><span class="o">,</span>
                                                            <span class="o">(</span><span class="n">pkg</span> <span class="o">==</span> <span class="n">mPlatformPackage</span><span class="o">),</span> <span class="n">user</span><span class="o">);</span>
                <span class="n">applyPolicy</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">parseFlags</span><span class="o">,</span> <span class="n">scanFlags</span><span class="o">,</span> <span class="n">mPlatformPackage</span><span class="o">);</span>
                <span class="n">scanPackageOnlyLI</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">mFactoryTest</span><span class="o">,</span> <span class="o">-</span><span class="n">1L</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// 新包安装路径是否改变
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">newPkgChangedPaths</span> <span class="o">=</span>
        <span class="n">pkgAlreadyExists</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pkgSetting</span><span class="o">.</span><span class="na">codePathString</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">codePath</span><span class="o">);</span>
    <span class="c1">// 新包版本是否升级
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">newPkgVersionGreater</span> <span class="o">=</span>
        <span class="n">pkgAlreadyExists</span> <span class="o">&amp;&amp;</span> <span class="n">pkg</span><span class="o">.</span><span class="na">getLongVersionCode</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">versionCode</span><span class="o">;</span>
    <span class="c1">// 系统包是否有升级
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isSystemPkgBetter</span> <span class="o">=</span> <span class="n">scanSystemPartition</span> <span class="o">&amp;&amp;</span> <span class="n">isSystemPkgUpdated</span>
        <span class="o">&amp;&amp;</span> <span class="n">newPkgChangedPaths</span> <span class="o">&amp;&amp;</span> <span class="n">newPkgVersionGreater</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isSystemPkgBetter</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// The version of the application on /system is greater than the version on
</span><span class="c1"></span>        <span class="c1">// /data. Switch back to the application on /system.
</span><span class="c1"></span>        <span class="c1">// It&#39;s safe to assume the application on /system will correctly scan. If not,
</span><span class="c1"></span>        <span class="c1">// there won&#39;t be a working copy of the application.
</span><span class="c1"></span>        <span class="c1">// /system 上的应用程序版本大于 /data 上的版本。 切换回 /system 上的应用程序。
</span><span class="c1"></span>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mPackages</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// just remove the loaded entries from package lists
</span><span class="c1"></span>            <span class="n">mPackages</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">pkgSetting</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">final</span> <span class="n">InstallArgs</span> <span class="n">args</span> <span class="o">=</span> <span class="n">createInstallArgsForExisting</span><span class="o">(</span>
                                                              <span class="n">packageFlagsToInstallFlags</span><span class="o">(</span><span class="n">pkgSetting</span><span class="o">),</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">codePathString</span><span class="o">,</span>
                                                              <span class="n">pkgSetting</span><span class="o">.</span><span class="na">resourcePathString</span><span class="o">,</span> <span class="n">getAppDexInstructionSets</span><span class="o">(</span><span class="n">pkgSetting</span><span class="o">));</span>
        <span class="c1">// 清理资源文件
</span><span class="c1"></span>        <span class="n">args</span><span class="o">.</span><span class="na">cleanUpResourcesLI</span><span class="o">();</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mPackages</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 重新启用系统分区上的应用包
</span><span class="c1"></span>            <span class="n">mSettings</span><span class="o">.</span><span class="na">enableSystemPackageLPw</span><span class="o">(</span><span class="n">pkgSetting</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">scanSystemPartition</span> <span class="o">&amp;&amp;</span> <span class="n">isSystemPkgUpdated</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isSystemPkgBetter</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// The version of the application on the /system partition is less than or
</span><span class="c1"></span>        <span class="c1">// equal to the version on the /data partition. Even though the disabled system package
</span><span class="c1"></span>        <span class="c1">// is likely to be replaced by a version on the /data partition, we make assumptions
</span><span class="c1"></span>        <span class="c1">// that it&#39;s part of the mPackages collection during package manager initialization. So,
</span><span class="c1"></span>        <span class="c1">// add it to mPackages if there isn&#39;t already a package in the collection and then throw
</span><span class="c1"></span>        <span class="c1">// an exception to use the application already installed on the /data partition.
</span><span class="c1"></span>        <span class="c1">// /system 分区上的应用程序版本小于或等于 /data 分区上的版本。仍然使用 /data 分区上的版本，但仍将改包加入到应用管理器
</span><span class="c1"></span>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mPackages</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">mPackages</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">mPackages</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">pkg</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// Verify certificates against what was last scanned. If it is an updated priv app, we will
</span><span class="c1"></span>    <span class="c1">// force re-collecting certificate.
</span><span class="c1"></span>    <span class="c1">// 根据上次扫描的内容验证证书。 如果它是更新  priv-app 下的应用程序，我们将强制重新收集证书。
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">forceCollect</span> <span class="o">=</span> <span class="n">PackageManagerServiceUtils</span><span class="o">.</span><span class="na">isApkVerificationForced</span><span class="o">(</span>
                                                                                    <span class="n">disabledPkgSetting</span><span class="o">);</span>
    <span class="c1">// Full APK verification can be skipped during certificate collection, only if the file is
</span><span class="c1"></span>    <span class="c1">// in verified partition, or can be verified on access (when apk verity is enabled). In both
</span><span class="c1"></span>    <span class="c1">// cases, only data in Signing Block is verified instead of the whole file.
</span><span class="c1"></span>    <span class="c1">// 只有当文件位于已验证的分区中，或者可以在访问时验证（apk 启用访问验证时），
</span><span class="c1"></span>    <span class="c1">//才能在证书收集期间跳过完整的  APK 验证。 在这两种情况下，仅验证签名块中的数据而不是整个文件。
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">skipVerify</span> <span class="o">=</span> <span class="o">((</span><span class="n">parseFlags</span> <span class="o">&amp;</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">PARSE_IS_SYSTEM_DIR</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">||</span>
        <span class="o">(</span><span class="n">forceCollect</span> <span class="o">&amp;&amp;</span> <span class="n">canSkipFullPackageVerification</span><span class="o">(</span><span class="n">pkg</span><span class="o">));</span>
    <span class="n">collectCertificatesLI</span><span class="o">(</span><span class="n">pkgSetting</span><span class="o">,</span> <span class="n">pkg</span><span class="o">,</span> <span class="n">forceCollect</span><span class="o">,</span> <span class="n">skipVerify</span><span class="o">);</span>

    <span class="c1">// Reset profile if the application version is changed
</span><span class="c1"></span>    <span class="n">maybeClearProfilesForUpgradesLI</span><span class="o">(</span><span class="n">pkgSetting</span><span class="o">,</span> <span class="n">pkg</span><span class="o">);</span>

    <span class="cm">/*
</span><span class="cm">     * A new system app appeared, but we already had a non-system one of the
</span><span class="cm">     * same name installed earlier.
</span><span class="cm">     */</span>
    <span class="c1">// 出现了一个新的系统应用程序，但我们之前已经安装了一个同名的非系统应用程序。
</span><span class="c1"></span>    <span class="kt">boolean</span> <span class="n">shouldHideSystemApp</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="c1">// A new application appeared on /system, but, we already have a copy of
</span><span class="c1"></span>    <span class="c1">// the application installed on /data.
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">scanSystemPartition</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isSystemPkgUpdated</span> <span class="o">&amp;&amp;</span> <span class="n">pkgAlreadyExists</span>
        <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pkgSetting</span><span class="o">.</span><span class="na">isSystem</span><span class="o">())</span> <span class="o">{</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">pkg</span><span class="o">.</span><span class="na">mSigningDetails</span><span class="o">.</span><span class="na">checkCapability</span><span class="o">(</span><span class="n">pkgSetting</span><span class="o">.</span><span class="na">signatures</span><span class="o">.</span><span class="na">mSigningDetails</span><span class="o">,</span>
                                                 <span class="n">PackageParser</span><span class="o">.</span><span class="na">SigningDetails</span><span class="o">.</span><span class="na">CertCapabilities</span><span class="o">.</span><span class="na">INSTALLED_DATA</span><span class="o">)</span>
            <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pkgSetting</span><span class="o">.</span><span class="na">signatures</span><span class="o">.</span><span class="na">mSigningDetails</span><span class="o">.</span><span class="na">checkCapability</span><span class="o">(</span>
                                                                      <span class="n">pkg</span><span class="o">.</span><span class="na">mSigningDetails</span><span class="o">,</span>
                                                                      <span class="n">PackageParser</span><span class="o">.</span><span class="na">SigningDetails</span><span class="o">.</span><span class="na">CertCapabilities</span><span class="o">.</span><span class="na">ROLLBACK</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// 签名不匹配，删除改包
</span><span class="c1"></span>            <span class="k">try</span> <span class="o">(</span><span class="n">PackageFreezer</span> <span class="n">freezer</span> <span class="o">=</span> <span class="n">freezePackage</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span>
                                                        <span class="s">&#34;scanPackageInternalLI&#34;</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">deletePackageLIF</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">pkgSetting</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">newPkgVersionGreater</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// The application on /system is newer than the application on /data.
</span><span class="c1"></span>            <span class="c1">// Simply remove the application on /data [keeping application data]
</span><span class="c1"></span>            <span class="c1">// and replace it with the version on /system.
</span><span class="c1"></span>            <span class="c1">// 系统新包版本更高，移除 /data 上的应用包但保留应用数据
</span><span class="c1"></span>            <span class="n">InstallArgs</span> <span class="n">args</span> <span class="o">=</span> <span class="n">createInstallArgsForExisting</span><span class="o">(</span>
                                                            <span class="n">packageFlagsToInstallFlags</span><span class="o">(</span><span class="n">pkgSetting</span><span class="o">),</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">codePathString</span><span class="o">,</span>
                                                            <span class="n">pkgSetting</span><span class="o">.</span><span class="na">resourcePathString</span><span class="o">,</span> <span class="n">getAppDexInstructionSets</span><span class="o">(</span><span class="n">pkgSetting</span><span class="o">));</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mInstallLock</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">args</span><span class="o">.</span><span class="na">cleanUpResourcesLI</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// The application on /system is older than the application on /data. Hide
</span><span class="c1"></span>            <span class="c1">// the application on /system and the version on /data will be scanned later
</span><span class="c1"></span>            <span class="c1">// and re-added like an update.
</span><span class="c1"></span>            <span class="c1">// /system 上的应用程序比 /data 上的应用程序旧。 隐藏 /system 上的应用程序，稍后将扫描 /data 上的版本，并像更新一样重新添加。
</span><span class="c1"></span>            <span class="n">shouldHideSystemApp</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// 下一步 &lt;2&gt;
</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="n">scannedPkg</span> <span class="o">=</span> <span class="n">scanPackageNewLI</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">parseFlags</span><span class="o">,</span> <span class="n">scanFlags</span>
                                                              <span class="o">|</span> <span class="n">SCAN_UPDATE_SIGNATURE</span><span class="o">,</span> <span class="n">currentTime</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">shouldHideSystemApp</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mPackages</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 停用需要隐藏的系统包
</span><span class="c1"></span>            <span class="n">mSettings</span><span class="o">.</span><span class="na">disableSystemPackageLPw</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">scannedPkg</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>scanPackageNewLI()</code></p>

<p>这个方法主要是有新应用包时（比如  ota 引入）确认是否要替换原应用包</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@GuardedBy</span><span class="o">(</span><span class="s">&#34;mInstallLock&#34;</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="nf">scanPackageNewLI</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="n">pkg</span><span class="o">,</span>
                                               <span class="kd">final</span> <span class="nd">@ParseFlags</span> <span class="kt">int</span> <span class="n">parseFlags</span><span class="o">,</span> <span class="nd">@ScanFlags</span> <span class="kt">int</span> <span class="n">scanFlags</span><span class="o">,</span> <span class="kt">long</span> <span class="n">currentTime</span><span class="o">,</span>
                                               <span class="nd">@Nullable</span> <span class="n">UserHandle</span> <span class="n">user</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">PackageManagerException</span> <span class="o">{</span>

    <span class="kd">final</span> <span class="n">String</span> <span class="n">renamedPkgName</span> <span class="o">=</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">getRenamedPackageLPr</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">mRealPackage</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">realPkgName</span> <span class="o">=</span> <span class="n">getRealPackageName</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">renamedPkgName</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">realPkgName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ensurePackageRenamed</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">renamedPkgName</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">final</span> <span class="n">PackageSetting</span> <span class="n">originalPkgSetting</span> <span class="o">=</span> <span class="n">getOriginalPackageLocked</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">renamedPkgName</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">PackageSetting</span> <span class="n">pkgSetting</span> <span class="o">=</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">getPackageLPr</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">PackageSetting</span> <span class="n">disabledPkgSetting</span> <span class="o">=</span>
        <span class="n">mSettings</span><span class="o">.</span><span class="na">getDisabledSystemPkgLPr</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">);</span>
    <span class="c1">// 调整扫描参数
</span><span class="c1"></span>    <span class="n">scanFlags</span> <span class="o">=</span> <span class="n">adjustScanFlags</span><span class="o">(</span><span class="n">scanFlags</span><span class="o">,</span> <span class="n">pkgSetting</span><span class="o">,</span> <span class="n">disabledPkgSetting</span><span class="o">,</span> <span class="n">user</span><span class="o">,</span> <span class="n">pkg</span><span class="o">);</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mPackages</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 根据给定的策略标志将策略应用于已解析的包。
</span><span class="c1"></span>        <span class="n">applyPolicy</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">parseFlags</span><span class="o">,</span> <span class="n">scanFlags</span><span class="o">,</span> <span class="n">mPlatformPackage</span><span class="o">);</span>
        <span class="c1">// 断言解析的包根据给定的策略有效。 如果包无效，无论出于何种原因，抛出  PackageManagerException。
</span><span class="c1"></span>        <span class="n">assertPackageIsValid</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">parseFlags</span><span class="o">,</span> <span class="n">scanFlags</span><span class="o">);</span>

        <span class="n">SharedUserSetting</span> <span class="n">sharedUserSetting</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">mSharedUserId</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// SIDE EFFECTS; may potentially allocate a new shared user
</span><span class="c1"></span>            <span class="c1">// 如果不存在则新建
</span><span class="c1"></span>            <span class="n">sharedUserSetting</span> <span class="o">=</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">getSharedUserLPw</span><span class="o">(</span>
                                                           <span class="n">pkg</span><span class="o">.</span><span class="na">mSharedUserId</span><span class="o">,</span> <span class="n">0</span> <span class="cm">/*pkgFlags*/</span><span class="o">,</span> <span class="n">0</span> <span class="cm">/*pkgPrivateFlags*/</span><span class="o">,</span> <span class="kc">true</span> <span class="cm">/*create*/</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kt">boolean</span> <span class="n">scanSucceeded</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">ScanRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ScanRequest</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">sharedUserSetting</span><span class="o">,</span>
                                                        <span class="n">pkgSetting</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">pkg</span><span class="o">,</span> <span class="n">pkgSetting</span><span class="o">,</span> <span class="n">disabledPkgSetting</span><span class="o">,</span>
                                                        <span class="n">originalPkgSetting</span><span class="o">,</span> <span class="n">realPkgName</span><span class="o">,</span> <span class="n">parseFlags</span><span class="o">,</span> <span class="n">scanFlags</span><span class="o">,</span>
                                                        <span class="o">(</span><span class="n">pkg</span> <span class="o">==</span> <span class="n">mPlatformPackage</span><span class="o">),</span> <span class="n">user</span><span class="o">);</span>
            <span class="c1">// 前面主要是解析  AndroidManifest.xm 获取应用的基本信息;同时确定应用使用的版本
</span><span class="c1"></span>            <span class="c1">// 这个方法将解析四大组件相关信息，并储存以供以后查询，比如  Intent 相关 &lt;3&gt;
</span><span class="c1"></span>            <span class="kd">final</span> <span class="n">ScanResult</span> <span class="n">result</span> <span class="o">=</span> <span class="n">scanPackageOnlyLI</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">mFactoryTest</span><span class="o">,</span> <span class="n">currentTime</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">success</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 提交结果 &lt;4&gt;
</span><span class="c1"></span>                <span class="n">commitScanResultsLocked</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">scanSucceeded</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">scanSucceeded</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_DELETE_DATA_ON_FAILURES</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// DELETE_DATA_ON_FAILURES is only used by frozen paths
</span><span class="c1"></span>                <span class="c1">// 失败则清理无效数据
</span><span class="c1"></span>                <span class="n">destroyAppDataLIF</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_ALL</span><span class="o">,</span>
                                  <span class="n">StorageManager</span><span class="o">.</span><span class="na">FLAG_STORAGE_DE</span> <span class="o">|</span> <span class="n">StorageManager</span><span class="o">.</span><span class="na">FLAG_STORAGE_CE</span><span class="o">);</span>
                <span class="n">destroyAppProfilesLIF</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_ALL</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">pkg</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>scanPackageOnlyLI()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@GuardedBy</span><span class="o">(</span><span class="s">&#34;mInstallLock&#34;</span><span class="o">)</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="nd">@NonNull</span> <span class="n">ScanResult</span> <span class="nf">scanPackageOnlyLI</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">ScanRequest</span> <span class="n">request</span><span class="o">,</span>
                                                     <span class="kt">boolean</span> <span class="n">isUnderFactoryTest</span><span class="o">,</span> <span class="kt">long</span> <span class="n">currentTime</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="n">PackageManagerException</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="n">pkg</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">pkg</span><span class="o">;</span>
    <span class="n">PackageSetting</span> <span class="n">pkgSetting</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">pkgSetting</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">PackageSetting</span> <span class="n">disabledPkgSetting</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">disabledPkgSetting</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">PackageSetting</span> <span class="n">originalPkgSetting</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">originalPkgSetting</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nd">@ParseFlags</span> <span class="kt">int</span> <span class="n">parseFlags</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">parseFlags</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nd">@ScanFlags</span> <span class="kt">int</span> <span class="n">scanFlags</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">scanFlags</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">realPkgName</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">realPkgName</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">SharedUserSetting</span> <span class="n">sharedUserSetting</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">sharedUserSetting</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">UserHandle</span> <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">user</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isPlatformPackage</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">isPlatformPackage</span><span class="o">;</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">changedAbiCodePath</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="n">DexManager</span><span class="o">.</span><span class="na">maybeLogUnexpectedPackageDetails</span><span class="o">(</span><span class="n">pkg</span><span class="o">);</span>

    <span class="c1">// Initialize package source and resource directories
</span><span class="c1"></span>    <span class="c1">// 初始化资源、源码目录
</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">File</span> <span class="n">scanFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">codePath</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">File</span> <span class="n">destCodeFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">getCodePath</span><span class="o">());</span>
    <span class="kd">final</span> <span class="n">File</span> <span class="n">destResourceFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">getResourcePath</span><span class="o">());</span>

    <span class="c1">// We keep references to the derived CPU Abis from settings in oder to reuse
</span><span class="c1"></span>    <span class="c1">// them in the case where we&#39;re not upgrading or booting for the first time.
</span><span class="c1"></span>    <span class="c1">// 如果不是系统升级或首次开机可以使用以前保存的  CPU Abis 的引用
</span><span class="c1"></span>    <span class="n">String</span> <span class="n">primaryCpuAbiFromSettings</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">String</span> <span class="n">secondaryCpuAbiFromSettings</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="c1">// 需要生成  abi 引用
</span><span class="c1"></span>    <span class="kt">boolean</span> <span class="n">needToDeriveAbi</span> <span class="o">=</span> <span class="o">(</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_FIRST_BOOT_OR_UPGRADE</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">needToDeriveAbi</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 不需要生成  abi 引用时，确保是否有旧的存在，没有则要生成
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">pkgSetting</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">primaryCpuAbiFromSettings</span> <span class="o">=</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">primaryCpuAbiString</span><span class="o">;</span>
            <span class="n">secondaryCpuAbiFromSettings</span> <span class="o">=</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">secondaryCpuAbiString</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// Re-scanning a system package after uninstalling updates; need to derive ABI
</span><span class="c1"></span>            <span class="n">needToDeriveAbi</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// sharedUser 不一致，需要重新生成  PackageSetting
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">pkgSetting</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">sharedUser</span> <span class="o">!=</span> <span class="n">sharedUserSetting</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">PackageManagerService</span><span class="o">.</span><span class="na">reportSettingsProblem</span><span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">WARN</span><span class="o">,</span>
                                                    <span class="s">&#34;Package &#34;</span> <span class="o">+</span> <span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span> <span class="o">+</span> <span class="s">&#34; shared user changed from &#34;</span>
                                                    <span class="o">+</span> <span class="o">(</span><span class="n">pkgSetting</span><span class="o">.</span><span class="na">sharedUser</span> <span class="o">!=</span> <span class="kc">null</span>
                                                       <span class="o">?</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">sharedUser</span><span class="o">.</span><span class="na">name</span> <span class="o">:</span> <span class="s">&#34;&lt;nothing&gt;&#34;</span><span class="o">)</span>
                                                    <span class="o">+</span> <span class="s">&#34; to &#34;</span>
                                                    <span class="o">+</span> <span class="o">(</span><span class="n">sharedUserSetting</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">sharedUserSetting</span><span class="o">.</span><span class="na">name</span> <span class="o">:</span> <span class="s">&#34;&lt;nothing&gt;&#34;</span><span class="o">)</span>
                                                    <span class="o">+</span> <span class="s">&#34;; replacing with new&#34;</span><span class="o">);</span>
        <span class="n">pkgSetting</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">String</span><span class="o">[]</span> <span class="n">usesStaticLibraries</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">usesStaticLibraries</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">usesStaticLibraries</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">pkg</span><span class="o">.</span><span class="na">usesStaticLibraries</span><span class="o">.</span><span class="na">size</span><span class="o">()];</span>
        <span class="n">pkg</span><span class="o">.</span><span class="na">usesStaticLibraries</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="n">usesStaticLibraries</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 更新  PackageSetting 没有则要生成
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">createNewPackage</span> <span class="o">=</span> <span class="o">(</span><span class="n">pkgSetting</span> <span class="o">==</span> <span class="kc">null</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">createNewPackage</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">String</span> <span class="n">parentPackageName</span> <span class="o">=</span> <span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">parentPackage</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="o">?</span> <span class="n">pkg</span><span class="o">.</span><span class="na">parentPackage</span><span class="o">.</span><span class="na">packageName</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">instantApp</span> <span class="o">=</span> <span class="o">(</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_AS_INSTANT_APP</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">virtualPreload</span> <span class="o">=</span> <span class="o">(</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_AS_VIRTUAL_PRELOAD</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">;</span>
        <span class="c1">// REMOVE SharedUserSetting from method; update in a separate call
</span><span class="c1"></span>        <span class="n">pkgSetting</span> <span class="o">=</span> <span class="n">Settings</span><span class="o">.</span><span class="na">createNewSetting</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">originalPkgSetting</span><span class="o">,</span>
                                               <span class="n">disabledPkgSetting</span><span class="o">,</span> <span class="n">realPkgName</span><span class="o">,</span> <span class="n">sharedUserSetting</span><span class="o">,</span> <span class="n">destCodeFile</span><span class="o">,</span>
                                               <span class="n">destResourceFile</span><span class="o">,</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">nativeLibraryRootDir</span><span class="o">,</span>
                                               <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">primaryCpuAbi</span><span class="o">,</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">secondaryCpuAbi</span><span class="o">,</span>
                                               <span class="n">pkg</span><span class="o">.</span><span class="na">mVersionCode</span><span class="o">,</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">flags</span><span class="o">,</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">privateFlags</span><span class="o">,</span>
                                               <span class="n">user</span><span class="o">,</span> <span class="kc">true</span> <span class="cm">/*allowInstall*/</span><span class="o">,</span> <span class="n">instantApp</span><span class="o">,</span> <span class="n">virtualPreload</span><span class="o">,</span>
                                               <span class="n">parentPackageName</span><span class="o">,</span> <span class="n">pkg</span><span class="o">.</span><span class="na">getChildPackageNames</span><span class="o">(),</span>
                                               <span class="n">UserManagerService</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(),</span> <span class="n">usesStaticLibraries</span><span class="o">,</span>
                                               <span class="n">pkg</span><span class="o">.</span><span class="na">usesStaticLibrariesVersions</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// REMOVE SharedUserSetting from method; update in a separate call.
</span><span class="c1"></span>        <span class="c1">//
</span><span class="c1"></span>        <span class="c1">// TODO(narayan): This update is bogus. nativeLibraryDir &amp; primaryCpuAbi,
</span><span class="c1"></span>        <span class="c1">// secondaryCpuAbi are not known at this point so we always update them
</span><span class="c1"></span>        <span class="c1">// to null here, only to reset them at a later point.
</span><span class="c1"></span>        <span class="n">Settings</span><span class="o">.</span><span class="na">updatePackageSetting</span><span class="o">(</span><span class="n">pkgSetting</span><span class="o">,</span> <span class="n">disabledPkgSetting</span><span class="o">,</span> <span class="n">sharedUserSetting</span><span class="o">,</span>
                                      <span class="n">destCodeFile</span><span class="o">,</span> <span class="n">destResourceFile</span><span class="o">,</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">nativeLibraryDir</span><span class="o">,</span>
                                      <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">primaryCpuAbi</span><span class="o">,</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">secondaryCpuAbi</span><span class="o">,</span>
                                      <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">flags</span><span class="o">,</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">privateFlags</span><span class="o">,</span>
                                      <span class="n">pkg</span><span class="o">.</span><span class="na">getChildPackageNames</span><span class="o">(),</span> <span class="n">UserManagerService</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(),</span>
                                      <span class="n">usesStaticLibraries</span><span class="o">,</span> <span class="n">pkg</span><span class="o">.</span><span class="na">usesStaticLibrariesVersions</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">createNewPackage</span> <span class="o">&amp;&amp;</span> <span class="n">originalPkgSetting</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// This is the initial transition from the original package, so,
</span><span class="c1"></span>        <span class="c1">// fix up the new package&#39;s name now. We must do this after looking
</span><span class="c1"></span>        <span class="c1">// up the package under its new name, so getPackageLP takes care of
</span><span class="c1"></span>        <span class="c1">// fiddling things correctly.
</span><span class="c1"></span>        <span class="n">pkg</span><span class="o">.</span><span class="na">setPackageName</span><span class="o">(</span><span class="n">originalPkgSetting</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>

        <span class="c1">// File a report about this.
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">&#34;New package &#34;</span> <span class="o">+</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">realName</span>
            <span class="o">+</span> <span class="s">&#34; renamed to replace old package &#34;</span> <span class="o">+</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">name</span><span class="o">;</span>
        <span class="n">reportSettingsProblem</span><span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">WARN</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="kt">int</span> <span class="n">userId</span> <span class="o">=</span> <span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_SYSTEM</span> <span class="o">:</span> <span class="n">user</span><span class="o">.</span><span class="na">getIdentifier</span><span class="o">());</span>
    <span class="c1">// for existing packages, change the install state; but, only if it&#39;s explicitly specified
</span><span class="c1"></span>    <span class="c1">// 更改已存在应用包的安装状态
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(!</span><span class="n">createNewPackage</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">instantApp</span> <span class="o">=</span> <span class="o">(</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_AS_INSTANT_APP</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">fullApp</span> <span class="o">=</span> <span class="o">(</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_AS_FULL_APP</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">;</span>
        <span class="n">setInstantAppForUser</span><span class="o">(</span><span class="n">pkgSetting</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span> <span class="n">instantApp</span><span class="o">,</span> <span class="n">fullApp</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">disabledPkgSetting</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">flags</span> <span class="o">|=</span> <span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">FLAG_UPDATED_SYSTEM_APP</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Apps which share a sharedUserId must be placed in the same selinux domain. If this
</span><span class="c1"></span>    <span class="c1">// package is the first app installed as this shared user, set seInfoTargetSdkVersion to its
</span><span class="c1"></span>    <span class="c1">// targetSdkVersion. These are later adjusted in PackageManagerService&#39;s constructor to be
</span><span class="c1"></span>    <span class="c1">// the lowest targetSdkVersion of all apps within the shared user, which corresponds to the
</span><span class="c1"></span>    <span class="c1">// least restrictive selinux domain.
</span><span class="c1"></span>    <span class="c1">// NOTE: As new packages are installed / updated, the shared user&#39;s seinfoTargetSdkVersion
</span><span class="c1"></span>    <span class="c1">// will NOT be modified until next boot, even if a lower targetSdkVersion is used. This
</span><span class="c1"></span>    <span class="c1">// ensures that all packages continue to run in the same selinux domain.
</span><span class="c1"></span>    <span class="c1">// 共享  sharedUserId 的应用必须放在同一个  selinux 域中。 如果此程序包是作为此共享用户安装的第一个应用程序，
</span><span class="c1"></span>    <span class="c1">// 请将  seInfoTargetSdkVersion 设置为其  targetSdkVersion。 这些稍后在  PackageManagerService 的构造函
</span><span class="c1"></span>    <span class="c1">// 数中调整为共享用户中所有应用程序的最低  targetSdkVersion，这对应于限制性最小的  selinux 域。
</span><span class="c1"></span>    <span class="c1">// 注意：在安装/更新新软件包时，即使使用较低的  targetSdkVersion，共享用户的  seinfoTargetSdkVersion
</span><span class="c1"></span>    <span class="c1">// 也不会被修改，直到下次引导。 这可确保所有包继续在同一  selinux 域中运行。
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">targetSdkVersion</span> <span class="o">=</span>
        <span class="o">((</span><span class="n">sharedUserSetting</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">sharedUserSetting</span><span class="o">.</span><span class="na">packages</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">!=</span> <span class="n">0</span><span class="o">))</span> <span class="o">?</span>
        <span class="n">sharedUserSetting</span><span class="o">.</span><span class="na">seInfoTargetSdkVersion</span> <span class="o">:</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">targetSdkVersion</span><span class="o">;</span>
    <span class="c1">// TODO(b/71593002): isPrivileged for sharedUser and appInfo should never be out of sync.
</span><span class="c1"></span>    <span class="c1">// They currently can be if the sharedUser apps are signed with the platform key.
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isPrivileged</span> <span class="o">=</span> <span class="o">(</span><span class="n">sharedUserSetting</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span>
        <span class="n">sharedUserSetting</span><span class="o">.</span><span class="na">isPrivileged</span><span class="o">()</span> <span class="o">|</span> <span class="n">pkg</span><span class="o">.</span><span class="na">isPrivileged</span><span class="o">()</span> <span class="o">:</span> <span class="n">pkg</span><span class="o">.</span><span class="na">isPrivileged</span><span class="o">();</span>

    <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">seInfo</span> <span class="o">=</span> <span class="n">SELinuxMMAC</span><span class="o">.</span><span class="na">getSeInfo</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">isPrivileged</span><span class="o">,</span>
                                                       <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">targetSandboxVersion</span><span class="o">,</span> <span class="n">targetSdkVersion</span><span class="o">);</span>
    <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">seInfoUser</span> <span class="o">=</span> <span class="n">SELinuxUtil</span><span class="o">.</span><span class="na">assignSeinfoUser</span><span class="o">(</span><span class="n">pkgSetting</span><span class="o">.</span><span class="na">readUserState</span><span class="o">(</span>
                                                                                           <span class="n">userId</span> <span class="o">==</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_ALL</span> <span class="o">?</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_SYSTEM</span> <span class="o">:</span> <span class="n">userId</span><span class="o">));</span>

    <span class="n">pkg</span><span class="o">.</span><span class="na">mExtras</span> <span class="o">=</span> <span class="n">pkgSetting</span><span class="o">;</span>
    <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">processName</span> <span class="o">=</span> <span class="n">fixProcessName</span><span class="o">(</span>
                                                     <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span>
                                                     <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">processName</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">isPlatformPackage</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Get all of our default paths setup
</span><span class="c1"></span>        <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">initForUser</span><span class="o">(</span><span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_SYSTEM</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 更新  abi 引用
</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">String</span> <span class="n">cpuAbiOverride</span> <span class="o">=</span> <span class="n">deriveAbiOverride</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">cpuAbiOverride</span><span class="o">,</span> <span class="n">pkgSetting</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">((</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_NEW_INSTALL</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">needToDeriveAbi</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="o">,</span> <span class="s">&#34;derivePackageAbi&#34;</span><span class="o">);</span>
            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">extractNativeLibs</span> <span class="o">=</span> <span class="o">!</span><span class="n">pkg</span><span class="o">.</span><span class="na">isLibrary</span><span class="o">();</span>
            <span class="n">derivePackageAbi</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">cpuAbiOverride</span><span class="o">,</span> <span class="n">extractNativeLibs</span><span class="o">);</span>
            <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="o">);</span>

            <span class="c1">// Some system apps still use directory structure for native libraries
</span><span class="c1"></span>            <span class="c1">// in which case we might end up not detecting abi solely based on apk
</span><span class="c1"></span>            <span class="c1">// structure. Try to detect abi based on directory structure.
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">isSystemApp</span><span class="o">(</span><span class="n">pkg</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pkg</span><span class="o">.</span><span class="na">isUpdatedSystemApp</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
                <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">primaryCpuAbi</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">setBundledAppAbisAndRoots</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">pkgSetting</span><span class="o">);</span>
                <span class="n">setNativeLibraryPaths</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">sAppLib32InstallDir</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// This is not a first boot or an upgrade, don&#39;t bother deriving the
</span><span class="c1"></span>            <span class="c1">// ABI during the scan. Instead, trust the value that was stored in the
</span><span class="c1"></span>            <span class="c1">// package setting.
</span><span class="c1"></span>            <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">primaryCpuAbi</span> <span class="o">=</span> <span class="n">primaryCpuAbiFromSettings</span><span class="o">;</span>
            <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">secondaryCpuAbi</span> <span class="o">=</span> <span class="n">secondaryCpuAbiFromSettings</span><span class="o">;</span>

            <span class="n">setNativeLibraryPaths</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">sAppLib32InstallDir</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_ABI_SELECTION</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Using ABIS and native lib paths from settings : &#34;</span> <span class="o">+</span>
                       <span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span> <span class="o">+</span> <span class="s">&#34; &#34;</span> <span class="o">+</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">primaryCpuAbi</span> <span class="o">+</span> <span class="s">&#34;, &#34;</span> <span class="o">+</span>
                       <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">secondaryCpuAbi</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_MOVE</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// We haven&#39;t run dex-opt for this move (since we&#39;ve moved the compiled output too)
</span><span class="c1"></span>            <span class="c1">// but we already have this packages package info in the PackageSetting. We just
</span><span class="c1"></span>            <span class="c1">// use that and derive the native library path based on the new codepath.
</span><span class="c1"></span>            <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">primaryCpuAbi</span> <span class="o">=</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">primaryCpuAbiString</span><span class="o">;</span>
            <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">secondaryCpuAbi</span> <span class="o">=</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">secondaryCpuAbiString</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// Set native library paths again. For moves, the path will be updated based on the
</span><span class="c1"></span>        <span class="c1">// ABIs we&#39;ve determined above. For non-moves, the path will be updated based on the
</span><span class="c1"></span>        <span class="c1">// ABIs we determined during compilation, but the path will depend on the final
</span><span class="c1"></span>        <span class="c1">// package path (after the rename away from the stage path).
</span><span class="c1"></span>        <span class="n">setNativeLibraryPaths</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">sAppLib32InstallDir</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// This is a special case for the &#34;system&#34; package, where the ABI is
</span><span class="c1"></span>    <span class="c1">// dictated by the zygote configuration (and init.rc). We should keep track
</span><span class="c1"></span>    <span class="c1">// of this ABI so that we can deal with &#34;normal&#34; applications that run under
</span><span class="c1"></span>    <span class="c1">// the same UID correctly.
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">isPlatformPackage</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">primaryCpuAbi</span> <span class="o">=</span> <span class="n">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">is64Bit</span><span class="o">()</span> <span class="o">?</span>
            <span class="n">Build</span><span class="o">.</span><span class="na">SUPPORTED_64_BIT_ABIS</span><span class="o">[</span><span class="n">0</span><span class="o">]</span> <span class="o">:</span> <span class="n">Build</span><span class="o">.</span><span class="na">SUPPORTED_32_BIT_ABIS</span><span class="o">[</span><span class="n">0</span><span class="o">];</span>
    <span class="o">}</span>

    <span class="c1">// If there&#39;s a mismatch between the abi-override in the package setting
</span><span class="c1"></span>    <span class="c1">// and the abiOverride specified for the install. Warn about this because we
</span><span class="c1"></span>    <span class="c1">// would&#39;ve already compiled the app without taking the package setting into
</span><span class="c1"></span>    <span class="c1">// account.
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">((</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_NO_DEX</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_NEW_INSTALL</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cpuAbiOverride</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Ignoring persisted ABI override &#34;</span> <span class="o">+</span> <span class="n">cpuAbiOverride</span> <span class="o">+</span>
                   <span class="s">&#34; for package &#34;</span> <span class="o">+</span> <span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">pkgSetting</span><span class="o">.</span><span class="na">primaryCpuAbiString</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">primaryCpuAbi</span><span class="o">;</span>
    <span class="n">pkgSetting</span><span class="o">.</span><span class="na">secondaryCpuAbiString</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">secondaryCpuAbi</span><span class="o">;</span>
    <span class="n">pkgSetting</span><span class="o">.</span><span class="na">cpuAbiOverrideString</span> <span class="o">=</span> <span class="n">cpuAbiOverride</span><span class="o">;</span>

    <span class="c1">// Copy the derived override back to the parsed package, so that we can
</span><span class="c1"></span>    <span class="c1">// update the package settings accordingly.
</span><span class="c1"></span>    <span class="n">pkg</span><span class="o">.</span><span class="na">cpuAbiOverride</span> <span class="o">=</span> <span class="n">cpuAbiOverride</span><span class="o">;</span>

    <span class="c1">// Push the derived path down into PackageSettings so we know what to
</span><span class="c1"></span>    <span class="c1">// clean up at uninstall time.
</span><span class="c1"></span>    <span class="n">pkgSetting</span><span class="o">.</span><span class="na">legacyNativeLibraryPathString</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">nativeLibraryRootDir</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">((</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_BOOTING</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">sharedUser</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// We don&#39;t do this here during boot because we can do it all
</span><span class="c1"></span>        <span class="c1">// at once after scanning all existing packages.
</span><span class="c1"></span>        <span class="c1">//
</span><span class="c1"></span>        <span class="c1">// We also do this *before* we perform dexopt on this package, so that
</span><span class="c1"></span>        <span class="c1">// we can avoid redundant dexopts, and also to make sure we&#39;ve got the
</span><span class="c1"></span>        <span class="c1">// code and package path correct.
</span><span class="c1"></span>        <span class="n">changedAbiCodePath</span> <span class="o">=</span>
            <span class="n">adjustCpuAbisForSharedUserLPw</span><span class="o">(</span><span class="n">pkgSetting</span><span class="o">.</span><span class="na">sharedUser</span><span class="o">.</span><span class="na">packages</span><span class="o">,</span> <span class="n">pkg</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">isUnderFactoryTest</span> <span class="o">&amp;&amp;</span> <span class="n">pkg</span><span class="o">.</span><span class="na">requestedPermissions</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span>
                                                                <span class="n">android</span><span class="o">.</span><span class="na">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">FACTORY_TEST</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">flags</span> <span class="o">|=</span> <span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">FLAG_FACTORY_TEST</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">isSystemApp</span><span class="o">(</span><span class="n">pkg</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">pkgSetting</span><span class="o">.</span><span class="na">isOrphaned</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Take care of first install / last update times.
</span><span class="c1"></span>    <span class="c1">// 记录首次安装时间和最后更新时间
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">long</span> <span class="n">scanFileTime</span> <span class="o">=</span> <span class="n">getLastModifiedTime</span><span class="o">(</span><span class="n">pkg</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">currentTime</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pkgSetting</span><span class="o">.</span><span class="na">firstInstallTime</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">pkgSetting</span><span class="o">.</span><span class="na">firstInstallTime</span> <span class="o">=</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">lastUpdateTime</span> <span class="o">=</span> <span class="n">currentTime</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_UPDATE_TIME</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">pkgSetting</span><span class="o">.</span><span class="na">lastUpdateTime</span> <span class="o">=</span> <span class="n">currentTime</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">pkgSetting</span><span class="o">.</span><span class="na">firstInstallTime</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// We need *something*.  Take time time stamp of the file.
</span><span class="c1"></span>        <span class="n">pkgSetting</span><span class="o">.</span><span class="na">firstInstallTime</span> <span class="o">=</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">lastUpdateTime</span> <span class="o">=</span> <span class="n">scanFileTime</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">parseFlags</span> <span class="o">&amp;</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">PARSE_IS_SYSTEM_DIR</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">scanFileTime</span> <span class="o">!=</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">timeStamp</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// A package on the system image has changed; consider this
</span><span class="c1"></span>            <span class="c1">// to be an update.
</span><span class="c1"></span>            <span class="n">pkgSetting</span><span class="o">.</span><span class="na">lastUpdateTime</span> <span class="o">=</span> <span class="n">scanFileTime</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">pkgSetting</span><span class="o">.</span><span class="na">setTimeStamp</span><span class="o">(</span><span class="n">scanFileTime</span><span class="o">);</span>

    <span class="n">pkgSetting</span><span class="o">.</span><span class="na">pkg</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">;</span>
    <span class="n">pkgSetting</span><span class="o">.</span><span class="na">pkgFlags</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">flags</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">getLongVersionCode</span><span class="o">()</span> <span class="o">!=</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">versionCode</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">pkgSetting</span><span class="o">.</span><span class="na">versionCode</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">getLongVersionCode</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// Update volume if needed
</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">String</span> <span class="n">volumeUuid</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">volumeUuid</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">volumeUuid</span><span class="o">,</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">volumeUuid</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">PackageManagerService</span><span class="o">.</span><span class="na">TAG</span><span class="o">,</span>
               <span class="s">&#34;Update&#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">pkgSetting</span><span class="o">.</span><span class="na">isSystem</span><span class="o">()</span> <span class="o">?</span> <span class="s">&#34; system&#34;</span> <span class="o">:</span> <span class="s">&#34;&#34;</span><span class="o">)</span>
               <span class="o">+</span> <span class="s">&#34; package &#34;</span> <span class="o">+</span> <span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span>
               <span class="o">+</span> <span class="s">&#34; volume from &#34;</span> <span class="o">+</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">volumeUuid</span>
               <span class="o">+</span> <span class="s">&#34; to &#34;</span> <span class="o">+</span> <span class="n">volumeUuid</span><span class="o">);</span>
        <span class="n">pkgSetting</span><span class="o">.</span><span class="na">volumeUuid</span> <span class="o">=</span> <span class="n">volumeUuid</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">ScanResult</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">pkgSetting</span><span class="o">,</span> <span class="n">changedAbiCodePath</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>commitScanResultsLocked()</code></p>

<p>提交包扫描并修改系统状态。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@GuardedBy</span><span class="o">(</span><span class="s">&#34;mPackages&#34;</span><span class="o">)</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">commitScanResultsLocked</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">ScanRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="n">ScanResult</span> <span class="n">result</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="n">PackageManagerException</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="n">pkg</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">pkg</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="n">oldPkg</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">oldPkg</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nd">@ParseFlags</span> <span class="kt">int</span> <span class="n">parseFlags</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">parseFlags</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nd">@ScanFlags</span> <span class="kt">int</span> <span class="n">scanFlags</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">scanFlags</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">PackageSetting</span> <span class="n">oldPkgSetting</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">oldPkgSetting</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">PackageSetting</span> <span class="n">originalPkgSetting</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">originalPkgSetting</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">PackageSetting</span> <span class="n">disabledPkgSetting</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">disabledPkgSetting</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">UserHandle</span> <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">user</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">realPkgName</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">realPkgName</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">PackageSetting</span> <span class="n">pkgSetting</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">pkgSetting</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">changedAbiCodePath</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">changedAbiCodePath</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">newPkgSettingCreated</span> <span class="o">=</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">pkgSetting</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="na">pkgSetting</span><span class="o">);</span>
    <span class="c1">// 新旧包  sharedUser 不一致
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">newPkgSettingCreated</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">originalPkgSetting</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mSettings</span><span class="o">.</span><span class="na">addRenamedPackageLPw</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">originalPkgSetting</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 新建用户
</span><span class="c1"></span>        <span class="n">mSettings</span><span class="o">.</span><span class="na">addUserToSettingLPw</span><span class="o">(</span><span class="n">pkgSetting</span><span class="o">);</span>
        <span class="c1">// 原应用包数据传给新包，原包数据将不会保留
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">originalPkgSetting</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_CHECK_ONLY</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mTransferedPackages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">originalPkgSetting</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">uid</span> <span class="o">=</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">appId</span><span class="o">;</span>
    <span class="c1">// 更新用户状态
</span><span class="c1"></span>    <span class="n">mSettings</span><span class="o">.</span><span class="na">writeUserRestrictionsLPw</span><span class="o">(</span><span class="n">pkgSetting</span><span class="o">,</span> <span class="n">oldPkgSetting</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">((</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_CHECK_ONLY</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">realPkgName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mTransferedPackages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">((</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_BOOTING</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span>
        <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">parseFlags</span> <span class="o">&amp;</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">PARSE_IS_SYSTEM_DIR</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Check all shared libraries and map to their actual file path.
</span><span class="c1"></span>        <span class="c1">// We only do this here for apps not on a system dir, because those
</span><span class="c1"></span>        <span class="c1">// are the only ones that can fail an install due to this.  We
</span><span class="c1"></span>        <span class="c1">// will take care of the system apps by updating all of their
</span><span class="c1"></span>        <span class="c1">// library paths after the scan is done. Also during the initial
</span><span class="c1"></span>        <span class="c1">// scan don&#39;t update any libs as we do this wholesale after all
</span><span class="c1"></span>        <span class="c1">// apps are scanned to avoid dependency based scanning.
</span><span class="c1"></span>        <span class="c1">// 检查所有非系统目录上的共享库并映射到它们的实际文件路径。
</span><span class="c1"></span>        <span class="n">updateSharedLibrariesLPr</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// All versions of a static shared library are referenced with the same
</span><span class="c1"></span>    <span class="c1">// package name. Internally, we use a synthetic package name to allow
</span><span class="c1"></span>    <span class="c1">// multiple versions of the same shared library to be installed. So,
</span><span class="c1"></span>    <span class="c1">// we need to generate the synthetic package name of the latest shared
</span><span class="c1"></span>    <span class="c1">// library in order to compare signatures.
</span><span class="c1"></span>    <span class="c1">// 使用相同的包名称引用静态共享库的所有版本。 在内部，我们使用合成包名称来允许安装同一共享库的多个版本。
</span><span class="c1"></span>    <span class="c1">// 因此，我们需要生成最新共享库的合成包名称，以便比较签名。
</span><span class="c1"></span>    <span class="c1">// 以下处理应用包的签名信息
</span><span class="c1"></span>    <span class="n">PackageSetting</span> <span class="n">signatureCheckPs</span> <span class="o">=</span> <span class="n">pkgSetting</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">isStaticSharedLibrary</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">SharedLibraryEntry</span> <span class="n">libraryEntry</span> <span class="o">=</span> <span class="n">getLatestSharedLibraVersionLPr</span><span class="o">(</span><span class="n">pkg</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">libraryEntry</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">signatureCheckPs</span> <span class="o">=</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">getPackageLPr</span><span class="o">(</span><span class="n">libraryEntry</span><span class="o">.</span><span class="na">apk</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="n">KeySetManagerService</span> <span class="n">ksms</span> <span class="o">=</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">mKeySetManagerService</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">ksms</span><span class="o">.</span><span class="na">shouldCheckUpgradeKeySetLocked</span><span class="o">(</span><span class="n">signatureCheckPs</span><span class="o">,</span> <span class="n">scanFlags</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ksms</span><span class="o">.</span><span class="na">checkUpgradeKeySetLocked</span><span class="o">(</span><span class="n">signatureCheckPs</span><span class="o">,</span> <span class="n">pkg</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// We just determined the app is signed correctly, so bring
</span><span class="c1"></span>            <span class="c1">// over the latest parsed certs.
</span><span class="c1"></span>            <span class="n">pkgSetting</span><span class="o">.</span><span class="na">signatures</span><span class="o">.</span><span class="na">mSigningDetails</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">mSigningDetails</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">parseFlags</span> <span class="o">&amp;</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">PARSE_IS_SYSTEM_DIR</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">PackageManagerException</span><span class="o">(</span><span class="n">INSTALL_FAILED_UPDATE_INCOMPATIBLE</span><span class="o">,</span>
                                                  <span class="s">&#34;Package &#34;</span> <span class="o">+</span> <span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span> <span class="o">+</span> <span class="s">&#34; upgrade keys do not match the &#34;</span>
                                                  <span class="o">+</span> <span class="s">&#34;previously installed version&#34;</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">pkgSetting</span><span class="o">.</span><span class="na">signatures</span><span class="o">.</span><span class="na">mSigningDetails</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">mSigningDetails</span><span class="o">;</span>
                <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">&#34;System package &#34;</span> <span class="o">+</span> <span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span>
                    <span class="o">+</span> <span class="s">&#34; signature changed; retaining data.&#34;</span><span class="o">;</span>
                <span class="n">reportSettingsProblem</span><span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">WARN</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">compareCompat</span> <span class="o">=</span> <span class="n">isCompatSignatureUpdateNeeded</span><span class="o">(</span><span class="n">pkg</span><span class="o">);</span>
            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">compareRecover</span> <span class="o">=</span> <span class="n">isRecoverSignatureUpdateNeeded</span><span class="o">(</span><span class="n">pkg</span><span class="o">);</span>
            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">compatMatch</span> <span class="o">=</span> <span class="n">verifySignatures</span><span class="o">(</span><span class="n">signatureCheckPs</span><span class="o">,</span> <span class="n">disabledPkgSetting</span><span class="o">,</span>
                                                         <span class="n">pkg</span><span class="o">.</span><span class="na">mSigningDetails</span><span class="o">,</span> <span class="n">compareCompat</span><span class="o">,</span> <span class="n">compareRecover</span><span class="o">);</span>
            <span class="c1">// The new KeySets will be re-added later in the scanning process.
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">compatMatch</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mPackages</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">ksms</span><span class="o">.</span><span class="na">removeAppKeySetDataLPw</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">// We just determined the app is signed correctly, so bring
</span><span class="c1"></span>            <span class="c1">// over the latest parsed certs.
</span><span class="c1"></span>            <span class="n">pkgSetting</span><span class="o">.</span><span class="na">signatures</span><span class="o">.</span><span class="na">mSigningDetails</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">mSigningDetails</span><span class="o">;</span>


            <span class="c1">// if this is is a sharedUser, check to see if the new package is signed by a newer
</span><span class="c1"></span>            <span class="c1">// signing certificate than the existing one, and if so, copy over the new details
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">signatureCheckPs</span><span class="o">.</span><span class="na">sharedUser</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">mSigningDetails</span><span class="o">.</span><span class="na">hasAncestor</span><span class="o">(</span>
                                                    <span class="n">signatureCheckPs</span><span class="o">.</span><span class="na">sharedUser</span><span class="o">.</span><span class="na">signatures</span><span class="o">.</span><span class="na">mSigningDetails</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">signatureCheckPs</span><span class="o">.</span><span class="na">sharedUser</span><span class="o">.</span><span class="na">signatures</span><span class="o">.</span><span class="na">mSigningDetails</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">mSigningDetails</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">signatureCheckPs</span><span class="o">.</span><span class="na">sharedUser</span><span class="o">.</span><span class="na">signaturesChanged</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">signatureCheckPs</span><span class="o">.</span><span class="na">sharedUser</span><span class="o">.</span><span class="na">signaturesChanged</span> <span class="o">=</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PackageManagerException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">parseFlags</span> <span class="o">&amp;</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">PARSE_IS_SYSTEM_DIR</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// The signature has changed, but this package is in the system
</span><span class="c1"></span>            <span class="c1">// image...  let&#39;s recover!
</span><span class="c1"></span>            <span class="n">pkgSetting</span><span class="o">.</span><span class="na">signatures</span><span class="o">.</span><span class="na">mSigningDetails</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">mSigningDetails</span><span class="o">;</span>

            <span class="c1">// If the system app is part of a shared user we allow that shared user to change
</span><span class="c1"></span>            <span class="c1">// signatures as well as part of an OTA. We still need to verify that the signatures
</span><span class="c1"></span>            <span class="c1">// are consistent within the shared user for a given boot, so only allow updating
</span><span class="c1"></span>            <span class="c1">// the signatures on the first package scanned for the shared user (i.e. if the
</span><span class="c1"></span>            <span class="c1">// signaturesChanged state hasn&#39;t been initialized yet in SharedUserSetting).
</span><span class="c1"></span>            <span class="c1">// OTA 更改了签名信息，更新签名信息
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">signatureCheckPs</span><span class="o">.</span><span class="na">sharedUser</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">signatureCheckPs</span><span class="o">.</span><span class="na">sharedUser</span><span class="o">.</span><span class="na">signaturesChanged</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="n">compareSignatures</span><span class="o">(</span>
                                      <span class="n">signatureCheckPs</span><span class="o">.</span><span class="na">sharedUser</span><span class="o">.</span><span class="na">signatures</span><span class="o">.</span><span class="na">mSigningDetails</span><span class="o">.</span><span class="na">signatures</span><span class="o">,</span>
                                      <span class="n">pkg</span><span class="o">.</span><span class="na">mSigningDetails</span><span class="o">.</span><span class="na">signatures</span><span class="o">)</span> <span class="o">!=</span> <span class="n">PackageManager</span><span class="o">.</span><span class="na">SIGNATURE_MATCH</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">PackageManagerException</span><span class="o">(</span>
                                                      <span class="n">INSTALL_PARSE_FAILED_INCONSISTENT_CERTIFICATES</span><span class="o">,</span>
                                                      <span class="s">&#34;Signature mismatch for shared user: &#34;</span> <span class="o">+</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">sharedUser</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="n">signatureCheckPs</span><span class="o">.</span><span class="na">sharedUser</span><span class="o">.</span><span class="na">signatures</span><span class="o">.</span><span class="na">mSigningDetails</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">mSigningDetails</span><span class="o">;</span>
                <span class="n">signatureCheckPs</span><span class="o">.</span><span class="na">sharedUser</span><span class="o">.</span><span class="na">signaturesChanged</span> <span class="o">=</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// File a report about this.
</span><span class="c1"></span>            <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">&#34;System package &#34;</span> <span class="o">+</span> <span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span>
                <span class="o">+</span> <span class="s">&#34; signature changed; retaining data.&#34;</span><span class="o">;</span>
            <span class="n">reportSettingsProblem</span><span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">WARN</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalArgumentException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// 权限相关
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">((</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_CHECK_ONLY</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">pkg</span><span class="o">.</span><span class="na">mAdoptPermissions</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// This package wants to adopt ownership of permissions from
</span><span class="c1"></span>        <span class="c1">// another package.
</span><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">mAdoptPermissions</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">String</span> <span class="n">origName</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">mAdoptPermissions</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="kd">final</span> <span class="n">PackageSetting</span> <span class="n">orig</span> <span class="o">=</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">getPackageLPr</span><span class="o">(</span><span class="n">origName</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">orig</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">verifyPackageUpdateLPr</span><span class="o">(</span><span class="n">orig</span><span class="o">,</span> <span class="n">pkg</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Adopting permissions from &#34;</span> <span class="o">+</span> <span class="n">origName</span> <span class="o">+</span> <span class="s">&#34; to &#34;</span>
                           <span class="o">+</span> <span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">);</span>
                    <span class="n">mSettings</span><span class="o">.</span><span class="na">mPermissions</span><span class="o">.</span><span class="na">transferPermissions</span><span class="o">(</span><span class="n">origName</span><span class="o">,</span> <span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// 处理  cpu abi
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">changedAbiCodePath</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">changedAbiCodePath</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">changedAbiCodePath</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">;</span> <span class="o">--</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">String</span> <span class="n">codePathString</span> <span class="o">=</span> <span class="n">changedAbiCodePath</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">mInstaller</span><span class="o">.</span><span class="na">rmdex</span><span class="o">(</span><span class="n">codePathString</span><span class="o">,</span>
                                 <span class="n">getDexCodeInstructionSet</span><span class="o">(</span><span class="n">getPreferredInstructionSet</span><span class="o">()));</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InstallerException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">((</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_CHECK_ONLY</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">oldPkgSetting</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mPackages</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mSettings</span><span class="o">.</span><span class="na">mPackages</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">oldPkgSetting</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">oldPkgSetting</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">user</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">0</span> <span class="o">:</span> <span class="n">user</span><span class="o">.</span><span class="na">getIdentifier</span><span class="o">();</span>
        <span class="c1">// Modify state for the given package setting
</span><span class="c1"></span>        <span class="c1">// 提交扫描结果到  PackageManagerService
</span><span class="c1"></span>        <span class="n">commitPackageSettings</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">oldPkg</span><span class="o">,</span> <span class="n">pkgSetting</span><span class="o">,</span> <span class="n">user</span><span class="o">,</span> <span class="n">scanFlags</span><span class="o">,</span>
                              <span class="o">(</span><span class="n">parseFlags</span> <span class="o">&amp;</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">PARSE_CHATTY</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span> <span class="cm">/*chatty*/</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pkgSetting</span><span class="o">.</span><span class="na">getInstantApp</span><span class="o">(</span><span class="n">userId</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">mInstantAppRegistry</span><span class="o">.</span><span class="na">addInstantAppLPw</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">pkgSetting</span><span class="o">.</span><span class="na">appId</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>commitPackageSettings()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">commitPackageSettings</span><span class="o">(</span><span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="n">pkg</span><span class="o">,</span>
                                   <span class="nd">@Nullable</span> <span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="n">oldPkg</span><span class="o">,</span> <span class="n">PackageSetting</span> <span class="n">pkgSetting</span><span class="o">,</span> <span class="n">UserHandle</span> <span class="n">user</span><span class="o">,</span>
                                   <span class="kd">final</span> <span class="nd">@ScanFlags</span> <span class="kt">int</span> <span class="n">scanFlags</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">chatty</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">pkgName</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">;</span>
    <span class="c1">// mCustomResolverComponentName 定义于：R.string.config_customResolverActivity
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">mCustomResolverComponentName</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
        <span class="n">mCustomResolverComponentName</span><span class="o">.</span><span class="na">getPackageName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// 用自定义的替换默认的  ResolverActivity；前面说过  ResolverActivity 的用处
</span><span class="c1"></span>        <span class="c1">// Intent 有多个匹配项时，展示这些匹配项供用户选择一个
</span><span class="c1"></span>        <span class="n">setUpCustomResolverActivity</span><span class="o">(</span><span class="n">pkg</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 处理特殊包名：android
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;android&#34;</span><span class="o">))</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mPackages</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_CHECK_ONLY</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Set up information for our fall-back user intent resolution activity.
</span><span class="c1"></span>                <span class="c1">// 系统应用包
</span><span class="c1"></span>                <span class="n">mPlatformPackage</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">;</span>
                <span class="n">pkg</span><span class="o">.</span><span class="na">mVersionCode</span> <span class="o">=</span> <span class="n">mSdkVersion</span><span class="o">;</span>
                <span class="n">pkg</span><span class="o">.</span><span class="na">mVersionCodeMajor</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                <span class="n">mAndroidApplication</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">;</span>
                <span class="c1">// 没有自定义  ResolverActivity;初始化默认  ResolverActivity
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(!</span><span class="n">mResolverReplaced</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">mResolveActivity</span><span class="o">.</span><span class="na">applicationInfo</span> <span class="o">=</span> <span class="n">mAndroidApplication</span><span class="o">;</span>
                    <span class="n">mResolveActivity</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">ResolverActivity</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
                    <span class="n">mResolveActivity</span><span class="o">.</span><span class="na">packageName</span> <span class="o">=</span> <span class="n">mAndroidApplication</span><span class="o">.</span><span class="na">packageName</span><span class="o">;</span>
                    <span class="n">mResolveActivity</span><span class="o">.</span><span class="na">processName</span> <span class="o">=</span> <span class="s">&#34;system:ui&#34;</span><span class="o">;</span>
                    <span class="n">mResolveActivity</span><span class="o">.</span><span class="na">launchMode</span> <span class="o">=</span> <span class="n">ActivityInfo</span><span class="o">.</span><span class="na">LAUNCH_MULTIPLE</span><span class="o">;</span>
                    <span class="n">mResolveActivity</span><span class="o">.</span><span class="na">documentLaunchMode</span> <span class="o">=</span> <span class="n">ActivityInfo</span><span class="o">.</span><span class="na">DOCUMENT_LAUNCH_NEVER</span><span class="o">;</span>
                    <span class="n">mResolveActivity</span><span class="o">.</span><span class="na">flags</span> <span class="o">=</span> <span class="n">ActivityInfo</span><span class="o">.</span><span class="na">FLAG_EXCLUDE_FROM_RECENTS</span><span class="o">;</span>
                    <span class="n">mResolveActivity</span><span class="o">.</span><span class="na">theme</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="na">style</span><span class="o">.</span><span class="na">Theme_Material_Dialog_Alert</span><span class="o">;</span>
                    <span class="n">mResolveActivity</span><span class="o">.</span><span class="na">exported</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="n">mResolveActivity</span><span class="o">.</span><span class="na">enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="n">mResolveActivity</span><span class="o">.</span><span class="na">resizeMode</span> <span class="o">=</span> <span class="n">ActivityInfo</span><span class="o">.</span><span class="na">RESIZE_MODE_RESIZEABLE</span><span class="o">;</span>
                    <span class="n">mResolveActivity</span><span class="o">.</span><span class="na">configChanges</span> <span class="o">=</span> <span class="n">ActivityInfo</span><span class="o">.</span><span class="na">CONFIG_SCREEN_SIZE</span>
                        <span class="o">|</span> <span class="n">ActivityInfo</span><span class="o">.</span><span class="na">CONFIG_SMALLEST_SCREEN_SIZE</span>
                        <span class="o">|</span> <span class="n">ActivityInfo</span><span class="o">.</span><span class="na">CONFIG_SCREEN_LAYOUT</span>
                        <span class="o">|</span> <span class="n">ActivityInfo</span><span class="o">.</span><span class="na">CONFIG_ORIENTATION</span>
                        <span class="o">|</span> <span class="n">ActivityInfo</span><span class="o">.</span><span class="na">CONFIG_KEYBOARD</span>
                        <span class="o">|</span> <span class="n">ActivityInfo</span><span class="o">.</span><span class="na">CONFIG_KEYBOARD_HIDDEN</span><span class="o">;</span>
                    <span class="n">mResolveInfo</span><span class="o">.</span><span class="na">activityInfo</span> <span class="o">=</span> <span class="n">mResolveActivity</span><span class="o">;</span>
                    <span class="n">mResolveInfo</span><span class="o">.</span><span class="na">priority</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                    <span class="n">mResolveInfo</span><span class="o">.</span><span class="na">preferredOrder</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                    <span class="n">mResolveInfo</span><span class="o">.</span><span class="na">match</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                    <span class="n">mResolveComponentName</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ComponentName</span><span class="o">(</span>
                                                              <span class="n">mAndroidApplication</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">mResolveActivity</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span><span class="o">&gt;</span> <span class="n">clientLibPkgs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="c1">// writer
</span><span class="c1"></span>    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mPackages</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">hasStaticSharedLibs</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

        <span class="c1">// Any app can add new static shared libraries
</span><span class="c1"></span>        <span class="c1">// 更新链接库信息
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">staticSharedLibName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Static shared libs don&#39;t allow renaming as they have synthetic package
</span><span class="c1"></span>            <span class="c1">// names to allow install of multiple versions, so use name from manifest.
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">addSharedLibraryLPw</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">pkg</span><span class="o">.</span><span class="na">staticSharedLibName</span><span class="o">,</span>
                                    <span class="n">pkg</span><span class="o">.</span><span class="na">staticSharedLibVersion</span><span class="o">,</span> <span class="n">SharedLibraryInfo</span><span class="o">.</span><span class="na">TYPE_STATIC</span><span class="o">,</span>
                                    <span class="n">pkg</span><span class="o">.</span><span class="na">manifestPackageName</span><span class="o">,</span> <span class="n">pkg</span><span class="o">.</span><span class="na">getLongVersionCode</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">hasStaticSharedLibs</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Package &#34;</span> <span class="o">+</span> <span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span> <span class="o">+</span> <span class="s">&#34; library &#34;</span>
                       <span class="o">+</span> <span class="n">pkg</span><span class="o">.</span><span class="na">staticSharedLibName</span> <span class="o">+</span> <span class="s">&#34; already exists; skipping&#34;</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// Static shared libs cannot be updated once installed since they
</span><span class="c1"></span>            <span class="c1">// use synthetic package name which includes the version code, so
</span><span class="c1"></span>            <span class="c1">// not need to update other packages&#39;s shared lib dependencies.
</span><span class="c1"></span>        <span class="o">}</span>
        <span class="c1">// 系统应用包更新时，链接库相关更新
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">hasStaticSharedLibs</span>
            <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">flags</span> <span class="o">&amp;</span> <span class="n">ApplicationInfo</span><span class="o">.</span><span class="na">FLAG_SYSTEM</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Only system apps can add new dynamic shared libraries.
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">libraryNames</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pkg</span><span class="o">.</span><span class="na">libraryNames</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">libraryNames</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                    <span class="kt">boolean</span> <span class="n">allowed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">isUpdatedSystemApp</span><span class="o">())</span> <span class="o">{</span>
                        <span class="c1">// New library entries can only be added through the
</span><span class="c1"></span>                        <span class="c1">// system image.  This is important to get rid of a lot
</span><span class="c1"></span>                        <span class="c1">// of nasty edge cases: for example if we allowed a non-
</span><span class="c1"></span>                        <span class="c1">// system update of the app to add a library, then uninstalling
</span><span class="c1"></span>                        <span class="c1">// the update would make the library go away, and assumptions
</span><span class="c1"></span>                        <span class="c1">// we made such as through app install filtering would now
</span><span class="c1"></span>                        <span class="c1">// have allowed apps on the device which aren&#39;t compatible
</span><span class="c1"></span>                        <span class="c1">// with it.  Better to just have the restriction here, be
</span><span class="c1"></span>                        <span class="c1">// conservative, and create many fewer cases that can negatively
</span><span class="c1"></span>                        <span class="c1">// impact the user experience.
</span><span class="c1"></span>                        <span class="kd">final</span> <span class="n">PackageSetting</span> <span class="n">sysPs</span> <span class="o">=</span> <span class="n">mSettings</span>
                            <span class="o">.</span><span class="na">getDisabledSystemPkgLPr</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">packageName</span><span class="o">);</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">sysPs</span><span class="o">.</span><span class="na">pkg</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">sysPs</span><span class="o">.</span><span class="na">pkg</span><span class="o">.</span><span class="na">libraryNames</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sysPs</span><span class="o">.</span><span class="na">pkg</span><span class="o">.</span><span class="na">libraryNames</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">sysPs</span><span class="o">.</span><span class="na">pkg</span><span class="o">.</span><span class="na">libraryNames</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">j</span><span class="o">)))</span> <span class="o">{</span>
                                    <span class="n">allowed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">allowed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_BOOTING</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// If we are not booting, we need to update any applications
</span><span class="c1"></span>                        <span class="c1">// that are clients of our shared library.  If we are booting,
</span><span class="c1"></span>                        <span class="c1">// this will all be done once the scan is complete.
</span><span class="c1"></span>                        <span class="n">clientLibPkgs</span> <span class="o">=</span> <span class="n">updateAllSharedLibrariesLPw</span><span class="o">(</span><span class="n">pkg</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">((</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_BOOTING</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// No apps can run during boot scan, so they don&#39;t need to be frozen
</span><span class="c1"></span>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_DONT_KILL_APP</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Caller asked to not kill app, so it&#39;s probably not frozen
</span><span class="c1"></span>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_IGNORE_FROZEN</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Caller asked us to ignore frozen check for some reason; they
</span><span class="c1"></span>            <span class="c1">// probably didn&#39;t know the package name
</span><span class="c1"></span>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// We&#39;re doing major surgery on this package, so it better be frozen
</span><span class="c1"></span>            <span class="c1">// right now to keep it from launching
</span><span class="c1"></span>            <span class="n">checkPackageFrozen</span><span class="o">(</span><span class="n">pkgName</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// Also need to kill any apps that are dependent on the library.
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">clientLibPkgs</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">clientLibPkgs</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">PackageParser</span><span class="o">.</span><span class="na">Package</span> <span class="n">clientPkg</span> <span class="o">=</span> <span class="n">clientLibPkgs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="n">killApplication</span><span class="o">(</span><span class="n">clientPkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span>
                                <span class="n">clientPkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="s">&#34;update lib&#34;</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// writer
</span><span class="c1"></span>        <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="o">,</span> <span class="s">&#34;updateSettings&#34;</span><span class="o">);</span>
        <span class="c1">// PackageManagerService 存储四大组件信息
</span><span class="c1"></span>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mPackages</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// We don&#39;t expect installation to fail beyond this point
</span><span class="c1"></span>
            <span class="c1">// Add the new setting to mSettings
</span><span class="c1"></span>            <span class="n">mSettings</span><span class="o">.</span><span class="na">insertPackageSettingLPw</span><span class="o">(</span><span class="n">pkgSetting</span><span class="o">,</span> <span class="n">pkg</span><span class="o">);</span>
            <span class="c1">// Add the new setting to mPackages
</span><span class="c1"></span>            <span class="n">mPackages</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">pkg</span><span class="o">);</span>
            <span class="c1">// Make sure we don&#39;t accidentally delete its data.
</span><span class="c1"></span>            <span class="kd">final</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">PackageCleanItem</span><span class="o">&gt;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">mPackagesToBeCleaned</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">PackageCleanItem</span> <span class="n">item</span> <span class="o">=</span> <span class="n">iter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">pkgName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">packageName</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">iter</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="c1">// Add the package&#39;s KeySets to the global KeySetManagerService
</span><span class="c1"></span>            <span class="n">KeySetManagerService</span> <span class="n">ksms</span> <span class="o">=</span> <span class="n">mSettings</span><span class="o">.</span><span class="na">mKeySetManagerService</span><span class="o">;</span>
            <span class="n">ksms</span><span class="o">.</span><span class="na">addScannedPackageLPw</span><span class="o">(</span><span class="n">pkg</span><span class="o">);</span>
            <span class="c1">// Provider
</span><span class="c1"></span>            <span class="kt">int</span> <span class="n">N</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">providers</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
            <span class="n">StringBuilder</span> <span class="n">r</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">i</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">i</span><span class="o">=</span><span class="n">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">PackageParser</span><span class="o">.</span><span class="na">Provider</span> <span class="n">p</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">providers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>

                <span class="c1">// ......
</span><span class="c1"></span>
            <span class="o">}</span>
            <span class="c1">// Service
</span><span class="c1"></span>            <span class="n">N</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">services</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
            <span class="n">r</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">i</span><span class="o">=</span><span class="n">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">PackageParser</span><span class="o">.</span><span class="na">Service</span> <span class="n">s</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">services</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="n">s</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">processName</span> <span class="o">=</span> <span class="n">fixProcessName</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span>
                                                    <span class="n">s</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">processName</span><span class="o">);</span>
                <span class="n">mServices</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">chatty</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="n">256</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">r</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39; &#39;</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">r</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">// Receiver
</span><span class="c1"></span>            <span class="n">N</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">receivers</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
            <span class="n">r</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">i</span><span class="o">=</span><span class="n">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">PackageParser</span><span class="o">.</span><span class="na">Activity</span> <span class="n">a</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">receivers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">processName</span> <span class="o">=</span> <span class="n">fixProcessName</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span>
                                                    <span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">processName</span><span class="o">);</span>
                <span class="n">mReceivers</span><span class="o">.</span><span class="na">addActivity</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">&#34;receiver&#34;</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">chatty</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="n">256</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">r</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39; &#39;</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">r</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">// Activity
</span><span class="c1"></span>            <span class="n">N</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">activities</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
            <span class="n">r</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">i</span><span class="o">=</span><span class="n">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">PackageParser</span><span class="o">.</span><span class="na">Activity</span> <span class="n">a</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">activities</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">processName</span> <span class="o">=</span> <span class="n">fixProcessName</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span>
                                                    <span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">processName</span><span class="o">);</span>
                <span class="n">mActivities</span><span class="o">.</span><span class="na">addActivity</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">&#34;activity&#34;</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">chatty</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="n">256</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">r</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39; &#39;</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">r</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">// Permission 不允许临时应用程序定义新权限和权限组。
</span><span class="c1"></span>            <span class="c1">// Don&#39;t allow ephemeral applications to define new permissions groups.
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">((</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_AS_INSTANT_APP</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">mPermissionManager</span><span class="o">.</span><span class="na">addAllPermissionGroups</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">chatty</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// Don&#39;t allow ephemeral applications to define new permissions.
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">((</span><span class="n">scanFlags</span> <span class="o">&amp;</span> <span class="n">SCAN_AS_INSTANT_APP</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">mPermissionManager</span><span class="o">.</span><span class="na">addAllPermissions</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">chatty</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// Instrumentation
</span><span class="c1"></span>            <span class="n">N</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">instrumentation</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
            <span class="n">r</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">i</span><span class="o">=</span><span class="n">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">PackageParser</span><span class="o">.</span><span class="na">Instrumentation</span> <span class="n">a</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">instrumentation</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">packageName</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">packageName</span><span class="o">;</span>
                <span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">sourceDir</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">sourceDir</span><span class="o">;</span>
                <span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">publicSourceDir</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">publicSourceDir</span><span class="o">;</span>
                <span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">splitNames</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">splitNames</span><span class="o">;</span>
                <span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">splitSourceDirs</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">splitSourceDirs</span><span class="o">;</span>
                <span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">splitPublicSourceDirs</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">splitPublicSourceDirs</span><span class="o">;</span>
                <span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">splitDependencies</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">splitDependencies</span><span class="o">;</span>
                <span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">dataDir</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">dataDir</span><span class="o">;</span>
                <span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">deviceProtectedDataDir</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">deviceProtectedDataDir</span><span class="o">;</span>
                <span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">credentialProtectedDataDir</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">credentialProtectedDataDir</span><span class="o">;</span>
                <span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">primaryCpuAbi</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">primaryCpuAbi</span><span class="o">;</span>
                <span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">secondaryCpuAbi</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">secondaryCpuAbi</span><span class="o">;</span>
                <span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">nativeLibraryDir</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">nativeLibraryDir</span><span class="o">;</span>
                <span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">secondaryNativeLibraryDir</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">secondaryNativeLibraryDir</span><span class="o">;</span>
                <span class="n">mInstrumentation</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">getComponentName</span><span class="o">(),</span> <span class="n">a</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">chatty</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="n">256</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">r</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39; &#39;</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">r</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">// Protected Broadcast
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">protectedBroadcasts</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">N</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="na">protectedBroadcasts</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mProtectedBroadcasts</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                        <span class="n">mProtectedBroadcasts</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">protectedBroadcasts</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>

        <span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">dinghmcn</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2019-04-22</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://dinghmcn.github.io/tags/android/">Android</a>
          <a href="https://dinghmcn.github.io/tags/systemserver/">SystemServer</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/packagemanagerservice3/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Android9.0 PackageManagerService 应用安装篇 （三）</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/packagemanagerservice1/">
            <span class="next-text nav-default">Android9.0 PackageManagerService 简介篇 （一）</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  
  
  

  
  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "dinghmcn/utterances"
            issue-term="pathname"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  
  
    



        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:your@email.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="stack-overflow"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M809.714286 932.571429l-638.857143 0 0-274.285714-91.428571 0 0 365.714286 821.714286 0 0-365.714286-91.428571 0 0 274.285714zm-538.285714-299.428571l18.857143-89.714286 447.428571 94.285714-18.857143 89.142857zm58.857143-213.714286l38.285714-83.428571 414.285714 193.714286-38.285714 82.857143zm114.857143-203.428571l58.285714-70.285714 350.857143 293.142857-58.285714 70.285714zm226.857143-216l272.571429 366.285714-73.142857 54.857143-272.571429-366.285714zm-410.285714 840.571429l0-90.857143 457.142857 0 0 90.857143-457.142857 0z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="twitter"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1264 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M1229.8616 18.043658c0 0-117.852626 63.135335-164.151872 67.344358-105.225559-164.151872-505.082682-92.598492-437.738325 223.078185C278.622548 312.675223 89.216542 47.506814 89.216542 47.506814s-117.852626 189.406006 75.762402 345.139833C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042C1179.353331 249.539887 1263.533778 123.269217 1263.533778 123.269217s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="facebook"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="33" height="33">
  <path d="M965.7344 2.7648c14.848 0 28.2624 5.5296 40.2432 16.6912C1017.9584 30.5152 1024 43.52 1024 58.2656l0 910.2336c0 14.848-6.0416 27.7504-18.0224 38.8096C993.8944 1018.4704 980.48 1024 965.7344 1024L704.9216 1024 704.9216 629.9648l133.2224 0 19.456-155.4432-152.576 0L705.024 373.0432c0-50.688 25.9072-76.0832 77.7216-76.0832l80.4864 0L863.232 163.5328c-27.7504-5.4272-67.4816-8.192-119.296-8.192-59.1872 0-106.8032 18.0224-142.9504 54.0672C564.736 245.5552 546.7136 296.0384 546.7136 360.7552l0 113.7664L413.4912 474.5216l0 155.4432 133.2224 0L546.7136 1024 55.5008 1024c-14.848 0-27.7504-5.5296-38.8096-16.6912C5.5296 996.2496 0 983.3472 0 968.4992L0 58.2656C0 43.52 5.5296 30.5152 16.6912 19.456c11.0592-11.0592 24.064-16.6912 38.8096-16.6912L965.7344 2.7648z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="linkedin"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="33" height="33">
  <path d="M872.405333 872.618667h-151.637333v-237.610667c0-56.661333-1.152-129.578667-79.018667-129.578667-79.061333 0-91.136 61.653333-91.136 125.397334v241.792H398.976V384h145.664v66.602667h1.962667c20.352-38.4 69.845333-78.933333 143.786666-78.933334 153.642667 0 182.058667 101.12 182.058667 232.746667v268.202667zM227.712 317.141333a87.978667 87.978667 0 0 1-88.021333-88.106666 88.064 88.064 0 1 1 88.021333 88.106666z m76.032 555.477334H151.68V384h152.064v488.618667zM948.266667 0H75.562667C33.792 0 0 33.024 0 73.770667v876.458666C0 991.018667 33.792 1024 75.562667 1024h872.576C989.866667 1024 1024 991.018667 1024 950.229333V73.770667C1024 33.024 989.866667 0 948.138667 0h0.128z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="google"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M853.333333 85.333333C900.266667 85.333333 938.666667 123.733333 938.666667 170.666667L938.666667 853.333333C938.666667 900.266667 900.266667 938.666667 853.333333 938.666667L170.666667 938.666667C123.733333 938.666667 85.333333 900.266667 85.333333 853.333333L85.333333 170.666667C85.333333 123.306667 123.733333 85.333333 170.666667 85.333333L853.333333 85.333333M853.333333 512 768 512 768 426.666667 725.333333 426.666667 725.333333 512 640 512 640 554.666667 725.333333 554.666667 725.333333 640 768 640 768 554.666667 853.333333 554.666667 853.333333 512M384 481.706667 384 554.666667 506.026667 554.666667C499.626667 584.96 469.333333 645.973333 384 645.973333 311.04 645.973333 253.013333 584.96 253.013333 512 253.013333 439.04 311.04 378.026667 384 378.026667 426.666667 378.026667 453.973333 396.373333 469.333333 411.306667L527.36 356.693333C490.666667 320 442.026667 298.666667 384 298.666667 264.96 298.666667 170.666667 392.96 170.666667 512 170.666667 631.04 264.96 725.333333 384 725.333333 506.026667 725.333333 588.373333 640 588.373333 517.973333 588.373333 503.04 588.373333 493.653333 584.96 481.706667L384 481.706667Z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="weibo"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M385.714286 733.714286q12-19.428571 6.285714-39.428571t-25.714286-28.571429q-19.428571-8-41.714286-0.571429t-34.285714 26.285714q-12.571429 19.428571-7.428571 39.142857t24.571429 28.857143 42.571429 1.428571 35.714286-27.142857zm53.714286-69.142857q4.571429-7.428571 2-15.142857t-10-10.571429q-8-2.857143-16.285714 2.857143t-12.285714 10.571429q-9.714286 17.714286 7.428571 25.714286 8 2.857143 16.571429 2.857143t12.571429-10.571429zm99.428571 61.142857q-25.714286 58.285714-90.285714 85.714286t-128 6.857143q-61.142857-19.428571-84.285714-72.285714t3.714286-107.142857q26.857143-53.142857 86.571429-79.428571t120.285714-10.857143q63.428571 16.571429 90.571429 68.285714t1.428571 108.857143zm178.285714-91.428571q-5.142857-54.857143-50.857143-97.142857t-119.142857-62.285714-156.857143-12q-127.428571 13.142857-211.142857 80.857143t-75.714286 151.142857q5.142857 54.857143 50.857143 97.142857t119.142857 62.285714 156.857143 12q127.428571-13.142857 211.142857-80.857143t75.714286-151.142857zm176 2.285714q0 38.857143-21.142857 79.714286t-62.285714 78.285714-96.285714 67.142857-129.142857 47.428571-154.571429 17.714286-157.142857-19.142857-137.428571-53.142857-98-86.285714-37.142857-114q0-65.714286 39.714286-140t112.857143-147.428571q96.571429-96.571429 195.142857-134.857143t140.857143 4q37.142857 36.571429 11.428571 119.428571-2.285714 8-0.571429 11.428571t5.714286 4 8.285714 2.857143 7.714286-2l3.428571-1.142857q79.428571-33.714286 140.571429-33.714286t87.428571 34.857143q25.714286 36 0 101.714286-1.142857 7.428571-2.571429 11.428571t2.571429 7.142857 6.857143 4.285714 9.714286 3.428571q32.571429 10.285714 58.857143 26.857143t45.714286 46.571429 19.428571 66.571429zm-42.285714-356.571429q24 26.857143 31.142857 62t-3.714286 67.142857q-4.571429 13.142857-16.857143 19.428571t-25.428571 2.285714q-13.142857-4.571429-19.428571-16.857143t-2.285714-25.428571q11.428571-36-13.714286-63.428571t-61.142857-20q-13.714286 2.857143-25.714286-4.571429t-14.285714-21.142857q-2.857143-13.714286 4.571429-25.428571t21.142857-14.571429q34.285714-7.428571 68 3.142857t57.714286 37.428571zm103.428571-93.142857q49.714286 54.857143 64.285714 127.142857t-7.714286 138q-5.142857 15.428571-19.428571 22.857143t-29.714286 2.285714-22.857143-19.428571-2.857143-29.714286q16-46.857143 5.714286-98.285714t-45.714286-90.285714q-35.428571-39.428571-84.571429-54.571429t-98.857143-4.857143q-16 3.428571-29.714286-5.428571t-17.142857-24.857143 5.428571-29.428571 24.857143-16.857143q70.285714-14.857143 139.428571 6.571429t118.857143 76.857143z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="zhihu"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M351.791182 562.469462l192.945407 0c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262l159.282726 0c0 0-0.86367-67.402109-18.578124-67.402109s-279.979646 0-279.979646 0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461c-4.536316 12.313443 24.62791 5.832845 36.941354 0 12.313443-5.832845 68.050885-25.924439 84.252893-103.69571l86.570681 0c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262L109.86113 490.530013c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449L279.868105 562.469462c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513 0 0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-0.055259 0.185218 167.855986 193.263655c0 0 22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-0.045025 0.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"></path>
  <path d="M584.918753 182.033893l0 668.840094 70.318532 0 28.807093 80.512708 121.875768-80.512708 153.600307 0L959.520453 182.033893 584.918753 182.033893zM887.150192 778.934538l-79.837326 0-99.578949 65.782216-23.537066-65.782216-24.855084 0L659.341766 256.673847l227.807403 0L887.149169 778.934538z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="douban"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M926.917973 37.80608C959.65184 37.80608 986.19392 64.34816 986.19392 97.082027L986.19392 926.917973C986.19392 959.65184 959.65184 986.19392 926.917973 986.19392L97.082027 986.19392C64.34816 986.19392 37.80608 959.65184 37.80608 926.917973L37.80608 97.082027C37.80608 64.34816 64.34816 37.80608 97.082027 37.80608zM176.653653 176.19968 176.653653 252.678827 825.658027 252.678827 825.658027 176.19968zM217.719467 316.146347 217.719467 628.08064 273.524053 628.08064 341.292373 770.39616 157.259093 770.39616 157.259093 845.417813 842.949973 845.417813 842.949973 770.39616 654.226773 770.39616 722.899627 628.08064 783.67744 628.08064 783.67744 316.146347zM684.885333 392.891733 684.885333 553.987413 312.576 553.987413 312.576 392.891733zM570.770773 770.39616 426.653013 770.39616 359.621973 628.08064 639.443627 628.08064z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="pocket"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M912.569234 73.142857a88.429714 88.429714 0 0 1 88.576 89.161143v296.557714C1001.145234 732.562286 782.301806 950.857143 510.28352 950.857143A489.837714 489.837714 0 0 1 18.288091 458.861714V162.304A90.002286 90.002286 0 0 1 107.449234 73.142857h805.156572z m-402.285714 608a68.388571 68.388571 0 0 0 46.848-18.870857l230.838857-221.696a68.022857 68.022857 0 0 0 21.138286-48.566857 67.547429 67.547429 0 0 0-114.285714-48.566857l-184.576 177.152-184.576-177.152a67.328 67.328 0 0 0-46.299429-18.870857 67.547429 67.547429 0 0 0-46.884571 116.004571l231.424 221.696c11.995429 11.995429 29.147429 18.870857 46.299428 18.870857z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="tumblr"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M556.716946 378.027729l133.939525 0 0 89.307002L556.716946 467.334731 556.716946 601.318258c0 58.898435 8.290827 92.557022 53.140291 89.809445 10.382465-0.677429 22.25077-1.855254 35.687804-5.586229 13.437034-3.729951 24.257473-7.458879 32.372292-11.190877l12.739139-5.606695 0 82.546018c-3.403516 2.070148-8.463766 4.820796-15.007809 8.048303-6.631024 3.338025-21.029966 7.656377-43.016723 13.045107-21.988804 5.41022-44.937468 8.070816-68.844971 8.070816-51.395554 0-89.177042-10.994402-113.608477-33.17968-24.343431-22.097274-27.572986-56.147788-27.572986-101.195773L422.605505 467.334731l-89.263 0-0.435928-66.64077c38.480406-12.369725 67.798129-29.734208 88.128153-52.114938 20.332071-22.273283 33.333176-57.021691 38.829354-104.22783l96.853885-0.393973L556.717969 378.027729zM958.70846 243.958244l0 536.105001c0 98.730629-80.013335 178.722474-178.615027 178.722474L243.991502 958.785719c-98.774631 0-178.700985-79.991846-178.700985-178.722474L65.290517 243.958244c0-98.642624 79.925331-178.744987 178.700985-178.744987l536.102954 0C878.695125 65.213257 958.70846 145.31562 958.70846 243.958244zM869.44546 288.612257c0-74.015737-60.033281-133.961014-134.027529-133.961014L288.667004 154.651242c-73.994248 0-134.115534 59.945277-134.115534 133.961014l0 446.775486c0 74.015737 60.121286 133.983527 134.115534 133.983527l446.750927 0c73.994248 0 134.027529-59.96779 134.027529-133.983527L869.44546 288.612257z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="instagram"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M853.333333 277.333333C853.333333 289.28 843.946667 298.666667 832 298.666667L746.666667 298.666667C734.72 298.666667 725.333333 289.28 725.333333 277.333333L725.333333 192C725.333333 180.053333 734.72 170.666667 746.666667 170.666667L832 170.666667C843.946667 170.666667 853.333333 180.053333 853.333333 192M192 853.333333C180.053333 853.333333 170.666667 843.946667 170.666667 832L170.666667 469.333333 259.84 469.333333C257.28 482.986667 256 497.493333 256 512 256 653.226667 370.773333 768 512 768 653.226667 768 768 653.226667 768 512 768 497.493333 766.293333 482.986667 764.16 469.333333L853.333333 469.333333 853.333333 832C853.333333 843.946667 843.946667 853.333333 832 853.333333M512 341.333333C606.293333 341.333333 682.666667 417.706667 682.666667 512 682.666667 606.293333 606.293333 682.666667 512 682.666667 417.706667 682.666667 341.333333 606.293333 341.333333 512 341.333333 417.706667 417.706667 341.333333 512 341.333333M853.333333 85.333333 170.666667 85.333333C123.306667 85.333333 85.333333 123.306667 85.333333 170.666667L85.333333 853.333333C85.333333 900.266667 123.733333 938.666667 170.666667 938.666667L853.333333 938.666667C900.266667 938.666667 938.666667 900.266667 938.666667 853.333333L938.666667 170.666667C938.666667 123.306667 900.266667 85.333333 853.333333 85.333333Z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="gitlab"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M59.544137 403.419429L512.115566 983.405714 16.09728 623.396571a39.936 39.936 0 0 1-14.299429-43.995428l57.709715-176.018286z m264.009143 0h377.161143L512.152137 983.405714zM210.40128 53.723429l113.152 349.696H59.544137l113.152-349.696a20.041143 20.041143 0 0 1 37.705143 0z m754.285714 349.696l57.709715 176.018285a39.862857 39.862857 0 0 1-14.299429 43.995429l-496.018286 360.009143 452.571429-579.986286z m0 0h-264.009143l113.152-349.696a20.041143 20.041143 0 0 1 37.705143 0z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="goodreads"  target="_blank"
      >
      <svg viewBox="0 0 128 128" version="1.1"
  width="32" height="32">
  <path d="M 85.685714,45.48571 C 87.142857,56.14286 84.342857,68.05714 75.428571,74.25714 69.057143,78.68571 60.342857,78.28571 55.2,75.88571 44.6,70.94286 41.057143,59.14286 41.828571,48.11429 c 1.228572,-17.4 11.685715,-25.11429 21.514286,-25 13.4,-0.0571 20.514286,9.08571 22.342857,22.37142 z M 128,16 v 96 c 0,8.82857 -7.17143,16 -16,16 H 16 C 7.1714286,128 0,120.82857 0,112 V 16 C 0,7.17143 7.1714286,0 16,0 h 96 c 8.82857,0 16,7.17143 16,16 z M 94.285714,80.34286 c 0,0 -0.02857,-9.71429 -0.02857,-62.08572 H 85.97143 V 29.77143 C 85.742858,29.85713 85.628572,29.62857 85.514287,29.42857 82.771429,23.51429 75.257143,16.2 63.8,16.28571 48.971429,16.4 38.885714,25.2 35.057143,38.51429 33.828571,42.77143 33.4,47.11429 33.485714,51.54286 33.971429,73.8 46.371429,85.2 65.6,84.45714 73.857143,84.14286 81.171429,79.6 85.314286,71.54286 85.457143,71.25714 85.628571,71 85.8,70.71429 c 0.05714,0.0286 0.114286,0.0286 0.171429,0.0571 0.08571,1.08571 0.05714,8.77143 0.02857,9.85714 -0.05714,4.22857 -0.571429,8.42857 -2.057143,12.42857 -2.228571,6 -6.371428,9.91429 -12.714286,11.28572 -5.085714,1.11428 -10.171428,1.08571 -15.2,-0.34286 C 49.885714,102.25714 45.6,98.57143 44.285714,92.05714 44.2,91.6 43.914286,91.68571 43.628571,91.68571 H 35.971429 C 36.2,94.71429 36.885714,97.48571 38.4,100.02857 45.314286,111.6 62.028571,113.88571 75.028571,110.71429 89.285714,107.2 94.257143,95.02857 94.285714,80.34286 Z" />
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="coding"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  width="36" height="36">
  <path
      d="m 313.5359,557.51414 c 9.229,0 16.57801,8.88719 16.57801,19.99616 0,11.10899 -7.34901,19.99617 -16.57801,19.99617 -9.229,0 -16.57801,-8.88718 -16.57801,-19.99617 0,-11.10897 7.34901,-19.99616 16.57801,-19.99616 z m 393.7706,0 c 9.22899,0 16.57802,8.88719 16.57802,19.99616 0,11.10899 -7.34903,19.99617 -16.57802,19.99617 -9.229,0 -16.57802,-8.88718 -16.57802,-19.99617 0,-11.10897 7.34902,-19.99616 16.57802,-19.99616 z"
      id="path6"/>
  <path
      d="m 945.8932,448.98796 c -27.17427,0 -51.1013,17.26164 -64.43208,43.23957 C 836.17066,393.44306 741.8298,302.00762 625.27096,264.23708 562.37704,239.1137 518.28294,190.57601 512.8139,134.17657 507.34486,190.74691 463.25077,239.1137 400.35685,264.23708 283.79802,301.83671 189.45714,393.44306 144.16669,492.22753 130.83591,466.2496 107.07979,448.98796 79.734607,448.98796 c -41.701401,0 -75.541066,40.84686 -75.541066,91.26454 0,50.41768 33.839665,91.26454 75.541066,91.26454 12.64715,0 24.610663,-3.75996 35.206923,-10.42536 3.58906,163.55837 180.30728,269.69186 397.87237,270.03367 217.5651,-0.34181 394.28332,-106.4753 397.87238,-270.03367 10.42535,6.6654 22.55977,10.42536 35.20692,10.42536 41.7014,0 75.541,-40.84686 75.541,-91.26454 0.171,-50.41768 -33.6687,-91.26454 -75.541,-91.26454 z M 114.2579,568.79403 c -3.58906,13.15987 -19.312535,18.79981 -35.206921,12.47625 -15.894385,-6.15267 -25.977916,-21.87616 -22.388867,-35.03602 3.58906,-13.15987 19.312533,-18.79981 35.206919,-12.47624 15.894389,6.15267 25.807019,21.87614 22.388869,35.03601 z m 398.556,276.69904 C 338.31748,845.15126 196.97707,762.603 196.97707,644.33509 c 0,-2.56361 0.1709,-4.95631 0.1709,-7.34902 0,-0.85453 0,-1.53817 0.17092,-2.3927 0.1709,-1.70908 0.34181,-3.41814 0.34181,-4.95631 0.1709,-2.22179 0.51273,-4.44359 0.85454,-6.6654 0,-0.1709 0,-0.51271 0.1709,-0.68362 3.58906,-23.2434 12.47624,-58.79214 26.14883,-79.13012 32.64331,-47.51224 90.92273,-78.9592 157.23479,-78.9592 51.1013,0 97.41721,18.79981 130.91506,49.05041 33.49784,-30.2506 79.64283,-49.05041 130.91504,-49.05041 66.48298,0 124.59148,31.61786 157.23479,78.9592 13.67259,20.50889 22.55977,55.88672 26.14883,79.13012 0,0.17091 0,0.51272 0.17091,0.68362 0.34182,2.22181 0.51272,4.44361 0.85453,6.6654 0.17091,1.70907 0.34181,3.24723 0.34181,4.95631 0,0.85453 0.17092,1.53817 0.17092,2.3927 0.17091,2.39271 0.17091,4.95631 0.17091,7.34902 C 828.82165,762.603 687.48124,845.15126 512.8139,845.49307 Z M 946.74774,581.27028 c -15.89439,6.15265 -31.61787,0.68362 -35.20692,-12.47625 -3.58906,-13.15987 6.49448,-28.88334 22.38887,-35.03601 15.89438,-6.15267 31.61786,-0.68363 35.20692,12.47624 3.41815,12.98896 -6.49448,28.71243 -22.38887,35.03602 z"
      id="path8"/>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="bilibili"  target="_blank"
      >
      <svg
  class="icon" style="" viewBox="0 0 1024 1024" version="1.1" width="36"
  height="36" id="svg8">
  <path
      style=""
      d="M 744.60599,0.00486267 A 41.779915,41.779915 0 0 0 710.4184,18.673394 L 548.5048,255.32642 h -11.70046 a 41.779915,41.779915 0 0 0 -10.80295,-7.84928 L 235.66,97.084498 a 41.779915,41.779915 0 0 0 -20.07193,-4.960864 41.779915,41.779915 0 0 0 -18.3748,79.145436 L 359.4859,255.32642 H 128.16909 c -49.458302,0 -89.27932,39.82105 -89.27932,89.27932 v 508.65224 c 0,49.4583 39.821018,89.27934 89.27932,89.27934 h 19.48445 C 149.12802,984.5043 179.92773,1024 224.79179,1024 c 44.86407,0 75.66379,-39.4957 77.13826,-81.46268 H 719.98116 C 721.45559,984.5043 752.25533,1024 797.1194,1024 c 44.86406,0 75.6638,-39.4957 77.13824,-81.46268 h 21.57323 c 49.45831,0 89.27936,-39.82104 89.27936,-89.27934 V 344.60574 c 0,-49.45827 -39.82105,-89.27932 -89.27936,-89.27932 H 649.74567 L 779.38103,65.866924 A 41.779915,41.779915 0 0 0 744.60599,0.00486267 Z M 644.49108,418.70871 c 6.29985,0.21538 12.44451,2.01107 17.86888,5.22196 l 171.36218,98.10771 c 18.23417,10.21935 24.63334,33.34627 14.24614,51.48533 -10.38726,18.13909 -33.57344,24.32718 -51.61587,13.77296 L 624.9903,489.18895 c -15.21356,-8.41858 -22.66871,-26.1765 -18.03211,-42.93436 4.63664,-16.75784 20.15573,-28.14465 37.53289,-27.54588 z M 350.2006,432.31846 c 16.89952,0.0317 31.69582,11.33328 36.17844,27.62747 4.48262,16.2942 -2.44981,33.57765 -16.95507,42.24898 l -140.7157,86.91312 c -17.68528,11.18244 -41.09629,5.77692 -52.08912,-12.02686 -10.99282,-17.80373 -5.33855,-41.15658 12.58167,-51.95857 L 329.9002,438.2095 c 6.0643,-3.86439 13.10951,-5.90891 20.3004,-5.89104 z M 501.605,641.53985 c 3.75002,-0.15248 7.48645,0.53903 10.93349,2.0235 0.15842,0.0637 0.31618,0.12888 0.47325,0.19582 0.59328,0.27092 1.17574,0.56489 1.74609,0.88121 0.15868,0.0854 0.31643,0.17233 0.47325,0.2611 0.55694,0.32165 1.10131,0.66458 1.63185,1.02807 0.16455,0.1123 0.32777,0.2265 0.48956,0.34269 0.50382,0.36781 0.99371,0.75428 1.46868,1.15864 0.18724,0.15504 0.37218,0.31282 0.55484,0.47323 0.43271,0.38784 0.8518,0.79061 1.25653,1.20756 0.15449,0.16114 0.30679,0.32437 0.45693,0.48959 0.40798,0.44266 0.79989,0.89988 1.17494,1.37076 0.17799,0.22544 0.35205,0.45395 0.5222,0.68538 0.25932,0.34701 0.50964,0.70071 0.75064,1.06071 0.26712,0.39516 0.52286,0.79784 0.76699,1.20757 0.16907,0.29043 0.33231,0.58424 0.48957,0.88123 0.21836,0.41297 0.42513,0.83199 0.62009,1.25653 0.14836,0.32333 0.28983,0.64976 0.42429,0.97911 0.21319,0.51552 0.40915,1.03801 0.58747,1.5666 0.0677,0.19499 0.13296,0.39085 0.19582,0.58748 0.18652,0.60823 0.34984,1.22334 0.48957,1.84399 0.0397,0.16277 0.0779,0.32601 0.11423,0.48957 0.1436,0.69112 0.25788,1.38801 0.34269,2.08877 0.005,0.0381 0.0111,0.0761 0.0163,0.11424 0.0857,0.78056 0.13474,1.56471 0.14687,2.34988 0.005,0.0543 0.0111,0.10879 0.0163,0.1632 0,0 -0.008,1.12132 0,1.45234 0,0 -0.14697,17.84761 5.89102,34.12231 3.01902,8.13734 7.33278,15.10615 12.61433,19.61501 5.28157,4.50889 11.42894,7.62081 23.64572,7.62081 12.2168,0 18.36416,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.5953,-11.47767 12.6143,-19.61501 6.03799,-16.2747 5.89103,-34.12231 5.89103,-34.12231 -0.44885,-13.87045 10.45922,-25.46302 24.3311,-25.86506 13.87189,-0.40201 25.42828,10.53953 25.78348,24.41272 0,0 1.11929,25.7226 -9.00791,53.01927 -5.06359,13.64832 -13.1986,28.46036 -27.05631,40.29073 -13.85772,11.83039 -33.5454,19.63135 -56.20142,19.63135 -22.65603,0 -42.34371,-7.80096 -56.20141,-19.63135 -4.1801,-3.56856 -7.78733,-7.42433 -10.99878,-11.42303 -3.21235,4.00037 -6.81703,7.85309 -10.99876,11.42303 -13.85773,11.83039 -33.5454,19.63135 -56.20144,19.63135 -22.65601,0 -42.3437,-7.80096 -56.2014,-19.63135 -13.85775,-11.83037 -21.99272,-26.64241 -27.05632,-40.29073 -10.12725,-27.29667 -9.00789,-53.01928 -9.00789,-53.01927 0.20714,-13.83687 11.58744,-24.88848 25.42444,-24.69013 14.1263,0.19991 25.2971,12.0278 24.69011,26.14247 0,0 -0.14697,17.84761 5.89103,34.12231 3.01902,8.13734 7.31646,15.10615 12.598,19.61501 5.28155,4.50889 11.44526,7.62081 23.66203,7.62081 12.21681,0 18.36418,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.57899,-11.47767 12.598,-19.61501 5.76352,-15.53489 5.89112,-32.05691 5.89103,-33.56746 0.006,-0.37466 0.0111,-1.05336 0.0163,-1.20759 -0.0117,-0.74583 0.0105,-1.49177 0.0652,-2.23565 0.009,-0.15784 0.0204,-0.31561 0.0327,-0.47324 0.14204,-1.56859 0.43163,-3.12027 0.86487,-4.63449 0.0213,-0.0763 0.0433,-0.15244 0.0652,-0.22848 3.0335,-10.25748 12.24157,-17.46007 22.92769,-17.93417 z"
      id="rect824"/>
</svg>

    </a>


<a href="https://dinghmcn.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        dinghmcn
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>






  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>










</body>
</html>
