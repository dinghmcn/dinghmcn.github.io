<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>PowerManagerService - dinghmcn&#39;s blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="dinghmcn" />
  <meta name="description" content="会简单的介绍 PowerManager ，重点会放在 PoerManagerService 的源码分析上。
" />

  <meta name="keywords" content="Java, Android, C&#43;&#43;" />






<meta name="generator" content="Hugo 0.55.1" />


<link rel="canonical" href="https://dinghmcn.github.io/post/powermanagerservice/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.ec807d8b802a40889537c26e014f733206312ea440d42e1f0dabed80918de1ac.css" integrity="sha256-7IB9i4AqQIiVN8JuAU9zMgYxLqRA1C4fDavtgJGN4aw=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="PowerManagerService" />
<meta property="og:description" content="会简单的介绍 PowerManager ，重点会放在 PoerManagerService 的源码分析上。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dinghmcn.github.io/post/powermanagerservice/" />
<meta property="article:published_time" content="2018-08-25T00:00:00&#43;08:00"/>
<meta property="article:modified_time" content="2019-04-23T12:10:18&#43;08:00"/>

<meta itemprop="name" content="PowerManagerService">
<meta itemprop="description" content="会简单的介绍 PowerManager ，重点会放在 PoerManagerService 的源码分析上。">


<meta itemprop="datePublished" content="2018-08-25T00:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2019-04-23T12:10:18&#43;08:00" />
<meta itemprop="wordCount" content="11175">



<meta itemprop="keywords" content="Android,SystemServer," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="PowerManagerService"/>
<meta name="twitter:description" content="会简单的介绍 PowerManager ，重点会放在 PoerManagerService 的源码分析上。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">dinghmcn&#39;s blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/about/">关于</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/index.xml">订阅</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      dinghmcn&#39;s blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/about/">关于</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dinghmcn.github.io/index.xml">订阅</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">PowerManagerService</h1>
      
      <div class="post-meta">
        <time datetime="2018-08-25" class="post-time">
          2018-08-25
        </time>
        <div class="post-category">
            <a href="https://dinghmcn.github.io/categories/android/"> Android </a>
            
          </div>
        <span class="more-meta"> 约 11175 字 </span>
          <span class="more-meta"> 预计阅读 23 分钟 </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#powermanager-and-powermanagerservice">PowerManager &amp; PowerManagerService</a>
<ul>
<li><a href="#powermanager">PowerManager</a></li>
<li><a href="#powermanagerservice">PowerManagerService</a>
<ul>
<li><a href="#概述">概述</a></li>
<li><a href="#启动">启动</a></li>
<li><a href="#构建">构建</a></li>
<li><a href="#关键函数">关键函数</a></li>
<li><a href="#wakelock-的使用"><code>WakeLock</code> 的使用</a></li>
<li><a href="#power-键动作流程">Power 键动作流程</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>会简单的介绍 <code>PowerManager</code> ，重点会放在 <code>PoerManagerService</code> 的源码分析上。</p>

<h2 id="powermanager-and-powermanagerservice">PowerManager &amp; PowerManagerService</h2>

<ul>
<li>涉及文件：

<ul>
<li><code>frameworks/base/core/java/android/os/PowerManager.java</code></li>
<li><code>frameworks/base/services/core/java/com/android/server/power/PowerManagerService.java</code></li>
<li><code>frameworks/base/services/core/java/com/android/server/policy/PhoneWindowManager.java</code></li>
</ul></li>
</ul>

<h3 id="powermanager">PowerManager</h3>

<ol>
<li>该类用于控制电源状态</li>
<li>应尽量避免使用 <code>WakeLock</code> ，它会严重影响设备电池的寿命；如果确实需要使用也应使用最低级别并确保尽快释放。</li>

<li><p>我们主要使用 <code>newWakeLock()</code> 方法获取 <code>WakeLock</code> 对象来控制电池状态</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">PowerManager</span> <span class="n">pm</span> <span class="o">=</span> <span class="o">(</span><span class="n">PowerManager</span><span class="o">)</span> <span class="n">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">POWER_SERVICE</span><span class="o">);</span>
<span class="n">PowerManager</span><span class="o">.</span><span class="na">WakeLock</span> <span class="n">wl</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="na">newWakeLock</span><span class="o">(</span><span class="n">PowerManager</span><span class="o">.</span><span class="na">SCREEN_DIM_WAKE_LOCK</span><span class="o">,</span> <span class="s">&#34;My Tag&#34;</span><span class="o">);</span>
<span class="n">wl</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
<span class="o">..</span><span class="na">screen</span> <span class="n">will</span> <span class="n">stay</span> <span class="n">on</span> <span class="n">during</span> <span class="k">this</span> <span class="n">section</span><span class="o">..</span>
    <span class="n">wl</span><span class="o">.</span><span class="na">release</span><span class="o">();</span></code></pre></td></tr></table>
</div>
</div>
<p>定义以下不同级别的唤醒锁，它们对系统功率的影响不同并且是互斥的。</p>

<table>
<thead>
<tr>
<th>标志</th>
<th>处理器</th>
<th>屏幕</th>
<th>键盘</th>
</tr>
</thead>

<tbody>
<tr>
<td>PARTIAL_WAKE_LOCK</td>
<td>开启</td>
<td>关闭</td>
<td>关闭</td>
</tr>

<tr>
<td>SCREEN_DIM_WAKE_LOCK</td>
<td>开启</td>
<td>暗</td>
<td>关闭</td>
</tr>

<tr>
<td>SCREEN_BRIGHT_WAKE_LOCK</td>
<td>开启</td>
<td>亮</td>
<td>关闭</td>
</tr>

<tr>
<td>FULL_WAKE_LOCK</td>
<td>开启</td>
<td>亮</td>
<td>亮</td>
</tr>
</tbody>
</table>

<p><code>PARTIAL_WAKE_LOCK</code> 状态时，处理器不会休眠即使你按下电源键而其它状态下处理器会休眠。</p></li>

<li><p>需要增加相应权限 <code>&lt;uses-permission android:name=&quot;android.permission.WAKE_LOCK&quot; /&gt;</code></p></li>

<li><p>获取 <code>PowerManager</code> 实例</p>

<ul>
<li><code>Context.getSystemService(PowerManager.class)</code></li>
<li><code>Context.getSystemService(Context.POWER_SERVICE)</code></li>
</ul></li>

<li><p>API</p>

<ul>
<li><a href="https://developer.android.google.cn/reference/android/os/PowerManager">https://developer.android.google.cn/reference/android/os/PowerManager</a></li>
<li><a href="https://developer.android.google.com/reference/android/os/PowerManager">https://developer.android.google.com/reference/android/os/PowerManager</a></li>
</ul></li>
</ol>

<h3 id="powermanagerservice">PowerManagerService</h3>

<h4 id="概述">概述</h4>

<ol>
<li><p>类图</p>


<link rel="stylesheet" href="/css/hugo-easy-gallery.css" />
<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" >
    <div class="img">
      <img itemprop="thumbnail" src="/PowerManagerService/UML.png" />
    </div>
    <a href="/PowerManagerService/UML.png" itemprop="contentUrl"></a>
  </figure>
</div>
</li>

<li><p><code>IPowerManager.java</code>
源码根目录执行命令： <code>prebuilts/sdk/tools/linux/bin/aidl -Iframeworks/base/core/java frameworks/base/core/java/android/os/IPowerManager.aidl</code> 生成 <a href="/PowerManagerService/IPowerManager.java">frameworks/base/core/java/android/os/IPowerManager.java</a> 文件。</p></li>

<li><p>说明</p>

<ul>
<li><code>PowerManagerService</code> 继承自 <code>SystemService</code> 类并实现了 <code>Watchdog.Monitor</code> 接口。内部类 <code>BinderService</code> 继承自 <code>IPowerManager.Stub</code> ， <code>PowerManagerService</code> 内部定义了较多的成员变量但没有持有其内部类 <code>BinderService</code> 对象，在后续分析中，我们会对其中比较重要的成员逐一进行介绍。</li>
<li>IPowerManager.Stub 及内部类  Proxy 均由  aidl 工具处理  PowerManager.aidl 后得到。</li>
<li>客户端使用 <code>PowerManager</code> 类，其内部通过代表 <code>BinderProxy</code> 端的 <code>mService</code> 成员变量与 <code>PowerManagerService.BinderService</code> 进行跨  Binder 通信。</li>
<li><code>LocalService</code> 继承自 <code>PowerManagerInternal</code> 属于 <code>SystemServer</code> 内部管理工具不能用于外部, 因为其与 <code>PowerManagerService</code> 属于同一进程间不同线程的通信，并非基于  Binder</li>
</ul></li>
</ol>

<h4 id="启动">启动</h4>

<ol>
<li><p><code>SystemServer</code> 启动</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm">​ * The main entry point from zygote.
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">SystemServer</span><span class="o">().</span><span class="na">run</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="c1">// 创建  SystemServiceManager 对象
</span><span class="c1"></span>    <span class="n">mSystemServiceManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SystemServiceManager</span><span class="o">(</span><span class="n">mSystemContext</span><span class="o">);</span>
    <span class="o">...</span>
        <span class="c1">// 启动少部分关键服务；服务间有复杂的相互依赖关系，统一初始化
</span><span class="c1"></span>        <span class="n">startBootstrapServices</span><span class="o">();</span>
        <span class="c1">// 启动其它关键服务
</span><span class="c1"></span>        <span class="n">startCoreServices</span><span class="o">();</span>
        <span class="c1">// 启动其它服务
</span><span class="c1"></span>        <span class="n">startOtherServices</span><span class="o">();</span>
        <span class="o">...</span>
            <span class="o">}</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">startBootstrapServices</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="c1">// 启动  PowerManagerService
</span><span class="c1"></span>    <span class="n">mPowerManagerService</span> <span class="o">=</span> <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">PowerManagerService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">...</span>
        <span class="o">}</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">startOtherServices</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="c1">// 调用  systemTeady()
</span><span class="c1"></span>    <span class="n">mPowerManagerService</span><span class="o">.</span><span class="na">systemReady</span><span class="o">(</span><span class="n">mActivityManagerService</span><span class="o">.</span><span class="na">getAppOpsService</span><span class="o">());</span>
    <span class="o">...</span>
        <span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>SystemServiceManager.starService()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">SystemService</span> <span class="nf">startService</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">SystemService</span><span class="o">&gt;</span> <span class="n">serviceClass</span><span class="o">;</span>
    <span class="o">...</span>
        <span class="k">return</span> <span class="n">startService</span><span class="o">(</span><span class="n">serviceClass</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">SystemService</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">startService</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">serviceClass</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="c1">// 通过反射创建类对象
</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">T</span> <span class="n">service</span><span class="o">;</span>
    <span class="n">Constructor</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">serviceClass</span><span class="o">.</span><span class="na">getConstructor</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">constructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">mContext</span><span class="o">);</span>
    <span class="o">...</span>
        <span class="n">startService</span><span class="o">(</span><span class="n">service</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">service</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">startService</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="kd">final</span> <span class="n">SystemService</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="n">service</span><span class="o">.</span><span class="na">onStart</span><span class="o">();</span>
    <span class="o">...</span>
        <span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>PowerManagerService.onStart()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStart</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// BinderService 继承自  IPowerManager.Stub 是服务端的  Binder 实体,负责跨进程通讯
</span><span class="c1"></span>    <span class="n">publishBinderService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">POWER_SERVICE</span><span class="o">,</span> <span class="k">new</span> <span class="n">BinderService</span><span class="o">());</span>
    <span class="c1">// LocalService 继承自  PowerManagerInternal 仅供  system server 调用使用
</span><span class="c1"></span>    <span class="c1">// 其实该方法实现了单例模式
</span><span class="c1"></span>    <span class="n">publishLocalService</span><span class="o">(</span><span class="n">PowerManagerInternal</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">LocalService</span><span class="o">());</span>
    <span class="c1">// 加入看门狗
</span><span class="c1"></span>    <span class="n">Watchdog</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">addMonitor</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="n">Watchdog</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">addThread</span><span class="o">(</span><span class="n">mHandler</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<ol>
<li><p><code>publishBinderService</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">publishBinderService</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">publishBinderService</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">service</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">protected</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">publishBinderService</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">service</span><span class="o">,</span>
                                          <span class="kt">boolean</span> <span class="n">allowIsolated</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">publishBinderService</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">service</span><span class="o">,</span> <span class="n">allowIsolated</span><span class="o">,</span> <span class="n">DUMP_FLAG_PRIORITY_DEFAULT</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">protected</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">publishBinderService</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">service</span><span class="o">,</span>
                                          <span class="kt">boolean</span> <span class="n">allowIsolated</span><span class="o">,</span> <span class="kt">int</span> <span class="n">dumpPriority</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 注册到  ServiceManager
</span><span class="c1"></span>    <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">service</span><span class="o">,</span> <span class="n">allowIsolated</span><span class="o">,</span> <span class="n">dumpPriority</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>publishLocalService</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kd">final</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">publishLocalService</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">,</span> <span class="n">T</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 注册到  LS
</span><span class="c1"></span>    <span class="n">LocalServices</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">service</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>
</ol></li>
</ol>

<h4 id="构建">构建</h4>

<ul>
<li><p><code>PowerManagerService</code> 构造函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">PowerManagerService</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="n">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
    <span class="c1">// ServiceThread 继承自  HandleThead
</span><span class="c1"></span>    <span class="n">mHandlerThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServiceThread</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="n">Process</span><span class="o">.</span><span class="na">THREAD_PRIORITY_DISPLAY</span><span class="o">,</span> <span class="kc">false</span> <span class="cm">/*allowIo*/</span><span class="o">);</span>
    <span class="n">mHandlerThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="c1">// 创建  PowerManagerHandler 处理异步消息
</span><span class="c1"></span>    <span class="n">mHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PowerManagerHandler</span><span class="o">(</span><span class="n">mHandlerThread</span><span class="o">.</span><span class="na">getLooper</span><span class="o">());</span>
    <span class="n">mConstants</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Constants</span><span class="o">(</span><span class="n">mHandler</span><span class="o">);</span>
    <span class="n">mAmbientDisplayConfiguration</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AmbientDisplayConfiguration</span><span class="o">(</span><span class="n">mContext</span><span class="o">);</span>

    <span class="c1">// 节能相关
</span><span class="c1"></span>    <span class="n">mBatterySavingStats</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BatterySavingStats</span><span class="o">(</span><span class="n">mLock</span><span class="o">);</span>
    <span class="n">mBatterySaverPolicy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BatterySaverPolicy</span><span class="o">(</span><span class="n">mLock</span><span class="o">,</span> <span class="n">mContext</span><span class="o">,</span> <span class="n">mBatterySavingStats</span><span class="o">);</span>
    <span class="n">mBatterySaverController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BatterySaverController</span><span class="o">(</span><span class="n">mLock</span><span class="o">,</span> <span class="n">mContext</span><span class="o">,</span>
                                                         <span class="n">BackgroundThread</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getLooper</span><span class="o">(),</span> <span class="n">mBatterySaverPolicy</span><span class="o">,</span> <span class="n">mBatterySavingStats</span><span class="o">);</span>
    <span class="n">mBatterySaverStateMachine</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BatterySaverStateMachine</span><span class="o">(</span>
                                                             <span class="n">mLock</span><span class="o">,</span> <span class="n">mContext</span><span class="o">,</span> <span class="n">mBatterySaverController</span><span class="o">);</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 阻止休眠锁，应用获取该锁时保持  CPU 唤醒
</span><span class="c1"></span>        <span class="n">mWakeLockSuspendBlocker</span> <span class="o">=</span> <span class="n">createSuspendBlockerLocked</span><span class="o">(</span><span class="s">&#34;PowerManagerService.WakeLocks&#34;</span><span class="o">);</span>
        <span class="c1">// 屏幕唤醒锁，屏幕唤醒时保持  CPU 唤醒；当屏幕准备就绪或应用活动时必须唤醒屏幕
</span><span class="c1"></span>        <span class="n">mDisplaySuspendBlocker</span> <span class="o">=</span> <span class="n">createSuspendBlockerLocked</span><span class="o">(</span><span class="s">&#34;PowerManagerService.Display&#34;</span><span class="o">);</span>
        <span class="c1">// 获取屏幕唤醒锁
</span><span class="c1"></span>        <span class="n">mDisplaySuspendBlocker</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
        <span class="c1">// 标记已获取屏幕唤醒锁
</span><span class="c1"></span>        <span class="n">mHoldingDisplaySuspendBlocker</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="c1">// 是否开启自动挂起模式
</span><span class="c1"></span>        <span class="n">mHalAutoSuspendModeEnabled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="c1">// 是否开启交互模式
</span><span class="c1"></span>        <span class="n">mHalInteractiveModeEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="c1">// 指示设备是处于唤醒状态还是处于睡眠状态或两者之间的某处。这与屏幕电源状态不同，后者是单独管理的。
</span><span class="c1"></span>        <span class="n">mWakefulness</span> <span class="o">=</span> <span class="n">WAKEFULNESS_AWAKE</span><span class="o">;</span>
        <span class="c1">// 表示是否关闭指示灯，默认  false 不关闭指示灯
</span><span class="c1"></span>        <span class="n">sQuiescent</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">SYSTEM_PROPERTY_QUIESCENT</span><span class="o">,</span> <span class="s">&#34;0&#34;</span><span class="o">).</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);</span>
        <span class="c1">// 下文分析
</span><span class="c1"></span>        <span class="n">nativeInit</span><span class="o">();</span>
        <span class="c1">// 同步自动挂起模式设置到  Native
</span><span class="c1"></span>        <span class="n">nativeSetAutoSuspend</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="c1">// 同步交互模式设置到  Native
</span><span class="c1"></span>        <span class="n">nativeSetInteractive</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="c1">// 关闭双击屏幕唤醒功能
</span><span class="c1"></span>        <span class="n">nativeSetFeature</span><span class="o">(</span><span class="n">POWER_FEATURE_DOUBLE_TAP_TO_WAKE</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<ol>
<li><p><code>nativeInit()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-C++" data-lang="C++"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C++" data-lang="C++"><span class="k">static</span> <span class="kt">void</span> <span class="nf">nativeInit</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 保存  PowerManagerService 对象的全局引用
</span><span class="c1"></span>  <span class="n">gPowerManagerServiceObj</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewGlobalRef</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
  <span class="c1">// 检查电源  HAL 服务的当前句柄的有效性，并在必要时调用  getService（）。调用者必须持有  gPowerHalMutex。
</span><span class="c1"></span>  <span class="n">gPowerHalMutex</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
  <span class="n">connectPowerHalLocked</span><span class="p">();</span>
  <span class="n">gPowerHalMutex</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ol></li>

<li><p><code>onBootPhase()</code></p>

<ol>
<li><p>随着 <code>SyteServer</code> 启动的不同阶段会调用 <code>SystemServiceManager.startBootPhase()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">startBootPhase</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">phase</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">phase</span> <span class="o">&lt;=</span> <span class="n">mCurrentPhase</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;Next phase must be larger than previous&#34;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">mCurrentPhase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">;</span>

    <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Starting phase &#34;</span> <span class="o">+</span> <span class="n">mCurrentPhase</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_SYSTEM_SERVER</span><span class="o">,</span> <span class="s">&#34;OnBootPhase &#34;</span> <span class="o">+</span> <span class="n">phase</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">serviceLen</span> <span class="o">=</span> <span class="n">mServices</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">serviceLen</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">SystemService</span> <span class="n">service</span> <span class="o">=</span> <span class="n">mServices</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="kt">long</span> <span class="n">time</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">();</span>
            <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_SYSTEM_SERVER</span><span class="o">,</span> <span class="n">service</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">service</span><span class="o">.</span><span class="na">onBootPhase</span><span class="o">(</span><span class="n">mCurrentPhase</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;Failed to boot service &#34;</span>
<span class="err">​</span>                                           <span class="o">+</span> <span class="n">service</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span>
<span class="err">​</span>                                           <span class="o">+</span> <span class="s">&#34;: onBootPhase threw an exception during phase &#34;</span>
<span class="err">​</span>                                           <span class="o">+</span> <span class="n">mCurrentPhase</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">warnIfTooLong</span><span class="o">(</span><span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">()</span> <span class="o">-</span> <span class="n">time</span><span class="o">,</span> <span class="n">service</span><span class="o">,</span> <span class="s">&#34;onBootPhase&#34;</span><span class="o">);</span>
            <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_SYSTEM_SERVER</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_SYSTEM_SERVER</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>PowerManagerService.onBootPhase()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onBootPhase</span><span class="o">(</span><span class="kt">int</span> <span class="n">phase</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">phase</span> <span class="o">==</span> <span class="n">PHASE_THIRD_PARTY_APPS_CAN_START</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 启动计数器
</span><span class="c1"></span>            <span class="n">incrementBootCount</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">phase</span> <span class="o">==</span> <span class="n">PHASE_BOOT_COMPLETED</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
            <span class="n">mBootCompleted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">mDirty</span> <span class="o">|=</span> <span class="n">DIRTY_BOOT_COMPLETED</span><span class="o">;</span>

            <span class="n">mBatterySaverStateMachine</span><span class="o">.</span><span class="na">onBootCompleted</span><span class="o">();</span>
            <span class="c1">// 触发一次用户事件；如果一段时间不操作会自动休眠，这个方法留到后面分析
</span><span class="c1"></span>            <span class="n">userActivityNoUpdateLocked</span><span class="o">(</span>
                                       <span class="n">now</span><span class="o">,</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">USER_ACTIVITY_EVENT_OTHER</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">Process</span><span class="o">.</span><span class="na">SYSTEM_UID</span><span class="o">);</span>
            <span class="c1">//根据  mDirty 的值更新电源状态信息，这个方法比较重要，重要肯定要留到后面
</span><span class="c1"></span>            <span class="n">updatePowerStateLocked</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(!</span><span class="n">ArrayUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">mBootCompletedRunnables</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Posting &#34;</span> <span class="o">+</span> <span class="n">mBootCompletedRunnables</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="s">&#34; delayed runnables&#34;</span><span class="o">);</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span> <span class="o">:</span> <span class="n">mBootCompletedRunnables</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">BackgroundThread</span><span class="o">.</span><span class="na">getHandler</span><span class="o">().</span><span class="na">post</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">mBootCompletedRunnables</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>
</ol></li>

<li><p><code>systemReady()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">systemReady</span><span class="o">(</span><span class="n">IAppOpsService</span> <span class="n">appOps</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mSystemReady</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="c1">// 获取一些相关的系统服务
</span><span class="c1"></span>        <span class="c1">// 权限管理服务
</span><span class="c1"></span>        <span class="n">mAppOps</span> <span class="o">=</span> <span class="n">appOps</span><span class="o">;</span>
        <span class="c1">// 屏保管理服务
</span><span class="c1"></span>        <span class="n">mDreamManager</span> <span class="o">=</span> <span class="n">getLocalService</span><span class="o">(</span><span class="n">DreamManagerInternal</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// 显示管理服务
</span><span class="c1"></span>        <span class="n">mDisplayManagerInternal</span> <span class="o">=</span> <span class="n">getLocalService</span><span class="o">(</span><span class="n">DisplayManagerInternal</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// 窗口管理服务
</span><span class="c1"></span>        <span class="n">mPolicy</span> <span class="o">=</span> <span class="n">getLocalService</span><span class="o">(</span><span class="n">WindowManagerPolicy</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// 电池管理服务
</span><span class="c1"></span>        <span class="n">mBatteryManagerInternal</span> <span class="o">=</span> <span class="n">getLocalService</span><span class="o">(</span><span class="n">BatteryManagerInternal</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// 电源管理服务
</span><span class="c1"></span>        <span class="n">PowerManager</span> <span class="n">pm</span> <span class="o">=</span> <span class="o">(</span><span class="n">PowerManager</span><span class="o">)</span> <span class="n">mContext</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">POWER_SERVICE</span><span class="o">);</span>
        <span class="c1">// 屏幕最小、最大、默认亮度
</span><span class="c1"></span>        <span class="n">mScreenBrightnessSettingMinimum</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="na">getMinimumScreenBrightnessSetting</span><span class="o">();</span>
        <span class="n">mScreenBrightnessSettingMaximum</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="na">getMaximumScreenBrightnessSetting</span><span class="o">();</span>
        <span class="n">mScreenBrightnessSettingDefault</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="na">getDefaultScreenBrightnessSetting</span><span class="o">();</span>
        <span class="c1">// 传感器管理服务
</span><span class="c1"></span>        <span class="n">SensorManager</span> <span class="n">sensorManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SystemSensorManager</span><span class="o">(</span><span class="n">mContext</span><span class="o">,</span> <span class="n">mHandler</span><span class="o">.</span><span class="na">getLooper</span><span class="o">());</span>

        <span class="c1">// The notifier runs on the system server&#39;s main looper so as not to interfere
</span><span class="c1"></span>        <span class="c1">// with the animations and other critical functions of the power manager.
</span><span class="c1"></span>        <span class="c1">// 电池电量统计服务
</span><span class="c1"></span>        <span class="n">mBatteryStats</span> <span class="o">=</span> <span class="n">BatteryStatsService</span><span class="o">.</span><span class="na">getService</span><span class="o">();</span>
        <span class="c1">// 又上面的注释可知该  notifier 运行于  system server 的主  looper，还传入了唤醒锁可以在发送通知时点亮屏幕； 用于  PMS 和其他系统服务间的交互,以及广播的发送
</span><span class="c1"></span>        <span class="n">mNotifier</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Notifier</span><span class="o">(</span><span class="n">Looper</span><span class="o">.</span><span class="na">getMainLooper</span><span class="o">(),</span> <span class="n">mContext</span><span class="o">,</span> <span class="n">mBatteryStats</span><span class="o">,</span>
                                 <span class="n">createSuspendBlockerLocked</span><span class="o">(</span><span class="s">&#34;PowerManagerService.Broadcasts&#34;</span><span class="o">),</span> <span class="n">mPolicy</span><span class="o">);</span>
        <span class="c1">// 无线充电探测器
</span><span class="c1"></span>        <span class="n">mWirelessChargerDetector</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WirelessChargerDetector</span><span class="o">(</span><span class="n">sensorManager</span><span class="o">,</span>
                                                               <span class="n">createSuspendBlockerLocked</span><span class="o">(</span><span class="s">&#34;PowerManagerService.WirelessChargerDetector&#34;</span><span class="o">),</span>
                                                               <span class="n">mHandler</span><span class="o">);</span>
        <span class="n">mSettingsObserver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SettingsObserver</span><span class="o">(</span><span class="n">mHandler</span><span class="o">);</span>
        <span class="c1">// 指示灯管理服务
</span><span class="c1"></span>        <span class="n">mLightsManager</span> <span class="o">=</span> <span class="n">getLocalService</span><span class="o">(</span><span class="n">LightsManager</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">mAttentionLight</span> <span class="o">=</span> <span class="n">mLightsManager</span><span class="o">.</span><span class="na">getLight</span><span class="o">(</span><span class="n">LightsManager</span><span class="o">.</span><span class="na">LIGHT_ID_ATTENTION</span><span class="o">);</span>

        <span class="c1">// Initialize display power management.
</span><span class="c1"></span>        <span class="n">mDisplayManagerInternal</span><span class="o">.</span><span class="na">initPowerManagement</span><span class="o">(</span>
                                                    <span class="n">mDisplayPowerCallbacks</span><span class="o">,</span> <span class="n">mHandler</span><span class="o">,</span> <span class="n">sensorManager</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">ForegroundProfileObserver</span> <span class="n">observer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ForegroundProfileObserver</span><span class="o">();</span>
            <span class="n">ActivityManager</span><span class="o">.</span><span class="na">getService</span><span class="o">().</span><span class="na">registerUserSwitchObserver</span><span class="o">(</span><span class="n">observer</span><span class="o">,</span> <span class="n">TAG</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Shouldn&#39;t happen since in-process.
</span><span class="c1"></span>        <span class="o">}</span>

        <span class="c1">// Go.
</span><span class="c1"></span>        <span class="c1">// 读取配置参数，这些参数是编译时确定的，运行过程中无法修改
</span><span class="c1"></span>        <span class="n">readConfigurationLocked</span><span class="o">();</span>
        <span class="c1">// 从数据库读取参数
</span><span class="c1"></span>        <span class="n">updateSettingsLocked</span><span class="o">();</span>
        <span class="c1">// 根据  mDirty 的值更新电源状态信息
</span><span class="c1"></span>        <span class="n">mDirty</span> <span class="o">|=</span> <span class="n">DIRTY_BATTERY_STATE</span><span class="o">;</span>
        <span class="c1">// 所有状态都在这里统一处理，这个方法比较重要会被频繁调用，重要肯定要留到后面
</span><span class="c1"></span>        <span class="n">updatePowerStateLocked</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="n">ContentResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="n">mContext</span><span class="o">.</span><span class="na">getContentResolver</span><span class="o">();</span>
    <span class="n">mConstants</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">resolver</span><span class="o">);</span>

    <span class="n">mBatterySaverController</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
    <span class="n">mBatterySaverPolicy</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>

    <span class="c1">// 监视屏幕、休眠、唤醒设置值的改变
</span><span class="c1"></span>    <span class="n">resolver</span><span class="o">.</span><span class="na">registerContentObserver</span><span class="o">(</span><span class="n">Settings</span><span class="o">.</span><span class="na">Secure</span><span class="o">.</span><span class="na">getUriFor</span><span class="o">(</span>
                                                               <span class="n">Settings</span><span class="o">.</span><span class="na">Secure</span><span class="o">.</span><span class="na">SCREENSAVER_ENABLED</span><span class="o">),</span>
                                     <span class="kc">false</span><span class="o">,</span> <span class="n">mSettingsObserver</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_ALL</span><span class="o">);</span>
    <span class="n">resolver</span><span class="o">.</span><span class="na">registerContentObserver</span><span class="o">(</span><span class="n">Settings</span><span class="o">.</span><span class="na">Secure</span><span class="o">.</span><span class="na">getUriFor</span><span class="o">(</span>
                                                               <span class="n">Settings</span><span class="o">.</span><span class="na">Secure</span><span class="o">.</span><span class="na">SCREENSAVER_ACTIVATE_ON_SLEEP</span><span class="o">),</span>
                                     <span class="kc">false</span><span class="o">,</span> <span class="n">mSettingsObserver</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_ALL</span><span class="o">);</span>
    <span class="n">resolver</span><span class="o">.</span><span class="na">registerContentObserver</span><span class="o">(</span><span class="n">Settings</span><span class="o">.</span><span class="na">Secure</span><span class="o">.</span><span class="na">getUriFor</span><span class="o">(</span>
                                                               <span class="n">Settings</span><span class="o">.</span><span class="na">Secure</span><span class="o">.</span><span class="na">SCREENSAVER_ACTIVATE_ON_DOCK</span><span class="o">),</span>
                                     <span class="kc">false</span><span class="o">,</span> <span class="n">mSettingsObserver</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_ALL</span><span class="o">);</span>
    <span class="n">resolver</span><span class="o">.</span><span class="na">registerContentObserver</span><span class="o">(</span><span class="n">Settings</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">getUriFor</span><span class="o">(</span>
                                                               <span class="n">Settings</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">SCREEN_OFF_TIMEOUT</span><span class="o">),</span>
                                     <span class="kc">false</span><span class="o">,</span> <span class="n">mSettingsObserver</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_ALL</span><span class="o">);</span>
    <span class="n">resolver</span><span class="o">.</span><span class="na">registerContentObserver</span><span class="o">(</span><span class="n">Settings</span><span class="o">.</span><span class="na">Secure</span><span class="o">.</span><span class="na">getUriFor</span><span class="o">(</span>
                                                               <span class="n">Settings</span><span class="o">.</span><span class="na">Secure</span><span class="o">.</span><span class="na">SLEEP_TIMEOUT</span><span class="o">),</span>
                                     <span class="kc">false</span><span class="o">,</span> <span class="n">mSettingsObserver</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_ALL</span><span class="o">);</span>
    <span class="n">resolver</span><span class="o">.</span><span class="na">registerContentObserver</span><span class="o">(</span><span class="n">Settings</span><span class="o">.</span><span class="na">Global</span><span class="o">.</span><span class="na">getUriFor</span><span class="o">(</span>
                                                               <span class="n">Settings</span><span class="o">.</span><span class="na">Global</span><span class="o">.</span><span class="na">STAY_ON_WHILE_PLUGGED_IN</span><span class="o">),</span>
                                     <span class="kc">false</span><span class="o">,</span> <span class="n">mSettingsObserver</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_ALL</span><span class="o">);</span>
    <span class="n">resolver</span><span class="o">.</span><span class="na">registerContentObserver</span><span class="o">(</span><span class="n">Settings</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">getUriFor</span><span class="o">(</span>
                                                               <span class="n">Settings</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">SCREEN_BRIGHTNESS_MODE</span><span class="o">),</span>
                                     <span class="kc">false</span><span class="o">,</span> <span class="n">mSettingsObserver</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_ALL</span><span class="o">);</span>
    <span class="n">resolver</span><span class="o">.</span><span class="na">registerContentObserver</span><span class="o">(</span><span class="n">Settings</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">getUriFor</span><span class="o">(</span>
                                                               <span class="n">Settings</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">SCREEN_AUTO_BRIGHTNESS_ADJ</span><span class="o">),</span>
                                     <span class="kc">false</span><span class="o">,</span> <span class="n">mSettingsObserver</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_ALL</span><span class="o">);</span>
    <span class="n">resolver</span><span class="o">.</span><span class="na">registerContentObserver</span><span class="o">(</span><span class="n">Settings</span><span class="o">.</span><span class="na">Global</span><span class="o">.</span><span class="na">getUriFor</span><span class="o">(</span>
                                                               <span class="n">Settings</span><span class="o">.</span><span class="na">Global</span><span class="o">.</span><span class="na">THEATER_MODE_ON</span><span class="o">),</span>
                                     <span class="kc">false</span><span class="o">,</span> <span class="n">mSettingsObserver</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_ALL</span><span class="o">);</span>
    <span class="n">resolver</span><span class="o">.</span><span class="na">registerContentObserver</span><span class="o">(</span><span class="n">Settings</span><span class="o">.</span><span class="na">Secure</span><span class="o">.</span><span class="na">getUriFor</span><span class="o">(</span>
                                                               <span class="n">Settings</span><span class="o">.</span><span class="na">Secure</span><span class="o">.</span><span class="na">DOZE_ALWAYS_ON</span><span class="o">),</span>
                                     <span class="kc">false</span><span class="o">,</span> <span class="n">mSettingsObserver</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_ALL</span><span class="o">);</span>
    <span class="n">resolver</span><span class="o">.</span><span class="na">registerContentObserver</span><span class="o">(</span><span class="n">Settings</span><span class="o">.</span><span class="na">Secure</span><span class="o">.</span><span class="na">getUriFor</span><span class="o">(</span>
                                                               <span class="n">Settings</span><span class="o">.</span><span class="na">Secure</span><span class="o">.</span><span class="na">DOUBLE_TAP_TO_WAKE</span><span class="o">),</span>
                                     <span class="kc">false</span><span class="o">,</span> <span class="n">mSettingsObserver</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_ALL</span><span class="o">);</span>
    <span class="n">resolver</span><span class="o">.</span><span class="na">registerContentObserver</span><span class="o">(</span><span class="n">Settings</span><span class="o">.</span><span class="na">Global</span><span class="o">.</span><span class="na">getUriFor</span><span class="o">(</span>
                                                               <span class="n">Settings</span><span class="o">.</span><span class="na">Global</span><span class="o">.</span><span class="na">DEVICE_DEMO_MODE</span><span class="o">),</span>
                                     <span class="kc">false</span><span class="o">,</span> <span class="n">mSettingsObserver</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_SYSTEM</span><span class="o">);</span>
    <span class="n">IVrManager</span> <span class="n">vrManager</span> <span class="o">=</span> <span class="o">(</span><span class="n">IVrManager</span><span class="o">)</span> <span class="n">getBinderService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">VR_SERVICE</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">vrManager</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">vrManager</span><span class="o">.</span><span class="na">registerListener</span><span class="o">(</span><span class="n">mVrStateCallbacks</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Failed to register VR mode state listener: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// 监听相关广播
</span><span class="c1"></span>    <span class="n">IntentFilter</span> <span class="n">filter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IntentFilter</span><span class="o">();</span>
    <span class="c1">// 电池电量改变广播
</span><span class="c1"></span>    <span class="n">filter</span><span class="o">.</span><span class="na">addAction</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_BATTERY_CHANGED</span><span class="o">);</span>
    <span class="n">filter</span><span class="o">.</span><span class="na">setPriority</span><span class="o">(</span><span class="n">IntentFilter</span><span class="o">.</span><span class="na">SYSTEM_HIGH_PRIORITY</span><span class="o">);</span>
    <span class="n">mContext</span><span class="o">.</span><span class="na">registerReceiver</span><span class="o">(</span><span class="k">new</span> <span class="n">BatteryReceiver</span><span class="o">(),</span> <span class="n">filter</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">mHandler</span><span class="o">);</span>

    <span class="n">filter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IntentFilter</span><span class="o">();</span>
    <span class="c1">// 屏保开启广播
</span><span class="c1"></span>    <span class="n">filter</span><span class="o">.</span><span class="na">addAction</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_DREAMING_STARTED</span><span class="o">);</span>
    <span class="c1">// 屏保关闭广播
</span><span class="c1"></span>    <span class="n">filter</span><span class="o">.</span><span class="na">addAction</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_DREAMING_STOPPED</span><span class="o">);</span>
    <span class="n">mContext</span><span class="o">.</span><span class="na">registerReceiver</span><span class="o">(</span><span class="k">new</span> <span class="n">DreamReceiver</span><span class="o">(),</span> <span class="n">filter</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">mHandler</span><span class="o">);</span>

    <span class="n">filter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IntentFilter</span><span class="o">();</span>
    <span class="c1">// 用户切换广播
</span><span class="c1"></span>    <span class="n">filter</span><span class="o">.</span><span class="na">addAction</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_USER_SWITCHED</span><span class="o">);</span>
    <span class="n">mContext</span><span class="o">.</span><span class="na">registerReceiver</span><span class="o">(</span><span class="k">new</span> <span class="n">UserSwitchedReceiver</span><span class="o">(),</span> <span class="n">filter</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">mHandler</span><span class="o">);</span>

    <span class="n">filter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IntentFilter</span><span class="o">();</span>
    <span class="c1">// 底座事件广播，底座一般用的比较少，我是没用过。。。
</span><span class="c1"></span>    <span class="n">filter</span><span class="o">.</span><span class="na">addAction</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_DOCK_EVENT</span><span class="o">);</span>
    <span class="n">mContext</span><span class="o">.</span><span class="na">registerReceiver</span><span class="o">(</span><span class="k">new</span> <span class="n">DockReceiver</span><span class="o">(),</span> <span class="n">filter</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">mHandler</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>

<h4 id="关键函数">关键函数</h4>

<ul>
<li><p><code>userActivityNoUpdateLocked()</code></p>

<p>之前的很多方法中都会调用 <code>userActivityNoUpdateLocked()</code> 方法。该方法将触发一次用户活动，以更新用户活动的时间，这样屏幕变暗和熄灭时间就会重新进行计算。 这也就是为什么用户一直操作手机，屏幕不会熄灭或者变暗的原因。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">userActivityNoUpdateLocked</span><span class="o">(</span><span class="kt">long</span> <span class="n">eventTime</span><span class="o">,</span> <span class="kt">int</span> <span class="n">event</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">uid</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">eventTime</span> <span class="o">&lt;</span> <span class="n">mLastSleepTime</span> <span class="o">||</span> <span class="n">eventTime</span> <span class="o">&lt;</span> <span class="n">mLastWakeTime</span>
        <span class="o">||</span> <span class="o">!</span><span class="n">mBootCompleted</span> <span class="o">||</span> <span class="o">!</span><span class="n">mSystemReady</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_POWER</span><span class="o">,</span> <span class="s">&#34;userActivity&#34;</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">eventTime</span> <span class="o">&gt;</span> <span class="n">mLastInteractivePowerHintTime</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 更新最后一次交互时间
</span><span class="c1"></span>            <span class="n">powerHintInternal</span><span class="o">(</span><span class="n">PowerHint</span><span class="o">.</span><span class="na">INTERACTION</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
            <span class="n">mLastInteractivePowerHintTime</span> <span class="o">=</span> <span class="n">eventTime</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 发送用户活动通知
</span><span class="c1"></span>        <span class="n">mNotifier</span><span class="o">.</span><span class="na">onUserActivity</span><span class="o">(</span><span class="n">event</span><span class="o">,</span> <span class="n">uid</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">mUserInactiveOverrideFromWindowManager</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 置于活动状态
</span><span class="c1"></span>            <span class="n">mUserInactiveOverrideFromWindowManager</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="c1">// 取消下一次用户活动超时时间
</span><span class="c1"></span>            <span class="n">mOverriddenTimeout</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">mWakefulness</span> <span class="o">==</span> <span class="n">WAKEFULNESS_ASLEEP</span>
            <span class="o">||</span> <span class="n">mWakefulness</span> <span class="o">==</span> <span class="n">WAKEFULNESS_DOZING</span>
            <span class="o">||</span> <span class="o">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">USER_ACTIVITY_FLAG_INDIRECT</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 当前设备处于非唤醒状态，忽略用户活动
</span><span class="c1"></span>            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 更新配置文件最后一次用户活动时间
</span><span class="c1"></span>        <span class="n">maybeUpdateForegroundProfileLastActivityLocked</span><span class="o">(</span><span class="n">eventTime</span><span class="o">);</span>
        <span class="c1">// 更新  mLastUserActivityTimeNoChangeLights 和  mLastUserActivityTime 值；
</span><span class="c1"></span>        <span class="c1">//并且会更新  mDirty 值进而在  updatePowerStateLocked()  方法更新相关唤醒锁
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">USER_ACTIVITY_FLAG_NO_CHANGE_LIGHTS</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">eventTime</span> <span class="o">&gt;</span> <span class="n">mLastUserActivityTimeNoChangeLights</span>
                <span class="o">&amp;&amp;</span> <span class="n">eventTime</span> <span class="o">&gt;</span> <span class="n">mLastUserActivityTime</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mLastUserActivityTimeNoChangeLights</span> <span class="o">=</span> <span class="n">eventTime</span><span class="o">;</span>
                <span class="n">mDirty</span> <span class="o">|=</span> <span class="n">DIRTY_USER_ACTIVITY</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">USER_ACTIVITY_EVENT_BUTTON</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">mDirty</span> <span class="o">|=</span> <span class="n">DIRTY_QUIESCENT</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">eventTime</span> <span class="o">&gt;</span> <span class="n">mLastUserActivityTime</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mLastUserActivityTime</span> <span class="o">=</span> <span class="n">eventTime</span><span class="o">;</span>
                <span class="n">mDirty</span> <span class="o">|=</span> <span class="n">DIRTY_USER_ACTIVITY</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">USER_ACTIVITY_EVENT_BUTTON</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">mDirty</span> <span class="o">|=</span> <span class="n">DIRTY_QUIESCENT</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_POWER</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>updatePowerStateLocked()</code></p>

<p>根据 <code>mDirty</code> 的值更新全局电源状态，该方法是更新电源状态的主要方法。所有的状态都统一在这里处理，方便重新计算功率并在这里收集所有的过渡逻辑。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">updatePowerStateLocked</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// 服务还没初始化好
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(!</span><span class="n">mSystemReady</span> <span class="o">||</span> <span class="n">mDirty</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">Thread</span><span class="o">.</span><span class="na">holdsLock</span><span class="o">(</span><span class="n">mLock</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">Slog</span><span class="o">.</span><span class="na">wtf</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Power manager lock was not held when calling updatePowerStateLocked&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_POWER</span><span class="o">,</span> <span class="s">&#34;updatePowerState&#34;</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// Phase 0: Basic state updates.
</span><span class="c1"></span>        <span class="n">updateIsPoweredLocked</span><span class="o">(</span><span class="n">mDirty</span><span class="o">);</span>
        <span class="c1">// 更新  mStayOn 的值。 如果发生更改，则设置  DIRTY_STAY_ON。
</span><span class="c1"></span>        <span class="n">updateStayOnLocked</span><span class="o">(</span><span class="n">mDirty</span><span class="o">);</span>
        <span class="n">updateScreenBrightnessBoostLocked</span><span class="o">(</span><span class="n">mDirty</span><span class="o">);</span>

        <span class="c1">// Phase 1: Update wakefulness.
</span><span class="c1"></span>        <span class="c1">// Loop because the wake lock and user activity computations are influenced
</span><span class="c1"></span>        <span class="c1">// by changes in wakefulness.
</span><span class="c1"></span>        <span class="kd">final</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">dirtyPhase2</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">dirtyPhase1</span> <span class="o">=</span> <span class="n">mDirty</span><span class="o">;</span>
            <span class="n">dirtyPhase2</span> <span class="o">|=</span> <span class="n">dirtyPhase1</span><span class="o">;</span>
            <span class="n">mDirty</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

            <span class="n">updateWakeLockSummaryLocked</span><span class="o">(</span><span class="n">dirtyPhase1</span><span class="o">);</span>
            <span class="n">updateUserActivitySummaryLocked</span><span class="o">(</span><span class="n">now</span><span class="o">,</span> <span class="n">dirtyPhase1</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">updateWakefulnessLocked</span><span class="o">(</span><span class="n">dirtyPhase1</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// Phase 2: Lock profiles that became inactive/not kept awake.
</span><span class="c1"></span>        <span class="n">updateProfilesLocked</span><span class="o">(</span><span class="n">now</span><span class="o">);</span>

        <span class="c1">// Phase 3: Update display power state.
</span><span class="c1"></span>        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">displayBecameReady</span> <span class="o">=</span> <span class="n">updateDisplayPowerStateLocked</span><span class="o">(</span><span class="n">dirtyPhase2</span><span class="o">);</span>

        <span class="c1">// Phase 4: Update dream state (depends on display ready signal).
</span><span class="c1"></span>        <span class="n">updateDreamLocked</span><span class="o">(</span><span class="n">dirtyPhase2</span><span class="o">,</span> <span class="n">displayBecameReady</span><span class="o">);</span>

        <span class="c1">// Phase 5: Send notifications, if needed.
</span><span class="c1"></span>        <span class="n">finishWakefulnessChangeIfNeededLocked</span><span class="o">();</span>

        <span class="c1">// Phase 6: Update suspend blocker.
</span><span class="c1"></span>        <span class="c1">// Because we might release the last suspend blocker here, we need to make sure
</span><span class="c1"></span>        <span class="c1">// we finished everything else first!
</span><span class="c1"></span>        <span class="n">updateSuspendBlockerLocked</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_POWER</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<ol>
<li><p>基本状态更新</p>

<ol>
<li><p><code>updateIsPoweredLocked</code>
<code>mIsPowered</code> 如果发生更改，则更新 <code>mIsPowered.Sets DIRTY_IS_POWERED</code> 的值。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">updateIsPoweredLocked</span><span class="o">(</span><span class="kt">int</span> <span class="n">dirty</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">DIRTY_BATTERY_STATE</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">wasPowered</span> <span class="o">=</span> <span class="n">mIsPowered</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldPlugType</span> <span class="o">=</span> <span class="n">mPlugType</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">oldLevelLow</span> <span class="o">=</span> <span class="n">mBatteryLevelLow</span><span class="o">;</span>
        <span class="c1">// 是否在充电
</span><span class="c1"></span>        <span class="n">mIsPowered</span> <span class="o">=</span> <span class="n">mBatteryManagerInternal</span><span class="o">.</span><span class="na">isPowered</span><span class="o">(</span><span class="n">BatteryManager</span><span class="o">.</span><span class="na">BATTERY_PLUGGED_ANY</span><span class="o">);</span>
        <span class="c1">// 充电类型
</span><span class="c1"></span>        <span class="n">mPlugType</span> <span class="o">=</span> <span class="n">mBatteryManagerInternal</span><span class="o">.</span><span class="na">getPlugType</span><span class="o">();</span>
        <span class="c1">// 当前电量
</span><span class="c1"></span>        <span class="n">mBatteryLevel</span> <span class="o">=</span> <span class="n">mBatteryManagerInternal</span><span class="o">.</span><span class="na">getBatteryLevel</span><span class="o">();</span>
        <span class="c1">// 是否是低电量
</span><span class="c1"></span>        <span class="n">mBatteryLevelLow</span> <span class="o">=</span> <span class="n">mBatteryManagerInternal</span><span class="o">.</span><span class="na">getBatteryLevelLow</span><span class="o">();</span>
        <span class="c1">// 充电状态或充电类型改变则设置 =DIRTY_IS_POWERED=
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">wasPowered</span> <span class="o">!=</span> <span class="n">mIsPowered</span> <span class="o">||</span> <span class="n">oldPlugType</span> <span class="o">!=</span> <span class="n">mPlugType</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mDirty</span> <span class="o">|=</span> <span class="n">DIRTY_IS_POWERED</span><span class="o">;</span>

            <span class="c1">//检测无线充电坞站状态。
</span><span class="c1"></span>            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">dockedOnWirelessCharger</span> <span class="o">=</span> <span class="n">mWirelessChargerDetector</span><span class="o">.</span><span class="na">update</span><span class="o">(</span>
                                                                                    <span class="n">mIsPowered</span><span class="o">,</span> <span class="n">mPlugType</span><span class="o">);</span>
            <span class="c1">// 插拔充电器是用户行为，设备应该作出相应的反馈告知用户是否操作成功，
</span><span class="c1"></span>            <span class="c1">// 特别设备是没有充电指示灯时，一般可以通过唤醒屏幕通知用户
</span><span class="c1"></span>            <span class="kd">final</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
            <span class="c1">// 是否需要充电状态改变时唤醒屏幕
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">shouldWakeUpWhenPluggedOrUnpluggedLocked</span><span class="o">(</span><span class="n">wasPowered</span><span class="o">,</span> <span class="n">oldPlugType</span><span class="o">,</span>
                                                         <span class="n">dockedOnWirelessCharger</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">// 唤醒屏幕
</span><span class="c1"></span>                <span class="n">wakeUpNoUpdateLocked</span><span class="o">(</span><span class="n">now</span><span class="o">,</span> <span class="s">&#34;android.server.power:POWER&#34;</span><span class="o">,</span> <span class="n">Process</span><span class="o">.</span><span class="na">SYSTEM_UID</span><span class="o">,</span>
                                     <span class="n">mContext</span><span class="o">.</span><span class="na">getOpPackageName</span><span class="o">(),</span> <span class="n">Process</span><span class="o">.</span><span class="na">SYSTEM_UID</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">userActivityNoUpdateLocked</span><span class="o">(</span>
                                       <span class="n">now</span><span class="o">,</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">USER_ACTIVITY_EVENT_OTHER</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">Process</span><span class="o">.</span><span class="na">SYSTEM_UID</span><span class="o">);</span>
            <span class="c1">// 充电提示音
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">mBootCompleted</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mIsPowered</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">BatteryManager</span><span class="o">.</span><span class="na">isPlugWired</span><span class="o">(</span><span class="n">oldPlugType</span><span class="o">)</span>
                    <span class="o">&amp;&amp;</span> <span class="n">BatteryManager</span><span class="o">.</span><span class="na">isPlugWired</span><span class="o">(</span><span class="n">mPlugType</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">mNotifier</span><span class="o">.</span><span class="na">onWiredChargingStarted</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">dockedOnWirelessCharger</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">mNotifier</span><span class="o">.</span><span class="na">onWirelessChargingStarted</span><span class="o">(</span><span class="n">mBatteryLevel</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">mBatterySaverStateMachine</span><span class="o">.</span><span class="na">setBatteryStatus</span><span class="o">(</span><span class="n">mIsPowered</span><span class="o">,</span> <span class="n">mBatteryLevel</span><span class="o">,</span> <span class="n">mBatteryLevelLow</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>updateScreenBrightnessBoostLocked()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">updateScreenBrightnessBoostLocked</span><span class="o">(</span><span class="kt">int</span> <span class="n">dirty</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 屏幕将被点亮
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">((</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">DIRTY_SCREEN_BRIGHTNESS_BOOST</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mScreenBrightnessBoostInProgress</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
            <span class="c1">// 删除屏幕亮度提升结束消息
</span><span class="c1"></span>            <span class="n">mHandler</span><span class="o">.</span><span class="na">removeMessages</span><span class="o">(</span><span class="n">MSG_SCREEN_BRIGHTNESS_BOOST_TIMEOUT</span><span class="o">);</span>
            <span class="c1">// 设备未休眠时
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">mLastScreenBrightnessBoostTime</span> <span class="o">&gt;</span> <span class="n">mLastSleepTime</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="kt">long</span> <span class="n">boostTimeout</span> <span class="o">=</span> <span class="n">mLastScreenBrightnessBoostTime</span> <span class="o">+</span>
                    <span class="n">SCREEN_BRIGHTNESS_BOOST_TIMEOUT</span><span class="o">;</span>
                <span class="c1">// 屏幕亮度提升还未结束时
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">boostTimeout</span> <span class="o">&gt;</span> <span class="n">now</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 发送屏幕亮度提升结束消息
</span><span class="c1"></span>                    <span class="n">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">mHandler</span><span class="o">.</span><span class="na">obtainMessage</span><span class="o">(</span><span class="n">MSG_SCREEN_BRIGHTNESS_BOOST_TIMEOUT</span><span class="o">);</span>
                    <span class="n">msg</span><span class="o">.</span><span class="na">setAsynchronous</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                    <span class="n">mHandler</span><span class="o">.</span><span class="na">sendMessageAtTime</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">boostTimeout</span><span class="o">);</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">// 未执行点亮屏幕流程
</span><span class="c1"></span>            <span class="n">mScreenBrightnessBoostInProgress</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">mNotifier</span><span class="o">.</span><span class="na">onScreenBrightnessBoostChanged</span><span class="o">();</span>
            <span class="c1">// 更新本地属性但不点亮屏幕
</span><span class="c1"></span>            <span class="n">userActivityNoUpdateLocked</span><span class="o">(</span><span class="n">now</span><span class="o">,</span>
                                       <span class="n">PowerManager</span><span class="o">.</span><span class="na">USER_ACTIVITY_EVENT_OTHER</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">Process</span><span class="o">.</span><span class="na">SYSTEM_UID</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>
</ol></li>

<li><p>更新唤醒状态
因为唤醒锁和用户活动计时会受唤醒状态影响，所以循环更新前两者直到后者不改变。</p>

<ol>
<li><p><code>updateWakeLockSummaryLocked()</code>
更新 <code>mWakeLockSummary</code> 的值以汇总所有活动唤醒锁的状态。 请注意，系统处于休眠状态时会忽略大多数唤醒锁。 此功能应当保证没有其他副作用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">updateWakeLockSummaryLocked</span><span class="o">(</span><span class="kt">int</span> <span class="n">dirty</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// mWakeLocks 或  mWakefulness 有改变时
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">((</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">DIRTY_WAKE_LOCKS</span> <span class="o">|</span> <span class="n">DIRTY_WAKEFULNESS</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mWakeLockSummary</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="c1">// 多用户相关
</span><span class="c1"></span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">numProfiles</span> <span class="o">=</span> <span class="n">mProfilePowerState</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numProfiles</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">mProfilePowerState</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">mWakeLockSummary</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">//mWakeLocks 保存了用户创建的所有  wakelock
</span><span class="c1"></span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">numWakeLocks</span> <span class="o">=</span> <span class="n">mWakeLocks</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numWakeLocks</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">WakeLock</span> <span class="n">wakeLock</span> <span class="o">=</span> <span class="n">mWakeLocks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="c1">// 获取唤醒锁对应的  flag
</span><span class="c1"></span>            <span class="kd">final</span> <span class="kt">int</span> <span class="n">wakeLockFlags</span> <span class="o">=</span> <span class="n">getWakeLockSummaryFlags</span><span class="o">(</span><span class="n">wakeLock</span><span class="o">);</span>
            <span class="c1">// 加入到  mWakeLockSummary
</span><span class="c1"></span>            <span class="n">mWakeLockSummary</span> <span class="o">|=</span> <span class="n">wakeLockFlags</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">numProfiles</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="n">ProfilePowerState</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">mProfilePowerState</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">wakeLockAffectsUser</span><span class="o">(</span><span class="n">wakeLock</span><span class="o">,</span> <span class="n">profile</span><span class="o">.</span><span class="na">mUserId</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">profile</span><span class="o">.</span><span class="na">mWakeLockSummary</span> <span class="o">|=</span> <span class="n">wakeLockFlags</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// 去掉当前  mWakefulness 状态下无作用的锁，也会根据当前状态增加相关唤醒锁
</span><span class="c1"></span>        <span class="n">mWakeLockSummary</span> <span class="o">=</span> <span class="n">adjustWakeLockSummaryLocked</span><span class="o">(</span><span class="n">mWakeLockSummary</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numProfiles</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">ProfilePowerState</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">mProfilePowerState</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="n">profile</span><span class="o">.</span><span class="na">mWakeLockSummary</span> <span class="o">=</span> <span class="n">adjustWakeLockSummaryLocked</span><span class="o">(</span><span class="n">profile</span><span class="o">.</span><span class="na">mWakeLockSummary</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>updateUserActivitySummaryLocked()</code>
更新用户活动超时计时器状态</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">updateUserActivitySummaryLocked</span><span class="o">(</span><span class="kt">long</span> <span class="n">now</span><span class="o">,</span> <span class="kt">int</span> <span class="n">dirty</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 唤醒锁、用户活动、唤醒状态或相关设置项改变时
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">((</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">DIRTY_WAKE_LOCKS</span> <span class="o">|</span> <span class="n">DIRTY_USER_ACTIVITY</span>
                  <span class="o">|</span> <span class="n">DIRTY_WAKEFULNESS</span> <span class="o">|</span> <span class="n">DIRTY_SETTINGS</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 移除用户活动超时消息
</span><span class="c1"></span>        <span class="n">mHandler</span><span class="o">.</span><span class="na">removeMessages</span><span class="o">(</span><span class="n">MSG_USER_ACTIVITY_TIMEOUT</span><span class="o">);</span>
        <span class="c1">// WAKEFULNESS_ASLEEP 睡眠状态，只能被  wakeUp() 唤醒
</span><span class="c1"></span>        <span class="c1">// WAKEFULNESS_AWAKE 唤醒状态，系统正常运行
</span><span class="c1"></span>        <span class="c1">// WAKEFULNESS_DREAMING 屏保状态
</span><span class="c1"></span>        <span class="c1">// WAKEFULNESS_DOZING 打盹状态，只有低功耗的“屏保”可以运行，其他应用进程都比休眠
</span><span class="c1"></span>        <span class="kt">long</span> <span class="n">nextTimeout</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="c1">// 非睡眠状态时
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">mWakefulness</span> <span class="o">==</span> <span class="n">WAKEFULNESS_AWAKE</span>
            <span class="o">||</span> <span class="n">mWakefulness</span> <span class="o">==</span> <span class="n">WAKEFULNESS_DREAMING</span>
            <span class="o">||</span> <span class="n">mWakefulness</span> <span class="o">==</span> <span class="n">WAKEFULNESS_DOZING</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 睡眠超时时间
</span><span class="c1"></span>            <span class="kd">final</span> <span class="kt">long</span> <span class="n">sleepTimeout</span> <span class="o">=</span> <span class="n">getSleepTimeoutLocked</span><span class="o">();</span>
            <span class="c1">// 灭屏超时时间
</span><span class="c1"></span>            <span class="kd">final</span> <span class="kt">long</span> <span class="n">screenOffTimeout</span> <span class="o">=</span> <span class="n">getScreenOffTimeoutLocked</span><span class="o">(</span><span class="n">sleepTimeout</span><span class="o">);</span>
            <span class="c1">// 暗屏超时时间
</span><span class="c1"></span>            <span class="kd">final</span> <span class="kt">long</span> <span class="n">screenDimDuration</span> <span class="o">=</span> <span class="n">getScreenDimDurationLocked</span><span class="o">(</span><span class="n">screenOffTimeout</span><span class="o">);</span>
            <span class="c1">// WindowManager 通过其他方式确定用户处于非活动状态则为  true
</span><span class="c1"></span>            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">userInactiveOverride</span> <span class="o">=</span> <span class="n">mUserInactiveOverrideFromWindowManager</span><span class="o">;</span>
            <span class="c1">// 查找下一个配置文件的超时时间
</span><span class="c1"></span>            <span class="kd">final</span> <span class="kt">long</span> <span class="n">nextProfileTimeout</span> <span class="o">=</span> <span class="n">getNextProfileTimeoutLocked</span><span class="o">(</span><span class="n">now</span><span class="o">);</span>

            <span class="n">mUserActivitySummary</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
            <span class="c1">// 最后一次用户活动时间后于最后一次唤醒时间，说明当前处于唤醒状态
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">mLastUserActivityTime</span> <span class="o">&gt;=</span> <span class="n">mLastWakeTime</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 屏幕变暗时间
</span><span class="c1"></span>                <span class="n">nextTimeout</span> <span class="o">=</span> <span class="n">mLastUserActivityTime</span>
<span class="err">​</span>                    <span class="o">+</span> <span class="n">screenOffTimeout</span> <span class="o">-</span> <span class="n">screenDimDuration</span><span class="o">;</span>
                <span class="c1">// 判断是否处于暗屏状态
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">now</span> <span class="o">&lt;</span> <span class="n">nextTimeout</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">mUserActivitySummary</span> <span class="o">=</span> <span class="n">USER_ACTIVITY_SCREEN_BRIGHT</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="c1">// 灭屏时间
</span><span class="c1"></span>                    <span class="n">nextTimeout</span> <span class="o">=</span> <span class="n">mLastUserActivityTime</span> <span class="o">+</span> <span class="n">screenOffTimeout</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">now</span> <span class="o">&lt;</span> <span class="n">nextTimeout</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">mUserActivitySummary</span> <span class="o">=</span> <span class="n">USER_ACTIVITY_SCREEN_DIM</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">// 最后一次用户活动时间先于最后一次唤醒时间，但最后一次用户活动但未改变屏幕亮度的时间后于最后一次唤醒时间，说明当前仍处于唤醒状态
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">mUserActivitySummary</span> <span class="o">==</span> <span class="n">0</span>
                <span class="o">&amp;&amp;</span> <span class="n">mLastUserActivityTimeNoChangeLights</span> <span class="o">&gt;=</span> <span class="n">mLastWakeTime</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">nextTimeout</span> <span class="o">=</span> <span class="n">mLastUserActivityTimeNoChangeLights</span> <span class="o">+</span> <span class="n">screenOffTimeout</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">now</span> <span class="o">&lt;</span> <span class="n">nextTimeout</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 不改变屏幕状态
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">mDisplayPowerRequest</span><span class="o">.</span><span class="na">policy</span> <span class="o">==</span> <span class="n">DisplayPowerRequest</span><span class="o">.</span><span class="na">POLICY_BRIGHT</span>
                        <span class="o">||</span> <span class="n">mDisplayPowerRequest</span><span class="o">.</span><span class="na">policy</span> <span class="o">==</span> <span class="n">DisplayPowerRequest</span><span class="o">.</span><span class="na">POLICY_VR</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">mUserActivitySummary</span> <span class="o">=</span> <span class="n">USER_ACTIVITY_SCREEN_BRIGHT</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">mDisplayPowerRequest</span><span class="o">.</span><span class="na">policy</span> <span class="o">==</span> <span class="n">DisplayPowerRequest</span><span class="o">.</span><span class="na">POLICY_DIM</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">mUserActivitySummary</span> <span class="o">=</span> <span class="n">USER_ACTIVITY_SCREEN_DIM</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">mUserActivitySummary</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">sleepTimeout</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 最后用户活动时间
</span><span class="c1"></span>                    <span class="kd">final</span> <span class="kt">long</span> <span class="n">anyUserActivity</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">mLastUserActivityTime</span><span class="o">,</span>
                                                          <span class="n">mLastUserActivityTimeNoChangeLights</span><span class="o">);</span>
                    <span class="c1">// 只有在唤醒状态才更新睡眠时间
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">anyUserActivity</span> <span class="o">&gt;=</span> <span class="n">mLastWakeTime</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">nextTimeout</span> <span class="o">=</span> <span class="n">anyUserActivity</span> <span class="o">+</span> <span class="n">sleepTimeout</span><span class="o">;</span>
                        <span class="c1">// 此时已灭屏但还未休眠，进入屏幕状态
</span><span class="c1"></span>                        <span class="k">if</span> <span class="o">(</span><span class="n">now</span> <span class="o">&lt;</span> <span class="n">nextTimeout</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">mUserActivitySummary</span> <span class="o">=</span> <span class="n">USER_ACTIVITY_SCREEN_DREAM</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">mUserActivitySummary</span> <span class="o">=</span> <span class="n">USER_ACTIVITY_SCREEN_DREAM</span><span class="o">;</span>
                    <span class="n">nextTimeout</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">// WindowManager 通过其他方式确定用户处于非活动状态,但未进入屏保状态，直接置为屏保状态
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">mUserActivitySummary</span> <span class="o">!=</span> <span class="n">USER_ACTIVITY_SCREEN_DREAM</span> <span class="o">&amp;&amp;</span> <span class="n">userInactiveOverride</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">mUserActivitySummary</span> <span class="o">&amp;</span>
                     <span class="o">(</span><span class="n">USER_ACTIVITY_SCREEN_BRIGHT</span> <span class="o">|</span> <span class="n">USER_ACTIVITY_SCREEN_DIM</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// Device is being kept awake by recent user activity
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">nextTimeout</span> <span class="o">&gt;=</span> <span class="n">now</span> <span class="o">&amp;&amp;</span> <span class="n">mOverriddenTimeout</span> <span class="o">==</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// Save when the next timeout would have occurred
</span><span class="c1"></span>                        <span class="c1">// 保存下次可能的用户活动时间
</span><span class="c1"></span>                        <span class="n">mOverriddenTimeout</span> <span class="o">=</span> <span class="n">nextTimeout</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">mUserActivitySummary</span> <span class="o">=</span> <span class="n">USER_ACTIVITY_SCREEN_DREAM</span><span class="o">;</span>
                <span class="n">nextTimeout</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">nextProfileTimeout</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">nextTimeout</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">nextTimeout</span><span class="o">,</span> <span class="n">nextProfileTimeout</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">mUserActivitySummary</span> <span class="o">!=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">nextTimeout</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//根据  nextTimeOut 延迟发送信息，信息被处理后，将重新调用  updatePowerStateLocked，于是再次进入到该方法；通过不断进入该方法，不断评估是否根据用户动作亮、熄屏等
</span><span class="c1"></span>                <span class="n">scheduleUserInactivityTimeout</span><span class="o">(</span><span class="n">nextTimeout</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">mUserActivitySummary</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>updateWakefulnessLocked()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">updateWakefulnessLocked</span><span class="o">(</span><span class="kt">int</span> <span class="n">dirty</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">changed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="c1">// 一般只要  mDirty 值有改变就能满足这个条件
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">((</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">DIRTY_WAKE_LOCKS</span> <span class="o">|</span> <span class="n">DIRTY_USER_ACTIVITY</span> <span class="o">|</span> <span class="n">DIRTY_BOOT_COMPLETED</span>
                  <span class="o">|</span> <span class="n">DIRTY_WAKEFULNESS</span> <span class="o">|</span> <span class="n">DIRTY_STAY_ON</span> <span class="o">|</span> <span class="n">DIRTY_PROXIMITY_POSITIVE</span>
                  <span class="o">|</span> <span class="n">DIRTY_DOCK_STATE</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 要求唤醒状态并且将不能保持唤醒状态
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">mWakefulness</span> <span class="o">==</span> <span class="n">WAKEFULNESS_AWAKE</span> <span class="o">&amp;&amp;</span> <span class="n">isItBedTimeYetLocked</span><span class="o">())</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">long</span> <span class="n">time</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
            <span class="c1">// 用户活动超时时系统自动进入打盹并能进入屏保状态，主要根据设置判断是否满足进入屏保状态的条件
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">shouldNapAtBedTimeLocked</span><span class="o">())</span> <span class="o">{</span>
                <span class="c1">//将  mWakefullness 的值置为  WAKEFULNESS_DREAMING，修改  mDirty 变量，并进行通知
</span><span class="c1"></span>                <span class="n">changed</span> <span class="o">=</span> <span class="n">napNoUpdateLocked</span><span class="o">(</span><span class="n">time</span><span class="o">,</span> <span class="n">Process</span><span class="o">.</span><span class="na">SYSTEM_UID</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// 将  mWakefullness 的值置为  WAKEFULNESS_DOZING,如果系统设置了跳过  Dozing 态，则将  mWakefullness 置为  WAKEFULNESS_ASLEEP, 同时修改  mDirty 变量，并进行通知
</span><span class="c1"></span>                <span class="n">changed</span> <span class="o">=</span> <span class="n">goToSleepNoUpdateLocked</span><span class="o">(</span><span class="n">time</span><span class="o">,</span>
                                                  <span class="n">PowerManager</span><span class="o">.</span><span class="na">GO_TO_SLEEP_REASON_TIMEOUT</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">Process</span><span class="o">.</span><span class="na">SYSTEM_UID</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// 注意：napNoUpdateLocked() 和  goToSleepNoUpdateLocked() 函数正常执行后，都会将  mSandmanSummoned(是否准备进入屏保状态)置为  true
</span><span class="c1"></span>        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">changed</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>从上面的代码可以看出，如果终端可以一直保持唤醒状态，或一开始就是非唤醒态， 那么  mWakefulness 不会发生改变，第二阶段的  for 循环将会  break； 如果终端要从唤醒态变为非唤醒态，那么  for 循环将再运行一次，即重新计算一次  mWakeLockSummary 和  mUserActivitySummary。 这么做的原因是：updateWakeLockSummaryLocked 和  updateUserActivitySummaryLocked 函数的一些计算，与终端是否处于唤醒状态，即  mWakefulness 的值有关。 由于这两个函数并不会修改  mWakefulness，因此在这一次运行时，updateWakefulnessLocked 将返回  false，即第二阶段结束。
因此，我们可以得出结论：更新电源状态的第二阶段，正常情况下最多运行两次。</p></li>
</ol></li>

<li><p>如果不活动或不保持唤醒则锁定配置文件
<code>updateProfilesLocked()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">updateProfilesLocked</span><span class="o">(</span><span class="kt">long</span> <span class="n">now</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">numProfiles</span> <span class="o">=</span> <span class="n">mProfilePowerState</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numProfiles</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">ProfilePowerState</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">mProfilePowerState</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isProfileBeingKeptAwakeLocked</span><span class="o">(</span><span class="n">profile</span><span class="o">,</span> <span class="n">now</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// 保持唤醒，则不发送锁定通知
</span><span class="c1"></span>            <span class="n">profile</span><span class="o">.</span><span class="na">mLockingNotified</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">profile</span><span class="o">.</span><span class="na">mLockingNotified</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 不保持唤醒并且没有发送锁定通知，则发送锁定通知
</span><span class="c1"></span>            <span class="n">profile</span><span class="o">.</span><span class="na">mLockingNotified</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">mNotifier</span><span class="o">.</span><span class="na">onProfileTimeout</span><span class="o">(</span><span class="n">profile</span><span class="o">.</span><span class="na">mUserId</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p>更新屏幕显示状态
<code>updateDisplayPowerStateLocked()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">updateDisplayPowerStateLocked</span><span class="o">(</span><span class="kt">int</span> <span class="n">dirty</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">oldDisplayReady</span> <span class="o">=</span> <span class="n">mDisplayReady</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">DIRTY_WAKE_LOCKS</span> <span class="o">|</span> <span class="n">DIRTY_USER_ACTIVITY</span> <span class="o">|</span> <span class="n">DIRTY_WAKEFULNESS</span>
                  <span class="o">|</span> <span class="n">DIRTY_ACTUAL_DISPLAY_POWER_STATE_UPDATED</span> <span class="o">|</span> <span class="n">DIRTY_BOOT_COMPLETED</span>
                  <span class="o">|</span> <span class="n">DIRTY_SETTINGS</span> <span class="o">|</span> <span class="n">DIRTY_SCREEN_BRIGHTNESS_BOOST</span> <span class="o">|</span> <span class="n">DIRTY_VR_MODE_CHANGED</span> <span class="o">|</span>
                  <span class="n">DIRTY_QUIESCENT</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 主要根据  mWakefulness mWakeLockSummary mUserActivitySummary 这  3 个值
</span><span class="c1"></span>        <span class="c1">// 推断出当前屏幕的策略
</span><span class="c1"></span>        <span class="n">mDisplayPowerRequest</span><span class="o">.</span><span class="na">policy</span> <span class="o">=</span> <span class="n">getDesiredScreenPolicyLocked</span><span class="o">();</span>

        <span class="c1">// Determine appropriate screen brightness and auto-brightness adjustments.
</span><span class="c1"></span>        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">autoBrightness</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">screenBrightnessOverride</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">mBootCompleted</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Keep the brightness steady during boot. This requires the
</span><span class="c1"></span>            <span class="c1">// bootloader brightness and the default brightness to be identical.
</span><span class="c1"></span>            <span class="c1">// 启动尚未完成，该阶段保持屏幕亮度不变
</span><span class="c1"></span>            <span class="n">autoBrightness</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">screenBrightnessOverride</span> <span class="o">=</span> <span class="n">mScreenBrightnessSettingDefault</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">isValidBrightness</span><span class="o">(</span><span class="n">mScreenBrightnessOverrideFromWindowManager</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// 如果  WindowManager 有设置屏幕亮度值，则使用该值
</span><span class="c1"></span>            <span class="n">autoBrightness</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">screenBrightnessOverride</span> <span class="o">=</span> <span class="n">mScreenBrightnessOverrideFromWindowManager</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// 从设置读取是否开启自动亮度
</span><span class="c1"></span>            <span class="n">autoBrightness</span> <span class="o">=</span> <span class="o">(</span><span class="n">mScreenBrightnessModeSetting</span> <span class="o">==</span>
                              <span class="n">Settings</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">SCREEN_BRIGHTNESS_MODE_AUTOMATIC</span><span class="o">);</span>
            <span class="n">screenBrightnessOverride</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// Update display power request.
</span><span class="c1"></span>        <span class="n">mDisplayPowerRequest</span><span class="o">.</span><span class="na">screenBrightnessOverride</span> <span class="o">=</span> <span class="n">screenBrightnessOverride</span><span class="o">;</span>
        <span class="n">mDisplayPowerRequest</span><span class="o">.</span><span class="na">useAutoBrightness</span> <span class="o">=</span> <span class="n">autoBrightness</span><span class="o">;</span>
        <span class="n">mDisplayPowerRequest</span><span class="o">.</span><span class="na">useProximitySensor</span> <span class="o">=</span> <span class="n">shouldUseProximitySensorLocked</span><span class="o">();</span>
        <span class="n">mDisplayPowerRequest</span><span class="o">.</span><span class="na">boostScreenBrightness</span> <span class="o">=</span> <span class="n">shouldBoostScreenBrightness</span><span class="o">();</span>

        <span class="n">updatePowerRequestFromBatterySaverPolicy</span><span class="o">(</span><span class="n">mDisplayPowerRequest</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">mDisplayPowerRequest</span><span class="o">.</span><span class="na">policy</span> <span class="o">==</span> <span class="n">DisplayPowerRequest</span><span class="o">.</span><span class="na">POLICY_DOZE</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mDisplayPowerRequest</span><span class="o">.</span><span class="na">dozeScreenState</span> <span class="o">=</span> <span class="n">mDozeScreenStateOverrideFromDreamManager</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">mWakeLockSummary</span> <span class="o">&amp;</span> <span class="n">WAKE_LOCK_DRAW</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span>
                <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mDrawWakeLockOverrideFromSidekick</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mDisplayPowerRequest</span><span class="o">.</span><span class="na">dozeScreenState</span> <span class="o">==</span> <span class="n">Display</span><span class="o">.</span><span class="na">STATE_DOZE_SUSPEND</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">mDisplayPowerRequest</span><span class="o">.</span><span class="na">dozeScreenState</span> <span class="o">=</span> <span class="n">Display</span><span class="o">.</span><span class="na">STATE_DOZE</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mDisplayPowerRequest</span><span class="o">.</span><span class="na">dozeScreenState</span> <span class="o">==</span> <span class="n">Display</span><span class="o">.</span><span class="na">STATE_ON_SUSPEND</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">mDisplayPowerRequest</span><span class="o">.</span><span class="na">dozeScreenState</span> <span class="o">=</span> <span class="n">Display</span><span class="o">.</span><span class="na">STATE_ON</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">mDisplayPowerRequest</span><span class="o">.</span><span class="na">dozeScreenBrightness</span> <span class="o">=</span>
                <span class="n">mDozeScreenBrightnessOverrideFromDreamManager</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">mDisplayPowerRequest</span><span class="o">.</span><span class="na">dozeScreenState</span> <span class="o">=</span> <span class="n">Display</span><span class="o">.</span><span class="na">STATE_UNKNOWN</span><span class="o">;</span>
            <span class="n">mDisplayPowerRequest</span><span class="o">.</span><span class="na">dozeScreenBrightness</span> <span class="o">=</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">BRIGHTNESS_DEFAULT</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 实际上调用  DisplayPowerController 的  requestPowerState 函数
</span><span class="c1"></span>        <span class="c1">//在初始时，PMS 注册了  mDisplayPowerCallbacks 到  DisplayPowerController 中，
</span><span class="c1"></span>        <span class="c1">//当更新完成后，会回调定义的接口，重新  updatePowerStateLocked
</span><span class="c1"></span>        <span class="c1">// 这里就不展开分析了
</span><span class="c1"></span>        <span class="n">mDisplayReady</span> <span class="o">=</span> <span class="n">mDisplayManagerInternal</span><span class="o">.</span><span class="na">requestPowerState</span><span class="o">(</span><span class="n">mDisplayPowerRequest</span><span class="o">,</span>
                                                                  <span class="n">mRequestWaitForNegativeProximity</span><span class="o">);</span>
        <span class="n">mRequestWaitForNegativeProximity</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">((</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">DIRTY_QUIESCENT</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sQuiescent</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">mDisplayReady</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">oldDisplayReady</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p>更新屏保状态
如果上一步屏幕显示状态准备就绪，则发送消息更新屏保状态。</p></li>

<li><p>发送设备状态更新完毕通知
如果设置状态有更新且屏幕显示状态准备完毕，则发送设置状态更新完毕通知并记录相关日志。</p></li>

<li><p>更新  SuspendBlocker
由于系统可能需要释放最后一个 <code>SuspendBlocker</code> ，所以必须将其他所有事物处理完成，再执行该操作。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">updateSuspendBlockerLocked</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// 是否需要  cpu 挂起拦截器
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">needWakeLockSuspendBlocker</span> <span class="o">=</span> <span class="o">((</span><span class="n">mWakeLockSummary</span> <span class="o">&amp;</span> <span class="n">WAKE_LOCK_CPU</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">);</span>
    <span class="c1">// 是否需要屏幕挂起拦截器
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">needDisplaySuspendBlocker</span> <span class="o">=</span> <span class="n">needDisplaySuspendBlockerLocked</span><span class="o">();</span>
    <span class="c1">// 是否自动挂起
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">autoSuspend</span> <span class="o">=</span> <span class="o">!</span><span class="n">needDisplaySuspendBlocker</span><span class="o">;</span>
    <span class="c1">// 是否是可交互的
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">interactive</span> <span class="o">=</span> <span class="n">mDisplayPowerRequest</span><span class="o">.</span><span class="na">isBrightOrDim</span><span class="o">();</span>

    <span class="c1">// Disable auto-suspend if needed.
</span><span class="c1"></span>    <span class="c1">// FIXME We should consider just leaving auto-suspend enabled forever since
</span><span class="c1"></span>    <span class="c1">// we already hold the necessary wakelocks.
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(!</span><span class="n">autoSuspend</span> <span class="o">&amp;&amp;</span> <span class="n">mDecoupleHalAutoSuspendModeFromDisplayConfig</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 关闭自动挂起
</span><span class="c1"></span>        <span class="n">setHalAutoSuspendModeLocked</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// First acquire suspend blockers if needed.
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">needWakeLockSuspendBlocker</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mHoldingWakeLockSuspendBlocker</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 需要获取  cpu 挂起拦截器但还未获取，则获取
</span><span class="c1"></span>        <span class="n">mWakeLockSuspendBlocker</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
        <span class="n">mHoldingWakeLockSuspendBlocker</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">needDisplaySuspendBlocker</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mHoldingDisplaySuspendBlocker</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 需要获取屏幕挂起拦截器但还未获取，则获取
</span><span class="c1"></span>        <span class="n">mDisplaySuspendBlocker</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
        <span class="n">mHoldingDisplaySuspendBlocker</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Inform the power HAL about interactive mode.
</span><span class="c1"></span>    <span class="c1">// Although we could set interactive strictly based on the wakefulness
</span><span class="c1"></span>    <span class="c1">// as reported by isInteractive(), it is actually more desirable to track
</span><span class="c1"></span>    <span class="c1">// the display policy state instead so that the interactive state observed
</span><span class="c1"></span>    <span class="c1">// by the HAL more accurately tracks transitions between AWAKE and DOZING.
</span><span class="c1"></span>    <span class="c1">// Refer to getDesiredScreenPolicyLocked() for details.
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">mDecoupleHalInteractiveModeFromDisplayConfig</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// When becoming non-interactive, we want to defer sending this signal
</span><span class="c1"></span>        <span class="c1">// until the display is actually ready so that all transitions have
</span><span class="c1"></span>        <span class="c1">// completed.  This is probably a good sign that things have gotten
</span><span class="c1"></span>        <span class="c1">// too tangled over here...
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">interactive</span> <span class="o">||</span> <span class="n">mDisplayReady</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 开启交互模式
</span><span class="c1"></span>            <span class="n">setHalInteractiveModeLocked</span><span class="o">(</span><span class="n">interactive</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// Then release suspend blockers if needed.
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(!</span><span class="n">needWakeLockSuspendBlocker</span> <span class="o">&amp;&amp;</span> <span class="n">mHoldingWakeLockSuspendBlocker</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 不需要获取  cpu 挂起拦截器但还已获取，则释放
</span><span class="c1"></span>        <span class="n">mWakeLockSuspendBlocker</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
        <span class="n">mHoldingWakeLockSuspendBlocker</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">needDisplaySuspendBlocker</span> <span class="o">&amp;&amp;</span> <span class="n">mHoldingDisplaySuspendBlocker</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 不需要获取屏幕挂起拦截器但还已获取，则释放
</span><span class="c1"></span>        <span class="n">mDisplaySuspendBlocker</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
        <span class="n">mHoldingDisplaySuspendBlocker</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Enable auto-suspend if needed.
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">autoSuspend</span> <span class="o">&amp;&amp;</span> <span class="n">mDecoupleHalAutoSuspendModeFromDisplayConfig</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 开启自动挂起模式
</span><span class="c1"></span>        <span class="n">setHalAutoSuspendModeLocked</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>
</ol></li>
</ul>

<h4 id="wakelock-的使用"><code>WakeLock</code> 的使用</h4>

<ul>
<li><p>创建 <code>WakeLock</code>: <code>PowerManager.newWakeLock()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">WakeLock</span> <span class="nf">newWakeLock</span><span class="o">(</span><span class="kt">int</span> <span class="n">levelAndFlags</span><span class="o">,</span> <span class="n">String</span> <span class="n">tag</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//检查参数合法性，即  levelAndFlags 必须对应于  PowerManager 中定义的  WakeLock 级别和  flag，tag 不能为空
</span><span class="c1"></span>    <span class="n">validateWakeLockParameters</span><span class="o">(</span><span class="n">levelAndFlags</span><span class="o">,</span> <span class="n">tag</span><span class="o">);</span>
    <span class="c1">// WakeLock 是  PowerManagerService 的内部类
</span><span class="c1"></span>    <span class="k">return</span> <span class="k">new</span> <span class="n">WakeLock</span><span class="o">(</span><span class="n">levelAndFlags</span><span class="o">,</span> <span class="n">tag</span><span class="o">,</span> <span class="n">mContext</span><span class="o">.</span><span class="na">getOpPackageName</span><span class="o">());</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>WakeLock</code> 构造函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">     <span class="n">WakeLock</span><span class="o">(</span><span class="kt">int</span> <span class="n">flags</span><span class="o">,</span> <span class="n">String</span> <span class="n">tag</span><span class="o">,</span> <span class="n">String</span> <span class="n">packageName</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">mFlags</span> <span class="o">=</span> <span class="n">flags</span><span class="o">;</span>
         <span class="n">mTag</span> <span class="o">=</span> <span class="n">tag</span><span class="o">;</span>
<span class="c1">// 创建该唤醒锁的包名
</span><span class="c1"></span>         <span class="n">mPackageName</span> <span class="o">=</span> <span class="n">packageName</span><span class="o">;</span>
<span class="c1">// 创建  Binder 对象，PowerManagerService 将作为该对象的客户端监听对应进程是否死亡
</span><span class="c1"></span>         <span class="n">mToken</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Binder</span><span class="o">();</span>
         <span class="n">mTraceName</span> <span class="o">=</span> <span class="s">&#34;WakeLock (&#34;</span> <span class="o">+</span> <span class="n">mTag</span> <span class="o">+</span> <span class="s">&#34;)&#34;</span><span class="o">;</span>
     <span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p>获取唤醒锁</p>

<ol>
<li><p><code>acquire()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">acquire</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mToken</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">acquireLocked</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">acquire</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mToken</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">acquireLocked</span><span class="o">();</span>
        <span class="n">mHandler</span><span class="o">.</span><span class="na">postDelayed</span><span class="o">(</span><span class="n">mReleaser</span><span class="o">,</span> <span class="n">timeout</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">acquireLocked</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// 计数器增加
</span><span class="c1"></span>    <span class="n">mInternalCount</span><span class="o">++;</span>
    <span class="n">mExternalCount</span><span class="o">++;</span>
    <span class="c1">// mRefCounted = true, acquire() 方法最多只能被调用一次，须与  release() 方法一一对应
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(!</span><span class="n">mRefCounted</span> <span class="o">||</span> <span class="n">mInternalCount</span> <span class="o">==</span> <span class="n">1</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Do this even if the wake lock is already thought to be held (mHeld == true)
</span><span class="c1"></span>        <span class="c1">// because non-reference counted wake locks are not always properly released.
</span><span class="c1"></span>        <span class="c1">// For example, the keyguard&#39;s wake lock might be forcibly released by the
</span><span class="c1"></span>        <span class="c1">// power manager without the keyguard knowing.  A subsequent call to acquire
</span><span class="c1"></span>        <span class="c1">// should immediately acquire the wake lock once again despite never having
</span><span class="c1"></span>        <span class="c1">// been explicitly released by the keyguard.
</span><span class="c1"></span>        <span class="n">mHandler</span><span class="o">.</span><span class="na">removeCallbacks</span><span class="o">(</span><span class="n">mReleaser</span><span class="o">);</span>
        <span class="n">Trace</span><span class="o">.</span><span class="na">asyncTraceBegin</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_POWER</span><span class="o">,</span> <span class="n">mTraceName</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// IPC 调用  PowerManagerService
</span><span class="c1"></span>            <span class="n">mService</span><span class="o">.</span><span class="na">acquireWakeLock</span><span class="o">(</span><span class="n">mToken</span><span class="o">,</span> <span class="n">mFlags</span><span class="o">,</span> <span class="n">mTag</span><span class="o">,</span> <span class="n">mPackageName</span><span class="o">,</span> <span class="n">mWorkSource</span><span class="o">,</span>
                                     <span class="n">mHistoryTag</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">rethrowFromSystemServer</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">mHeld</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>acquireWakeLock()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">acquireWakeLock</span><span class="o">(</span><span class="n">IBinder</span> <span class="n">lock</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">,</span> <span class="n">String</span> <span class="n">tag</span><span class="o">,</span> <span class="n">String</span> <span class="n">packageName</span><span class="o">,</span>
                            <span class="n">WorkSource</span> <span class="n">ws</span><span class="o">,</span> <span class="n">String</span> <span class="n">historyTag</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 合法性及权限检查
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">lock</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;lock must not be null&#34;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">packageName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;packageName must not be null&#34;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">PowerManager</span><span class="o">.</span><span class="na">validateWakeLockParameters</span><span class="o">(</span><span class="n">flags</span><span class="o">,</span> <span class="n">tag</span><span class="o">);</span>

    <span class="n">mContext</span><span class="o">.</span><span class="na">enforceCallingOrSelfPermission</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">WAKE_LOCK</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">DOZE_WAKE_LOCK</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mContext</span><span class="o">.</span><span class="na">enforceCallingOrSelfPermission</span><span class="o">(</span>
                                                <span class="n">android</span><span class="o">.</span><span class="na">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">DEVICE_POWER</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">ws</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ws</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">mContext</span><span class="o">.</span><span class="na">enforceCallingOrSelfPermission</span><span class="o">(</span>
                                                <span class="n">android</span><span class="o">.</span><span class="na">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">UPDATE_DEVICE_STATS</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">getCallingUid</span><span class="o">();</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">getCallingPid</span><span class="o">();</span>
    <span class="c1">// 替换为当前进程身份进行调用，并保存原有信息用于后面恢复
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">long</span> <span class="n">ident</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">clearCallingIdentity</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">acquireWakeLockInternal</span><span class="o">(</span><span class="n">lock</span><span class="o">,</span> <span class="n">flags</span><span class="o">,</span> <span class="n">tag</span><span class="o">,</span> <span class="n">packageName</span><span class="o">,</span> <span class="n">ws</span><span class="o">,</span> <span class="n">historyTag</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">pid</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="c1">// 恢复调用者身份：Uid 和  Pid
</span><span class="c1"></span>        <span class="n">Binder</span><span class="o">.</span><span class="na">restoreCallingIdentity</span><span class="o">(</span><span class="n">ident</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">acquireWakeLockInternal</span><span class="o">(</span><span class="n">IBinder</span> <span class="n">lock</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">,</span> <span class="n">String</span> <span class="n">tag</span><span class="o">,</span> <span class="n">String</span> <span class="n">packageName</span><span class="o">,</span>
                                     <span class="n">WorkSource</span> <span class="n">ws</span><span class="o">,</span> <span class="n">String</span> <span class="n">historyTag</span><span class="o">,</span> <span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">pid</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// PowerManagerService 也定义了一个  WakeLock 内部类
</span><span class="c1"></span>        <span class="n">WakeLock</span> <span class="n">wakeLock</span><span class="o">;</span>
        <span class="c1">// 检查当前唤醒锁是否已被申请过
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">findWakeLockIndexLocked</span><span class="o">(</span><span class="n">lock</span><span class="o">);</span>
        <span class="kt">boolean</span> <span class="n">notifyAcquire</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">wakeLock</span> <span class="o">=</span> <span class="n">mWakeLocks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
            <span class="c1">// 如果该唤醒锁已存在，并且属性有改变则更新属性
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(!</span><span class="n">wakeLock</span><span class="o">.</span><span class="na">hasSameProperties</span><span class="o">(</span><span class="n">flags</span><span class="o">,</span> <span class="n">tag</span><span class="o">,</span> <span class="n">ws</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">pid</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">// Update existing wake lock.  This shouldn&#39;t happen but is harmless.
</span><span class="c1"></span>                <span class="n">notifyWakeLockChangingLocked</span><span class="o">(</span><span class="n">wakeLock</span><span class="o">,</span> <span class="n">flags</span><span class="o">,</span> <span class="n">tag</span><span class="o">,</span> <span class="n">packageName</span><span class="o">,</span>
                                             <span class="n">uid</span><span class="o">,</span> <span class="n">pid</span><span class="o">,</span> <span class="n">ws</span><span class="o">,</span> <span class="n">historyTag</span><span class="o">);</span>
                <span class="n">wakeLock</span><span class="o">.</span><span class="na">updateProperties</span><span class="o">(</span><span class="n">flags</span><span class="o">,</span> <span class="n">tag</span><span class="o">,</span> <span class="n">packageName</span><span class="o">,</span> <span class="n">ws</span><span class="o">,</span> <span class="n">historyTag</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">pid</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">notifyAcquire</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// 保存获取当前请求唤醒锁用户的唤醒锁状态
</span><span class="c1"></span>            <span class="n">UidState</span> <span class="n">state</span> <span class="o">=</span> <span class="n">mUidState</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">uid</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">state</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 不存在当前用户的锁状态则新建一个并加入到  mUidState 列表
</span><span class="c1"></span>                <span class="n">state</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UidState</span><span class="o">(</span><span class="n">uid</span><span class="o">);</span>
                <span class="n">state</span><span class="o">.</span><span class="na">mProcState</span> <span class="o">=</span> <span class="n">ActivityManager</span><span class="o">.</span><span class="na">PROCESS_STATE_NONEXISTENT</span><span class="o">;</span>
                <span class="n">mUidState</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">uid</span><span class="o">,</span> <span class="n">state</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">//增加当前用户请求的唤醒锁数量
</span><span class="c1"></span>            <span class="n">state</span><span class="o">.</span><span class="na">mNumWakeLocks</span><span class="o">++;</span>
            <span class="c1">// 新建一个唤醒锁
</span><span class="c1"></span>            <span class="n">wakeLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WakeLock</span><span class="o">(</span><span class="n">lock</span><span class="o">,</span> <span class="n">flags</span><span class="o">,</span> <span class="n">tag</span><span class="o">,</span> <span class="n">packageName</span><span class="o">,</span> <span class="n">ws</span><span class="o">,</span> <span class="n">historyTag</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">pid</span><span class="o">,</span>
                                    <span class="n">state</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// 1) 监听当前请求唤醒锁用户进程的死亡状态
</span><span class="c1"></span>                <span class="n">lock</span><span class="o">.</span><span class="na">linkToDeath</span><span class="o">(</span><span class="n">wakeLock</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;Wake lock is already dead.&#34;</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// 把新建的唤醒锁增加到  mWakeLocks 列表
</span><span class="c1"></span>            <span class="n">mWakeLocks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">wakeLock</span><span class="o">);</span>
            <span class="c1">// 2) 更新唤醒锁的  mDisabled 变量
</span><span class="c1"></span>            <span class="n">setWakeLockDisabledStateLocked</span><span class="o">(</span><span class="n">wakeLock</span><span class="o">);</span>
            <span class="n">notifyAcquire</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 3) 处理  flag 属性
</span><span class="c1"></span>        <span class="n">applyWakeLockFlagsOnAcquireLocked</span><span class="o">(</span><span class="n">wakeLock</span><span class="o">,</span> <span class="n">uid</span><span class="o">);</span>
        <span class="c1">// 标记唤醒锁有改变
</span><span class="c1"></span>        <span class="n">mDirty</span> <span class="o">|=</span> <span class="n">DIRTY_WAKE_LOCKS</span><span class="o">;</span>
        <span class="c1">// 更新系统电源状态
</span><span class="c1"></span>        <span class="n">updatePowerStateLocked</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">notifyAcquire</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// This needs to be done last so we are sure we have acquired the
</span><span class="c1"></span>            <span class="c1">// kernel wake lock.  Otherwise we have a race where the system may
</span><span class="c1"></span>            <span class="c1">// go to sleep between the time we start the accounting in battery
</span><span class="c1"></span>            <span class="c1">// stats and when we actually get around to telling the kernel to
</span><span class="c1"></span>            <span class="c1">// stay awake.
</span><span class="c1"></span>            <span class="c1">// 通知唤醒锁改变，电量统计服务统计电量
</span><span class="c1"></span>            <span class="n">notifyWakeLockAcquiredLocked</span><span class="o">(</span><span class="n">wakeLock</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<ol>
<li><p><code>lock.linkToDeath(akeLock, 0)</code>
<code>lock</code> 其实是请求唤醒锁进程  Binder 服务的代理，通过  linkToDeath() 方法注册其死亡通知， <code>wakeLock</code> 需要实现 <code>IBinder.DeathRecipient</code> 接口，当请求唤醒锁的进程死亡时会回调该接口的 <code>binderDied()</code> 方法，这个过程是通过  Binder 机制实现的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">binderDied</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">PowerManagerService</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">handleWakeLockDeath</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleWakeLockDeath</span><span class="o">(</span><span class="n">WakeLock</span> <span class="n">wakeLock</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">mWakeLocks</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">wakeLock</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">removeWakeLockLocked</span><span class="o">(</span><span class="n">wakeLock</span><span class="o">,</span> <span class="n">index</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">removeWakeLockLocked</span><span class="o">(</span><span class="n">WakeLock</span> <span class="n">wakeLock</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 从唤醒锁列表中移除该唤醒锁
</span><span class="c1"></span>    <span class="n">mWakeLocks</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="n">UidState</span> <span class="n">state</span> <span class="o">=</span> <span class="n">wakeLock</span><span class="o">.</span><span class="na">mUidState</span><span class="o">;</span>
    <span class="c1">// 请求唤醒锁用户状态中的唤醒锁数量减一
</span><span class="c1"></span>    <span class="n">state</span><span class="o">.</span><span class="na">mNumWakeLocks</span><span class="o">--;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">mNumWakeLocks</span> <span class="o">&lt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
        <span class="n">state</span><span class="o">.</span><span class="na">mProcState</span> <span class="o">==</span> <span class="n">ActivityManager</span><span class="o">.</span><span class="na">PROCESS_STATE_NONEXISTENT</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mUidState</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">mUid</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">notifyWakeLockReleasedLocked</span><span class="o">(</span><span class="n">wakeLock</span><span class="o">);</span>
    <span class="c1">// 主要是看有没有保持屏幕唤醒的锁，没有就息屏
</span><span class="c1"></span>    <span class="n">applyWakeLockFlagsOnReleaseLocked</span><span class="o">(</span><span class="n">wakeLock</span><span class="o">);</span>
    <span class="n">mDirty</span> <span class="o">|=</span> <span class="n">DIRTY_WAKE_LOCKS</span><span class="o">;</span>
    <span class="n">updatePowerStateLocked</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isScreenLock</span><span class="o">(</span><span class="kd">final</span> <span class="n">WakeLock</span> <span class="n">wakeLock</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">wakeLock</span><span class="o">.</span><span class="na">mFlags</span> <span class="o">&amp;</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">WAKE_LOCK_LEVEL_MASK</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">FULL_WAKE_LOCK</span><span class="o">:</span>
    <span class="k">case</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">SCREEN_BRIGHT_WAKE_LOCK</span><span class="o">:</span>
    <span class="k">case</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">SCREEN_DIM_WAKE_LOCK</span><span class="o">:</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">applyWakeLockFlagsOnReleaseLocked</span><span class="o">(</span><span class="n">WakeLock</span> <span class="n">wakeLock</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">wakeLock</span><span class="o">.</span><span class="na">mFlags</span> <span class="o">&amp;</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">ON_AFTER_RELEASE</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span>
        <span class="o">&amp;&amp;</span> <span class="n">isScreenLock</span><span class="o">(</span><span class="n">wakeLock</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">userActivityNoUpdateLocked</span><span class="o">(</span><span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">(),</span>
                                   <span class="n">PowerManager</span><span class="o">.</span><span class="na">USER_ACTIVITY_EVENT_OTHER</span><span class="o">,</span>
                                   <span class="n">PowerManager</span><span class="o">.</span><span class="na">USER_ACTIVITY_FLAG_NO_CHANGE_LIGHTS</span><span class="o">,</span>
                                   <span class="n">wakeLock</span><span class="o">.</span><span class="na">mOwnerUid</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>setWakeLockDisabledStateLocked()</code>
主要是根据  Doze 模式的白名单和进程优先级来看 <code>PowerManager.PARTIAL_WAKE_LOCK</code> 唤醒锁是否要更新 <code>mDisabled</code> 变量</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">setWakeLockDisabledStateLocked</span><span class="o">(</span><span class="n">WakeLock</span> <span class="n">wakeLock</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">wakeLock</span><span class="o">.</span><span class="na">mFlags</span> <span class="o">&amp;</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">WAKE_LOCK_LEVEL_MASK</span><span class="o">)</span>
        <span class="o">==</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">PARTIAL_WAKE_LOCK</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">disabled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">appid</span> <span class="o">=</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">getAppId</span><span class="o">(</span><span class="n">wakeLock</span><span class="o">.</span><span class="na">mOwnerUid</span><span class="o">);</span>
        <span class="c1">// 判断是否为非系统应用
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">appid</span> <span class="o">&gt;=</span> <span class="n">Process</span><span class="o">.</span><span class="na">FIRST_APPLICATION_UID</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Cached inactive processes are never allowed to hold wake locks.
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">mConstants</span><span class="o">.</span><span class="na">NO_CACHED_WAKE_LOCKS</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">disabled</span> <span class="o">=</span>
                    <span class="c1">// 当前用户身份状态是有效的
</span><span class="c1"></span>                    <span class="o">!</span><span class="n">wakeLock</span><span class="o">.</span><span class="na">mUidState</span><span class="o">.</span><span class="na">mActive</span>
                    <span class="c1">// 当前进程是存在的
</span><span class="c1"></span>                    <span class="o">&amp;&amp;</span> <span class="n">wakeLock</span><span class="o">.</span><span class="na">mUidState</span><span class="o">.</span><span class="na">mProcState</span> <span class="o">!=</span> <span class="n">ActivityManager</span><span class="o">.</span><span class="na">PROCESS_STATE_NONEXISTENT</span>
                    <span class="c1">// 进程优先级，越大越容易被杀死
</span><span class="c1"></span>                    <span class="o">&amp;&amp;</span> <span class="n">wakeLock</span><span class="o">.</span><span class="na">mUidState</span><span class="o">.</span><span class="na">mProcState</span> <span class="o">&gt;</span> <span class="n">ActivityManager</span><span class="o">.</span><span class="na">PROCESS_STATE_RECEIVER</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// 设置是否处于  IDLE 模式
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">mDeviceIdleMode</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// If we are in idle mode, we will also ignore all partial wake locks that are
</span><span class="c1"></span>                <span class="c1">// for application uids that are not whitelisted.
</span><span class="c1"></span>                <span class="kd">final</span> <span class="n">UidState</span> <span class="n">state</span> <span class="o">=</span> <span class="n">wakeLock</span><span class="o">.</span><span class="na">mUidState</span><span class="o">;</span>
                <span class="c1">// 搜索白名单
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">binarySearch</span><span class="o">(</span><span class="n">mDeviceIdleWhitelist</span><span class="o">,</span> <span class="n">appid</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
                    <span class="n">Arrays</span><span class="o">.</span><span class="na">binarySearch</span><span class="o">(</span><span class="n">mDeviceIdleTempWhitelist</span><span class="o">,</span> <span class="n">appid</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
                    <span class="n">state</span><span class="o">.</span><span class="na">mProcState</span> <span class="o">!=</span> <span class="n">ActivityManager</span><span class="o">.</span><span class="na">PROCESS_STATE_NONEXISTENT</span> <span class="o">&amp;&amp;</span>
                    <span class="n">state</span><span class="o">.</span><span class="na">mProcState</span> <span class="o">&gt;</span>
                    <span class="n">ActivityManager</span><span class="o">.</span><span class="na">PROCESS_STATE_BOUND_FOREGROUND_SERVICE</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">disabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">wakeLock</span><span class="o">.</span><span class="na">mDisabled</span> <span class="o">!=</span> <span class="n">disabled</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">wakeLock</span><span class="o">.</span><span class="na">mDisabled</span> <span class="o">=</span> <span class="n">disabled</span><span class="o">;</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>applyWakeLockFlagsOnAcquireLocked()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">applyWakeLockFlagsOnAcquireLocked</span><span class="o">(</span><span class="n">WakeLock</span> <span class="n">wakeLock</span><span class="o">,</span> <span class="kt">int</span> <span class="n">uid</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 主要是检查  PowerManager.ACQUIRE_CAUSES_WAKEUP 属性及是否涉及到屏幕亮灭
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">((</span><span class="n">wakeLock</span><span class="o">.</span><span class="na">mFlags</span> <span class="o">&amp;</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">ACQUIRE_CAUSES_WAKEUP</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span>
        <span class="o">&amp;&amp;</span> <span class="n">isScreenLock</span><span class="o">(</span><span class="n">wakeLock</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">opPackageName</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">opUid</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">wakeLock</span><span class="o">.</span><span class="na">mWorkSource</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">wakeLock</span><span class="o">.</span><span class="na">mWorkSource</span><span class="o">.</span><span class="na">getName</span><span class="o">(</span><span class="n">0</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">opPackageName</span> <span class="o">=</span> <span class="n">wakeLock</span><span class="o">.</span><span class="na">mWorkSource</span><span class="o">.</span><span class="na">getName</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
            <span class="n">opUid</span> <span class="o">=</span> <span class="n">wakeLock</span><span class="o">.</span><span class="na">mWorkSource</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">opPackageName</span> <span class="o">=</span> <span class="n">wakeLock</span><span class="o">.</span><span class="na">mPackageName</span><span class="o">;</span>
            <span class="n">opUid</span> <span class="o">=</span> <span class="n">wakeLock</span><span class="o">.</span><span class="na">mWorkSource</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">wakeLock</span><span class="o">.</span><span class="na">mWorkSource</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">)</span>
                <span class="o">:</span> <span class="n">wakeLock</span><span class="o">.</span><span class="na">mOwnerUid</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">wakeUpNoUpdateLocked</span><span class="o">(</span><span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">(),</span> <span class="n">wakeLock</span><span class="o">.</span><span class="na">mTag</span><span class="o">,</span> <span class="n">opUid</span><span class="o">,</span>
                             <span class="n">opPackageName</span><span class="o">,</span> <span class="n">opUid</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p><a href="#orga7a97cb">wakeUpNoUpdateLocked()</a> 前面有分析过的</p></li>
</ol></li>
</ol></li>

<li><p>释放唤醒锁</p>

<ol>
<li><p><code>release()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">release</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">release</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">release</span><span class="o">(</span><span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mToken</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mInternalCount</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// internal count must only be decreased if it is &gt; 0 or state of
</span><span class="c1"></span>            <span class="c1">// the WakeLock object is broken.
</span><span class="c1"></span>            <span class="n">mInternalCount</span><span class="o">--;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RELEASE_FLAG_TIMEOUT</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
 <span class="c1">// 唤醒锁不是超时而被调用的
</span><span class="c1"></span>            <span class="n">mExternalCount</span><span class="o">--;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">mRefCounted</span> <span class="o">||</span> <span class="n">mInternalCount</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mHandler</span><span class="o">.</span><span class="na">removeCallbacks</span><span class="o">(</span><span class="n">mReleaser</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mHeld</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Trace</span><span class="o">.</span><span class="na">asyncTraceEnd</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_POWER</span><span class="o">,</span> <span class="n">mTraceName</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="c1">// 通过  Binder 调用  PowerManagerService.releaseWakeLock() 方法
</span><span class="c1"></span>                    <span class="n">mService</span><span class="o">.</span><span class="na">releaseWakeLock</span><span class="o">(</span><span class="n">mToken</span><span class="o">,</span> <span class="n">flags</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">rethrowFromSystemServer</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="n">mHeld</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mRefCounted</span> <span class="o">&amp;&amp;</span> <span class="n">mExternalCount</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;WakeLock under-locked &#34;</span> <span class="o">+</span> <span class="n">mTag</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>releaseWakeLock()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">           <span class="kd">public</span> <span class="kt">void</span> <span class="nf">releaseWakeLock</span><span class="o">(</span><span class="n">IBinder</span> <span class="n">lock</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">lock</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                   <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;lock must not be null&#34;</span><span class="o">);</span>
               <span class="o">}</span>

               <span class="n">mContext</span><span class="o">.</span><span class="na">enforceCallingOrSelfPermission</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">WAKE_LOCK</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

               <span class="kd">final</span> <span class="kt">long</span> <span class="n">ident</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">clearCallingIdentity</span><span class="o">();</span>
               <span class="k">try</span> <span class="o">{</span>
                   <span class="n">releaseWakeLockInternal</span><span class="o">(</span><span class="n">lock</span><span class="o">,</span> <span class="n">flags</span><span class="o">);</span>
               <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                   <span class="n">Binder</span><span class="o">.</span><span class="na">restoreCallingIdentity</span><span class="o">(</span><span class="n">ident</span><span class="o">);</span>
               <span class="o">}</span>
           <span class="o">}</span>

           <span class="kd">private</span> <span class="kt">void</span> <span class="nf">releaseWakeLockInternal</span><span class="o">(</span><span class="n">IBinder</span> <span class="n">lock</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="o">{</span>
                   <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
                       <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">findWakeLockIndexLocked</span><span class="o">(</span><span class="n">lock</span><span class="o">);</span>
                       <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                           <span class="k">return</span><span class="o">;</span>
                       <span class="o">}</span>

                       <span class="n">WakeLock</span> <span class="n">wakeLock</span> <span class="o">=</span> <span class="n">mWakeLocks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
<span class="c1">// 近距离感应离物体较远
</span><span class="c1"></span>                       <span class="k">if</span> <span class="o">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">RELEASE_FLAG_WAIT_FOR_NO_PROXIMITY</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                           <span class="n">mRequestWaitForNegativeProximity</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                       <span class="o">}</span>
<span class="c1">// 注销死亡通知
</span><span class="c1"></span>                       <span class="n">wakeLock</span><span class="o">.</span><span class="na">mLock</span><span class="o">.</span><span class="na">unlinkToDeath</span><span class="o">(</span><span class="n">wakeLock</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
                       <span class="n">removeWakeLockLocked</span><span class="o">(</span><span class="n">wakeLock</span><span class="o">,</span> <span class="n">index</span><span class="o">);</span>
                   <span class="o">}</span>
               <span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>removeWakeLockLocked()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">           <span class="kd">private</span> <span class="kt">void</span> <span class="nf">removeWakeLockLocked</span><span class="o">(</span><span class="n">WakeLock</span> <span class="n">wakeLock</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">mWakeLocks</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
               <span class="n">UidState</span> <span class="n">state</span> <span class="o">=</span> <span class="n">wakeLock</span><span class="o">.</span><span class="na">mUidState</span><span class="o">;</span>
               <span class="n">state</span><span class="o">.</span><span class="na">mNumWakeLocks</span><span class="o">--;</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">mNumWakeLocks</span> <span class="o">&lt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
                   <span class="n">state</span><span class="o">.</span><span class="na">mProcState</span> <span class="o">==</span> <span class="n">ActivityManager</span><span class="o">.</span><span class="na">PROCESS_STATE_NONEXISTENT</span><span class="o">)</span> <span class="o">{</span>
                   <span class="n">mUidState</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">mUid</span><span class="o">);</span>
               <span class="o">}</span>
    <span class="c1">// 通知锁释放，电量统计
</span><span class="c1"></span>               <span class="n">notifyWakeLockReleasedLocked</span><span class="o">(</span><span class="n">wakeLock</span><span class="o">);</span>
<span class="c1">// 与获取唤醒锁是类似，只不过是互逆的
</span><span class="c1"></span>               <span class="n">applyWakeLockFlagsOnReleaseLocked</span><span class="o">(</span><span class="n">wakeLock</span><span class="o">);</span>
               <span class="n">mDirty</span> <span class="o">|=</span> <span class="n">DIRTY_WAKE_LOCKS</span><span class="o">;</span>
               <span class="n">updatePowerStateLocked</span><span class="o">();</span>
           <span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>
</ol></li>
</ul>

<h4 id="power-键动作流程">Power 键动作流程</h4>

<p>Power 键属于物理输入硬件由 <code>InputManagerService</code> 管理其按键触发事件，该事件最终会传递到 <code>PhoneWindowManager</code> 的 <code>intercdeptKeyBeforeQueueing()</code> 函数。</p>

<ol>
<li><p><code>intercdeptKeyBeforeQueueing()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">int</span> <span class="nf">interceptKeyBeforeQueueing</span><span class="o">(</span><span class="n">KeyEvent</span> <span class="n">event</span><span class="o">,</span> <span class="kt">int</span> <span class="n">policyFlags</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">mSystemBooted</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// If we have not yet booted, don&#39;t let key events do anything.
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// 是否处于交互模式，即是否要亮屏
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">interactive</span> <span class="o">=</span> <span class="o">(</span><span class="n">policyFlags</span> <span class="o">&amp;</span> <span class="n">FLAG_INTERACTIVE</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">;</span>
    <span class="c1">// 是否是按下事件
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">down</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getAction</span><span class="o">()</span> <span class="o">==</span> <span class="n">KeyEvent</span><span class="o">.</span><span class="na">ACTION_DOWN</span><span class="o">;</span>
    <span class="c1">// 是否被标记取消
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">canceled</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">isCanceled</span><span class="o">();</span>
    <span class="c1">// 获取键值
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">keyCode</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getKeyCode</span><span class="o">();</span>

    <span class="o">...</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">keyCode</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="n">KeyEvent</span><span class="o">.</span><span class="na">KEYCODE_POWER</span><span class="o">:</span> <span class="o">{</span>
            <span class="c1">// Any activity on the power button stops the accessibility shortcut
</span><span class="c1"></span>            <span class="c1">// 电源键事件会停止辅助功能快捷方式
</span><span class="c1"></span>            <span class="n">cancelPendingAccessibilityShortcutAction</span><span class="o">();</span>
            <span class="n">result</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACTION_PASS_TO_USER</span><span class="o">;</span>
            <span class="c1">// 这里不作唤醒处理
</span><span class="c1"></span>            <span class="n">isWakeKey</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// wake-up will be handled separately
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">down</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 处理电源键按下动作
</span><span class="c1"></span>                <span class="n">interceptPowerKeyDown</span><span class="o">(</span><span class="n">event</span><span class="o">,</span> <span class="n">interactive</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// 处理电源键松开动作
</span><span class="c1"></span>                <span class="n">interceptPowerKeyUp</span><span class="o">(</span><span class="n">event</span><span class="o">,</span> <span class="n">interactive</span><span class="o">,</span> <span class="n">canceled</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="o">...</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isWakeKey</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 电源键事件不会走这里
</span><span class="c1"></span>        <span class="n">wakeUp</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getEventTime</span><span class="o">(),</span> <span class="n">mAllowTheaterModeWakeFromKey</span><span class="o">,</span> <span class="s">&#34;android.policy:KEY&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>interceptPowerKeyDown()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">interceptPowerKeyDown</span><span class="o">(</span><span class="n">KeyEvent</span> <span class="n">event</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">interactive</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Hold a wake lock until the power key is released.
</span><span class="c1"></span>    <span class="c1">// mPowerKeyWakeLock 是  PARTIAL_WAKE_LOCK 锁，没有获取该锁则获取
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(!</span><span class="n">mPowerKeyWakeLock</span><span class="o">.</span><span class="na">isHeld</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">mPowerKeyWakeLock</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// Cancel multi-press detection timeout.
</span><span class="c1"></span>    <span class="c1">// 处理连击事件，比如：双击打开相机，三连击拨打紧急号码；
</span><span class="c1"></span>    <span class="c1">// 触发连击机制时会先发送延迟消息,如果在改消息发送成功前再次点击就取消改消息，否则触发改连击事件
</span><span class="c1"></span>    <span class="c1">// 例如：连击两次后会发送打开相机的延迟消息，如果消息还未被处理再次按电源键
</span><span class="c1"></span>    <span class="c1">// 则取消该消息而发送拨打紧急号码的延迟消息，否则会处理改消息执行双击动作即打开相机。
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">mPowerKeyPressCounter</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mHandler</span><span class="o">.</span><span class="na">removeMessages</span><span class="o">(</span><span class="n">MSG_POWER_DELAYED_PRESS</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Detect user pressing the power button in panic when an application has
</span><span class="c1"></span>    <span class="c1">// taken over the whole screen.
</span><span class="c1"></span>    <span class="c1">// 检测当前应用是否是在全屏运行而误按电源键，比如看视频，玩游戏
</span><span class="c1"></span>    <span class="kt">boolean</span> <span class="n">panic</span> <span class="o">=</span> <span class="n">mImmersiveModeConfirmation</span><span class="o">.</span><span class="na">onPowerKeyDown</span><span class="o">(</span><span class="n">interactive</span><span class="o">,</span>
                                                              <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">(),</span> <span class="n">isImmersiveMode</span><span class="o">(</span><span class="n">mLastSystemUiFlags</span><span class="o">),</span>
                                                              <span class="n">isNavBarEmpty</span><span class="o">(</span><span class="n">mLastSystemUiFlags</span><span class="o">));</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">panic</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mHandler</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="n">mHiddenNavPanic</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Abort possibly stuck animations.
</span><span class="c1"></span>    <span class="c1">// 终止当前可能被卡住的动画
</span><span class="c1"></span>    <span class="n">mHandler</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="nl">mWindowManagerFuncs:</span><span class="o">:</span><span class="n">triggerAnimationFailsafe</span><span class="o">);</span>

    <span class="c1">// Latch power key state to detect screenshot chord.
</span><span class="c1"></span>    <span class="c1">// 锁定电源键检测是否满足截屏条件，符合则截屏
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">interactive</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mScreenshotChordPowerKeyTriggered</span>
        <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getFlags</span><span class="o">()</span> <span class="o">&amp;</span> <span class="n">KeyEvent</span><span class="o">.</span><span class="na">FLAG_FALLBACK</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mScreenshotChordPowerKeyTriggered</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="n">mScreenshotChordPowerKeyTime</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getDownTime</span><span class="o">();</span>
        <span class="n">interceptScreenshotChord</span><span class="o">();</span>
        <span class="n">interceptRingerToggleChord</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// Stop ringing or end call if configured to do so when power is pressed.
</span><span class="c1"></span>    <span class="n">TelecomManager</span> <span class="n">telecomManager</span> <span class="o">=</span> <span class="n">getTelecommService</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="n">hungUp</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">telecomManager</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">telecomManager</span><span class="o">.</span><span class="na">isRinging</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// Pressing Power while there&#39;s a ringing incoming
</span><span class="c1"></span>            <span class="c1">// call should silence the ringer.
</span><span class="c1"></span>            <span class="c1">// 来电响铃则静音
</span><span class="c1"></span>            <span class="n">telecomManager</span><span class="o">.</span><span class="na">silenceRinger</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">mIncallPowerBehavior</span>
                    <span class="o">&amp;</span> <span class="n">Settings</span><span class="o">.</span><span class="na">Secure</span><span class="o">.</span><span class="na">INCALL_POWER_BUTTON_BEHAVIOR_HANGUP</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span>
                   <span class="o">&amp;&amp;</span> <span class="n">telecomManager</span><span class="o">.</span><span class="na">isInCall</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">interactive</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Otherwise, if &#34;Power button ends call&#34; is enabled,
</span><span class="c1"></span>            <span class="c1">// the Power button will hang up any current active call.
</span><span class="c1"></span>            <span class="c1">// 如果是通话状态并且设置中设置了电源键可以挂断电话则挂断电话
</span><span class="c1"></span>            <span class="n">hungUp</span> <span class="o">=</span> <span class="n">telecomManager</span><span class="o">.</span><span class="na">endCall</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">GestureLauncherService</span> <span class="n">gestureService</span> <span class="o">=</span> <span class="n">LocalServices</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span>
                                                                     <span class="n">GestureLauncherService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="n">gesturedServiceIntercepted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">gestureService</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 手势服务处理本次事件
</span><span class="c1"></span>        <span class="n">gesturedServiceIntercepted</span> <span class="o">=</span> <span class="n">gestureService</span><span class="o">.</span><span class="na">interceptPowerKeyDown</span><span class="o">(</span><span class="n">event</span><span class="o">,</span> <span class="n">interactive</span><span class="o">,</span>
                                                                          <span class="n">mTmpBoolean</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mTmpBoolean</span><span class="o">.</span><span class="na">value</span> <span class="o">&amp;&amp;</span> <span class="n">mRequestedOrGoingToSleep</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mCameraGestureTriggeredDuringGoingToSleep</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// Inform the StatusBar; but do not allow it to consume the event.
</span><span class="c1"></span>    <span class="c1">// 通知状态栏本次事件，但不会消耗本次事件
</span><span class="c1"></span>    <span class="n">sendSystemKeyToStatusBarAsync</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getKeyCode</span><span class="o">());</span>

    <span class="c1">// If the power key has still not yet been handled, then detect short
</span><span class="c1"></span>    <span class="c1">// press, long press, or multi press and decide what to do.
</span><span class="c1"></span>    <span class="c1">// 上面的动作都会依次处理，例如：通话时你进行截屏，会先截屏再挂断电话；
</span><span class="c1"></span>    <span class="c1">//如果上面的动作都没有触发才会开始处理短按、长按、连击等事件并执行相应动作
</span><span class="c1"></span>    <span class="n">mPowerKeyHandled</span> <span class="o">=</span> <span class="n">hungUp</span> <span class="o">||</span> <span class="n">mScreenshotChordVolumeDownKeyTriggered</span>
        <span class="o">||</span> <span class="n">mA11yShortcutChordVolumeUpKeyTriggered</span> <span class="o">||</span> <span class="n">gesturedServiceIntercepted</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">mPowerKeyHandled</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">interactive</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// When interactive, we&#39;re already awake.
</span><span class="c1"></span>            <span class="c1">// Wait for a long press or for the button to be released to decide what to do.
</span><span class="c1"></span>            <span class="c1">// 亮屏状态，处理长按事件
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">hasLongPressOnPowerBehavior</span><span class="o">())</span> <span class="o">{</span>
                <span class="c1">// 支持长按动作，是否支持长按及长按执行的动作都由：
</span><span class="c1"></span>                <span class="c1">// com.android.internal.R.integer.config_longPressOnPowerBehavior 的值决定，默认是：1
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">((</span><span class="n">event</span><span class="o">.</span><span class="na">getFlags</span><span class="o">()</span> <span class="o">&amp;</span> <span class="n">KeyEvent</span><span class="o">.</span><span class="na">FLAG_LONG_PRESS</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 长按事件直接执行长按动作
</span><span class="c1"></span>                    <span class="n">powerLongPress</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="c1">// 发送长按动作延迟消息
</span><span class="c1"></span>                    <span class="n">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">mHandler</span><span class="o">.</span><span class="na">obtainMessage</span><span class="o">(</span><span class="n">MSG_POWER_LONG_PRESS</span><span class="o">);</span>
                    <span class="n">msg</span><span class="o">.</span><span class="na">setAsynchronous</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                    <span class="n">mHandler</span><span class="o">.</span><span class="na">sendMessageDelayed</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span>
                                                <span class="n">ViewConfiguration</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">mContext</span><span class="o">).</span><span class="na">getDeviceGlobalActionKeyTimeout</span><span class="o">());</span>

                    <span class="k">if</span> <span class="o">(</span><span class="n">hasVeryLongPressOnPowerBehavior</span><span class="o">())</span> <span class="o">{</span>
                        <span class="c1">// 支持超长按动作，发送相应延迟消息;会先执行长按动作再执行超长按动作
</span><span class="c1"></span>                        <span class="n">Message</span> <span class="n">longMsg</span> <span class="o">=</span> <span class="n">mHandler</span><span class="o">.</span><span class="na">obtainMessage</span><span class="o">(</span><span class="n">MSG_POWER_VERY_LONG_PRESS</span><span class="o">);</span>
                        <span class="n">longMsg</span><span class="o">.</span><span class="na">setAsynchronous</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                        <span class="n">mHandler</span><span class="o">.</span><span class="na">sendMessageDelayed</span><span class="o">(</span><span class="n">longMsg</span><span class="o">,</span> <span class="n">mVeryLongPressTimeout</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// 次时是息屏状态，先唤醒屏幕
</span><span class="c1"></span>            <span class="n">wakeUpFromPowerKey</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getDownTime</span><span class="o">());</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">mSupportLongPressPowerWhenNonInteractive</span> <span class="o">&amp;&amp;</span> <span class="n">hasLongPressOnPowerBehavior</span><span class="o">())</span> <span class="o">{</span>
                <span class="c1">// 支持息屏长按并且支持长按动作
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">((</span><span class="n">event</span><span class="o">.</span><span class="na">getFlags</span><span class="o">()</span> <span class="o">&amp;</span> <span class="n">KeyEvent</span><span class="o">.</span><span class="na">FLAG_LONG_PRESS</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">powerLongPress</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">mHandler</span><span class="o">.</span><span class="na">obtainMessage</span><span class="o">(</span><span class="n">MSG_POWER_LONG_PRESS</span><span class="o">);</span>
                    <span class="n">msg</span><span class="o">.</span><span class="na">setAsynchronous</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                    <span class="n">mHandler</span><span class="o">.</span><span class="na">sendMessageDelayed</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span>
                                                <span class="n">ViewConfiguration</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">mContext</span><span class="o">).</span><span class="na">getDeviceGlobalActionKeyTimeout</span><span class="o">());</span>

                    <span class="k">if</span> <span class="o">(</span><span class="n">hasVeryLongPressOnPowerBehavior</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">Message</span> <span class="n">longMsg</span> <span class="o">=</span> <span class="n">mHandler</span><span class="o">.</span><span class="na">obtainMessage</span><span class="o">(</span><span class="n">MSG_POWER_VERY_LONG_PRESS</span><span class="o">);</span>
                        <span class="n">longMsg</span><span class="o">.</span><span class="na">setAsynchronous</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                        <span class="n">mHandler</span><span class="o">.</span><span class="na">sendMessageDelayed</span><span class="o">(</span><span class="n">longMsg</span><span class="o">,</span> <span class="n">mVeryLongPressTimeout</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>

                <span class="n">mBeganFromNonInteractive</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// 支持的连击数，默认返回：1，支持三连击返回：3，支持双击返回：2
</span><span class="c1"></span>                <span class="kd">final</span> <span class="kt">int</span> <span class="n">maxCount</span> <span class="o">=</span> <span class="n">getMaxMultiPressPowerCount</span><span class="o">();</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">maxCount</span> <span class="o">&lt;=</span> <span class="n">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">mPowerKeyHandled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">mBeganFromNonInteractive</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<ol>
<li><p><code>wakeUpFromPowerKey()</code>
息屏状态下按下电源键会先唤醒屏幕</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">wakeUpFromPowerKey</span><span class="o">(</span><span class="kt">long</span> <span class="n">eventTime</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// mAllowTheaterModeWakeFromPowerKey 的值由  com.android.internal.R.bool.config_allowTheaterModeWakeFromKey) &amp;&amp;
</span><span class="c1"></span>    <span class="c1">// com.android.internal.R.bool.config_allowTheaterModeWakeFromPowerKey 共同决定，一般是：true
</span><span class="c1"></span>    <span class="n">wakeUp</span><span class="o">(</span><span class="n">eventTime</span><span class="o">,</span> <span class="n">mAllowTheaterModeWakeFromPowerKey</span><span class="o">,</span> <span class="s">&#34;android.policy:POWER&#34;</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">wakeUp</span><span class="o">(</span><span class="kt">long</span> <span class="n">wakeTime</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">wakeInTheaterMode</span><span class="o">,</span> <span class="n">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 当前是否处在剧院模式
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">theaterModeEnabled</span> <span class="o">=</span> <span class="n">isTheaterModeEnabled</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">wakeInTheaterMode</span> <span class="o">&amp;&amp;</span> <span class="n">theaterModeEnabled</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">theaterModeEnabled</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 退出剧院模式
</span><span class="c1"></span>        <span class="n">Settings</span><span class="o">.</span><span class="na">Global</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">mContext</span><span class="o">.</span><span class="na">getContentResolver</span><span class="o">(),</span>
                               <span class="n">Settings</span><span class="o">.</span><span class="na">Global</span><span class="o">.</span><span class="na">THEATER_MODE_ON</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 通过  PowerManager IPC 调用  PowerManagerService.wakeUp() 唤醒系统
</span><span class="c1"></span>    <span class="n">mPowerManager</span><span class="o">.</span><span class="na">wakeUp</span><span class="o">(</span><span class="n">wakeTime</span><span class="o">,</span> <span class="n">reason</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>PowerManagerService.wakeUp()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">wakeUp</span><span class="o">(</span><span class="kt">long</span> <span class="n">eventTime</span><span class="o">,</span> <span class="n">String</span> <span class="n">reason</span><span class="o">,</span> <span class="n">String</span> <span class="n">opPackageName</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">eventTime</span> <span class="o">&gt;</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;event time must not be in the future&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">mContext</span><span class="o">.</span><span class="na">enforceCallingOrSelfPermission</span><span class="o">(</span>
                                            <span class="n">android</span><span class="o">.</span><span class="na">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">DEVICE_POWER</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

    <span class="kd">final</span> <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">getCallingUid</span><span class="o">();</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">ident</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">clearCallingIdentity</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">wakeUpInternal</span><span class="o">(</span><span class="n">eventTime</span><span class="o">,</span> <span class="n">reason</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">opPackageName</span><span class="o">,</span> <span class="n">uid</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">Binder</span><span class="o">.</span><span class="na">restoreCallingIdentity</span><span class="o">(</span><span class="n">ident</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>wakeUpInternal()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">wakeUpInternal</span><span class="o">(</span><span class="kt">long</span> <span class="n">eventTime</span><span class="o">,</span> <span class="n">String</span> <span class="n">reason</span><span class="o">,</span> <span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="n">String</span> <span class="n">opPackageName</span><span class="o">,</span>
                            <span class="kt">int</span> <span class="n">opUid</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">wakeUpNoUpdateLocked</span><span class="o">(</span><span class="n">eventTime</span><span class="o">,</span> <span class="n">reason</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">opPackageName</span><span class="o">,</span> <span class="n">opUid</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// 更新电源状态
</span><span class="c1"></span>            <span class="n">updatePowerStateLocked</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>wakeUpNoUpdateLocked()</code> <a id="orga7a97cb"></a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">wakeUpNoUpdateLocked</span><span class="o">(</span><span class="kt">long</span> <span class="n">eventTime</span><span class="o">,</span> <span class="n">String</span> <span class="n">reason</span><span class="o">,</span> <span class="kt">int</span> <span class="n">reasonUid</span><span class="o">,</span>
                                     <span class="n">String</span> <span class="n">opPackageName</span><span class="o">,</span> <span class="kt">int</span> <span class="n">opUid</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">eventTime</span> <span class="o">&lt;</span> <span class="n">mLastSleepTime</span> <span class="o">||</span> <span class="n">mWakefulness</span> <span class="o">==</span> <span class="n">WAKEFULNESS_AWAKE</span>
        <span class="o">||</span> <span class="o">!</span><span class="n">mBootCompleted</span> <span class="o">||</span> <span class="o">!</span><span class="n">mSystemReady</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 更新最后一次唤醒时间
</span><span class="c1"></span>        <span class="n">mLastWakeTime</span> <span class="o">=</span> <span class="n">eventTime</span><span class="o">;</span>
        <span class="c1">// 更新  Wakefulness 状态为  WAKEFULNESS_AWAKE
</span><span class="c1"></span>        <span class="n">setWakefulnessLocked</span><span class="o">(</span><span class="n">WAKEFULNESS_AWAKE</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
        <span class="c1">// 发送唤醒消息
</span><span class="c1"></span>        <span class="n">mNotifier</span><span class="o">.</span><span class="na">onWakeUp</span><span class="o">(</span><span class="n">reason</span><span class="o">,</span> <span class="n">reasonUid</span><span class="o">,</span> <span class="n">opPackageName</span><span class="o">,</span> <span class="n">opUid</span><span class="o">);</span>
        <span class="c1">// 触发一次用户活动事件
</span><span class="c1"></span>        <span class="n">userActivityNoUpdateLocked</span><span class="o">(</span>
                                   <span class="n">eventTime</span><span class="o">,</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">USER_ACTIVITY_EVENT_OTHER</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">reasonUid</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>
</ol></li>

<li><p><code>interceptPowerKeyUp()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">interceptPowerKeyUp</span><span class="o">(</span><span class="n">KeyEvent</span> <span class="n">event</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">interactive</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">canceled</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 本事件被标记取消或已被处理则标记被处理
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">handled</span> <span class="o">=</span> <span class="n">canceled</span> <span class="o">||</span> <span class="n">mPowerKeyHandled</span><span class="o">;</span>
    <span class="n">mScreenshotChordPowerKeyTriggered</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="c1">// 退出截屏
</span><span class="c1"></span>    <span class="n">cancelPendingScreenshotChordAction</span><span class="o">();</span>
    <span class="c1">// 取消长按延迟消息、超长按延迟消息，松开了表示不是长按动作
</span><span class="c1"></span>    <span class="n">cancelPendingPowerKeyAction</span><span class="o">();</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">handled</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Figure out how to handle the key now that it has been released.
</span><span class="c1"></span>        <span class="c1">// 记录连击次数
</span><span class="c1"></span>        <span class="n">mPowerKeyPressCounter</span> <span class="o">+=</span> <span class="n">1</span><span class="o">;</span>

        <span class="kd">final</span> <span class="kt">int</span> <span class="n">maxCount</span> <span class="o">=</span> <span class="n">getMaxMultiPressPowerCount</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">eventTime</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getDownTime</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mPowerKeyPressCounter</span> <span class="o">&lt;</span> <span class="n">maxCount</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// This could be a multi-press.  Wait a little bit longer to confirm.
</span><span class="c1"></span>            <span class="c1">// Continue holding the wake lock.
</span><span class="c1"></span>            <span class="n">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">mHandler</span><span class="o">.</span><span class="na">obtainMessage</span><span class="o">(</span><span class="n">MSG_POWER_DELAYED_PRESS</span><span class="o">,</span>
                                                 <span class="n">interactive</span> <span class="o">?</span> <span class="n">1</span> <span class="o">:</span> <span class="n">0</span><span class="o">,</span> <span class="n">mPowerKeyPressCounter</span><span class="o">,</span> <span class="n">eventTime</span><span class="o">);</span>
            <span class="n">msg</span><span class="o">.</span><span class="na">setAsynchronous</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="c1">// 该消息也会调用  powerPress() 方法，单击、双击、三连击都是该方法处理
</span><span class="c1"></span>            <span class="n">mHandler</span><span class="o">.</span><span class="na">sendMessageDelayed</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">ViewConfiguration</span><span class="o">.</span><span class="na">getMultiPressTimeout</span><span class="o">());</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// No other actions.  Handle it immediately.
</span><span class="c1"></span>        <span class="c1">// 没有其它动作了，立即处理单击事件
</span><span class="c1"></span>        <span class="n">powerPress</span><span class="o">(</span><span class="n">eventTime</span><span class="o">,</span> <span class="n">interactive</span><span class="o">,</span> <span class="n">mPowerKeyPressCounter</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Done.  Reset our state.
</span><span class="c1"></span>    <span class="c1">// 事件处理完成，重置状态
</span><span class="c1"></span>    <span class="n">finishPowerKeyPress</span><span class="o">();</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>powerPress()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">powerPress</span><span class="o">(</span><span class="kt">long</span> <span class="n">eventTime</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">interactive</span><span class="o">,</span> <span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mScreenOnEarly</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mScreenOnFully</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// 默认连击动作只支持关闭剧院模式和增加亮度
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// com.android.internal.R.integer.config_doublePressOnPowerBehavior 这个值决定双击动作
</span><span class="c1"></span>        <span class="n">powerMultiPressAction</span><span class="o">(</span><span class="n">eventTime</span><span class="o">,</span> <span class="n">interactive</span><span class="o">,</span> <span class="n">mDoublePressOnPowerBehavior</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">3</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// com.android.internal.R.integer.config_triplePressOnPowerBehavior 这个值决定三连击动作
</span><span class="c1"></span>        <span class="n">powerMultiPressAction</span><span class="o">(</span><span class="n">eventTime</span><span class="o">,</span> <span class="n">interactive</span><span class="o">,</span> <span class="n">mTriplePressOnPowerBehavior</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">interactive</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mBeganFromNonInteractive</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">mShortPressOnPowerBehavior</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nl">SHORT_PRESS_POWER_NOTHING:</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">SHORT_PRESS_POWER_GO_TO_SLEEP:</span>
            <span class="c1">// mShortPressOnPowerBehavior 默认值是：1，走这个分支
</span><span class="c1"></span>            <span class="n">goToSleep</span><span class="o">(</span><span class="n">eventTime</span><span class="o">,</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">GO_TO_SLEEP_REASON_POWER_BUTTON</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">SHORT_PRESS_POWER_REALLY_GO_TO_SLEEP:</span>
            <span class="n">goToSleep</span><span class="o">(</span><span class="n">eventTime</span><span class="o">,</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">GO_TO_SLEEP_REASON_POWER_BUTTON</span><span class="o">,</span>
                      <span class="n">PowerManager</span><span class="o">.</span><span class="na">GO_TO_SLEEP_FLAG_NO_DOZE</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">SHORT_PRESS_POWER_REALLY_GO_TO_SLEEP_AND_GO_HOME:</span>
            <span class="n">goToSleep</span><span class="o">(</span><span class="n">eventTime</span><span class="o">,</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">GO_TO_SLEEP_REASON_POWER_BUTTON</span><span class="o">,</span>
                      <span class="n">PowerManager</span><span class="o">.</span><span class="na">GO_TO_SLEEP_FLAG_NO_DOZE</span><span class="o">);</span>
            <span class="n">launchHomeFromHotKey</span><span class="o">();</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">SHORT_PRESS_POWER_GO_HOME:</span>
            <span class="n">shortPressPowerGoHome</span><span class="o">();</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">SHORT_PRESS_POWER_CLOSE_IME_OR_GO_HOME:</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mDismissImeOnBackKeyPressed</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mInputMethodManagerInternal</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">mInputMethodManagerInternal</span> <span class="o">=</span>
                        <span class="n">LocalServices</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="n">InputMethodManagerInternal</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mInputMethodManagerInternal</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">mInputMethodManagerInternal</span><span class="o">.</span><span class="na">hideCurrentInputMethod</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">shortPressPowerGoHome</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<ol>
<li><p><code>goToSleep()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">goToSleep</span><span class="o">(</span><span class="kt">long</span> <span class="n">eventTime</span><span class="o">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mRequestedOrGoingToSleep</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="c1">// 通过  PowerManager IPC 调用  PowerManagerService.goToSleep() 进行休眠
</span><span class="c1"></span>    <span class="n">mPowerManager</span><span class="o">.</span><span class="na">goToSleep</span><span class="o">(</span><span class="n">eventTime</span><span class="o">,</span> <span class="n">reason</span><span class="o">,</span> <span class="n">flags</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>PowerManagerService.goToSleep()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">goToSleep</span><span class="o">(</span><span class="kt">long</span> <span class="n">eventTime</span><span class="o">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">eventTime</span> <span class="o">&gt;</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;event time must not be in the future&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">mContext</span><span class="o">.</span><span class="na">enforceCallingOrSelfPermission</span><span class="o">(</span>
                                            <span class="n">android</span><span class="o">.</span><span class="na">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">DEVICE_POWER</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

    <span class="kd">final</span> <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">getCallingUid</span><span class="o">();</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">ident</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">clearCallingIdentity</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">goToSleepInternal</span><span class="o">(</span><span class="n">eventTime</span><span class="o">,</span> <span class="n">reason</span><span class="o">,</span> <span class="n">flags</span><span class="o">,</span> <span class="n">uid</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">Binder</span><span class="o">.</span><span class="na">restoreCallingIdentity</span><span class="o">(</span><span class="n">ident</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">goToSleepInternal</span><span class="o">(</span><span class="kt">long</span> <span class="n">eventTime</span><span class="o">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">uid</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">goToSleepNoUpdateLocked</span><span class="o">(</span><span class="n">eventTime</span><span class="o">,</span> <span class="n">reason</span><span class="o">,</span> <span class="n">flags</span><span class="o">,</span> <span class="n">uid</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// 更新电源状态，熄灭屏幕
</span><span class="c1"></span>            <span class="n">updatePowerStateLocked</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>goToSleepNoUpdateLocked()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">goToSleepNoUpdateLocked</span><span class="o">(</span><span class="kt">long</span> <span class="n">eventTime</span><span class="o">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">uid</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">eventTime</span> <span class="o">&lt;</span> <span class="n">mLastWakeTime</span>
        <span class="o">||</span> <span class="n">mWakefulness</span> <span class="o">==</span> <span class="n">WAKEFULNESS_ASLEEP</span>
        <span class="o">||</span> <span class="n">mWakefulness</span> <span class="o">==</span> <span class="n">WAKEFULNESS_DOZING</span>
        <span class="o">||</span> <span class="o">!</span><span class="n">mBootCompleted</span> <span class="o">||</span> <span class="o">!</span><span class="n">mSystemReady</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// 更新最后一次睡眠时间
</span><span class="c1"></span>    <span class="n">mLastSleepTime</span> <span class="o">=</span> <span class="n">eventTime</span><span class="o">;</span>
    <span class="n">mSandmanSummoned</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="c1">// Wakefulness 置为  WAKEFULNESS_DOZING
</span><span class="c1"></span>    <span class="n">setWakefulnessLocked</span><span class="o">(</span><span class="n">WAKEFULNESS_DOZING</span><span class="o">,</span> <span class="n">reason</span><span class="o">);</span>

    <span class="c1">// Report the number of wake locks that will be cleared by going to sleep.
</span><span class="c1"></span>    <span class="c1">// 清除所有唤醒锁
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">numWakeLocksCleared</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">numWakeLocks</span> <span class="o">=</span> <span class="n">mWakeLocks</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numWakeLocks</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">WakeLock</span> <span class="n">wakeLock</span> <span class="o">=</span> <span class="n">mWakeLocks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">wakeLock</span><span class="o">.</span><span class="na">mFlags</span> <span class="o">&amp;</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">WAKE_LOCK_LEVEL_MASK</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">FULL_WAKE_LOCK</span><span class="o">:</span>
        <span class="k">case</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">SCREEN_BRIGHT_WAKE_LOCK</span><span class="o">:</span>
        <span class="k">case</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">SCREEN_DIM_WAKE_LOCK</span><span class="o">:</span>
            <span class="n">numWakeLocksCleared</span> <span class="o">+=</span> <span class="n">1</span><span class="o">;</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writePowerSleepRequested</span><span class="o">(</span><span class="n">numWakeLocksCleared</span><span class="o">);</span>

    <span class="c1">// Skip dozing if requested.
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PowerManager</span><span class="o">.</span><span class="na">GO_TO_SLEEP_FLAG_NO_DOZE</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 不打盹直接休眠，Wakefulness 置为  WAKEFULNESS_ASLEEP
</span><span class="c1"></span>        <span class="n">reallyGoToSleepNoUpdateLocked</span><span class="o">(</span><span class="n">eventTime</span><span class="o">,</span> <span class="n">uid</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>
</ol></li>

<li><p><code>finishPowerKeyPress()</code>
一次完整的电源键事件后会复位状态</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">finishPowerKeyPress</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">mBeganFromNonInteractive</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="c1">// 清除连击计数
</span><span class="c1"></span>    <span class="n">mPowerKeyPressCounter</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mPowerKeyWakeLock</span><span class="o">.</span><span class="na">isHeld</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">mPowerKeyWakeLock</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">dinghmcn</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2019-04-23</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://dinghmcn.github.io/tags/android/">Android</a>
          <a href="https://dinghmcn.github.io/tags/systemserver/">SystemServer</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/androidlearningroadmap/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Android Learning Roadmap</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/wifiservice/">
            <span class="next-text nav-default">WifiService</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  
  
  

  
  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "dinghmcn/utterances"
            issue-term="pathname"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  
  
    



        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:your@email.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="stack-overflow"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M809.714286 932.571429l-638.857143 0 0-274.285714-91.428571 0 0 365.714286 821.714286 0 0-365.714286-91.428571 0 0 274.285714zm-538.285714-299.428571l18.857143-89.714286 447.428571 94.285714-18.857143 89.142857zm58.857143-213.714286l38.285714-83.428571 414.285714 193.714286-38.285714 82.857143zm114.857143-203.428571l58.285714-70.285714 350.857143 293.142857-58.285714 70.285714zm226.857143-216l272.571429 366.285714-73.142857 54.857143-272.571429-366.285714zm-410.285714 840.571429l0-90.857143 457.142857 0 0 90.857143-457.142857 0z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="twitter"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1264 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M1229.8616 18.043658c0 0-117.852626 63.135335-164.151872 67.344358-105.225559-164.151872-505.082682-92.598492-437.738325 223.078185C278.622548 312.675223 89.216542 47.506814 89.216542 47.506814s-117.852626 189.406006 75.762402 345.139833C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042C1179.353331 249.539887 1263.533778 123.269217 1263.533778 123.269217s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="facebook"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="33" height="33">
  <path d="M965.7344 2.7648c14.848 0 28.2624 5.5296 40.2432 16.6912C1017.9584 30.5152 1024 43.52 1024 58.2656l0 910.2336c0 14.848-6.0416 27.7504-18.0224 38.8096C993.8944 1018.4704 980.48 1024 965.7344 1024L704.9216 1024 704.9216 629.9648l133.2224 0 19.456-155.4432-152.576 0L705.024 373.0432c0-50.688 25.9072-76.0832 77.7216-76.0832l80.4864 0L863.232 163.5328c-27.7504-5.4272-67.4816-8.192-119.296-8.192-59.1872 0-106.8032 18.0224-142.9504 54.0672C564.736 245.5552 546.7136 296.0384 546.7136 360.7552l0 113.7664L413.4912 474.5216l0 155.4432 133.2224 0L546.7136 1024 55.5008 1024c-14.848 0-27.7504-5.5296-38.8096-16.6912C5.5296 996.2496 0 983.3472 0 968.4992L0 58.2656C0 43.52 5.5296 30.5152 16.6912 19.456c11.0592-11.0592 24.064-16.6912 38.8096-16.6912L965.7344 2.7648z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="linkedin"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="33" height="33">
  <path d="M872.405333 872.618667h-151.637333v-237.610667c0-56.661333-1.152-129.578667-79.018667-129.578667-79.061333 0-91.136 61.653333-91.136 125.397334v241.792H398.976V384h145.664v66.602667h1.962667c20.352-38.4 69.845333-78.933333 143.786666-78.933334 153.642667 0 182.058667 101.12 182.058667 232.746667v268.202667zM227.712 317.141333a87.978667 87.978667 0 0 1-88.021333-88.106666 88.064 88.064 0 1 1 88.021333 88.106666z m76.032 555.477334H151.68V384h152.064v488.618667zM948.266667 0H75.562667C33.792 0 0 33.024 0 73.770667v876.458666C0 991.018667 33.792 1024 75.562667 1024h872.576C989.866667 1024 1024 991.018667 1024 950.229333V73.770667C1024 33.024 989.866667 0 948.138667 0h0.128z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="google"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M853.333333 85.333333C900.266667 85.333333 938.666667 123.733333 938.666667 170.666667L938.666667 853.333333C938.666667 900.266667 900.266667 938.666667 853.333333 938.666667L170.666667 938.666667C123.733333 938.666667 85.333333 900.266667 85.333333 853.333333L85.333333 170.666667C85.333333 123.306667 123.733333 85.333333 170.666667 85.333333L853.333333 85.333333M853.333333 512 768 512 768 426.666667 725.333333 426.666667 725.333333 512 640 512 640 554.666667 725.333333 554.666667 725.333333 640 768 640 768 554.666667 853.333333 554.666667 853.333333 512M384 481.706667 384 554.666667 506.026667 554.666667C499.626667 584.96 469.333333 645.973333 384 645.973333 311.04 645.973333 253.013333 584.96 253.013333 512 253.013333 439.04 311.04 378.026667 384 378.026667 426.666667 378.026667 453.973333 396.373333 469.333333 411.306667L527.36 356.693333C490.666667 320 442.026667 298.666667 384 298.666667 264.96 298.666667 170.666667 392.96 170.666667 512 170.666667 631.04 264.96 725.333333 384 725.333333 506.026667 725.333333 588.373333 640 588.373333 517.973333 588.373333 503.04 588.373333 493.653333 584.96 481.706667L384 481.706667Z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="weibo"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M385.714286 733.714286q12-19.428571 6.285714-39.428571t-25.714286-28.571429q-19.428571-8-41.714286-0.571429t-34.285714 26.285714q-12.571429 19.428571-7.428571 39.142857t24.571429 28.857143 42.571429 1.428571 35.714286-27.142857zm53.714286-69.142857q4.571429-7.428571 2-15.142857t-10-10.571429q-8-2.857143-16.285714 2.857143t-12.285714 10.571429q-9.714286 17.714286 7.428571 25.714286 8 2.857143 16.571429 2.857143t12.571429-10.571429zm99.428571 61.142857q-25.714286 58.285714-90.285714 85.714286t-128 6.857143q-61.142857-19.428571-84.285714-72.285714t3.714286-107.142857q26.857143-53.142857 86.571429-79.428571t120.285714-10.857143q63.428571 16.571429 90.571429 68.285714t1.428571 108.857143zm178.285714-91.428571q-5.142857-54.857143-50.857143-97.142857t-119.142857-62.285714-156.857143-12q-127.428571 13.142857-211.142857 80.857143t-75.714286 151.142857q5.142857 54.857143 50.857143 97.142857t119.142857 62.285714 156.857143 12q127.428571-13.142857 211.142857-80.857143t75.714286-151.142857zm176 2.285714q0 38.857143-21.142857 79.714286t-62.285714 78.285714-96.285714 67.142857-129.142857 47.428571-154.571429 17.714286-157.142857-19.142857-137.428571-53.142857-98-86.285714-37.142857-114q0-65.714286 39.714286-140t112.857143-147.428571q96.571429-96.571429 195.142857-134.857143t140.857143 4q37.142857 36.571429 11.428571 119.428571-2.285714 8-0.571429 11.428571t5.714286 4 8.285714 2.857143 7.714286-2l3.428571-1.142857q79.428571-33.714286 140.571429-33.714286t87.428571 34.857143q25.714286 36 0 101.714286-1.142857 7.428571-2.571429 11.428571t2.571429 7.142857 6.857143 4.285714 9.714286 3.428571q32.571429 10.285714 58.857143 26.857143t45.714286 46.571429 19.428571 66.571429zm-42.285714-356.571429q24 26.857143 31.142857 62t-3.714286 67.142857q-4.571429 13.142857-16.857143 19.428571t-25.428571 2.285714q-13.142857-4.571429-19.428571-16.857143t-2.285714-25.428571q11.428571-36-13.714286-63.428571t-61.142857-20q-13.714286 2.857143-25.714286-4.571429t-14.285714-21.142857q-2.857143-13.714286 4.571429-25.428571t21.142857-14.571429q34.285714-7.428571 68 3.142857t57.714286 37.428571zm103.428571-93.142857q49.714286 54.857143 64.285714 127.142857t-7.714286 138q-5.142857 15.428571-19.428571 22.857143t-29.714286 2.285714-22.857143-19.428571-2.857143-29.714286q16-46.857143 5.714286-98.285714t-45.714286-90.285714q-35.428571-39.428571-84.571429-54.571429t-98.857143-4.857143q-16 3.428571-29.714286-5.428571t-17.142857-24.857143 5.428571-29.428571 24.857143-16.857143q70.285714-14.857143 139.428571 6.571429t118.857143 76.857143z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="zhihu"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M351.791182 562.469462l192.945407 0c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262l159.282726 0c0 0-0.86367-67.402109-18.578124-67.402109s-279.979646 0-279.979646 0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461c-4.536316 12.313443 24.62791 5.832845 36.941354 0 12.313443-5.832845 68.050885-25.924439 84.252893-103.69571l86.570681 0c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262L109.86113 490.530013c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449L279.868105 562.469462c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513 0 0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-0.055259 0.185218 167.855986 193.263655c0 0 22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-0.045025 0.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"></path>
  <path d="M584.918753 182.033893l0 668.840094 70.318532 0 28.807093 80.512708 121.875768-80.512708 153.600307 0L959.520453 182.033893 584.918753 182.033893zM887.150192 778.934538l-79.837326 0-99.578949 65.782216-23.537066-65.782216-24.855084 0L659.341766 256.673847l227.807403 0L887.149169 778.934538z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="douban"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M926.917973 37.80608C959.65184 37.80608 986.19392 64.34816 986.19392 97.082027L986.19392 926.917973C986.19392 959.65184 959.65184 986.19392 926.917973 986.19392L97.082027 986.19392C64.34816 986.19392 37.80608 959.65184 37.80608 926.917973L37.80608 97.082027C37.80608 64.34816 64.34816 37.80608 97.082027 37.80608zM176.653653 176.19968 176.653653 252.678827 825.658027 252.678827 825.658027 176.19968zM217.719467 316.146347 217.719467 628.08064 273.524053 628.08064 341.292373 770.39616 157.259093 770.39616 157.259093 845.417813 842.949973 845.417813 842.949973 770.39616 654.226773 770.39616 722.899627 628.08064 783.67744 628.08064 783.67744 316.146347zM684.885333 392.891733 684.885333 553.987413 312.576 553.987413 312.576 392.891733zM570.770773 770.39616 426.653013 770.39616 359.621973 628.08064 639.443627 628.08064z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="pocket"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M912.569234 73.142857a88.429714 88.429714 0 0 1 88.576 89.161143v296.557714C1001.145234 732.562286 782.301806 950.857143 510.28352 950.857143A489.837714 489.837714 0 0 1 18.288091 458.861714V162.304A90.002286 90.002286 0 0 1 107.449234 73.142857h805.156572z m-402.285714 608a68.388571 68.388571 0 0 0 46.848-18.870857l230.838857-221.696a68.022857 68.022857 0 0 0 21.138286-48.566857 67.547429 67.547429 0 0 0-114.285714-48.566857l-184.576 177.152-184.576-177.152a67.328 67.328 0 0 0-46.299429-18.870857 67.547429 67.547429 0 0 0-46.884571 116.004571l231.424 221.696c11.995429 11.995429 29.147429 18.870857 46.299428 18.870857z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="tumblr"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M556.716946 378.027729l133.939525 0 0 89.307002L556.716946 467.334731 556.716946 601.318258c0 58.898435 8.290827 92.557022 53.140291 89.809445 10.382465-0.677429 22.25077-1.855254 35.687804-5.586229 13.437034-3.729951 24.257473-7.458879 32.372292-11.190877l12.739139-5.606695 0 82.546018c-3.403516 2.070148-8.463766 4.820796-15.007809 8.048303-6.631024 3.338025-21.029966 7.656377-43.016723 13.045107-21.988804 5.41022-44.937468 8.070816-68.844971 8.070816-51.395554 0-89.177042-10.994402-113.608477-33.17968-24.343431-22.097274-27.572986-56.147788-27.572986-101.195773L422.605505 467.334731l-89.263 0-0.435928-66.64077c38.480406-12.369725 67.798129-29.734208 88.128153-52.114938 20.332071-22.273283 33.333176-57.021691 38.829354-104.22783l96.853885-0.393973L556.717969 378.027729zM958.70846 243.958244l0 536.105001c0 98.730629-80.013335 178.722474-178.615027 178.722474L243.991502 958.785719c-98.774631 0-178.700985-79.991846-178.700985-178.722474L65.290517 243.958244c0-98.642624 79.925331-178.744987 178.700985-178.744987l536.102954 0C878.695125 65.213257 958.70846 145.31562 958.70846 243.958244zM869.44546 288.612257c0-74.015737-60.033281-133.961014-134.027529-133.961014L288.667004 154.651242c-73.994248 0-134.115534 59.945277-134.115534 133.961014l0 446.775486c0 74.015737 60.121286 133.983527 134.115534 133.983527l446.750927 0c73.994248 0 134.027529-59.96779 134.027529-133.983527L869.44546 288.612257z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="instagram"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M853.333333 277.333333C853.333333 289.28 843.946667 298.666667 832 298.666667L746.666667 298.666667C734.72 298.666667 725.333333 289.28 725.333333 277.333333L725.333333 192C725.333333 180.053333 734.72 170.666667 746.666667 170.666667L832 170.666667C843.946667 170.666667 853.333333 180.053333 853.333333 192M192 853.333333C180.053333 853.333333 170.666667 843.946667 170.666667 832L170.666667 469.333333 259.84 469.333333C257.28 482.986667 256 497.493333 256 512 256 653.226667 370.773333 768 512 768 653.226667 768 768 653.226667 768 512 768 497.493333 766.293333 482.986667 764.16 469.333333L853.333333 469.333333 853.333333 832C853.333333 843.946667 843.946667 853.333333 832 853.333333M512 341.333333C606.293333 341.333333 682.666667 417.706667 682.666667 512 682.666667 606.293333 606.293333 682.666667 512 682.666667 417.706667 682.666667 341.333333 606.293333 341.333333 512 341.333333 417.706667 417.706667 341.333333 512 341.333333M853.333333 85.333333 170.666667 85.333333C123.306667 85.333333 85.333333 123.306667 85.333333 170.666667L85.333333 853.333333C85.333333 900.266667 123.733333 938.666667 170.666667 938.666667L853.333333 938.666667C900.266667 938.666667 938.666667 900.266667 938.666667 853.333333L938.666667 170.666667C938.666667 123.306667 900.266667 85.333333 853.333333 85.333333Z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="gitlab"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M59.544137 403.419429L512.115566 983.405714 16.09728 623.396571a39.936 39.936 0 0 1-14.299429-43.995428l57.709715-176.018286z m264.009143 0h377.161143L512.152137 983.405714zM210.40128 53.723429l113.152 349.696H59.544137l113.152-349.696a20.041143 20.041143 0 0 1 37.705143 0z m754.285714 349.696l57.709715 176.018285a39.862857 39.862857 0 0 1-14.299429 43.995429l-496.018286 360.009143 452.571429-579.986286z m0 0h-264.009143l113.152-349.696a20.041143 20.041143 0 0 1 37.705143 0z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="goodreads"  target="_blank"
      >
      <svg viewBox="0 0 128 128" version="1.1"
  width="32" height="32">
  <path d="M 85.685714,45.48571 C 87.142857,56.14286 84.342857,68.05714 75.428571,74.25714 69.057143,78.68571 60.342857,78.28571 55.2,75.88571 44.6,70.94286 41.057143,59.14286 41.828571,48.11429 c 1.228572,-17.4 11.685715,-25.11429 21.514286,-25 13.4,-0.0571 20.514286,9.08571 22.342857,22.37142 z M 128,16 v 96 c 0,8.82857 -7.17143,16 -16,16 H 16 C 7.1714286,128 0,120.82857 0,112 V 16 C 0,7.17143 7.1714286,0 16,0 h 96 c 8.82857,0 16,7.17143 16,16 z M 94.285714,80.34286 c 0,0 -0.02857,-9.71429 -0.02857,-62.08572 H 85.97143 V 29.77143 C 85.742858,29.85713 85.628572,29.62857 85.514287,29.42857 82.771429,23.51429 75.257143,16.2 63.8,16.28571 48.971429,16.4 38.885714,25.2 35.057143,38.51429 33.828571,42.77143 33.4,47.11429 33.485714,51.54286 33.971429,73.8 46.371429,85.2 65.6,84.45714 73.857143,84.14286 81.171429,79.6 85.314286,71.54286 85.457143,71.25714 85.628571,71 85.8,70.71429 c 0.05714,0.0286 0.114286,0.0286 0.171429,0.0571 0.08571,1.08571 0.05714,8.77143 0.02857,9.85714 -0.05714,4.22857 -0.571429,8.42857 -2.057143,12.42857 -2.228571,6 -6.371428,9.91429 -12.714286,11.28572 -5.085714,1.11428 -10.171428,1.08571 -15.2,-0.34286 C 49.885714,102.25714 45.6,98.57143 44.285714,92.05714 44.2,91.6 43.914286,91.68571 43.628571,91.68571 H 35.971429 C 36.2,94.71429 36.885714,97.48571 38.4,100.02857 45.314286,111.6 62.028571,113.88571 75.028571,110.71429 89.285714,107.2 94.257143,95.02857 94.285714,80.34286 Z" />
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="coding"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  width="36" height="36">
  <path
      d="m 313.5359,557.51414 c 9.229,0 16.57801,8.88719 16.57801,19.99616 0,11.10899 -7.34901,19.99617 -16.57801,19.99617 -9.229,0 -16.57801,-8.88718 -16.57801,-19.99617 0,-11.10897 7.34901,-19.99616 16.57801,-19.99616 z m 393.7706,0 c 9.22899,0 16.57802,8.88719 16.57802,19.99616 0,11.10899 -7.34903,19.99617 -16.57802,19.99617 -9.229,0 -16.57802,-8.88718 -16.57802,-19.99617 0,-11.10897 7.34902,-19.99616 16.57802,-19.99616 z"
      id="path6"/>
  <path
      d="m 945.8932,448.98796 c -27.17427,0 -51.1013,17.26164 -64.43208,43.23957 C 836.17066,393.44306 741.8298,302.00762 625.27096,264.23708 562.37704,239.1137 518.28294,190.57601 512.8139,134.17657 507.34486,190.74691 463.25077,239.1137 400.35685,264.23708 283.79802,301.83671 189.45714,393.44306 144.16669,492.22753 130.83591,466.2496 107.07979,448.98796 79.734607,448.98796 c -41.701401,0 -75.541066,40.84686 -75.541066,91.26454 0,50.41768 33.839665,91.26454 75.541066,91.26454 12.64715,0 24.610663,-3.75996 35.206923,-10.42536 3.58906,163.55837 180.30728,269.69186 397.87237,270.03367 217.5651,-0.34181 394.28332,-106.4753 397.87238,-270.03367 10.42535,6.6654 22.55977,10.42536 35.20692,10.42536 41.7014,0 75.541,-40.84686 75.541,-91.26454 0.171,-50.41768 -33.6687,-91.26454 -75.541,-91.26454 z M 114.2579,568.79403 c -3.58906,13.15987 -19.312535,18.79981 -35.206921,12.47625 -15.894385,-6.15267 -25.977916,-21.87616 -22.388867,-35.03602 3.58906,-13.15987 19.312533,-18.79981 35.206919,-12.47624 15.894389,6.15267 25.807019,21.87614 22.388869,35.03601 z m 398.556,276.69904 C 338.31748,845.15126 196.97707,762.603 196.97707,644.33509 c 0,-2.56361 0.1709,-4.95631 0.1709,-7.34902 0,-0.85453 0,-1.53817 0.17092,-2.3927 0.1709,-1.70908 0.34181,-3.41814 0.34181,-4.95631 0.1709,-2.22179 0.51273,-4.44359 0.85454,-6.6654 0,-0.1709 0,-0.51271 0.1709,-0.68362 3.58906,-23.2434 12.47624,-58.79214 26.14883,-79.13012 32.64331,-47.51224 90.92273,-78.9592 157.23479,-78.9592 51.1013,0 97.41721,18.79981 130.91506,49.05041 33.49784,-30.2506 79.64283,-49.05041 130.91504,-49.05041 66.48298,0 124.59148,31.61786 157.23479,78.9592 13.67259,20.50889 22.55977,55.88672 26.14883,79.13012 0,0.17091 0,0.51272 0.17091,0.68362 0.34182,2.22181 0.51272,4.44361 0.85453,6.6654 0.17091,1.70907 0.34181,3.24723 0.34181,4.95631 0,0.85453 0.17092,1.53817 0.17092,2.3927 0.17091,2.39271 0.17091,4.95631 0.17091,7.34902 C 828.82165,762.603 687.48124,845.15126 512.8139,845.49307 Z M 946.74774,581.27028 c -15.89439,6.15265 -31.61787,0.68362 -35.20692,-12.47625 -3.58906,-13.15987 6.49448,-28.88334 22.38887,-35.03601 15.89438,-6.15267 31.61786,-0.68363 35.20692,12.47624 3.41815,12.98896 -6.49448,28.71243 -22.38887,35.03602 z"
      id="path8"/>
</svg>

    </a>
  
    <a href="http://localhost:1313" rel="me noopener" class="iconfont"
      title="bilibili"  target="_blank"
      >
      <svg
  class="icon" style="" viewBox="0 0 1024 1024" version="1.1" width="36"
  height="36" id="svg8">
  <path
      style=""
      d="M 744.60599,0.00486267 A 41.779915,41.779915 0 0 0 710.4184,18.673394 L 548.5048,255.32642 h -11.70046 a 41.779915,41.779915 0 0 0 -10.80295,-7.84928 L 235.66,97.084498 a 41.779915,41.779915 0 0 0 -20.07193,-4.960864 41.779915,41.779915 0 0 0 -18.3748,79.145436 L 359.4859,255.32642 H 128.16909 c -49.458302,0 -89.27932,39.82105 -89.27932,89.27932 v 508.65224 c 0,49.4583 39.821018,89.27934 89.27932,89.27934 h 19.48445 C 149.12802,984.5043 179.92773,1024 224.79179,1024 c 44.86407,0 75.66379,-39.4957 77.13826,-81.46268 H 719.98116 C 721.45559,984.5043 752.25533,1024 797.1194,1024 c 44.86406,0 75.6638,-39.4957 77.13824,-81.46268 h 21.57323 c 49.45831,0 89.27936,-39.82104 89.27936,-89.27934 V 344.60574 c 0,-49.45827 -39.82105,-89.27932 -89.27936,-89.27932 H 649.74567 L 779.38103,65.866924 A 41.779915,41.779915 0 0 0 744.60599,0.00486267 Z M 644.49108,418.70871 c 6.29985,0.21538 12.44451,2.01107 17.86888,5.22196 l 171.36218,98.10771 c 18.23417,10.21935 24.63334,33.34627 14.24614,51.48533 -10.38726,18.13909 -33.57344,24.32718 -51.61587,13.77296 L 624.9903,489.18895 c -15.21356,-8.41858 -22.66871,-26.1765 -18.03211,-42.93436 4.63664,-16.75784 20.15573,-28.14465 37.53289,-27.54588 z M 350.2006,432.31846 c 16.89952,0.0317 31.69582,11.33328 36.17844,27.62747 4.48262,16.2942 -2.44981,33.57765 -16.95507,42.24898 l -140.7157,86.91312 c -17.68528,11.18244 -41.09629,5.77692 -52.08912,-12.02686 -10.99282,-17.80373 -5.33855,-41.15658 12.58167,-51.95857 L 329.9002,438.2095 c 6.0643,-3.86439 13.10951,-5.90891 20.3004,-5.89104 z M 501.605,641.53985 c 3.75002,-0.15248 7.48645,0.53903 10.93349,2.0235 0.15842,0.0637 0.31618,0.12888 0.47325,0.19582 0.59328,0.27092 1.17574,0.56489 1.74609,0.88121 0.15868,0.0854 0.31643,0.17233 0.47325,0.2611 0.55694,0.32165 1.10131,0.66458 1.63185,1.02807 0.16455,0.1123 0.32777,0.2265 0.48956,0.34269 0.50382,0.36781 0.99371,0.75428 1.46868,1.15864 0.18724,0.15504 0.37218,0.31282 0.55484,0.47323 0.43271,0.38784 0.8518,0.79061 1.25653,1.20756 0.15449,0.16114 0.30679,0.32437 0.45693,0.48959 0.40798,0.44266 0.79989,0.89988 1.17494,1.37076 0.17799,0.22544 0.35205,0.45395 0.5222,0.68538 0.25932,0.34701 0.50964,0.70071 0.75064,1.06071 0.26712,0.39516 0.52286,0.79784 0.76699,1.20757 0.16907,0.29043 0.33231,0.58424 0.48957,0.88123 0.21836,0.41297 0.42513,0.83199 0.62009,1.25653 0.14836,0.32333 0.28983,0.64976 0.42429,0.97911 0.21319,0.51552 0.40915,1.03801 0.58747,1.5666 0.0677,0.19499 0.13296,0.39085 0.19582,0.58748 0.18652,0.60823 0.34984,1.22334 0.48957,1.84399 0.0397,0.16277 0.0779,0.32601 0.11423,0.48957 0.1436,0.69112 0.25788,1.38801 0.34269,2.08877 0.005,0.0381 0.0111,0.0761 0.0163,0.11424 0.0857,0.78056 0.13474,1.56471 0.14687,2.34988 0.005,0.0543 0.0111,0.10879 0.0163,0.1632 0,0 -0.008,1.12132 0,1.45234 0,0 -0.14697,17.84761 5.89102,34.12231 3.01902,8.13734 7.33278,15.10615 12.61433,19.61501 5.28157,4.50889 11.42894,7.62081 23.64572,7.62081 12.2168,0 18.36416,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.5953,-11.47767 12.6143,-19.61501 6.03799,-16.2747 5.89103,-34.12231 5.89103,-34.12231 -0.44885,-13.87045 10.45922,-25.46302 24.3311,-25.86506 13.87189,-0.40201 25.42828,10.53953 25.78348,24.41272 0,0 1.11929,25.7226 -9.00791,53.01927 -5.06359,13.64832 -13.1986,28.46036 -27.05631,40.29073 -13.85772,11.83039 -33.5454,19.63135 -56.20142,19.63135 -22.65603,0 -42.34371,-7.80096 -56.20141,-19.63135 -4.1801,-3.56856 -7.78733,-7.42433 -10.99878,-11.42303 -3.21235,4.00037 -6.81703,7.85309 -10.99876,11.42303 -13.85773,11.83039 -33.5454,19.63135 -56.20144,19.63135 -22.65601,0 -42.3437,-7.80096 -56.2014,-19.63135 -13.85775,-11.83037 -21.99272,-26.64241 -27.05632,-40.29073 -10.12725,-27.29667 -9.00789,-53.01928 -9.00789,-53.01927 0.20714,-13.83687 11.58744,-24.88848 25.42444,-24.69013 14.1263,0.19991 25.2971,12.0278 24.69011,26.14247 0,0 -0.14697,17.84761 5.89103,34.12231 3.01902,8.13734 7.31646,15.10615 12.598,19.61501 5.28155,4.50889 11.44526,7.62081 23.66203,7.62081 12.21681,0 18.36418,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.57899,-11.47767 12.598,-19.61501 5.76352,-15.53489 5.89112,-32.05691 5.89103,-33.56746 0.006,-0.37466 0.0111,-1.05336 0.0163,-1.20759 -0.0117,-0.74583 0.0105,-1.49177 0.0652,-2.23565 0.009,-0.15784 0.0204,-0.31561 0.0327,-0.47324 0.14204,-1.56859 0.43163,-3.12027 0.86487,-4.63449 0.0213,-0.0763 0.0433,-0.15244 0.0652,-0.22848 3.0335,-10.25748 12.24157,-17.46007 22.92769,-17.93417 z"
      id="rect824"/>
</svg>

    </a>


<a href="https://dinghmcn.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        dinghmcn
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>






  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>










</body>
</html>
